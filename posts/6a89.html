<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"><title>Redis | å¥•ä¸ƒ</title><meta name="keywords" content="Java,Redis"><meta name="author" content="å¥•ä¸ƒ,2392889869@qq.com"><meta name="copyright" content="å¥•ä¸ƒ"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#f7f9fe"><meta name="mobile-web-app-capable" content="yes"><meta name="apple-touch-fullscreen" content="yes"><meta name="apple-mobile-web-app-title" content="Redis"><meta name="application-name" content="Redis"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="#f7f9fe"><meta name="description" content="Rediså…¥é—¨ç®€ä»‹Redisæ˜¯ä¸€ä¸ªå¼€æºçš„å†…å­˜æ•°æ®ç»“æ„å­˜å‚¨ï¼Œç”¨ä½œæ•°æ®åº“ã€ç¼“å­˜å’Œæ¶ˆæ¯ä»£ç†ã€‚å®ƒæ”¯æŒå¤šç§ç±»å‹çš„æ•°æ®ç»“æ„ï¼Œå¦‚å­—ç¬¦ä¸²ã€å“ˆå¸Œè¡¨ã€åˆ—è¡¨ã€é›†åˆã€æœ‰åºé›†åˆã€ä½å›¾ã€è¶…çº§æ—¥å¿—å’Œåœ°ç†ç©ºé—´ç´¢å¼•ç­‰ã€‚ä¸å…¶ä»–key-valueå­˜å‚¨ä¸åŒçš„æ˜¯ï¼ŒRedisæä¾›äº†æ›´ä¸ºå¤æ‚çš„æ•°æ®ç»“æ„å¹¶ä¸”æä¾›å¯¹ä»–ä»¬çš„åŸå­æ€§æ“ä½œ å…³ç³»å‹SQLå’ŒNoSQLå¯¹æ¯”å…³ç³»å‹SQLæ•°æ®åº“å’ŒNoSQLæ•°æ®åº“æ˜¯ä¸¤ç§ä¸åŒçš„æ•°æ®åº“ç±»å‹ï¼Œå®ƒä»¬åœ¨å¾ˆå¤šæ–¹é¢éƒ½æœ‰æ‰€ä¸åŒã€‚ä»¥">
<meta property="og:type" content="article">
<meta property="og:title" content="Redis">
<meta property="og:url" content="https://y-yiqi.github.io/posts/6a89.html">
<meta property="og:site_name" content="å¥•ä¸ƒ">
<meta property="og:description" content="Rediså…¥é—¨ç®€ä»‹Redisæ˜¯ä¸€ä¸ªå¼€æºçš„å†…å­˜æ•°æ®ç»“æ„å­˜å‚¨ï¼Œç”¨ä½œæ•°æ®åº“ã€ç¼“å­˜å’Œæ¶ˆæ¯ä»£ç†ã€‚å®ƒæ”¯æŒå¤šç§ç±»å‹çš„æ•°æ®ç»“æ„ï¼Œå¦‚å­—ç¬¦ä¸²ã€å“ˆå¸Œè¡¨ã€åˆ—è¡¨ã€é›†åˆã€æœ‰åºé›†åˆã€ä½å›¾ã€è¶…çº§æ—¥å¿—å’Œåœ°ç†ç©ºé—´ç´¢å¼•ç­‰ã€‚ä¸å…¶ä»–key-valueå­˜å‚¨ä¸åŒçš„æ˜¯ï¼ŒRedisæä¾›äº†æ›´ä¸ºå¤æ‚çš„æ•°æ®ç»“æ„å¹¶ä¸”æä¾›å¯¹ä»–ä»¬çš„åŸå­æ€§æ“ä½œ å…³ç³»å‹SQLå’ŒNoSQLå¯¹æ¯”å…³ç³»å‹SQLæ•°æ®åº“å’ŒNoSQLæ•°æ®åº“æ˜¯ä¸¤ç§ä¸åŒçš„æ•°æ®åº“ç±»å‹ï¼Œå®ƒä»¬åœ¨å¾ˆå¤šæ–¹é¢éƒ½æœ‰æ‰€ä¸åŒã€‚ä»¥">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://y-yiqi.github.io/img/default_cover.jpg">
<meta property="article:published_time" content="2020-02-23T09:09:13.000Z">
<meta property="article:modified_time" content="2023-05-21T11:45:42.334Z">
<meta property="article:author" content="å¥•ä¸ƒ">
<meta property="article:tag" content="Java">
<meta property="article:tag" content="Redis">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://y-yiqi.github.io/img/default_cover.jpg"><link rel="shortcut icon" href="/img/favicon.ico"><link rel="canonical" href="https://y-yiqi.github.io/posts/6a89"><link rel="preconnect" href="//npm.elemecdn.com"/><meta name="google-site-verification" content="xxx"/><meta name="baidu-site-verification" content="code-xxx"/><meta name="msvalidate.01" content="xxx"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://npm.elemecdn.com/node-snackbar@0.1.16/dist/snackbar.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  friends_vue_info: undefined,
  navMusic: true,
  algolia: undefined,
  localSearch: {"path":"/search.xml","preload":true,"languages":{"hits_empty":"æ‰¾ä¸åˆ°æ‚¨æŸ¥è¯¢çš„å†…å®¹ï¼š${query}"}},
  translate: {"defaultEncoding":2,"translateDelay":0,"msgToTraditionalChinese":"ç¹","msgToSimplifiedChinese":"ç®€","rightMenuMsgToTraditionalChinese":"è½¬ä¸ºç¹ä½“","rightMenuMsgToSimplifiedChinese":"è½¬ä¸ºç®€ä½“"},
  noticeOutdate: {"limitDay":365,"position":"top","messagePrev":"It has been","messageNext":"days since the last update, the content of the article may be outdated."},
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":330},
  copy: {
    success: 'å¤åˆ¶æˆåŠŸ',
    error: 'å¤åˆ¶é”™è¯¯',
    noSupport: 'æµè§ˆå™¨ä¸æ”¯æŒ'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: 'å¤©',
  date_suffix: {
    just: 'åˆšåˆš',
    min: 'åˆ†é’Ÿå‰',
    hour: 'å°æ—¶å‰',
    day: 'å¤©å‰',
    month: 'ä¸ªæœˆå‰'
  },
  copyright: undefined,
  lightbox: 'mediumZoom',
  Snackbar: {"chs_to_cht":"ä½ å·²åˆ‡æ¢ä¸ºç¹ä½“","cht_to_chs":"ä½ å·²åˆ‡æ¢ä¸ºç®€ä½“","day_to_night":"ä½ å·²åˆ‡æ¢ä¸ºæ·±è‰²æ¨¡å¼","night_to_day":"ä½ å·²åˆ‡æ¢ä¸ºæµ…è‰²æ¨¡å¼","bgLight":"#3b70fc","bgDark":"#1f1f1f","position":"top-center"},
  source: {
    justifiedGallery: {
      js: 'https://npm.elemecdn.com/flickr-justified-gallery@2.1.2/dist/fjGallery.min.js',
      css: 'https://npm.elemecdn.com/flickr-justified-gallery@2.1.2/dist/fjGallery.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: true,
  isAnchor: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'Redis',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2023-05-21 19:45:42'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
    win.getCSS = (url,id = false) => new Promise((resolve, reject) => {
      const link = document.createElement('link')
      link.rel = 'stylesheet'
      link.href = url
      if (id) link.id = id
      link.onerror = reject
      link.onload = link.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        link.onload = link.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(link)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#18171d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#f7f9fe')
        }
      }
      const t = saveToLocal.get('theme')
    
          const isDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches
          const isLightMode = window.matchMedia('(prefers-color-scheme: light)').matches
          const isNotSpecified = window.matchMedia('(prefers-color-scheme: no-preference)').matches
          const hasNoSupport = !isDarkMode && !isLightMode && !isNotSpecified

          if (t === undefined) {
            if (isLightMode) activateLightMode()
            else if (isDarkMode) activateDarkMode()
            else if (isNotSpecified || hasNoSupport) {
              const now = new Date()
              const hour = now.getHours()
              const isNight = hour <= 6 || hour >= 18
              isNight ? activateDarkMode() : activateLightMode()
            }
            window.matchMedia('(prefers-color-scheme: dark)').addListener(function (e) {
              if (saveToLocal.get('theme') === undefined) {
                e.matches ? activateDarkMode() : activateLightMode()
              }
            })
          } else if (t === 'light') activateLightMode()
          else activateDarkMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><svg aria-hidden="true" style="position:absolute; overflow:hidden; width:0; height:0"><symbol id="icon-sun" viewBox="0 0 1024 1024"><path d="M960 512l-128 128v192h-192l-128 128-128-128H192v-192l-128-128 128-128V192h192l128-128 128 128h192v192z" fill="#FFD878" p-id="8420"></path><path d="M736 512a224 224 0 1 0-448 0 224 224 0 1 0 448 0z" fill="#FFE4A9" p-id="8421"></path><path d="M512 109.248L626.752 224H800v173.248L914.752 512 800 626.752V800h-173.248L512 914.752 397.248 800H224v-173.248L109.248 512 224 397.248V224h173.248L512 109.248M512 64l-128 128H192v192l-128 128 128 128v192h192l128 128 128-128h192v-192l128-128-128-128V192h-192l-128-128z" fill="#4D5152" p-id="8422"></path><path d="M512 320c105.888 0 192 86.112 192 192s-86.112 192-192 192-192-86.112-192-192 86.112-192 192-192m0-32a224 224 0 1 0 0 448 224 224 0 0 0 0-448z" fill="#4D5152" p-id="8423"></path></symbol><symbol id="icon-moon" viewBox="0 0 1024 1024"><path d="M611.370667 167.082667a445.013333 445.013333 0 0 1-38.4 161.834666 477.824 477.824 0 0 1-244.736 244.394667 445.141333 445.141333 0 0 1-161.109334 38.058667 85.077333 85.077333 0 0 0-65.066666 135.722666A462.08 462.08 0 1 0 747.093333 102.058667a85.077333 85.077333 0 0 0-135.722666 65.024z" fill="#FFB531" p-id="11345"></path><path d="M329.728 274.133333l35.157333-35.157333a21.333333 21.333333 0 1 0-30.165333-30.165333l-35.157333 35.157333-35.114667-35.157333a21.333333 21.333333 0 0 0-30.165333 30.165333l35.114666 35.157333-35.114666 35.157334a21.333333 21.333333 0 1 0 30.165333 30.165333l35.114667-35.157333 35.157333 35.157333a21.333333 21.333333 0 1 0 30.165333-30.165333z" fill="#030835" p-id="11346"></path></symbol></svg><!-- hexo injector head_end start --><link rel="stylesheet" href="https://cdn.cbd.int/hexo-butterfly-wowjs/lib/animate.min.css" media="print" onload="this.media='screen'"><!-- hexo injector head_end end --><meta name="generator" content="Hexo 6.3.0"></head><body data-type="anzhiyu"><div id="web_bg"></div><div id="an_music_bg"></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header"><nav id="nav"><div id="nav-group"><span id="blog_name"><div class="back-home-button" tabindex="-1"><i class="anzhiyufont anzhiyu-icon-grip-vertical"></i><div class="back-menu-list-groups"><div class="back-menu-list-group"><div class="back-menu-list-title">ç½‘é¡µ</div><div class="back-menu-list"><a class="back-menu-item" href="https://anzhiy.cn/" title="åšå®¢" target="_blank"><img class="back-menu-item-icon" src="/img/favicon.ico" alt="åšå®¢"/><span class="back-menu-item-text">åšå®¢</span></a></div></div><div class="back-menu-list-group"><div class="back-menu-list-title">é¡¹ç›®</div><div class="back-menu-list"><a class="back-menu-item" href="https://image.anzhiy.cn/" title="å®‰çŸ¥é±¼å›¾åºŠ" target="_blank"><img class="back-menu-item-icon" src="https://image.anzhiy.cn/favicon.ico" alt="å®‰çŸ¥é±¼å›¾åºŠ"/><span class="back-menu-item-text">å®‰çŸ¥é±¼å›¾åºŠ</span></a></div></div></div></div><a id="site-name" href="/"><div class="title">å¥•ä¸ƒ</div><i class="anzhiyufont anzhiyu-icon-house-chimney"></i></a></span><div class="mask-name-container"><div id="name-container"><a id="page-name" href="javascript:anzhiyu.scrollToDest(0, 500)">PAGE_NAME</a></div></div><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page faa-parent animated-hover" href="javascript:void(0);"><span> æ–‡ç« </span></a><ul class="menus_item_child" style="left:-79px;"><li><a class="site-page child faa-parent animated-hover" href="/archives/"><i class="anzhiyufont anzhiyu-icon-box-archive faa-tada" style="font-size: 0.9em;"></i><span> éš§é“</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/categories/"><i class="anzhiyufont anzhiyu-icon-shapes faa-tada" style="font-size: 0.9em;"></i><span> åˆ†ç±»</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/tags/"><i class="anzhiyufont anzhiyu-icon-tags faa-tada" style="font-size: 0.9em;"></i><span> æ ‡ç­¾</span></a></li></ul></div><div class="menus_item"><a class="site-page faa-parent animated-hover" href="javascript:void(0);"><span> å‹é“¾</span></a><ul class="menus_item_child" style="left:-31px;"><li><a class="site-page child faa-parent animated-hover" href="/link/"><i class="anzhiyufont anzhiyu-icon-link faa-tada" style="font-size: 0.9em;"></i><span> å‹äººå¸</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/comments/"><i class="anzhiyufont anzhiyu-icon-envelope faa-tada" style="font-size: 0.9em;"></i><span> ç•™è¨€æ¿</span></a></li></ul></div><div class="menus_item"><a class="site-page faa-parent animated-hover" href="javascript:void(0);"><span> æˆ‘çš„</span></a><ul class="menus_item_child" style="left:-79px;"><li><a class="site-page child faa-parent animated-hover" href="/music/?id=7451835303&amp;server=tencent"><i class="anzhiyufont anzhiyu-icon-music faa-tada" style="font-size: 0.9em;"></i><span> éŸ³ä¹é¦†</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/album/"><i class="anzhiyufont anzhiyu-icon-images faa-tada" style="font-size: 0.9em;"></i><span> ç›¸å†Œé›†</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/air-conditioner/"><i class="anzhiyufont anzhiyu-icon-fan faa-tada" style="font-size: 0.9em;"></i><span> å°ç©ºè°ƒ</span></a></li></ul></div><div class="menus_item"><a class="site-page faa-parent animated-hover" href="javascript:void(0);"><span> å…³äº</span></a><ul class="menus_item_child" style="left:-79px;"><li><a class="site-page child faa-parent animated-hover" href="/about/"><i class="anzhiyufont anzhiyu-icon-paper-plane faa-tada" style="font-size: 0.9em;"></i><span> å…³äºæœ¬äºº</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/essay/"><i class="anzhiyufont anzhiyu-icon-lightbulb faa-tada" style="font-size: 0.9em;"></i><span> é—²è¨€ç¢è¯­</span></a></li><li><a class="site-page child faa-parent animated-hover" href="javascript:toRandomPost()"><i class="anzhiyufont anzhiyu-icon-shoe-prints1 faa-tada" style="font-size: 0.9em;"></i><span> éšä¾¿é€›é€›</span></a></li></ul></div></div></div><div id="nav-right"><div class="nav-button only-home" id="travellings_button" style="display: flex"><a class="site-page" onclick="anzhiyu.totraveling()" title="éšæœºå‰å¾€ä¸€ä¸ªå¼€å¾€é¡¹ç›®ç½‘ç«™" href="javascript:void(0);" rel="external nofollow" data-pjax-state="external"><i class="anzhiyufont anzhiyu-icon-train"></i></a></div><div class="nav-button" id="randomPost_button"><a class="site-page" onclick="toRandomPost()" title="éšæœºå‰å¾€ä¸€ä¸ªæ–‡ç« " href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-dice"></i></a></div><div class="nav-button" id="search-button"><a class="site-page social-icon search" href="javascript:void(0);" title="æœç´¢ğŸ”"><i class="anzhiyufont anzhiyu-icon-magnifying-glass"></i><span> æœç´¢</span></a></div><div class="nav-button" id="darkmode_navswitch"><a class="darkmode_switchbutton" type="button" href="javascript:void(0);" title="æµ…è‰²å’Œæ·±è‰²æ¨¡å¼è½¬æ¢" onclick="rm.switchDarkMode()"><i class="anzhiyufont anzhiyu-icon-circle-half-stroke" style="font-size: 1.3rem"></i></a></div><div class="nav-button" id="nav-totop"><a class="totopbtn" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-arrow-up"></i><span id="percent" onclick="anzhiyu.scrollToDest(0,500)">0</span></a></div><div id="toggle-menu"><a class="site-page" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-bars"></i></a></div></div></div></nav><div id="post-info"><div id="post-firstinfo"><div class="meta-firstline"><a class="post-meta-original">åŸåˆ›</a><span class="post-meta-categories"><span class="post-meta-separator"></span><i class="anzhiyufont anzhiyu-icon-inbox post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E5%90%8E%E7%AB%AF%E5%BC%80%E5%8F%91/">åç«¯å¼€å‘</a></span><span class="article-meta tags"><a class="article-meta__tags" href="/tags/Java/"> <span> <i class="anzhiyufont anzhiyu-icon-hashtag"></i>Java</span></a><a class="article-meta__tags" href="/tags/Redis/"> <span> <i class="anzhiyufont anzhiyu-icon-hashtag"></i>Redis</span></a></span></div></div><h1 class="post-title">Redis</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="anzhiyufont anzhiyu-icon-calendar-days post-meta-icon"></i><span class="post-meta-label">å‘è¡¨äº</span><time class="post-meta-date-created" datetime="2020-02-23T09:09:13.000Z" title="å‘è¡¨äº 2020-02-23 17:09:13">2020-02-23</time><span class="post-meta-separator"></span><i class="anzhiyufont anzhiyu-icon-history post-meta-icon"></i><span class="post-meta-label">æ›´æ–°äº</span><time class="post-meta-date-updated" datetime="2023-05-21T11:45:42.334Z" title="æ›´æ–°äº 2023-05-21 19:45:42">2023-05-21</time></span></div><div class="meta-secondline"><span class="post-meta-separator"></span><span class="post-meta-wordcount"><i class="anzhiyufont anzhiyu-icon-file-word post-meta-icon" title="æ–‡ç« å­—æ•°"></i><span class="post-meta-label" title="æ–‡ç« å­—æ•°">å­—æ•°æ€»è®¡:</span><span class="word-count" title="æ–‡ç« å­—æ•°">29.6k</span><span class="post-meta-separator"></span><i class="anzhiyufont anzhiyu-icon-clock post-meta-icon" title="é˜…è¯»æ—¶é•¿"></i><span class="post-meta-label" title="é˜…è¯»æ—¶é•¿">é˜…è¯»æ—¶é•¿:</span><span>109åˆ†é’Ÿ</span></span></div></div></div><section class="main-hero-waves-area waves-area"><svg class="waves-svg" xmlns="http://www.w3.org/2000/svg" xlink="http://www.w3.org/1999/xlink" viewBox="0 24 150 28" preserveAspectRatio="none" shape-rendering="auto"><defs><path id="gentle-wave" d="M -160 44 c 30 0 58 -18 88 -18 s 58 18 88 18 s 58 -18 88 -18 s 58 18 88 18 v 44 h -352 Z"></path></defs><g class="parallax"><use href="#gentle-wave" x="48" y="0"></use><use href="#gentle-wave" x="48" y="3"></use><use href="#gentle-wave" x="48" y="5"></use><use href="#gentle-wave" x="48" y="7"></use></g></svg></section><div id="post-top-cover"><img class="nolazyload" id="post-top-bg" src="/img/default_cover.jpg"></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h1 id="Rediså…¥é—¨"><a href="#Rediså…¥é—¨" class="headerlink" title="Rediså…¥é—¨"></a>Rediså…¥é—¨</h1><h2 id="ç®€ä»‹"><a href="#ç®€ä»‹" class="headerlink" title="ç®€ä»‹"></a>ç®€ä»‹</h2><p>Redisæ˜¯ä¸€ä¸ªå¼€æºçš„å†…å­˜æ•°æ®ç»“æ„å­˜å‚¨ï¼Œç”¨ä½œæ•°æ®åº“ã€ç¼“å­˜å’Œæ¶ˆæ¯ä»£ç†ã€‚å®ƒæ”¯æŒå¤šç§ç±»å‹çš„æ•°æ®ç»“æ„ï¼Œå¦‚å­—ç¬¦ä¸²ã€å“ˆå¸Œè¡¨ã€åˆ—è¡¨ã€é›†åˆã€æœ‰åºé›†åˆã€ä½å›¾ã€è¶…çº§æ—¥å¿—å’Œåœ°ç†ç©ºé—´ç´¢å¼•ç­‰ã€‚ä¸å…¶ä»–key-valueå­˜å‚¨ä¸åŒçš„æ˜¯ï¼ŒRedisæä¾›äº†æ›´ä¸ºå¤æ‚çš„æ•°æ®ç»“æ„å¹¶ä¸”æä¾›å¯¹ä»–ä»¬çš„åŸå­æ€§æ“ä½œ</p>
<h3 id="å…³ç³»å‹SQLå’ŒNoSQLå¯¹æ¯”"><a href="#å…³ç³»å‹SQLå’ŒNoSQLå¯¹æ¯”" class="headerlink" title="å…³ç³»å‹SQLå’ŒNoSQLå¯¹æ¯”"></a>å…³ç³»å‹SQLå’ŒNoSQLå¯¹æ¯”</h3><p>å…³ç³»å‹SQLæ•°æ®åº“å’ŒNoSQLæ•°æ®åº“æ˜¯ä¸¤ç§ä¸åŒçš„æ•°æ®åº“ç±»å‹ï¼Œå®ƒä»¬åœ¨å¾ˆå¤šæ–¹é¢éƒ½æœ‰æ‰€ä¸åŒã€‚ä»¥ä¸‹æ˜¯å®ƒä»¬çš„ä¸»è¦å¯¹æ¯”ï¼š</p>
<ol>
<li>æ•°æ®æ¨¡å‹<br>å…³ç³»å‹SQLæ•°æ®åº“ä½¿ç”¨è¡¨æ ¼æ¥å­˜å‚¨å’Œç»„ç»‡æ•°æ®ï¼Œæ•°æ®ä¹‹é—´çš„å…³ç³»é€šè¿‡å¤–é”®æ¥å»ºç«‹ã€‚è€ŒNoSQLæ•°æ®åº“åˆ™ä½¿ç”¨ä¸åŒçš„æ•°æ®æ¨¡å‹ï¼Œå¦‚æ–‡æ¡£å‹ã€é”®å€¼å‹ã€åˆ—æ—å‹ã€å›¾å½¢æ•°æ®åº“ç­‰ã€‚ </li>
<li>æ•°æ®åº“è®¾è®¡<br>å…³ç³»å‹SQLæ•°æ®åº“éœ€è¦åœ¨è®¾è®¡æ—¶é¢„å…ˆå®šä¹‰è¡¨æ ¼çš„ç»“æ„å’Œå…³ç³»ï¼Œè€ŒNoSQLæ•°æ®åº“åˆ™æ›´åŠ çµæ´»ï¼Œå¯ä»¥åœ¨å¼€å‘è¿‡ç¨‹ä¸­æ ¹æ®éœ€è¦åŠ¨æ€æ·»åŠ æ•°æ®ã€‚ </li>
<li>æ•°æ®ä¸€è‡´æ€§<br>å…³ç³»å‹SQLæ•°æ®åº“å¼ºè°ƒæ•°æ®ä¸€è‡´æ€§ï¼Œæ”¯æŒACIDäº‹åŠ¡ï¼Œä¿è¯æ•°æ®çš„å®Œæ•´æ€§å’Œä¸€è‡´æ€§ã€‚è€ŒNoSQLæ•°æ®åº“åˆ™æ›´åŠ æ³¨é‡æ•°æ®çš„å¯æ‰©å±•æ€§å’Œåˆ†å¸ƒå¼å­˜å‚¨ï¼Œåœ¨æ•°æ®ä¸€è‡´æ€§ä¸Šå¯èƒ½æœ‰æ‰€ç‰ºç‰²ã€‚ </li>
<li>è¯»å†™æ€§èƒ½<br>NoSQLæ•°æ®åº“åœ¨è¯»å†™æ€§èƒ½ä¸Šé€šå¸¸æ¯”å…³ç³»å‹SQLæ•°æ®åº“æ›´å¥½ï¼Œå› ä¸ºNoSQLæ•°æ®åº“å¯ä»¥æ°´å¹³æ‰©å±•ï¼Œæ”¯æŒåˆ†å¸ƒå¼å­˜å‚¨å’Œå¤„ç†ï¼Œè€Œå…³ç³»å‹SQLæ•°æ®åº“åˆ™æ›´é€‚åˆå¤„ç†å¤æ‚çš„æŸ¥è¯¢å’Œäº‹åŠ¡æ“ä½œã€‚ </li>
<li>æ•°æ®å¤„ç†æ–¹å¼<br>å…³ç³»å‹SQLæ•°æ®åº“é€šå¸¸ä½¿ç”¨ç»“æ„åŒ–æŸ¥è¯¢è¯­è¨€ï¼ˆSQLï¼‰æ¥å¤„ç†æ•°æ®ï¼Œè€ŒNoSQLæ•°æ®åº“åˆ™æ›´åŠ çµæ´»ï¼Œå¯ä»¥ä½¿ç”¨å„ç§ä¸åŒçš„æ•°æ®å¤„ç†æ–¹å¼å’Œç¼–ç¨‹è¯­è¨€ã€‚ </li>
<li>æ•°æ®å­˜å‚¨æ–¹å¼<br>å…³ç³»å‹SQLæ•°æ®åº“é€šå¸¸ä½¿ç”¨ç£ç›˜å­˜å‚¨ï¼Œè€ŒNoSQLæ•°æ®åº“åˆ™é€šå¸¸ä½¿ç”¨å†…å­˜å­˜å‚¨æˆ–è€…æ··åˆå­˜å‚¨ã€‚ </li>
<li>æ•°æ®å¤åˆ¶å’Œå¤‡ä»½<br>NoSQLæ•°æ®åº“é€šå¸¸å…·æœ‰æ›´å¥½çš„æ•°æ®å¤åˆ¶å’Œå¤‡ä»½åŠŸèƒ½ï¼Œå› ä¸ºå®ƒä»¬æ”¯æŒåˆ†å¸ƒå¼å­˜å‚¨å’Œå¤„ç†ï¼Œè€Œå…³ç³»å‹SQLæ•°æ®åº“åˆ™éœ€è¦æ›´å¤šçš„å¤æ‚æ€§å’Œèµ„æºæ¥å®ç°æ•°æ®å¤åˆ¶å’Œå¤‡ä»½ã€‚</li>
</ol>
<p>æ€»çš„æ¥è¯´ï¼Œå…³ç³»å‹SQLæ•°æ®åº“é€‚åˆå¤„ç†ç»“æ„åŒ–æ•°æ®å’Œéœ€è¦ä¿è¯æ•°æ®ä¸€è‡´æ€§çš„åœºæ™¯ï¼Œè€ŒNoSQLæ•°æ®åº“åˆ™é€‚åˆå¤„ç†å¤§é‡éç»“æ„åŒ–æˆ–åŠç»“æ„åŒ–æ•°æ®ï¼Œéœ€è¦é«˜å¯æ‰©å±•æ€§å’Œé«˜è¯»å†™æ€§èƒ½çš„åœºæ™¯ã€‚</p>
<h3 id="Redisç‰¹å¾"><a href="#Redisç‰¹å¾" class="headerlink" title="Redisç‰¹å¾"></a>Redisç‰¹å¾</h3><p>Redisæ˜¯ä¸€ç§å¼€æºçš„å†…å­˜æ•°æ®å­˜å‚¨ç³»ç»Ÿï¼Œå®ƒå…·æœ‰ä»¥ä¸‹å‡ ä¸ªç‰¹å¾ï¼š</p>
<ol>
<li>å†…å­˜å­˜å‚¨<br>Rediså°†æ‰€æœ‰æ•°æ®éƒ½å­˜å‚¨åœ¨å†…å­˜ä¸­ï¼Œè¿™ä½¿å¾—å®ƒå…·æœ‰æå¿«çš„è¯»å†™é€Ÿåº¦ã€‚åŒæ—¶ï¼ŒRedisä¹Ÿæ”¯æŒå°†æ•°æ®æŒä¹…åŒ–åˆ°ç£ç›˜ä¸­ï¼Œä»¥ä¿è¯æ•°æ®çš„å¯é æ€§ã€‚ </li>
<li>é”®å€¼å­˜å‚¨<br>Redisæ˜¯ä¸€ç§é”®å€¼å­˜å‚¨ç³»ç»Ÿï¼Œå®ƒæ”¯æŒå¤šç§æ•°æ®ç±»å‹ï¼Œå¦‚å­—ç¬¦ä¸²ã€åˆ—è¡¨ã€å“ˆå¸Œè¡¨ã€é›†åˆç­‰ã€‚ç”¨æˆ·å¯ä»¥æ ¹æ®éœ€è¦é€‰æ‹©åˆé€‚çš„æ•°æ®ç±»å‹å­˜å‚¨æ•°æ®ã€‚ </li>
<li>é«˜æ€§èƒ½<br>Rediså…·æœ‰éå¸¸é«˜çš„è¯»å†™æ€§èƒ½ï¼Œå®ƒå¯ä»¥å¤„ç†æ•°ä»¥ç™¾ä¸‡è®¡çš„æ“ä½œï¼Œæ¯ç§’é’Ÿå¯ä»¥å¤„ç†æ•°ç™¾ä¸‡ä¸ªé”®å€¼å¯¹çš„è¯»å†™æ“ä½œã€‚ </li>
<li>æ”¯æŒå¤šç§æ•°æ®ç»“æ„<br>Redisæ”¯æŒå¤šç§æ•°æ®ç»“æ„ï¼Œå¦‚å­—ç¬¦ä¸²ã€åˆ—è¡¨ã€å“ˆå¸Œè¡¨ã€é›†åˆã€æœ‰åºé›†åˆç­‰ã€‚è¿™äº›æ•°æ®ç»“æ„å¯ä»¥æ»¡è¶³ä¸åŒçš„æ•°æ®å¤„ç†éœ€æ±‚ï¼ŒåŒæ—¶ä¹Ÿå¯ä»¥æé«˜æ•°æ®å¤„ç†æ•ˆç‡ã€‚ </li>
<li>æ”¯æŒé«˜çº§æ•°æ®æ“ä½œ<br>Redisæä¾›äº†è®¸å¤šé«˜çº§æ•°æ®æ“ä½œï¼Œå¦‚äº‹åŠ¡ã€å‘å¸ƒ&#x2F;è®¢é˜…ã€Luaè„šæœ¬ã€è‡ªåŠ¨è¿‡æœŸç­‰ã€‚è¿™äº›åŠŸèƒ½å¯ä»¥å¸®åŠ©ç”¨æˆ·æ›´æ–¹ä¾¿åœ°è¿›è¡Œæ•°æ®å¤„ç†å’Œç®¡ç†ã€‚ </li>
<li>å¯æ‰©å±•æ€§<br>Rediså…·æœ‰è‰¯å¥½çš„å¯æ‰©å±•æ€§ï¼Œå®ƒæ”¯æŒåˆ†å¸ƒå¼å­˜å‚¨å’Œé›†ç¾¤æ¨¡å¼ï¼Œç”¨æˆ·å¯ä»¥æ ¹æ®éœ€è¦å°†æ•°æ®åˆ†å¸ƒåˆ°å¤šä¸ªèŠ‚ç‚¹ä¸Šï¼Œä»¥å®ç°æ›´é«˜çš„æ€§èƒ½å’Œå¯é æ€§ã€‚ </li>
<li>ç®€å•æ˜“ç”¨<br>Redisçš„å‘½ä»¤å’ŒAPIéå¸¸ç®€å•æ˜“ç”¨ï¼Œç”¨æˆ·å¯ä»¥è½»æ¾åœ°å­¦ä¹ å’Œä½¿ç”¨Redisã€‚åŒæ—¶ï¼ŒRedisè¿˜æä¾›äº†ä¸°å¯Œçš„å®¢æˆ·ç«¯åº“å’Œå·¥å…·ï¼Œå¯ä»¥æ–¹ä¾¿åœ°é›†æˆåˆ°å„ç§åº”ç”¨ä¸­ã€‚</li>
</ol>
<p>æ€»çš„æ¥è¯´ï¼ŒRediså…·æœ‰é«˜æ€§èƒ½ã€çµæ´»æ€§ã€å¯æ‰©å±•æ€§å’Œç®€å•æ˜“ç”¨ç­‰ç‰¹ç‚¹ï¼Œé€‚ç”¨äºå¤šç§åœºæ™¯ï¼Œå¦‚ç¼“å­˜ã€æ¶ˆæ¯é˜Ÿåˆ—ã€è®¡æ•°å™¨ã€æ’è¡Œæ¦œç­‰ã€‚</p>
<h1 id="åŸºæœ¬æ•°æ®ç±»å‹"><a href="#åŸºæœ¬æ•°æ®ç±»å‹" class="headerlink" title="åŸºæœ¬æ•°æ®ç±»å‹"></a>åŸºæœ¬æ•°æ®ç±»å‹</h1><h2 id="ç®€ä»‹-1"><a href="#ç®€ä»‹-1" class="headerlink" title="ç®€ä»‹"></a>ç®€ä»‹</h2><p>Redis æ˜¯ä¸€ç§åŸºäºå†…å­˜çš„æ•°æ®å­˜å‚¨ç³»ç»Ÿï¼Œå®ƒæ”¯æŒå¤šç§æ•°æ®ç±»å‹çš„å­˜å‚¨å’Œæ“ä½œã€‚ä»¥ä¸‹æ˜¯ Redis çš„åŸºæœ¬æ•°æ®ç±»å‹ï¼š</p>
<ol>
<li>String ç±»å‹ï¼šå­—ç¬¦ä¸²ç±»å‹æ˜¯ Redis ä¸­æœ€åŸºæœ¬çš„æ•°æ®ç±»å‹ï¼Œå¯ä»¥å­˜å‚¨ä»»æ„ç±»å‹çš„å­—ç¬¦ä¸²ï¼ŒåŒ…æ‹¬æ•°å­—ã€æµ®ç‚¹æ•°ã€äºŒè¿›åˆ¶æ•°æ®ç­‰ã€‚ </li>
<li>Hash ç±»å‹ï¼šå“ˆå¸Œç±»å‹ç”¨äºå­˜å‚¨é”®å€¼å¯¹ï¼Œå…¶ä¸­é”®å’Œå€¼éƒ½æ˜¯å­—ç¬¦ä¸²ç±»å‹ã€‚å“ˆå¸Œç±»å‹é€‚ç”¨äºå­˜å‚¨å¯¹è±¡ç±»å‹çš„æ•°æ®ï¼Œå¦‚å­˜å‚¨ç”¨æˆ·ä¿¡æ¯ç­‰ã€‚ </li>
<li>List ç±»å‹ï¼šåˆ—è¡¨ç±»å‹ç”¨äºå­˜å‚¨ä¸€ä¸ªæœ‰åºçš„å­—ç¬¦ä¸²åˆ—è¡¨ï¼Œå…¶ä¸­æ¯ä¸ªå…ƒç´ éƒ½å¯ä»¥æ˜¯å­—ç¬¦ä¸²ç±»å‹ã€‚åˆ—è¡¨ç±»å‹é€‚ç”¨äºå­˜å‚¨æœ‰åºçš„æ•°æ®é›†åˆï¼Œå¦‚å­˜å‚¨æ—¥å¿—æ•°æ®ç­‰ã€‚ </li>
<li>Set ç±»å‹ï¼šé›†åˆç±»å‹ç”¨äºå­˜å‚¨ä¸€ä¸ª<strong>æ— åº</strong>çš„å­—ç¬¦ä¸²é›†åˆï¼Œå…¶ä¸­æ¯ä¸ªå…ƒç´ éƒ½æ˜¯å”¯ä¸€çš„å­—ç¬¦ä¸²ç±»å‹ã€‚é›†åˆç±»å‹é€‚ç”¨äºå­˜å‚¨æ— åºçš„æ•°æ®é›†åˆï¼Œå¦‚å­˜å‚¨ç”¨æˆ·æ ‡ç­¾ç­‰ã€‚ </li>
<li>Sorted Set ç±»å‹ï¼šæœ‰åºé›†åˆç±»å‹ç”¨äºå­˜å‚¨ä¸€ä¸ª<strong>æœ‰åº</strong>çš„å­—ç¬¦ä¸²é›†åˆï¼Œå…¶ä¸­æ¯ä¸ªå…ƒç´ éƒ½æœ‰ä¸€ä¸ªåˆ†æ•°å€¼ï¼Œæ ¹æ®åˆ†æ•°å€¼è¿›è¡Œæ’åºã€‚æœ‰åºé›†åˆç±»å‹é€‚ç”¨äºå­˜å‚¨æŒ‰ç…§åˆ†æ•°æ’åºçš„æ•°æ®é›†åˆï¼Œå¦‚å­˜å‚¨æ’è¡Œæ¦œç­‰ã€‚</li>
</ol>
<p>é™¤äº†ä¸Šè¿°åŸºæœ¬æ•°æ®ç±»å‹ï¼ŒRedis è¿˜æä¾›äº†ä¸€äº›é«˜çº§æ•°æ®ç»“æ„ï¼Œå¦‚ Bitmapã€HyperLogLogã€GeoHash ç­‰ï¼Œç”¨äºæ”¯æŒæ›´å¤æ‚çš„æ•°æ®å­˜å‚¨å’Œæ“ä½œéœ€æ±‚ã€‚</p>
<p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼ŒRedis æ˜¯ä¸€ç§åŸºäºå†…å­˜çš„æ•°æ®å­˜å‚¨ç³»ç»Ÿï¼Œå› æ­¤åœ¨å­˜å‚¨å¤§é‡æ•°æ®æ—¶éœ€è¦æ³¨æ„å†…å­˜ä½¿ç”¨æƒ…å†µï¼Œé¿å…å› ä¸ºå†…å­˜ä¸è¶³è€Œå¯¼è‡´ç³»ç»Ÿå´©æºƒã€‚åŒæ—¶ï¼Œä¸ºäº†ä¿è¯æ•°æ®çš„å¯é æ€§ï¼Œéœ€è¦å®šæœŸå¯¹æ•°æ®è¿›è¡Œå¤‡ä»½å’Œæ¢å¤æ“ä½œã€‚</p>
<h2 id="String"><a href="#String" class="headerlink" title="String"></a>String</h2><p>ä»¥ä¸‹æ˜¯ä¸€äº›å¸¸ç”¨çš„ String ç±»å‹çš„å‘½ä»¤ï¼š</p>
<ol>
<li>SET key valueï¼šè®¾ç½® key çš„å€¼ä¸º valueã€‚</li>
<li>GET keyï¼šè·å– key çš„å€¼ã€‚</li>
<li>INCR keyï¼šå°† key çš„å€¼å¢åŠ  1ã€‚</li>
<li>DECR keyï¼šå°† key çš„å€¼å‡å°‘ 1ã€‚</li>
<li>APPEND key valueï¼šå°† value è¿½åŠ åˆ° key çš„å€¼æœ«å°¾ã€‚</li>
<li>STRLEN keyï¼šè·å– key çš„å€¼çš„é•¿åº¦ã€‚</li>
<li>MSET key1 value1 key2 value2 â€¦ï¼šåŒæ—¶è®¾ç½®å¤šä¸ª key çš„å€¼ã€‚</li>
<li>MGET key1 key2 â€¦ï¼šåŒæ—¶è·å–å¤šä¸ª key çš„å€¼ã€‚</li>
<li>SETEX key seconds valueï¼šè®¾ç½® key çš„å€¼ä¸º valueï¼Œå¹¶ä¸”è®¾ç½® key çš„è¿‡æœŸæ—¶é—´ä¸º seconds ç§’ã€‚</li>
<li>GETSET key valueï¼šå°† key çš„å€¼è®¾ç½®ä¸º valueï¼Œå¹¶è¿”å› key åŸæ¥çš„å€¼ã€‚</li>
</ol>
<h2 id="Hash"><a href="#Hash" class="headerlink" title="Hash"></a>Hash</h2><p>Hash æ˜¯ Redis çš„ä¸€ç§åŸºæœ¬æ•°æ®ç±»å‹ï¼Œç”¨äºå­˜å‚¨é”®å€¼å¯¹ï¼Œå…¶ä¸­é”®å’Œå€¼éƒ½æ˜¯å­—ç¬¦ä¸²ç±»å‹ã€‚ä»¥ä¸‹æ˜¯ä¸€äº›å¸¸ç”¨çš„ Hash å‘½ä»¤ï¼š</p>
<ol>
<li>HSET key field valueï¼šè®¾ç½® key ä¸­æŒ‡å®š field çš„å€¼ä¸º valueã€‚ </li>
<li>HGET key fieldï¼šè·å– key ä¸­æŒ‡å®š field çš„å€¼ã€‚ </li>
<li>HMSET key field1 value1 field2 value2 â€¦ï¼šåŒæ—¶è®¾ç½® key ä¸­å¤šä¸ª field çš„å€¼ã€‚ </li>
<li>HMGET key field1 field2 â€¦ï¼šåŒæ—¶è·å– key ä¸­å¤šä¸ª field çš„å€¼ã€‚ </li>
<li>HLEN keyï¼šè·å– key ä¸­ field çš„æ•°é‡ã€‚ </li>
<li>HDEL key field1 field2 â€¦ï¼šåˆ é™¤ key ä¸­æŒ‡å®šçš„ fieldã€‚ </li>
<li>HEXISTS key fieldï¼šåˆ¤æ–­ key ä¸­æ˜¯å¦å­˜åœ¨æŒ‡å®šçš„ fieldã€‚ </li>
<li>HKEYS keyï¼šè·å– key ä¸­æ‰€æœ‰çš„ fieldã€‚ </li>
<li>HVALS keyï¼šè·å– key ä¸­æ‰€æœ‰çš„ valueã€‚ </li>
<li>HINCRBY key field incrementï¼šå°† key ä¸­æŒ‡å®šçš„ field çš„å€¼å¢åŠ  incrementã€‚</li>
</ol>
<h2 id="List"><a href="#List" class="headerlink" title="List"></a>List</h2><p>List æ˜¯ Redis çš„ä¸€ç§åŸºæœ¬æ•°æ®ç±»å‹ï¼Œç”¨äºå­˜å‚¨ä¸€ä¸ªæœ‰åºçš„å­—ç¬¦ä¸²åˆ—è¡¨ï¼Œå…¶ä¸­æ¯ä¸ªå…ƒç´ éƒ½å¯ä»¥æ˜¯å­—ç¬¦ä¸²ç±»å‹ã€‚ä»¥ä¸‹æ˜¯ä¸€äº›å¸¸ç”¨çš„ List å‘½ä»¤ï¼š</p>
<ol>
<li>LPUSH key value1 value2 â€¦ï¼šå°†ä¸€ä¸ªæˆ–å¤šä¸ªå€¼æ’å…¥åˆ° key çš„å¤´éƒ¨ã€‚ </li>
<li>RPUSH key value1 value2 â€¦ï¼šå°†ä¸€ä¸ªæˆ–å¤šä¸ªå€¼æ’å…¥åˆ° key çš„å°¾éƒ¨ã€‚ </li>
<li>LPOP keyï¼šç§»é™¤å¹¶è¿”å› key çš„å¤´éƒ¨å…ƒç´ ã€‚ </li>
<li>RPOP keyï¼šç§»é™¤å¹¶è¿”å› key çš„å°¾éƒ¨å…ƒç´ ã€‚ </li>
<li>LINDEX key indexï¼šè·å– key ä¸­æŒ‡å®šç´¢å¼•ä½ç½®çš„å…ƒç´ ã€‚ </li>
<li>LLEN keyï¼šè·å– key ä¸­å…ƒç´ çš„æ•°é‡ã€‚ </li>
<li>LRANGE key start stopï¼šè·å– key ä¸­æŒ‡å®šèŒƒå›´å†…çš„å…ƒç´ ã€‚ </li>
<li>LREM key count valueï¼šä» key ä¸­ç§»é™¤æŒ‡å®šæ•°é‡çš„å…ƒç´ ã€‚ </li>
<li>LSET key index valueï¼šå°† key ä¸­æŒ‡å®šç´¢å¼•ä½ç½®çš„å…ƒç´ è®¾ç½®ä¸º valueã€‚ </li>
<li>LTRIM key start stopï¼šæˆªå– key ä¸­æŒ‡å®šèŒƒå›´å†…çš„å…ƒç´ ã€‚</li>
</ol>
<h2 id="Set"><a href="#Set" class="headerlink" title="Set"></a>Set</h2><p>Set æ˜¯ Redis çš„ä¸€ç§åŸºæœ¬æ•°æ®ç±»å‹ï¼Œç”¨äºå­˜å‚¨ä¸€ä¸ª<strong>æ— åº</strong>çš„ã€<strong>ä¸é‡å¤</strong>çš„å­—ç¬¦ä¸²é›†åˆã€‚ä»¥ä¸‹æ˜¯ä¸€äº›å¸¸ç”¨çš„ Set å‘½ä»¤ï¼š</p>
<ol>
<li>SADD key member1 member2 â€¦ï¼šå‘ key ä¸­æ·»åŠ ä¸€ä¸ªæˆ–å¤šä¸ª member å…ƒç´ ï¼Œå¦‚æœ member å·²ç»å­˜åœ¨äºé›†åˆä¸­ï¼Œåˆ™ä¸è¿›è¡Œä»»ä½•æ“ä½œã€‚ </li>
<li>SREM key member1 member2 â€¦ï¼šä» key ä¸­ç§»é™¤ä¸€ä¸ªæˆ–å¤šä¸ª member å…ƒç´ ã€‚ </li>
<li>SMEMBERS keyï¼šè¿”å› key ä¸­æ‰€æœ‰çš„å…ƒç´ ã€‚ </li>
<li>SISMEMBER key memberï¼šåˆ¤æ–­ member æ˜¯å¦å­˜åœ¨äº key ä¸­ã€‚ </li>
<li>SCARD keyï¼šè¿”å› key ä¸­å…ƒç´ çš„æ•°é‡ã€‚ </li>
<li>SPOP keyï¼šéšæœºç§»é™¤å¹¶è¿”å› key ä¸­çš„ä¸€ä¸ªå…ƒç´ ã€‚ </li>
<li>SRANDMEMBER key [count]ï¼šéšæœºè¿”å› key ä¸­çš„ä¸€ä¸ªæˆ–å¤šä¸ªå…ƒç´ ï¼Œå¦‚æœ count å‚æ•°ä¸ºæ­£æ•°ï¼Œåˆ™è¿”å›çš„å…ƒç´ ä¸é‡å¤ï¼Œå¦‚æœä¸ºè´Ÿæ•°ï¼Œåˆ™è¿”å›çš„å…ƒç´ å¯èƒ½é‡å¤ã€‚ </li>
<li>SINTER key1 key2 â€¦ï¼šè¿”å›å¤šä¸ªé›†åˆçš„<strong>äº¤é›†</strong>ã€‚ </li>
<li>SUNION key1 key2 â€¦ï¼šè¿”å›å¤šä¸ªé›†åˆçš„<strong>å¹¶é›†</strong>ã€‚ </li>
<li>SDIFF key1 key2 â€¦ï¼šè¿”å›å¤šä¸ªé›†åˆçš„<strong>å·®é›†</strong>ã€‚</li>
</ol>
<p>è¿™äº›å‘½ä»¤å¯ä»¥ç”¨äºå¯¹ Redis ä¸­çš„ Set ç±»å‹æ•°æ®è¿›è¡ŒåŸºæœ¬çš„å­˜å‚¨å’Œæ“ä½œã€‚é™¤äº†è¿™äº›åŸºæœ¬å‘½ä»¤ï¼ŒRedis è¿˜æä¾›äº†ä¸€äº›é«˜çº§çš„ Set å‘½ä»¤ï¼Œå¦‚ SINTERSTOREã€SUNIONSTOREã€SDIFFSTORE ç­‰ï¼Œå¯ä»¥æ ¹æ®å…·ä½“çš„éœ€æ±‚é€‰æ‹©åˆé€‚çš„å‘½ä»¤è¿›è¡Œæ“ä½œã€‚</p>
<p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼ŒSet ç±»å‹æ˜¯ä¸€ä¸ªæ— åºçš„æ•°æ®ç»“æ„ï¼Œå¯ä»¥æ”¯æŒå¿«é€Ÿçš„æ’å…¥ã€åˆ é™¤å’Œåˆ¤æ–­å…ƒç´ æ˜¯å¦å­˜åœ¨çš„æ“ä½œï¼Œä½†æ˜¯åœ¨è·å–æ‰€æœ‰å…ƒç´ æ—¶éœ€è¦è¿›è¡Œæ‰«æï¼Œæ•ˆç‡è¾ƒä½ã€‚æ­¤å¤–ï¼Œå½“ Set ç±»å‹çš„é”®ä¸­å­˜å‚¨çš„å…ƒç´ æ•°é‡è¾ƒå¤šæ—¶ï¼Œä¼šå½±å“ Redis çš„æ€§èƒ½å’Œå†…å­˜ä½¿ç”¨æƒ…å†µã€‚å› æ­¤ï¼Œåœ¨ä½¿ç”¨ Set ç±»å‹æ—¶ï¼Œåº”è¯¥æ ¹æ®å…·ä½“çš„éœ€æ±‚é€‰æ‹©åˆé€‚çš„å‘½ä»¤è¿›è¡Œæ“ä½œï¼Œä»¥åŠé¿å…åœ¨ Set ç±»å‹çš„é”®ä¸­å­˜å‚¨è¿‡å¤šçš„å…ƒç´ ã€‚</p>
<h2 id="Sorted-Set"><a href="#Sorted-Set" class="headerlink" title="Sorted Set"></a>Sorted Set</h2><p>Sorted Set æ˜¯ Redis çš„ä¸€ç§åŸºæœ¬æ•°æ®ç±»å‹ï¼Œç”¨äºå­˜å‚¨ä¸€ä¸ªæœ‰åºçš„ã€ä¸é‡å¤çš„å­—ç¬¦ä¸²é›†åˆï¼Œå…¶ä¸­æ¯ä¸ªå…ƒç´ éƒ½æœ‰ä¸€ä¸ªå¯¹åº”çš„åˆ†æ•°ï¼Œå¯ä»¥æ ¹æ®åˆ†æ•°çš„å¤§å°è¿›è¡Œæ’åºã€‚ä»¥ä¸‹æ˜¯ä¸€äº›å¸¸ç”¨çš„ Sorted Set å‘½ä»¤ï¼š</p>
<ol>
<li>ZADD key score1 member1 score2 member2 â€¦ï¼šå‘ key ä¸­æ·»åŠ ä¸€ä¸ªæˆ–å¤šä¸ª member å…ƒç´ ï¼Œæ¯ä¸ªå…ƒç´ éƒ½æœ‰ä¸€ä¸ªå¯¹åº”çš„åˆ†æ•° <strong>score</strong>ã€‚ </li>
<li>ZREM key member1 member2 â€¦ï¼šä» key ä¸­ç§»é™¤ä¸€ä¸ªæˆ–å¤šä¸ª member å…ƒç´ ã€‚ </li>
<li>ZRANGE key start stop [WITHSCORES]ï¼šè¿”å› key ä¸­æŒ‡å®šèŒƒå›´å†…çš„å…ƒç´ ï¼ŒæŒ‰ç…§åˆ†æ•°ä»å°åˆ°å¤§æ’åºï¼Œå¦‚æœæŒ‡å®šäº† WITHSCORES å‚æ•°ï¼Œåˆ™åŒæ—¶è¿”å›å…ƒç´ çš„åˆ†æ•°ã€‚ </li>
<li>ZREVRANGE key start stop [WITHSCORES]ï¼šè¿”å› key ä¸­æŒ‡å®šèŒƒå›´å†…çš„å…ƒç´ ï¼ŒæŒ‰ç…§åˆ†æ•°ä»å¤§åˆ°å°æ’åºï¼Œå¦‚æœæŒ‡å®šäº† WITHSCORES å‚æ•°ï¼Œåˆ™åŒæ—¶è¿”å›å…ƒç´ çš„åˆ†æ•°ã€‚ </li>
<li>ZSCORE key memberï¼šè¿”å› member åœ¨ key ä¸­çš„åˆ†æ•°ã€‚ </li>
<li>ZCARD keyï¼šè¿”å› key ä¸­å…ƒç´ çš„æ•°é‡ã€‚ </li>
<li>ZCOUNT key min maxï¼šè¿”å› key ä¸­åˆ†æ•°åœ¨æŒ‡å®šèŒƒå›´å†…çš„å…ƒç´ æ•°é‡ã€‚ </li>
<li>ZRANK key memberï¼šè¿”å› member åœ¨ key ä¸­æŒ‰ç…§åˆ†æ•°æ’åºåçš„æ’åï¼Œæ’åä» 0 å¼€å§‹ã€‚ </li>
<li>ZREVRANK key memberï¼šè¿”å› member åœ¨ key ä¸­æŒ‰ç…§åˆ†æ•°æ’åºåçš„å€’åºæ’åï¼Œæ’åä» 0 å¼€å§‹ã€‚ </li>
<li>ZINCRBY key increment memberï¼šå°† member åœ¨ key ä¸­çš„åˆ†æ•°å¢åŠ  incrementã€‚</li>
</ol>
<p>è¿™äº›å‘½ä»¤å¯ä»¥ç”¨äºå¯¹ Redis ä¸­çš„ Sorted Set ç±»å‹æ•°æ®è¿›è¡ŒåŸºæœ¬çš„å­˜å‚¨å’Œæ“ä½œã€‚é™¤äº†è¿™äº›åŸºæœ¬å‘½ä»¤ï¼ŒRedis è¿˜æä¾›äº†ä¸€äº›é«˜çº§çš„ Sorted Set å‘½ä»¤ï¼Œå¦‚ ZINTERSTOREã€ZUNIONSTOREã€ZREMRANGEBYRANKã€ZREMRANGEBYSCORE ç­‰ï¼Œå¯ä»¥æ ¹æ®å…·ä½“çš„éœ€æ±‚é€‰æ‹©åˆé€‚çš„å‘½ä»¤è¿›è¡Œæ“ä½œã€‚<br>éœ€è¦æ³¨æ„çš„æ˜¯ï¼ŒSorted Set ç±»å‹æ˜¯ä¸€ä¸ªæœ‰åºçš„æ•°æ®ç»“æ„ï¼Œå¯ä»¥æ”¯æŒæ ¹æ®åˆ†æ•°è¿›è¡ŒèŒƒå›´æŸ¥æ‰¾ã€æ’åºå’Œè®¡ç®—æ’åç­‰æ“ä½œï¼Œä½†æ˜¯åœ¨è·å–æ‰€æœ‰å…ƒç´ æ—¶éœ€è¦è¿›è¡Œæ‰«æï¼Œæ•ˆç‡è¾ƒä½ã€‚æ­¤å¤–ï¼Œå½“ Sorted Set ç±»å‹çš„é”®ä¸­å­˜å‚¨çš„å…ƒç´ æ•°é‡è¾ƒå¤šæ—¶ï¼Œä¼šå½±å“ Redis çš„æ€§èƒ½å’Œå†…å­˜ä½¿ç”¨æƒ…å†µã€‚å› æ­¤ï¼Œåœ¨ä½¿ç”¨ Sorted Set ç±»å‹æ—¶ï¼Œåº”è¯¥æ ¹æ®å…·ä½“çš„éœ€æ±‚é€‰æ‹©åˆé€‚çš„å‘½ä»¤è¿›è¡Œæ“ä½œï¼Œä»¥åŠé¿å…åœ¨ Sorted Set ç±»å‹çš„é”®ä¸­å­˜å‚¨è¿‡å¤šçš„å…ƒç´ ã€‚</p>
<h1 id="å…±äº«Sessionï¼ˆå•ç‚¹ç™»å½•ï¼‰"><a href="#å…±äº«Sessionï¼ˆå•ç‚¹ç™»å½•ï¼‰" class="headerlink" title="å…±äº«Sessionï¼ˆå•ç‚¹ç™»å½•ï¼‰"></a>å…±äº«Sessionï¼ˆå•ç‚¹ç™»å½•ï¼‰</h1><h2 id="ä»‹ç»"><a href="#ä»‹ç»" class="headerlink" title="ä»‹ç»"></a>ä»‹ç»</h2><p>å…±äº«sessionæ˜¯æŒ‡åœ¨å¤šå°æœåŠ¡å™¨ä¹‹é—´å…±äº«sessionæ•°æ®ã€‚è¿™æ ·åšçš„ç›®çš„æ˜¯ä¸ºäº†æ”¯æŒ<code>è´Ÿè½½å‡è¡¡</code>ï¼Œå³å½“å¤šå°æœåŠ¡å™¨ä½¿ç”¨åŒä¸€å¥—ç½‘ç«™ä»£ç æ—¶ï¼Œç”¨æˆ·è¯·æ±‚è¢«åˆ†å‘åˆ°ä¸åŒçš„æœåŠ¡å™¨ä¸Šã€‚è¿™ç§æƒ…å†µä¸‹ï¼Œç”¨æˆ·ç¬¬ä¸€æ¬¡è¯·æ±‚æ—¶ï¼Œåœ¨ä¸€å°æœåŠ¡å™¨ä¸Šç”Ÿæˆäº†sessionidï¼Œä½†åœ¨å…¶ä»–æœåŠ¡å™¨ä¸Šä¹Ÿéœ€è¦è®¿é—®è¯¥sessionæ•°æ®ã€‚<br>ä¾‹å¦‚ï¼Œå¦‚æœä¸€ä¸ªç”¨æˆ·åœ¨ç½‘ç«™ä¸Šç™»å½•äº†ï¼Œä»–çš„ç™»å½•ä¿¡æ¯ä¼šè¢«å­˜å‚¨åœ¨sessionä¸­ã€‚å¦‚æœè¯¥ç”¨æˆ·çš„ä¸‹ä¸€ä¸ªè¯·æ±‚è¢«åˆ†å‘åˆ°å¦ä¸€å°æœåŠ¡å™¨ä¸Šï¼Œé‚£ä¹ˆè¿™å°æœåŠ¡å™¨ä¹Ÿéœ€è¦è®¿é—®è¯¥ç”¨æˆ·çš„ç™»å½•ä¿¡æ¯ã€‚å› æ­¤ï¼Œéœ€è¦åœ¨å¤šå°æœåŠ¡å™¨ä¹‹é—´å…±äº«sessionæ•°æ®ã€‚<br><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.nlark.com/yuque/0/2023/png/32620241/1679480448867-eddb1974-7a41-4a0b-8887-ca8c9ef8587a.png#averageHue=%23f6f4f4&clientId=ua6475701-a0dd-4&from=paste&height=503&id=u6872694b&name=image.png&originHeight=754&originWidth=1723&originalType=binary&ratio=1.5&rotation=0&showTitle=false&size=346019&status=done&style=none&taskId=u695756d8-dc4d-40ac-aabd-ba629eb843a&title=&width=1148.6666666666667#averageHue=%23f6f4f4&id=jXvcH&originHeight=754&originWidth=1723&originalType=binary&ratio=1&rotation=0&showTitle=false&status=done&style=none&title=" alt="image.png"></p>
<h2 id="å®ç°"><a href="#å®ç°" class="headerlink" title="å®ç°"></a>å®ç°</h2><h3 id="è®¾è®¡key"><a href="#è®¾è®¡key" class="headerlink" title="è®¾è®¡key"></a>è®¾è®¡key</h3><p>éšæœºç”Ÿæˆtoken</p>
<h3 id="é€‰å–æ•°æ®ç»“æ„"><a href="#é€‰å–æ•°æ®ç»“æ„" class="headerlink" title="é€‰å–æ•°æ®ç»“æ„"></a>é€‰å–æ•°æ®ç»“æ„</h3><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.nlark.com/yuque/0/2023/png/32620241/1679480882862-adcc8755-03ce-46cd-a9bf-8f126905780f.png#averageHue=%23f2e9e5&clientId=ua6475701-a0dd-4&from=paste&height=443&id=u9db5000e&name=image.png&originHeight=664&originWidth=1019&originalType=binary&ratio=1.5&rotation=0&showTitle=false&size=192073&status=done&style=none&taskId=u6f68a962-b81c-4d36-b4d6-bb75f184333&title=&width=679.3333333333334#averageHue=%23f2e9e5&id=mJ8qb&originHeight=664&originWidth=1019&originalType=binary&ratio=1&rotation=0&showTitle=false&status=done&style=none&title=" alt="image.png"><br>ä¸¤ç§æ–¹æ¡ˆï¼š</p>
<ol>
<li>å…ˆåœ¨ç¨‹åºä¸­å°†å¯¹è±¡è¿›è¡ŒJSONåºåˆ—åŒ–ï¼Œåœ¨ä»¥stringç±»å‹å†™å…¥</li>
<li>ç›´æ¥ä»¥hashæ•°æ®ç»“æ„å†™å…¥ğŸ”¥</li>
</ol>
<h3 id="å…·ä½“æµç¨‹ï¼ˆé‡‡ç”¨stringï¼‰"><a href="#å…·ä½“æµç¨‹ï¼ˆé‡‡ç”¨stringï¼‰" class="headerlink" title="å…·ä½“æµç¨‹ï¼ˆé‡‡ç”¨stringï¼‰"></a>å…·ä½“æµç¨‹ï¼ˆé‡‡ç”¨stringï¼‰</h3><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.nlark.com/yuque/0/2023/png/32620241/1679481109556-9e7134c4-75be-4564-ba6b-e39c40b1864e.png#averageHue=%23f0ecec&clientId=ua6475701-a0dd-4&from=paste&height=603&id=u40a8c449&name=image.png&originHeight=904&originWidth=1726&originalType=binary&ratio=1.5&rotation=0&showTitle=false&size=451855&status=done&style=none&taskId=u003b9837-6127-4427-8491-f8a810e15d1&title=&width=1150.6666666666667#averageHue=%23f0ecec&id=K6VMK&originHeight=904&originWidth=1726&originalType=binary&ratio=1&rotation=0&showTitle=false&status=done&style=none&title=" alt="image.png"></p>
<ul>
<li>å­˜å‚¨session<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="type">String</span> <span class="variable">token</span> <span class="operator">=</span> UUID.randomUUID().toString(<span class="literal">true</span>);</span><br><span class="line"><span class="comment">// å°†Userå¯¹è±¡è½¬ä¸ºHashMapå­˜å‚¨</span></span><br><span class="line"><span class="type">UserDTO</span> <span class="variable">userDTO</span> <span class="operator">=</span> BeanUtil.copyProperties(user, UserDTO.class);</span><br><span class="line">Map&lt;String, Object&gt; userMap = BeanUtil.beanToMap(userDTO, <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;(),</span><br><span class="line">            CopyOptions.create()</span><br><span class="line">                    .setIgnoreNullValue(<span class="literal">true</span>)</span><br><span class="line">                    .setFieldValueEditor((fieldName, fieldValue) -&gt; fieldValue.toString()));</span><br><span class="line">    <span class="comment">// 7å­˜å‚¨</span></span><br><span class="line"><span class="type">String</span> <span class="variable">tokenKey</span> <span class="operator">=</span> LOGIN_USER_KEY + token;</span><br><span class="line">stringRedisTemplate.opsForHash().putAll(tokenKey, userMap);</span><br><span class="line">    <span class="comment">// è®¾ç½®tokenæœ‰æ•ˆæœŸ</span></span><br><span class="line">stringRedisTemplate.expire(tokenKey, LOGIN_USER_TTL, TimeUnit.MINUTES);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è¿”å›token</span></span><br><span class="line"><span class="keyword">return</span> Result.ok(token);</span><br></pre></td></tr></table></figure>
æ³¨æ„StringRedisTemplateè¦æ±‚ç±»å‹æ˜¯Stringï¼Œä½†æ˜¯æˆ‘ä»¬çš„UserDtoé‡Œé¢æœ‰ä¸€ä¸ªLongç±»å‹çš„idï¼Œæ‰€ä»¥éœ€è¦å…ˆè¿›è¡Œè½¬æ¢<br><strong>æ³¨æ„äº‹é¡¹</strong>ï¼š</li>
</ul>
<ol>
<li>å­˜å…¥Redisçš„æ•°æ®ä¸€å®šè¦è®¾ç½®è¿‡æœŸæ—¶é—´</li>
<li>å­˜å…¥Redisçš„æ•°æ®å°½é‡ç²¾ç®€å’Œå®‰å…¨ï¼Œæ¯”å¦‚ç”¨æˆ·ä¿¡æ¯è„±æ•</li>
<li><strong>å·²ç™»å½•ç”¨æˆ·è®¿é—®ç³»ç»Ÿåï¼Œè¦åˆ·æ–°tokenè¿‡æœŸæ—¶é—´ï¼ˆç»­æœŸï¼‰ã€‚è®¿é—®ä»»ä½•è·¯å¾„éƒ½è¦åˆ·æ–°tokenï¼Œä¸ç„¶æ—¶é—´åˆ°äº†ä¼šè¢«å¼ºåˆ¶é€€å‡º</strong></li>
</ol>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.nlark.com/yuque/0/2023/png/32620241/1679482336011-04410982-ea2b-46c8-a76e-991ecec2e229.png#averageHue=%23e9d5d2&clientId=ua6475701-a0dd-4&from=paste&height=357&id=uf30981b2&name=image.png&originHeight=535&originWidth=1046&originalType=binary&ratio=1.5&rotation=0&showTitle=false&size=121501&status=done&style=none&taskId=u72935797-95ba-4740-9cb2-1ab8b2bd387&title=&width=697.3333333333334#averageHue=%23e9d5d2&id=Ouo4R&originHeight=535&originWidth=1046&originalType=binary&ratio=1&rotation=0&showTitle=false&status=done&style=none&title=" alt="image.png"></p>
<h3 id="è¡¥å……"><a href="#è¡¥å……" class="headerlink" title="è¡¥å……"></a>è¡¥å……</h3><blockquote>
<p>get:æ‹¦æˆªå™¨æ˜¯æ‰‹åŠ¨åˆ›å»ºçš„ï¼Œä¸æ˜¯SpringBootæ„å»ºçš„ï¼Œä¸ä¼šå¸®æˆ‘ä»¬æ³¨å…¥ä¾èµ–</p>
</blockquote>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.nlark.com/yuque/0/2023/png/32620241/1679482546551-3a6efe2c-5c8b-4a3e-8aea-0d5340c9bb6d.png#averageHue=%23faf9f6&clientId=ua6475701-a0dd-4&from=paste&height=288&id=ueaf4171a&name=image.png&originHeight=432&originWidth=1617&originalType=binary&ratio=1.5&rotation=0&showTitle=false&size=116557&status=done&style=none&taskId=u32dc2a1a-a96b-44b2-bccc-11993ba52f1&title=&width=1078#averageHue=%23faf9f6&id=VAYYz&originHeight=432&originWidth=1617&originalType=binary&ratio=1&rotation=0&showTitle=false&status=done&style=none&title=" alt="image.png"><br>åœ¨ç¬¬ä¸€ä¸ªæ‹¦æˆªå™¨ä¸­æ‹¦æˆªæ‰€æœ‰çš„è·¯å¾„ï¼ŒæŠŠç¬¬äºŒä¸ªæ‹¦æˆªå™¨åšçš„äº‹æƒ…æ”¾å…¥åˆ°ç¬¬ä¸€ä¸ªæ‹¦æˆªå™¨ä¸­ï¼ŒåŒæ—¶åˆ·æ–°ä»¤ç‰Œï¼Œå› ä¸ºç¬¬ä¸€ä¸ªæ‹¦æˆªå™¨æœ‰äº†threadLocalçš„æ•°æ®ï¼Œæ‰€ä»¥æ­¤æ—¶ç¬¬äºŒä¸ªæ‹¦æˆªå™¨åªéœ€è¦åˆ¤æ–­æ‹¦æˆªå™¨ä¸­çš„userå¯¹è±¡æ˜¯å¦å­˜åœ¨å³å¯ï¼Œå®Œæˆæ•´ä½“åˆ·æ–°åŠŸèƒ½ã€‚<br><strong>UserHolderæ˜¯ä¸€ä¸ªThreadLocalå¯¹è±¡</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RefreshTokenInterceptor</span> <span class="keyword">implements</span> <span class="title class_">HandlerInterceptor</span> &#123;</span><br><span class="line">    <span class="comment">//è¿™é‡Œå¹¶ä¸æ˜¯è‡ªåŠ¨è£…é…ï¼Œå› ä¸ºRefreshTokenInterceptoræ˜¯æˆ‘ä»¬æ‰‹åŠ¨åœ¨WebConfigé‡Œnewå‡ºæ¥çš„</span></span><br><span class="line">    <span class="keyword">private</span> StringRedisTemplate stringRedisTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">RefreshTokenInterceptor</span><span class="params">(StringRedisTemplate stringRedisTemplate)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.stringRedisTemplate = stringRedisTemplate;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">preHandle</span><span class="params">(HttpServletRequest request, HttpServletResponse response, Object handler)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="comment">//1. è·å–è¯·æ±‚å¤´ä¸­çš„token</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">token</span> <span class="operator">=</span> request.getHeader(<span class="string">&quot;authorization&quot;</span>);</span><br><span class="line">        <span class="comment">//2. å¦‚æœtokenæ˜¯ç©ºï¼Œç›´æ¥æ”¾è¡Œï¼Œäº¤ç»™LoginInterceptorå¤„ç†</span></span><br><span class="line">        <span class="keyword">if</span> (StrUtil.isBlank(token)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> RedisConstants.LOGIN_USER_KEY + token;</span><br><span class="line">        <span class="comment">//3. åŸºäºtokenè·å–Redisä¸­çš„ç”¨æˆ·æ•°æ®</span></span><br><span class="line">        Map&lt;Object, Object&gt; userMap = stringRedisTemplate.opsForHash().entries(key);</span><br><span class="line">        <span class="comment">//4. åˆ¤æ–­ç”¨æˆ·æ˜¯å¦å­˜åœ¨ï¼Œä¸å­˜åœ¨ï¼Œä¹Ÿæ”¾è¡Œï¼Œäº¤ç»™LoginInterceptor</span></span><br><span class="line">        <span class="keyword">if</span> (userMap.isEmpty()) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//5. å°†æŸ¥è¯¢åˆ°çš„Hashæ•°æ®è½¬åŒ–ä¸ºUserDtoå¯¹è±¡</span></span><br><span class="line">        <span class="type">UserDTO</span> <span class="variable">userDTO</span> <span class="operator">=</span> BeanUtil.fillBeanWithMap(userMap, <span class="keyword">new</span> <span class="title class_">UserDTO</span>(), <span class="literal">false</span>);</span><br><span class="line">        <span class="comment">//6. å°†ç”¨æˆ·ä¿¡æ¯ä¿å­˜åˆ°ThreadLocal</span></span><br><span class="line">        UserHolder.saveUser(userDTO);</span><br><span class="line">        <span class="comment">//7. åˆ·æ–°tokenTTLï¼Œè¿™é‡Œçš„å­˜æ´»æ—¶é—´æ ¹æ®éœ€è¦è‡ªå·±è®¾ç½®ï¼Œè¿™é‡Œçš„å¸¸é‡å€¼æˆ‘æ”¹ä¸ºäº†30åˆ†é’Ÿ</span></span><br><span class="line">        stringRedisTemplate.expire(key, RedisConstants.LOGIN_USER_TTL, TimeUnit.MINUTES);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">afterCompletion</span><span class="params">(HttpServletRequest request, HttpServletResponse response, Object handler, Exception ex)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        UserHolder.removeUser();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LoginInterceptor</span> <span class="keyword">implements</span> <span class="title class_">HandlerInterceptor</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">preHandle</span><span class="params">(HttpServletRequest request, HttpServletResponse response, Object handler)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="comment">//åˆ¤æ–­ç”¨æˆ·æ˜¯å¦å­˜åœ¨</span></span><br><span class="line">        <span class="keyword">if</span> (UserHolder.getUser()==<span class="literal">null</span>)&#123;</span><br><span class="line">            <span class="comment">//ä¸å­˜åœ¨åˆ™æ‹¦æˆª</span></span><br><span class="line">            response.setStatus(<span class="number">401</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//å­˜åœ¨åˆ™æ”¾è¡Œ</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">afterCompletion</span><span class="params">(HttpServletRequest request, HttpServletResponse response, Object handler, Exception ex)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        UserHolder.removeUser();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MvcConfig</span> <span class="keyword">implements</span> <span class="title class_">WebMvcConfigurer</span> &#123;</span><br><span class="line">    <span class="comment">//åˆ°äº†è¿™é‡Œæ‰èƒ½è‡ªåŠ¨è£…é…</span></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> StringRedisTemplate stringRedisTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">addInterceptors</span><span class="params">(InterceptorRegistry registry)</span> &#123;</span><br><span class="line">        registry.addInterceptor(<span class="keyword">new</span> <span class="title class_">LoginInterceptor</span>())</span><br><span class="line">                .excludePathPatterns(</span><br><span class="line">                        <span class="string">&quot;/user/code&quot;</span>,</span><br><span class="line">                        <span class="string">&quot;/user/login&quot;</span>,</span><br><span class="line">                        <span class="string">&quot;/blog/hot&quot;</span>,</span><br><span class="line">                        <span class="string">&quot;/shop/**&quot;</span>,</span><br><span class="line">                        <span class="string">&quot;/shop-type/**&quot;</span>,</span><br><span class="line">                        <span class="string">&quot;/upload/**&quot;</span>,</span><br><span class="line">                        <span class="string">&quot;/voucher/**&quot;</span></span><br><span class="line">                ).order(<span class="number">1</span>);</span><br><span class="line">        <span class="comment">//RefreshTokenInterceptoræ˜¯æˆ‘ä»¬æ‰‹åŠ¨newå‡ºæ¥çš„</span></span><br><span class="line">        registry.addInterceptor(<span class="keyword">new</span> <span class="title class_">RefreshTokenInterceptor</span>(stringRedisTemplate)).order(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>æ³¨æ„tokeæ‹¦æˆªå™¨è¦åœ¨ç™»å½•æ‹¦æˆªå™¨å‰æ‰§è¡Œï¼Œä¸€ç›´æ–¹æ³•æ˜¯å§tokenæ‹¦æˆªå™¨å†™åœ¨å‰é¢ï¼Œä¸€ç§æ˜¯orderï¼Œæ•°å­—è¶Šå°ï¼Œé¡ºåºè¶Šæ—©</p>
</blockquote>
<h1 id="ç¼“å­˜"><a href="#ç¼“å­˜" class="headerlink" title="ç¼“å­˜"></a>ç¼“å­˜</h1><h2 id="ç®€ä»‹-2"><a href="#ç®€ä»‹-2" class="headerlink" title="ç®€ä»‹"></a>ç®€ä»‹</h2><p>ç¼“å­˜(Cache)å°±æ˜¯æ•°æ®äº¤æ¢çš„ç¼“å†²åŒºï¼Œä¿—ç§°çš„ç¼“å­˜å°±æ˜¯ç¼“å†²åŒºå†…çš„æ•°æ®ï¼Œä¸€èˆ¬ä»æ•°æ®åº“ä¸­è·å–ï¼Œå­˜å‚¨äºæœ¬åœ°<br>ç¼“å­˜æ˜¯ä¸€ç§ç”¨äºæé«˜ç³»ç»Ÿæ€§èƒ½çš„æŠ€æœ¯ã€‚å®ƒå¯ä»¥é€šè¿‡å°†æ•°æ®å­˜å‚¨åœ¨å†…å­˜ä¸­ï¼Œä»è€Œå‡å°‘å¯¹ç£ç›˜æˆ–ç½‘ç»œçš„è®¿é—®ï¼Œæ¥æé«˜æ•°æ®è®¿é—®é€Ÿåº¦ã€‚è¿™æ ·ï¼Œå½“éœ€è¦è®¿é—®ç›¸åŒçš„æ•°æ®æ—¶ï¼Œå¯ä»¥ç›´æ¥ä»ç¼“å­˜ä¸­è·å–ï¼Œè€Œä¸éœ€è¦å†æ¬¡è®¿é—®ç£ç›˜æˆ–ç½‘ç»œÂ¹ã€‚</p>
<p>ç¼“å­˜çš„ä¸»è¦ä¼˜ç‚¹æ˜¯å¯ä»¥å®ç°é«˜æ€§èƒ½å’Œé«˜å¹¶å‘ã€‚å®ƒå¯ä»¥å‡å°‘å¯¹æ•°æ®åº“æˆ–å…¶ä»–å¤–éƒ¨èµ„æºçš„è®¿é—®ï¼Œä»è€Œå‡å°‘ç³»ç»Ÿçš„å“åº”æ—¶é—´ã€‚æ­¤å¤–ï¼Œç¼“å­˜è¿˜å¯ä»¥å‡å°‘æœåŠ¡å™¨çš„è´Ÿè½½ï¼Œæé«˜ç³»ç»Ÿçš„å¯æ‰©å±•æ€§Â¹ã€‚</p>
<p>ä½†æ˜¯ï¼Œä½¿ç”¨ç¼“å­˜ä¹Ÿæœ‰ä¸€äº›æ½œåœ¨çš„é£é™©ã€‚å¦‚æœç¼“å­˜ä¸­çš„æ•°æ®è¿‡æœŸæˆ–ä¸ä¸€è‡´ï¼Œå¯èƒ½ä¼šå¯¼è‡´ç³»ç»Ÿå‡ºç°é”™è¯¯ã€‚å› æ­¤ï¼Œåœ¨ä½¿ç”¨ç¼“å­˜æ—¶ï¼Œéœ€è¦æ³¨æ„æ•°æ®çš„æœ‰æ•ˆæ€§å’Œä¸€è‡´æ€§ã€‚</p>
<h2 id="å®ç°-1"><a href="#å®ç°-1" class="headerlink" title="å®ç°"></a>å®ç°</h2><ol>
<li>æš‚æ— ç¼“å­˜ï¼Œä»æ•°æ®åº“ä¸­è¯»ï¼Œç„¶åè®¾ç½®ï¼ˆæ›´æ–°ï¼‰ç¼“å­˜</li>
<li>ä¸€æœ‰ç¼“å­˜ï¼Œç›´æ¥è¯»ç¼“å­˜</li>
</ol>
<h3 id="ç¼“å­˜æ›´æ–°"><a href="#ç¼“å­˜æ›´æ–°" class="headerlink" title="ç¼“å­˜æ›´æ–°"></a>ç¼“å­˜æ›´æ–°</h3><p>ç¼“å­˜æ›´æ–°æ˜¯redisä¸ºäº†èŠ‚çº¦å†…å­˜è€Œè®¾è®¡å‡ºæ¥çš„ä¸€ä¸ªä¸œè¥¿ï¼Œä¸»è¦æ˜¯å› ä¸ºå†…å­˜æ•°æ®å®è´µï¼Œå½“æˆ‘ä»¬å‘redisæ’å…¥å¤ªå¤šæ•°æ®ï¼Œæ­¤æ—¶å°±å¯èƒ½ä¼šå¯¼è‡´ç¼“å­˜ä¸­çš„æ•°æ®è¿‡å¤šï¼Œæ‰€ä»¥redisä¼šå¯¹éƒ¨åˆ†æ•°æ®è¿›è¡Œæ›´æ–°ï¼Œæˆ–è€…æŠŠä»–å«ä¸ºæ·˜æ±°æ›´åˆé€‚ã€‚</p>
<ul>
<li><strong>å†…å­˜æ·˜æ±°ï¼š</strong>redisè‡ªåŠ¨è¿›è¡Œï¼Œå½“rediså†…å­˜è¾¾åˆ°å’±ä»¬è®¾å®šçš„max-memeryçš„æ—¶å€™ï¼Œä¼šè‡ªåŠ¨è§¦å‘æ·˜æ±°æœºåˆ¶ï¼Œæ·˜æ±°æ‰ä¸€äº›ä¸é‡è¦çš„æ•°æ®(å¯ä»¥è‡ªå·±è®¾ç½®ç­–ç•¥æ–¹å¼)</li>
<li><strong>è¶…æ—¶å‰”é™¤ï¼š</strong>å½“æˆ‘ä»¬ç»™redisè®¾ç½®äº†è¿‡æœŸæ—¶é—´ttlä¹‹åï¼Œredisä¼šå°†è¶…æ—¶çš„æ•°æ®è¿›è¡Œåˆ é™¤ï¼Œæ–¹ä¾¿å’±ä»¬ç»§ç»­ä½¿ç”¨ç¼“å­˜</li>
<li><strong>ä¸»åŠ¨æ›´æ–°ï¼š</strong>æˆ‘ä»¬å¯ä»¥æ‰‹åŠ¨è°ƒç”¨æ–¹æ³•æŠŠç¼“å­˜åˆ æ‰ï¼Œé€šå¸¸ç”¨äºè§£å†³ç¼“å­˜å’Œæ•°æ®åº“ä¸ä¸€è‡´é—®é¢˜</li>
</ul>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.nlark.com/yuque/0/2023/png/32620241/1679487448289-73fae28e-fb31-4c4e-81b2-46614b2e5949.png#averageHue=%23e1d0d0&clientId=ua6475701-a0dd-4&from=paste&height=489&id=u0f93aca8&name=image.png&originHeight=734&originWidth=1613&originalType=binary&ratio=1.5&rotation=0&showTitle=false&size=307125&status=done&style=none&taskId=ue2d34ff4-0671-45a6-adc9-b05d113cd46&title=&width=1075.3333333333333#averageHue=%23e1d0d0&id=dKzOA&originHeight=734&originWidth=1613&originalType=binary&ratio=1&rotation=0&showTitle=false&status=done&style=none&title=" alt="image.png"><br>ä¸»åŠ¨æ›´æ–°ç¼“å­˜æ˜¯æŒ‡åœ¨æ•°æ®å‘ç”Ÿå˜åŒ–æ—¶ï¼Œä¸»åŠ¨æ›´æ–°ç¼“å­˜ä¸­çš„æ•°æ®ï¼Œä»¥ä¿è¯ç¼“å­˜ä¸­çš„æ•°æ®ä¸æ•°æ®åº“ä¸­çš„æ•°æ®ä¸€è‡´ã€‚å¸¸è§çš„ä¸»åŠ¨æ›´æ–°ç¼“å­˜çš„æ–¹å¼æœ‰ä»¥ä¸‹å‡ ç§:</p>
<ol>
<li><strong>è¯»å†™æ“ä½œåŒæ—¶è¿›è¡Œ</strong>: åœ¨æ‰§è¡Œå†™æ“ä½œæ—¶ï¼ŒåŒæ—¶æ›´æ–°ç¼“å­˜ä¸­çš„æ•°æ®ã€‚è¿™ç§æ–¹å¼å¯ä»¥ä¿è¯ç¼“å­˜ä¸­çš„æ•°æ®ä¸æ•°æ®åº“ä¸­çš„æ•°æ®ä¸€è‡´ï¼Œä½†å¯èƒ½ä¼šå¢åŠ å†™æ“ä½œçš„å»¶è¿Ÿã€‚</li>
<li><strong>å®šæ—¶æ›´æ–°</strong>: å®šæ—¶ä»æ•°æ®åº“ä¸­è¯»å–æ•°æ®ï¼Œæ›´æ–°ç¼“å­˜ä¸­çš„æ•°æ®ã€‚è¿™ç§æ–¹å¼å¯ä»¥å‡å°‘å†™æ“ä½œçš„å»¶è¿Ÿï¼Œä½†å¯èƒ½ä¼šå¯¼è‡´ç¼“å­˜ä¸­çš„æ•°æ®ä¸æ•°æ®åº“ä¸­çš„æ•°æ®ä¸ä¸€è‡´ã€‚</li>
<li><strong>å¼‚æ­¥æ›´æ–°</strong>: åœ¨æ‰§è¡Œå†™æ“ä½œåï¼Œå¼‚æ­¥æ›´æ–°ç¼“å­˜ä¸­çš„æ•°æ®ã€‚è¿™ç§æ–¹å¼å¯ä»¥å‡å°‘å†™æ“ä½œçš„å»¶è¿Ÿï¼Œå¹¶ä¸”å¯ä»¥ä¿è¯ç¼“å­˜ä¸­çš„æ•°æ®ä¸æ•°æ®åº“ä¸­çš„æ•°æ®ä¸€è‡´ï¼Œä½†éœ€è¦é¢å¤–çš„çº¿ç¨‹æ¥æ‰§è¡Œå¼‚æ­¥æ›´æ–°ã€‚</li>
</ol>
<p>é€‰æ‹©åˆ é™¤ç¼“å­˜è¿˜æ˜¯æ›´æ–°ç¼“å­˜ï¼Ÿ<br>å»ºè®®åˆ é™¤ç¼“å­˜ï¼Œç­‰å¾…ä¸‹æ¬¡æŸ¥è¯¢è‡ªåŠ¨è®¾ç½®ç¼“å­˜ï¼Œåšåˆ°éšç”¨éšå–ï¼Œå¯ä»¥é¿å…æ¯æ¬¡æ›´æ–°æ•°æ®åº“åéƒ½æ›´æ–°ç¼“å­˜çš„æ— æ•ˆæ“ä½œ</p>
<p>å…ˆåˆ é™¤ç¼“å­˜è¿˜æ˜¯å…ˆæ“ä½œæ•°æ®åº“ï¼Ÿ</p>
<ol>
<li>æ›´æ–°ç¼“å­˜ï¼šæ¯æ¬¡æ›´æ–°æ•°æ®åº“éƒ½è¦æ›´æ–°ç¼“å­˜â€“å†™å¤šè¯»å°‘æ—¶ä¼šå¯¼è‡´å¤šæ¬¡æ— æ•ˆå†™æ“ä½œ</li>
<li>åˆ é™¤ç¼“å­˜ï¼šæ›´æ–°æ•°æ®åº“æ—¶è®©ç¼“å­˜å¤±æ•ˆï¼ŒæŸ¥è¯¢æ—¶å†æ›´æ–°ç¼“å­˜</li>
</ol>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.nlark.com/yuque/0/2023/png/32620241/1682081700363-f5e5f90b-91d6-4ad6-a300-e615bd26d03b.png#averageHue=%23c8f8f8&clientId=uf8948dec-d357-4&from=paste&height=747&id=ud617427c&originHeight=1120&originWidth=1213&originalType=binary&ratio=1.5&rotation=0&showTitle=false&size=460605&status=done&style=none&taskId=u88ad9f45-166f-4836-9af4-22c4a98581b&title=&width=808.6666666666666" alt="image.png"><br><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.nlark.com/yuque/0/2023/png/32620241/1682081680894-7a9a574b-4be8-4da0-8297-096f5834522a.png#averageHue=%23c9f8f8&clientId=uf8948dec-d357-4&from=paste&height=733&id=u6c1124f0&originHeight=1099&originWidth=1263&originalType=binary&ratio=1.5&rotation=0&showTitle=false&size=481203&status=done&style=none&taskId=ue8eeb0a8-7a6c-477b-9269-2ebb0cb197e&title=&width=842" alt="image.png"><br>åœ¨æ›´æ–°æ•°æ®æ—¶ï¼Œé€šå¸¸å»ºè®®å…ˆæ“ä½œæ•°æ®åº“ï¼Œç„¶åå†åˆ é™¤ç¼“å­˜ã€‚è¿™æ ·åšçš„åŸå› æ˜¯ä¸ºäº†ä¿è¯æ•°æ®çš„ä¸€è‡´æ€§ã€‚<br>å¦‚æœå…ˆåˆ é™¤ç¼“å­˜ï¼Œé‚£ä¹ˆåœ¨åˆ é™¤ç¼“å­˜å’Œæ›´æ–°æ•°æ®åº“ä¹‹é—´ï¼Œå¯èƒ½ä¼šæœ‰ä¸€æ®µæ—¶é—´ç¼“å­˜ä¸­æ²¡æœ‰æ•°æ®ã€‚è¿™ç§æƒ…å†µä¸‹ï¼Œå¦‚æœæœ‰è¯·æ±‚è®¿é—®è¯¥æ•°æ®ï¼Œé‚£ä¹ˆéœ€è¦ä»æ•°æ®åº“ä¸­è¯»å–æ•°æ®ã€‚ä½†æ˜¯ï¼Œå¦‚æœæ­¤æ—¶æ•°æ®åº“ä¸­çš„æ•°æ®è¿˜æ²¡æœ‰æ›´æ–°ï¼Œé‚£ä¹ˆè¯·æ±‚ä¼šè¯»å–åˆ°æ—§çš„æ•°æ®ã€‚<br>å¦‚æœå…ˆæ“ä½œæ•°æ®åº“ï¼Œç„¶åå†åˆ é™¤ç¼“å­˜ï¼Œé‚£ä¹ˆå¯ä»¥é¿å…ä¸Šè¿°é—®é¢˜ã€‚å³ä½¿åœ¨æ›´æ–°æ•°æ®åº“å’Œåˆ é™¤ç¼“å­˜ä¹‹é—´æœ‰è¯·æ±‚è®¿é—®è¯¥æ•°æ®ï¼Œä¹Ÿä¼šä»ç¼“å­˜ä¸­è¯»å–åˆ°æ—§çš„æ•°æ®ã€‚å½“ç¼“å­˜è¢«åˆ é™¤åï¼Œä¸‹ä¸€ä¸ªè¯·æ±‚ä¼šä»æ•°æ®åº“ä¸­è¯»å–åˆ°æ–°çš„æ•°æ®ã€‚<br>å› æ­¤ï¼Œåœ¨æ›´æ–°æ•°æ®æ—¶ï¼Œé€šå¸¸å»ºè®®å…ˆæ“ä½œæ•°æ®åº“ï¼Œç„¶åå†åˆ é™¤ç¼“å­˜ã€‚</p>
<h2 id="æ ¸å¿ƒæ¦‚å¿µ"><a href="#æ ¸å¿ƒæ¦‚å¿µ" class="headerlink" title="æ ¸å¿ƒæ¦‚å¿µ"></a>æ ¸å¿ƒæ¦‚å¿µ</h2><p>ç¼“å­˜ç©¿é€ã€ç¼“å­˜å‡»ç©¿å’Œç¼“å­˜é›ªå´©éƒ½æ˜¯ç¼“å­˜ä¸­çš„å¸¸è§é—®é¢˜ï¼Œå®ƒä»¬ä¹‹é—´çš„åŒºåˆ«å¦‚ä¸‹ï¼š</p>
<ol>
<li>ç¼“å­˜ç©¿é€</li>
</ol>
<p>å½“è¯·æ±‚çš„æ•°æ®åœ¨ç¼“å­˜ä¸­<code>ä¸å­˜åœ¨</code>ï¼Œä¸”æ•°æ®åº“ä¸­ä¹Ÿ<code>ä¸å­˜åœ¨</code>è¯¥æ•°æ®æ—¶ï¼Œå°±ä¼šå‘ç”Ÿç¼“å­˜ç©¿é€ã€‚è¿™ç§æƒ…å†µä¸‹ï¼Œæ¯æ¬¡è¯·æ±‚éƒ½éœ€è¦ä»æ•°æ®åº“ä¸­æŸ¥è¯¢æ•°æ®ï¼Œå¯¼è‡´æ•°æ®åº“å‹åŠ›è¿‡å¤§ï¼Œå¯èƒ½ä¼šå¼•èµ·é›ªå´©æ•ˆåº”ã€‚<br>è§£å†³æ–¹æ³•ï¼šå¯ä»¥åœ¨ç¼“å­˜ä¸­è®¾ç½®ä¸€ä¸ª<code>ç©ºå€¼</code>æˆ–è€…å¸ƒå°”å€¼ï¼Œè¡¨ç¤ºè¯¥æ•°æ®ä¸å­˜åœ¨ï¼Œè¿™æ ·ä¸‹æ¬¡è¯·æ±‚æ—¶å°±ä¼šç›´æ¥è¿”å›ç©ºå€¼ï¼Œé¿å…äº†å¯¹æ•°æ®åº“çš„æŸ¥è¯¢ã€‚</p>
<ol start="2">
<li>ç¼“å­˜å‡»ç©¿</li>
</ol>
<p>å½“ä¸€ä¸ªçƒ­ç‚¹æ•°æ®è¿‡æœŸæˆ–è€…è¢«åˆ é™¤ï¼Œè€Œæ­¤æ—¶æœ‰å¤§é‡çš„è¯·æ±‚è®¿é—®è¿™ä¸ªæ•°æ®æ—¶ï¼Œå°±ä¼šå‘ç”Ÿç¼“å­˜å‡»ç©¿ã€‚è¿™ç§æƒ…å†µä¸‹ï¼Œå¤§é‡çš„è¯·æ±‚éƒ½ä¼šè®¿é—®æ•°æ®åº“ï¼Œå¯¼è‡´æ•°æ®åº“å‹åŠ›è¿‡å¤§ï¼Œå¯èƒ½ä¼šå¼•èµ·é›ªå´©æ•ˆåº”ã€‚<br>è§£å†³æ–¹æ³•ï¼šå¯ä»¥åœ¨ç¼“å­˜ä¸­è®¾ç½®ä¸€ä¸ªçŸ­æš‚çš„è¿‡æœŸæ—¶é—´ï¼Œå½“ç¼“å­˜è¿‡æœŸæ—¶ï¼Œå…ˆè¿”å›<code>æ—§å€¼</code>ï¼Œå¹¶å¼‚æ­¥æ›´æ–°ç¼“å­˜ï¼Œé¿å…äº†å¯¹æ•°æ®åº“çš„å¤§é‡æŸ¥è¯¢ã€‚</p>
<ol start="3">
<li>ç¼“å­˜é›ªå´©</li>
</ol>
<p>å½“ç¼“å­˜ä¸­çš„å¤§é‡æ•°æ®åŒæ—¶è¿‡æœŸå¤±æ•ˆï¼Œå¯¼è‡´å¤§é‡è¯·æ±‚éƒ½è½åˆ°æ•°æ®åº“ä¸Šæ—¶ï¼Œå°±ä¼šå‘ç”Ÿç¼“å­˜é›ªå´©ã€‚è¿™ç§æƒ…å†µä¸‹ï¼Œæ•°æ®åº“çš„å‹åŠ›ä¼šå‰§å¢ï¼Œå¯èƒ½ä¼šå¯¼è‡´æ•°æ®åº“å®•æœºæˆ–å´©æºƒã€‚<br>è§£å†³æ–¹æ³•ï¼šå¯ä»¥åœ¨ç¼“å­˜ä¸­è®¾ç½®ä¸åŒçš„è¿‡æœŸæ—¶é—´ï¼Œé¿å…æ‰€æœ‰æ•°æ®åŒæ—¶å¤±æ•ˆã€‚å¦å¤–ï¼Œå¯ä»¥é‡‡ç”¨å¤šçº§ç¼“å­˜ã€çƒ­ç‚¹æ•°æ®é¢„åŠ è½½ç­‰æ–¹å¼æ¥é¿å…ç¼“å­˜é›ªå´©ã€‚</p>
<h2 id="ç¼“å­˜ç©¿é€"><a href="#ç¼“å­˜ç©¿é€" class="headerlink" title="ç¼“å­˜ç©¿é€"></a>ç¼“å­˜ç©¿é€</h2><p>ç¼“å­˜ç©¿é€ ï¼šç¼“å­˜ç©¿é€æ˜¯æŒ‡å®¢æˆ·ç«¯è¯·æ±‚çš„æ•°æ®åœ¨ç¼“å­˜ä¸­å’Œæ•°æ®åº“ä¸­éƒ½ä¸å­˜åœ¨ï¼Œè¿™æ ·ç¼“å­˜æ°¸è¿œä¸ä¼šç”Ÿæ•ˆï¼Œè¿™äº›è¯·æ±‚éƒ½ä¼šæ‰“åˆ°æ•°æ®åº“ã€‚<br>å¸¸è§çš„è§£å†³æ–¹æ¡ˆæœ‰ä¸¤ç§ï¼š</p>
<ul>
<li>ç¼“å­˜ç©ºå¯¹è±¡ <ul>
<li>ä¼˜ç‚¹ï¼šå®ç°ç®€å•ï¼Œç»´æŠ¤æ–¹ä¾¿</li>
<li>ç¼ºç‚¹ï¼š <ul>
<li>é¢å¤–çš„å†…å­˜æ¶ˆè€—</li>
<li>å¯èƒ½é€ æˆçŸ­æœŸçš„ä¸ä¸€è‡´</li>
</ul>
</li>
</ul>
</li>
<li>å¸ƒéš†è¿‡æ»¤ <ul>
<li>ä¼˜ç‚¹ï¼šå†…å­˜å ç”¨è¾ƒå°‘ï¼Œæ²¡æœ‰å¤šä½™key</li>
<li>ç¼ºç‚¹ï¼š <ul>
<li>å®ç°å¤æ‚</li>
<li>å­˜åœ¨è¯¯åˆ¤å¯èƒ½</li>
</ul>
</li>
</ul>
</li>
</ul>
<p><strong>ç¼“å­˜ç©ºå¯¹è±¡æ€è·¯åˆ†æï¼š</strong>å½“æˆ‘ä»¬å®¢æˆ·ç«¯è®¿é—®ä¸å­˜åœ¨çš„æ•°æ®æ—¶ï¼Œå…ˆè¯·æ±‚redisï¼Œä½†æ˜¯æ­¤æ—¶redisä¸­æ²¡æœ‰æ•°æ®ï¼Œæ­¤æ—¶ä¼šè®¿é—®åˆ°æ•°æ®åº“ï¼Œä½†æ˜¯æ•°æ®åº“ä¸­ä¹Ÿæ²¡æœ‰æ•°æ®ï¼Œè¿™ä¸ªæ•°æ®ç©¿é€äº†ç¼“å­˜ï¼Œç›´å‡»æ•°æ®åº“ï¼Œæˆ‘ä»¬éƒ½çŸ¥é“æ•°æ®åº“èƒ½å¤Ÿæ‰¿è½½çš„å¹¶å‘ä¸å¦‚redisè¿™ä¹ˆé«˜ï¼Œå¦‚æœå¤§é‡çš„è¯·æ±‚åŒæ—¶è¿‡æ¥è®¿é—®è¿™ç§ä¸å­˜åœ¨çš„æ•°æ®ï¼Œè¿™äº›è¯·æ±‚å°±éƒ½ä¼šè®¿é—®åˆ°æ•°æ®åº“ï¼Œç®€å•çš„è§£å†³æ–¹æ¡ˆå°±æ˜¯å“ªæ€•è¿™ä¸ªæ•°æ®åœ¨æ•°æ®åº“ä¸­ä¹Ÿä¸å­˜åœ¨ï¼Œæˆ‘ä»¬ä¹ŸæŠŠè¿™ä¸ªæ•°æ®å­˜å…¥åˆ°redisä¸­å»ï¼Œè¿™æ ·ï¼Œä¸‹æ¬¡ç”¨æˆ·è¿‡æ¥è®¿é—®è¿™ä¸ªä¸å­˜åœ¨çš„æ•°æ®ï¼Œé‚£ä¹ˆåœ¨redisä¸­ä¹Ÿèƒ½æ‰¾åˆ°è¿™ä¸ªæ•°æ®å°±ä¸ä¼šè¿›å…¥åˆ°ç¼“å­˜äº†<br><strong>å¸ƒéš†è¿‡æ»¤ï¼š</strong>å¸ƒéš†è¿‡æ»¤å™¨å…¶å®é‡‡ç”¨çš„æ˜¯å“ˆå¸Œæ€æƒ³æ¥è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œé€šè¿‡ä¸€ä¸ªåºå¤§çš„äºŒè¿›åˆ¶æ•°ç»„ï¼Œèµ°å“ˆå¸Œæ€æƒ³å»åˆ¤æ–­å½“å‰è¿™ä¸ªè¦æŸ¥è¯¢çš„è¿™ä¸ªæ•°æ®æ˜¯å¦å­˜åœ¨ï¼Œå¦‚æœå¸ƒéš†è¿‡æ»¤å™¨åˆ¤æ–­å­˜åœ¨ï¼Œåˆ™æ”¾è¡Œï¼Œè¿™ä¸ªè¯·æ±‚ä¼šå»è®¿é—®redisï¼Œå“ªæ€•æ­¤æ—¶redisä¸­çš„æ•°æ®è¿‡æœŸäº†ï¼Œä½†æ˜¯æ•°æ®åº“ä¸­ä¸€å®šå­˜åœ¨è¿™ä¸ªæ•°æ®ï¼Œåœ¨æ•°æ®åº“ä¸­æŸ¥è¯¢å‡ºæ¥è¿™ä¸ªæ•°æ®åï¼Œå†å°†å…¶æ”¾å…¥åˆ°redisä¸­ï¼Œ<br>å‡è®¾å¸ƒéš†è¿‡æ»¤å™¨åˆ¤æ–­è¿™ä¸ªæ•°æ®ä¸å­˜åœ¨ï¼Œåˆ™ç›´æ¥è¿”å›<br>è¿™ç§æ–¹å¼ä¼˜ç‚¹åœ¨äºèŠ‚çº¦å†…å­˜ç©ºé—´ï¼Œå­˜åœ¨è¯¯åˆ¤ï¼Œè¯¯åˆ¤åŸå› åœ¨äºï¼šå¸ƒéš†è¿‡æ»¤å™¨èµ°çš„æ˜¯å“ˆå¸Œæ€æƒ³ï¼Œåªè¦å“ˆå¸Œæ€æƒ³ï¼Œå°±å¯èƒ½å­˜åœ¨å“ˆå¸Œå†²çª<br><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.nlark.com/yuque/0/2023/png/32620241/1679538039906-ff893fe0-89fb-42af-95fa-ee8280ce19fd.png#averageHue=%23f8f6f5&clientId=u13b1c3e4-cb39-4&from=paste&height=549&id=ue33c9b2a&name=image.png&originHeight=823&originWidth=1470&originalType=binary&ratio=1.5&rotation=0&showTitle=false&size=263421&status=done&style=none&taskId=ued9c7128-e471-4561-b53c-1a47059694c&title=&width=980#averageHue=%23f8f6f5&id=FudEK&originHeight=823&originWidth=1470&originalType=binary&ratio=1&rotation=0&showTitle=false&status=done&style=none&title=" alt="image.png"><br>é¢„é˜²åšæ³•ï¼š</p>
<ol>
<li>å¢å¼ºå¯¹è¯·æ±‚æ•°æ®çš„æ ¡éªŒ</li>
<li>å¢å¼ºå¯¹æ•°æ®æ ¼å¼çš„æ§åˆ¶</li>
<li>å¢å¼ºidå¤æ‚åº¦ï¼Œé¿å…è¢«çŒœæµ‹idè§„å¾‹ï¼ˆå¯ä»¥é‡‡ç”¨é›ªèŠ±ç®—æ³•ï¼‰</li>
<li>å¢å¼ºç”¨æˆ·æƒé™æ ¡éªŒ</li>
<li>é™æµ</li>
</ol>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.nlark.com/yuque/0/2023/png/32620241/1679538112846-963b5504-7434-4c90-87f2-3c9e7baba3b1.png#averageHue=%23eeebeb&clientId=u13b1c3e4-cb39-4&from=paste&height=472&id=u68222c95&name=image.png&originHeight=708&originWidth=1676&originalType=binary&ratio=1.5&rotation=0&showTitle=false&size=365890&status=done&style=none&taskId=ucf0c4b03-9058-4b40-9275-c076e9660cc&title=&width=1117.3333333333333#averageHue=%23eeebeb&id=L1vgz&originHeight=708&originWidth=1676&originalType=binary&ratio=1&rotation=0&showTitle=false&status=done&style=none&title=" alt="image.png"></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> Result <span class="title function_">queryById</span><span class="params">(Long id)</span> &#123;</span><br><span class="line">    <span class="comment">//å…ˆä»Redisä¸­æŸ¥ï¼Œè¿™é‡Œçš„å¸¸é‡å€¼æ˜¯å›ºå®šçš„å‰ç¼€ + åº—é“ºid</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">shopJson</span> <span class="operator">=</span> stringRedisTemplate.opsForValue().get(CACHE_SHOP_KEY + id);</span><br><span class="line">    <span class="comment">//å¦‚æœä¸ä¸ºç©ºï¼ˆæŸ¥è¯¢åˆ°äº†ï¼‰ï¼Œåˆ™è½¬ä¸ºShopç±»å‹ç›´æ¥è¿”å›</span></span><br><span class="line">    <span class="keyword">if</span> (StrUtil.isNotBlank(shopJson)) &#123;</span><br><span class="line">        <span class="type">Shop</span> <span class="variable">shop</span> <span class="operator">=</span> JSONUtil.toBean(shopJson, Shop.class);</span><br><span class="line">        <span class="keyword">return</span> Result.ok(shop);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//å¦‚æœæŸ¥è¯¢åˆ°çš„æ˜¯ç©ºå­—ç¬¦ä¸²ï¼Œåˆ™è¯´æ˜æ˜¯æˆ‘ä»¬ç¼“å­˜çš„ç©ºæ•°æ®</span></span><br><span class="line">    <span class="keyword">if</span> (shopJson != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> Result.fail(<span class="string">&quot;åº—é“ºä¸å­˜åœ¨ï¼ï¼&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//å¦åˆ™å»æ•°æ®åº“ä¸­æŸ¥</span></span><br><span class="line">    <span class="type">Shop</span> <span class="variable">shop</span> <span class="operator">=</span> getById(id);</span><br><span class="line">    <span class="comment">//æŸ¥ä¸åˆ°ï¼Œåˆ™å°†ç©ºå­—ç¬¦ä¸²å†™å…¥Redis</span></span><br><span class="line">    <span class="keyword">if</span> (shop == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="comment">//è¿™é‡Œçš„å¸¸é‡å€¼æ˜¯2åˆ†é’Ÿ</span></span><br><span class="line">        stringRedisTemplate.opsForValue().set(CACHE_SHOP_KEY + id, <span class="string">&quot;&quot;</span>, CACHE_NULL_TTL, TimeUnit.MINUTES);</span><br><span class="line">        <span class="keyword">return</span> Result.fail(<span class="string">&quot;åº—é“ºä¸å­˜åœ¨ï¼ï¼&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//æŸ¥åˆ°äº†åˆ™è½¬ä¸ºjsonå­—ç¬¦ä¸²</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">jsonStr</span> <span class="operator">=</span> JSONUtil.toJsonStr(shop);</span><br><span class="line">    <span class="comment">//å¹¶å­˜å…¥redisï¼Œè®¾ç½®TTL</span></span><br><span class="line">    stringRedisTemplate.opsForValue().set(CACHE_SHOP_KEY + id, jsonStr, CACHE_SHOP_TTL, TimeUnit.MINUTES);</span><br><span class="line">    <span class="comment">//æœ€ç»ˆæŠŠæŸ¥è¯¢åˆ°çš„å•†æˆ·ä¿¡æ¯è¿”å›ç»™å‰ç«¯</span></span><br><span class="line">    <span class="keyword">return</span> Result.ok(shop);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="ç¼“å­˜é›ªå´©"><a href="#ç¼“å­˜é›ªå´©" class="headerlink" title="ç¼“å­˜é›ªå´©"></a>ç¼“å­˜é›ªå´©</h2><ul>
<li>ç¼“å­˜é›ªå´©æ˜¯æŒ‡åœ¨åŒä¸€æ—¶é—´æ®µï¼Œ<code>å¤§é‡ç¼“å­˜çš„keyåŒæ—¶å¤±æ•ˆ</code>ï¼Œæˆ–è€…<code>RedisæœåŠ¡å®•æœº</code>ï¼Œå¯¼è‡´å¤§é‡è¯·æ±‚åˆ°è¾¾æ•°æ®åº“ï¼Œå¸¦æ¥å·¨å¤§å‹åŠ›</li>
<li>è§£å†³æ–¹æ¡ˆ <ul>
<li>ç»™ä¸åŒçš„Keyçš„TTLæ·»åŠ éšæœºå€¼ï¼Œè®©å…¶åœ¨ä¸åŒæ—¶é—´æ®µåˆ†æ‰¹å¤±æ•ˆ</li>
<li>åˆ©ç”¨Redisé›†ç¾¤æé«˜æœåŠ¡çš„å¯ç”¨æ€§ï¼ˆä½¿ç”¨ä¸€ä¸ªæˆ–è€…å¤šä¸ªå“¨å…µ(Sentinel)å®ä¾‹ç»„æˆçš„ç³»ç»Ÿï¼Œå¯¹redisèŠ‚ç‚¹è¿›è¡Œç›‘æ§ï¼Œåœ¨ä¸»èŠ‚ç‚¹å‡ºç°æ•…éšœçš„æƒ…å†µä¸‹ï¼Œèƒ½å°†ä»èŠ‚ç‚¹ä¸­çš„ä¸€ä¸ªå‡çº§ä¸ºä¸»èŠ‚ç‚¹ï¼Œè¿›è¡Œæ•…éšœè½¬ä¹‰ï¼Œä¿è¯ç³»ç»Ÿçš„å¯ç”¨æ€§ã€‚ ï¼‰</li>
<li>ç»™ç¼“å­˜ä¸šåŠ¡æ·»åŠ é™çº§é™æµç­–ç•¥</li>
<li>ç»™ä¸šåŠ¡æ·»åŠ å¤šçº§ç¼“å­˜ï¼ˆæµè§ˆå™¨è®¿é—®é™æ€èµ„æºæ—¶ï¼Œä¼˜å…ˆè¯»å–æµè§ˆå™¨æœ¬åœ°ç¼“å­˜ï¼›è®¿é—®éé™æ€èµ„æºï¼ˆajaxæŸ¥è¯¢æ•°æ®ï¼‰æ—¶ï¼Œè®¿é—®æœåŠ¡ç«¯ï¼›è¯·æ±‚åˆ°è¾¾Nginxåï¼Œä¼˜å…ˆè¯»å–Nginxæœ¬åœ°ç¼“å­˜ï¼›å¦‚æœNginxæœ¬åœ°ç¼“å­˜æœªå‘½ä¸­ï¼Œåˆ™å»ç›´æ¥æŸ¥è¯¢Redisï¼ˆä¸ç»è¿‡Tomcatï¼‰ï¼›å¦‚æœRedisæŸ¥è¯¢æœªå‘½ä¸­ï¼Œåˆ™æŸ¥è¯¢Tomcatï¼›è¯·æ±‚è¿›å…¥Tomcatåï¼Œä¼˜å…ˆæŸ¥è¯¢JVMè¿›ç¨‹ç¼“å­˜ï¼›å¦‚æœJVMè¿›ç¨‹ç¼“å­˜æœªå‘½ä¸­ï¼Œåˆ™æŸ¥è¯¢æ•°æ®åº“ï¼‰</li>
</ul>
</li>
</ul>
<h2 id="ç¼“å­˜å‡»ç©¿"><a href="#ç¼“å­˜å‡»ç©¿" class="headerlink" title="ç¼“å­˜å‡»ç©¿"></a>ç¼“å­˜å‡»ç©¿</h2><ul>
<li>ç¼“å­˜å‡»ç©¿ä¹Ÿå«<code>çƒ­ç‚¹Key</code>é—®é¢˜ï¼Œå°±æ˜¯ä¸€ä¸ªè¢«é«˜å¹¶å‘è®¿é—®å¹¶ä¸”ç¼“å­˜é‡å»ºä¸šåŠ¡è¾ƒå¤æ‚çš„keyçªç„¶å¤±æ•ˆäº†ï¼Œé‚£ä¹ˆæ— æ•°è¯·æ±‚è®¿é—®å°±ä¼šåœ¨ç¬é—´ç»™æ•°æ®åº“å¸¦æ¥å·¨å¤§çš„å†²å‡»</li>
<li>ä¸¾ä¸ªä¸å¤ªæ°å½“çš„ä¾‹å­ï¼šä¸€ä»¶ç§’æ€ä¸­çš„å•†å“çš„keyçªç„¶å¤±æ•ˆäº†ï¼Œå¤§å®¶éƒ½åœ¨ç–¯ç‹‚æŠ¢è´­ï¼Œé‚£ä¹ˆè¿™ä¸ªç¬é—´å°±ä¼šæœ‰æ— æ•°çš„è¯·æ±‚è®¿é—®å»ç›´æ¥æŠµè¾¾æ•°æ®åº“ï¼Œä»è€Œé€ æˆç¼“å­˜å‡»ç©¿</li>
<li>é€»è¾‘åˆ†æï¼šå‡è®¾çº¿ç¨‹1åœ¨æŸ¥è¯¢ç¼“å­˜ä¹‹åæœªå‘½ä¸­ï¼Œæœ¬æ¥åº”è¯¥å»æŸ¥è¯¢æ•°æ®åº“ï¼Œé‡å»ºç¼“å­˜æ•°æ®ï¼Œå®Œæˆè¿™äº›ä¹‹åï¼Œå…¶ä»–çº¿ç¨‹ä¹Ÿå°±èƒ½ä»ç¼“å­˜ä¸­åŠ è½½è¿™äº›æ•°æ®äº†ã€‚ä½†æ˜¯åœ¨çº¿ç¨‹1è¿˜æœªæ‰§è¡Œå®Œæ¯•æ—¶ï¼Œåˆè¿›æ¥äº†çº¿ç¨‹2ã€3ã€4åŒæ—¶æ¥è®¿é—®å½“å‰æ–¹æ³•ï¼Œé‚£ä¹ˆè¿™äº›çº¿ç¨‹éƒ½ä¸èƒ½ä»ç¼“å­˜ä¸­æŸ¥è¯¢åˆ°æ•°æ®ï¼Œé‚£ä¹ˆä»–ä»¬å°±ä¼šåœ¨åŒä¸€æ—¶åˆ»è®¿é—®æ•°æ®åº“ï¼Œæ‰§è¡ŒSQLè¯­å¥æŸ¥è¯¢ï¼Œå¯¹æ•°æ®åº“è®¿é—®å‹åŠ›è¿‡å¤§</li>
</ul>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.nlark.com/yuque/0/2023/png/32620241/1681644333844-a9e5cafb-f3a3-484b-897d-dd824dd1ae56.png#averageHue=%23f3f2eb&clientId=u58a9a4fb-4925-4&from=paste&height=242&id=uffb2972d&originHeight=363&originWidth=616&originalType=binary&ratio=1.5&rotation=0&showTitle=false&size=100557&status=done&style=none&taskId=uec3e7ddc-1c40-47b0-919c-eb6ef61e228&title=&width=410.6666666666667" alt="image.png"></p>
<ul>
<li>å¸¸è§çš„è§£å†³æ–¹æ¡ˆæœ‰ä¸¤ç§ <ol>
<li><strong>äº’æ–¥é”</strong>ï¼šåªæœ‰ä¸€ä¸ªçº¿ç¨‹å¤åˆ¶ç¼“å­˜é‡å»ºï¼Œå…¶ä½™çº¿ç¨‹æ‹¿ä¸åˆ°é”ï¼Œå°±ç­‰ç€</li>
</ol>
</li>
</ul>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.nlark.com/yuque/0/2023/png/32620241/1679543412026-b1e927ec-b533-4d63-aac7-aca4447a09e7.png#averageHue=%23ebe9e8&clientId=u1ca47393-cf9e-4&from=paste&id=u1246c27a&name=image.png&originHeight=850&originWidth=655&originalType=url&ratio=1.5&rotation=0&showTitle=false&size=270192&status=done&style=none&taskId=ucf3a57ca-cd09-4be5-84d5-8b200a3d2ca&title=#averageHue=%23ebe9e8&id=ltdNe&originHeight=850&originWidth=655&originalType=binary&ratio=1&rotation=0&showTitle=false&status=done&style=none&title=" alt="image.png"></p>
<ol start="2">
<li><strong>é€»è¾‘è¿‡æœŸï¼š</strong>keyè®¾ç½®ä¸ºæ°¸ä¸è¿‡æœŸï¼Œåœ¨valueä¸­æ·»åŠ å…¶å®ƒå­—æ®µè®°å½•è¿‡æœŸæ—¶é—´ï¼Œä¸šåŠ¡ä¸­æ ¹æ®è¿‡æœŸæ—¶é—´åˆ¤æ–­ç¼“å­˜æ˜¯å¦æœ‰æ•ˆï¼›å¦‚æœç¼“å­˜å·²ç»è¿‡å»ï¼Œåªæœ‰ä¸€ä¸ªçº¿ç¨‹èƒ½æŠ¢åˆ°é”ï¼Œå¼€å¯ç‹¬ç«‹çº¿ç¨‹å»æ›´æ˜¾ç¼“å­˜ï¼Œç„¶åç«‹å³è¿”å›è¿‡æœŸæ•°æ®ï¼›å…¶å®ƒæŠ¢ä¸åˆ°é”çš„çº¿ç¨‹ä¹Ÿç«‹å³è¿”å›è¿‡æœŸæ•°æ®ï¼Œä¸ç”¨ç­‰é”é‡Šæ”¾</li>
</ol>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.nlark.com/yuque/0/2023/png/32620241/1679543465399-9545689e-2892-457a-9b33-d7565a9c85fa.png#averageHue=%23e8e4e3&clientId=u1ca47393-cf9e-4&from=paste&id=u9732ff99&name=image.png&originHeight=757&originWidth=871&originalType=url&ratio=1.5&rotation=0&showTitle=false&size=301880&status=done&style=none&taskId=ua37f95c8-2395-4d6d-994f-b7d6c43d6be&title=#averageHue=%23e8e4e3&id=I5wEH&originHeight=757&originWidth=871&originalType=binary&ratio=1&rotation=0&showTitle=false&status=done&style=none&title=" alt="image.png"><br>æ–¹æ¡ˆä¼˜ç¼ºç‚¹å¯¹æ¯”<br><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.nlark.com/yuque/0/2023/png/32620241/1681644716598-c59d6dc7-e717-4c8a-9e74-74029127550c.png#averageHue=%23f6f5f3&clientId=u58a9a4fb-4925-4&from=paste&height=264&id=u61bbc144&originHeight=396&originWidth=988&originalType=binary&ratio=1.5&rotation=0&showTitle=false&size=101831&status=done&style=none&taskId=uec023c45-9c34-411e-b2b1-cd4a443b723&title=&width=658.6666666666666" alt="image.png"></p>
<h3 id="äº’æ–¥é”"><a href="#äº’æ–¥é”" class="headerlink" title="äº’æ–¥é”"></a>äº’æ–¥é”</h3><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.nlark.com/yuque/0/2023/png/32620241/1679543534010-f84388df-7ad3-4258-933e-8bebdbf75aed.png#averageHue=%23faf5f5&clientId=u1ca47393-cf9e-4&from=paste&id=u2536802d&name=image.png&originHeight=749&originWidth=1076&originalType=url&ratio=1.5&rotation=0&showTitle=false&size=279114&status=done&style=none&taskId=u37a34493-9b09-4c3a-837a-cbd030430b8&title=#averageHue=%23faf5f5&from=url&id=wSBCU&originHeight=749&originWidth=1076&originalType=binary&ratio=1.5&rotation=0&showTitle=false&status=done&style=none&title=" alt="image.png"></p>
<ul>
<li>æ ¸å¿ƒï¼šåˆ©ç”¨redisçš„setnxæ–¹æ³•æ¥è¡¨ç¤ºè·å–é”ï¼Œå¦‚æœredisæ²¡æœ‰è¿™ä¸ªkeyï¼Œåˆ™æ’å…¥æˆåŠŸï¼Œè¿”å›1ï¼Œå¦‚æœå·²ç»å­˜åœ¨è¿™ä¸ªkeyï¼Œåˆ™æ’å…¥å¤±è´¥ï¼Œè¿”å›0ã€‚åœ¨StringRedisTemplateä¸­è¿”å›true&#x2F;falseï¼Œæˆ‘ä»¬å¯ä»¥æ ¹æ®è¿”å›å€¼æ¥åˆ¤æ–­æ˜¯å¦æœ‰çº¿ç¨‹æˆåŠŸè·å–åˆ°äº†é”<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="type">boolean</span> <span class="title function_">tryLock</span><span class="params">(String key)</span> &#123;</span><br><span class="line">    <span class="type">Boolean</span> <span class="variable">flag</span> <span class="operator">=</span> stringRedisTemplate.opsForValue().setIfAbsent(key, <span class="string">&quot;1&quot;</span>, <span class="number">10</span>, TimeUnit.SECONDS);</span><br><span class="line">    <span class="comment">//é¿å…è¿”å›å€¼ä¸ºnullï¼Œæˆ‘ä»¬è¿™é‡Œä½¿ç”¨äº†BooleanUtilå·¥å…·ç±»</span></span><br><span class="line">    <span class="keyword">return</span> BooleanUtil.isTrue(flag);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">unlock</span><span class="params">(String key)</span> &#123;</span><br><span class="line">    stringRedisTemplate.delete(key);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> Shop <span class="title function_">queryWithMutex</span><span class="params">(Long id)</span> &#123;</span><br><span class="line">    <span class="comment">//å…ˆä»Redisä¸­æŸ¥ï¼Œè¿™é‡Œçš„å¸¸é‡å€¼æ˜¯å›ºå®šçš„å‰ç¼€ + åº—é“ºid</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">shopJson</span> <span class="operator">=</span> stringRedisTemplate.opsForValue().get(CACHE_SHOP_KEY + id);</span><br><span class="line">    <span class="comment">//å¦‚æœä¸ä¸ºç©ºï¼ˆæŸ¥è¯¢åˆ°äº†ï¼‰ï¼Œåˆ™è½¬ä¸ºShopç±»å‹ç›´æ¥è¿”å›</span></span><br><span class="line">    <span class="keyword">if</span> (StrUtil.isNotBlank(shopJson)) &#123;</span><br><span class="line">        <span class="type">Shop</span> <span class="variable">shop</span> <span class="operator">=</span> JSONUtil.toBean(shopJson, Shop.class);</span><br><span class="line">        <span class="keyword">return</span> shop;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (shopJson != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">Shop</span> <span class="variable">shop</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">//å¦åˆ™å»æ•°æ®åº“ä¸­æŸ¥</span></span><br><span class="line">        <span class="type">boolean</span> <span class="variable">flag</span> <span class="operator">=</span> tryLock(LOCK_SHOP_KEY + id);</span><br><span class="line">        <span class="keyword">if</span> (!flag) &#123;</span><br><span class="line">            Thread.sleep(<span class="number">50</span>);</span><br><span class="line">            <span class="keyword">return</span> queryWithMutex(id);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//æŸ¥ä¸åˆ°ï¼Œåˆ™å°†ç©ºå€¼å†™å…¥Redis</span></span><br><span class="line">        shop = getById(id);</span><br><span class="line">        <span class="keyword">if</span> (shop == <span class="literal">null</span>) &#123;</span><br><span class="line">            stringRedisTemplate.opsForValue().set(CACHE_SHOP_KEY + id, <span class="string">&quot;&quot;</span>, CACHE_NULL_TTL, TimeUnit.MINUTES);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//æŸ¥åˆ°äº†åˆ™è½¬ä¸ºjsonå­—ç¬¦ä¸²</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">jsonStr</span> <span class="operator">=</span> JSONUtil.toJsonStr(shop);</span><br><span class="line">        <span class="comment">//å¹¶å­˜å…¥redisï¼Œè®¾ç½®TTL</span></span><br><span class="line">        stringRedisTemplate.opsForValue().set(CACHE_SHOP_KEY + id, jsonStr, CACHE_SHOP_TTL, TimeUnit.MINUTES);</span><br><span class="line">        <span class="comment">//æœ€ç»ˆæŠŠæŸ¥è¯¢åˆ°çš„å•†æˆ·ä¿¡æ¯è¿”å›ç»™å‰ç«¯</span></span><br><span class="line">    &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        unlock(LOCK_SHOP_KEY + id);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> shop;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> Result <span class="title function_">queryById</span><span class="params">(Long id)</span> &#123;</span><br><span class="line">    <span class="type">Shop</span> <span class="variable">shop</span> <span class="operator">=</span> queryWithMutex(id);</span><br><span class="line">    <span class="keyword">if</span> (shop == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> Result.fail(<span class="string">&quot;åº—é“ºä¸å­˜åœ¨ï¼ï¼&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> Result.ok(shop);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ul>
<h3 id="é€»è¾‘è¿‡æœŸ"><a href="#é€»è¾‘è¿‡æœŸ" class="headerlink" title="é€»è¾‘è¿‡æœŸ"></a>é€»è¾‘è¿‡æœŸ</h3><ul>
<li>éœ€æ±‚ï¼šæ ¹æ®idæŸ¥è¯¢å•†é“ºçš„ä¸šåŠ¡ï¼ŒåŸºäº<code>é€»è¾‘è¿‡æœŸ</code>æ–¹å¼æ¥è§£å†³ç¼“å­˜å‡»ç©¿é—®é¢˜</li>
<li>æ€è·¯åˆ†æï¼šå½“ç”¨æˆ·å¼€å§‹æŸ¥è¯¢redisæ—¶ï¼Œåˆ¤æ–­æ˜¯å¦å‘½ä¸­<ul>
<li>å¦‚æœæ²¡æœ‰å‘½ä¸­åˆ™ç›´æ¥è¿”å›ç©ºæ•°æ®ï¼Œä¸æŸ¥è¯¢æ•°æ®åº“</li>
<li>å¦‚æœå‘½ä¸­ï¼Œåˆ™å°†valueå–å‡ºï¼Œåˆ¤æ–­valueä¸­çš„è¿‡æœŸæ—¶é—´æ˜¯å¦æ»¡è¶³<ul>
<li>å¦‚æœæ²¡æœ‰è¿‡æœŸï¼Œåˆ™ç›´æ¥è¿”å›redisä¸­çš„æ•°æ®</li>
<li>å¦‚æœè¿‡æœŸï¼Œåˆ™åœ¨å¼€å¯ç‹¬ç«‹çº¿ç¨‹åï¼Œç›´æ¥è¿”å›ä¹‹å‰çš„æ•°æ®ï¼Œç‹¬ç«‹çº¿ç¨‹å»é‡æ„æ•°æ®ï¼Œé‡æ„å®Œæˆåå†é‡Šæ”¾äº’æ–¥é”<a target="_blank" rel="noopener" href="https://pic1.imgdb.cn/item/6355073c16f2c2beb1375808.jpg"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.nlark.com/yuque/0/2023/png/32620241/1679641139130-cbba7b89-062d-408c-8f2f-b0fed1a31915.png#averageHue=%23f8f3f3&clientId=u93ccb212-de26-4&from=paste&id=u59b44c08&name=image.png&originHeight=629&originWidth=1229&originalType=url&ratio=1.5&rotation=0&showTitle=false&size=272539&status=done&style=none&taskId=u0cf0d253-426c-4518-8050-f765cc93ede&title=#averageHue=%23f8f3f3&from=url&id=SOtG0&originHeight=629&originWidth=1229&originalType=binary&ratio=1.5&rotation=0&showTitle=false&status=done&style=none&title=" alt="image.png"></a></li>
</ul>
</li>
</ul>
</li>
<li>å°è£…æ•°æ®ï¼šå› ä¸ºç°åœ¨redisä¸­å­˜å‚¨çš„æ•°æ®çš„valueéœ€è¦å¸¦ä¸Šè¿‡æœŸæ—¶é—´ï¼Œæ­¤æ—¶è¦ä¹ˆä½ å»ä¿®æ”¹åŸæ¥çš„å®ä½“ç±»ï¼Œè¦ä¹ˆæ–°å»ºä¸€ä¸ªç±»åŒ…å«åŸæœ‰çš„æ•°æ®å’Œè¿‡æœŸæ—¶é—´</li>
</ul>
<p>è¿™é‡Œæˆ‘ä»¬é€‰æ‹©æ–°å»ºä¸€ä¸ªå®ä½“ç±»ï¼ŒåŒ…å«åŸæœ‰æ•°æ®(ç”¨ä¸‡èƒ½çš„Object)å’Œè¿‡æœŸæ—¶é—´ï¼Œè¿™æ ·å¯¹åŸæœ‰çš„ä»£ç æ²¡æœ‰ä¾µå…¥æ€§</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RedisData</span>&lt;T&gt; &#123;</span><br><span class="line">    <span class="keyword">private</span> LocalDateTime expireTime;</span><br><span class="line">    <span class="keyword">private</span> T data;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">saveShop2Redis</span><span class="params">(Long id, Long expirSeconds)</span> &#123;</span><br><span class="line">    <span class="type">Shop</span> <span class="variable">shop</span> <span class="operator">=</span> getById(id);</span><br><span class="line">    <span class="type">RedisData</span> <span class="variable">redisData</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RedisData</span>();</span><br><span class="line">    redisData.setData(shop);</span><br><span class="line">    redisData.setExpireTime(LocalDateTime.now().plusSeconds(expirSeconds));</span><br><span class="line">    stringRedisTemplate.opsForValue().set(CACHE_SHOP_KEY + id, JSONUtil.toJsonStr(redisData));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">ExecutorService</span> <span class="variable">CACHE_REBUILD_EXECUTOR</span> <span class="operator">=</span> Executors.newFixedThreadPool(<span class="number">10</span>);</span><br><span class="line"><span class="keyword">public</span> Shop <span class="title function_">queryWithLogicalExpire</span><span class="params">( Long id )</span> &#123;</span><br><span class="line">    <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> CACHE_SHOP_KEY + id;</span><br><span class="line">    <span class="comment">// 1.ä»redisæŸ¥è¯¢å•†é“ºç¼“å­˜</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">json</span> <span class="operator">=</span> stringRedisTemplate.opsForValue().get(key);</span><br><span class="line">    <span class="comment">// 2.åˆ¤æ–­æ˜¯å¦å­˜åœ¨</span></span><br><span class="line">    <span class="keyword">if</span> (StrUtil.isBlank(json)) &#123;</span><br><span class="line">        <span class="comment">// 3.å­˜åœ¨ï¼Œç›´æ¥è¿”å›</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 4.å‘½ä¸­ï¼Œéœ€è¦å…ˆæŠŠjsonååºåˆ—åŒ–ä¸ºå¯¹è±¡</span></span><br><span class="line">    <span class="type">RedisData</span> <span class="variable">redisData</span> <span class="operator">=</span> JSONUtil.toBean(json, RedisData.class);</span><br><span class="line">    <span class="type">Shop</span> <span class="variable">shop</span> <span class="operator">=</span> JSONUtil.toBean((JSONObject) redisData.getData(), Shop.class);</span><br><span class="line">    <span class="type">LocalDateTime</span> <span class="variable">expireTime</span> <span class="operator">=</span> redisData.getExpireTime();</span><br><span class="line">    <span class="comment">// 5.åˆ¤æ–­æ˜¯å¦è¿‡æœŸ</span></span><br><span class="line">    <span class="keyword">if</span>(expireTime.isAfter(LocalDateTime.now())) &#123;</span><br><span class="line">        <span class="comment">// 5.1.æœªè¿‡æœŸï¼Œç›´æ¥è¿”å›åº—é“ºä¿¡æ¯</span></span><br><span class="line">        <span class="keyword">return</span> shop;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 5.2.å·²è¿‡æœŸï¼Œéœ€è¦ç¼“å­˜é‡å»º</span></span><br><span class="line">    <span class="comment">// 6.ç¼“å­˜é‡å»º</span></span><br><span class="line">    <span class="comment">// 6.1.è·å–äº’æ–¥é”</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">lockKey</span> <span class="operator">=</span> LOCK_SHOP_KEY + id;</span><br><span class="line">    <span class="type">boolean</span> <span class="variable">isLock</span> <span class="operator">=</span> tryLock(lockKey);</span><br><span class="line">    <span class="comment">// 6.2.åˆ¤æ–­æ˜¯å¦è·å–é”æˆåŠŸ</span></span><br><span class="line">    <span class="keyword">if</span> (isLock)&#123;</span><br><span class="line">        CACHE_REBUILD_EXECUTOR.submit( ()-&gt;&#123;</span><br><span class="line">            <span class="keyword">try</span>&#123;</span><br><span class="line">                <span class="comment">//é‡å»ºç¼“å­˜</span></span><br><span class="line">                <span class="built_in">this</span>.saveShop2Redis(id,<span class="number">20L</span>);</span><br><span class="line">            &#125;<span class="keyword">catch</span> (Exception e)&#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">            &#125;<span class="keyword">finally</span> &#123;</span><br><span class="line">                unlock(lockKey);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 6.4.è¿”å›è¿‡æœŸçš„å•†é“ºä¿¡æ¯</span></span><br><span class="line">    <span class="keyword">return</span> shop;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="å°è£…Rediså·¥å…·ç±»"><a href="#å°è£…Rediså·¥å…·ç±»" class="headerlink" title="å°è£…Rediså·¥å…·ç±»"></a>å°è£…Rediså·¥å…·ç±»</h2><ul>
<li>åŸºäºStringRedisTemplateå°è£…ä¸€ä¸ªç¼“å­˜å·¥å…·ç±»</li>
<li>æ–¹æ³•ä¸€ï¼šå°†ä»»æ„Javaå¯¹è±¡åºåˆ—åŒ–ä¸ºJSONï¼Œå¹¶å­˜å‚¨åˆ°Stringç±»å‹çš„Keyä¸­ï¼Œå¹¶å¯ä»¥è®¾ç½®TTLè¿‡æœŸæ—¶é—´</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">set</span><span class="params">(String key, Object value, Long time, TimeUnit timeUnit)</span> &#123;</span><br><span class="line">    stringRedisTemplate.opsForValue().set(key, JSONUtil.toJsonStr(value), time, timeUnit);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>æ–¹æ³•2ï¼šå°†ä»»æ„Javaå¯¹è±¡åºåˆ—åŒ–ä¸ºJSONï¼Œå¹¶å­˜å‚¨åœ¨Stringç±»å‹çš„Keyä¸­ï¼Œå¹¶å¯ä»¥è®¾ç½®é€»è¾‘è¿‡æœŸæ—¶é—´ï¼Œç”¨äºå¤„ç†ç¼“å­˜å‡»ç©¿é—®é¢˜</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setWithLogicExpire</span><span class="params">(String key, Object value, Long time, TimeUnit timeUnit)</span> &#123;</span><br><span class="line">    <span class="comment">//ç”±äºéœ€è¦è®¾ç½®é€»è¾‘è¿‡æœŸæ—¶é—´ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦ç”¨åˆ°RedisData</span></span><br><span class="line">    RedisData&lt;Object&gt; redisData = <span class="keyword">new</span> <span class="title class_">RedisData</span>&lt;&gt;();</span><br><span class="line">    <span class="comment">//redisDataçš„dataå°±æ˜¯ä¼ è¿›æ¥çš„valueå¯¹è±¡</span></span><br><span class="line">    redisData.setData(value);</span><br><span class="line">    <span class="comment">//é€»è¾‘è¿‡æœŸæ—¶é—´å°±æ˜¯å½“å‰æ—¶é—´åŠ ä¸Šä¼ è¿›æ¥çš„å‚æ•°æ—¶é—´ï¼Œç”¨TimeUnitå¯ä»¥å°†æ—¶é—´è½¬ä¸ºç§’ï¼Œéšåä¸å½“å‰æ—¶é—´ç›¸åŠ </span></span><br><span class="line">    redisData.setExpireTime(LocalDateTime.now().plusSeconds(timeUnit.toSeconds(time)));</span><br><span class="line">    <span class="comment">//ç”±äºæ˜¯é€»è¾‘è¿‡æœŸï¼Œæ‰€ä»¥è¿™é‡Œä¸éœ€è¦è®¾ç½®è¿‡æœŸæ—¶é—´ï¼Œåªå­˜ä¸€ä¸‹keyå’Œvalueå°±å¥½äº†ï¼ŒåŒæ—¶æ³¨æ„valueæ˜¯ridisDataç±»å‹</span></span><br><span class="line">    stringRedisTemplate.opsForValue().set(key, JSONUtil.toJsonStr(redisData));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æ–¹æ³•3ï¼šæ ¹æ®æŒ‡å®šçš„KeyæŸ¥è¯¢ç¼“å­˜ï¼Œå¹¶ååºåˆ—åŒ–ä¸ºæŒ‡å®šç±»å‹ï¼Œåˆ©ç”¨ç¼“å­˜ç©ºå€¼çš„æ–¹å¼è§£å†³ç¼“å­˜ç©¿é€é—®é¢˜<br>åŸæ¥çš„æ–¹æ³•</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> Shop <span class="title function_">queryWithPassThrough</span><span class="params">(Long id)</span> &#123;</span><br><span class="line">    <span class="comment">//å…ˆä»Redisä¸­æŸ¥ï¼Œè¿™é‡Œçš„å¸¸é‡å€¼æ˜¯å›ºå®šçš„å‰ç¼€ + åº—é“ºid</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">shopJson</span> <span class="operator">=</span> stringRedisTemplate.opsForValue().get(CACHE_SHOP_KEY + id);</span><br><span class="line">    <span class="comment">//å¦‚æœä¸ä¸ºç©ºï¼ˆæŸ¥è¯¢åˆ°äº†ï¼‰ï¼Œåˆ™è½¬ä¸ºShopç±»å‹ç›´æ¥è¿”å›</span></span><br><span class="line">    <span class="keyword">if</span> (StrUtil.isNotBlank(shopJson)) &#123;</span><br><span class="line">        <span class="keyword">return</span> JSONUtil.toBean(shopJson, Shop.class);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (shopjson != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//å¦åˆ™å»æ•°æ®åº“ä¸­æŸ¥</span></span><br><span class="line">    <span class="type">Shop</span> <span class="variable">shop</span> <span class="operator">=</span> getById(id);</span><br><span class="line">    <span class="comment">//æŸ¥ä¸åˆ°ï¼Œåˆ™å°†ç©ºå€¼å†™å…¥Redis</span></span><br><span class="line">    <span class="keyword">if</span> (shop == <span class="literal">null</span>) &#123;</span><br><span class="line">        stringRedisTemplate.opsForValue().set(CACHE_SHOP_KEY + id, <span class="string">&quot;&quot;</span>, CACHE_NULL_TTL, TimeUnit.MINUTES);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//æŸ¥åˆ°äº†åˆ™è½¬ä¸ºjsonå­—ç¬¦ä¸²</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">jsonStr</span> <span class="operator">=</span> JSONUtil.toJsonStr(shop);</span><br><span class="line">    <span class="comment">//å¹¶å­˜å…¥redisï¼Œè®¾ç½®TTL</span></span><br><span class="line">    stringRedisTemplate.opsForValue().set(CACHE_SHOP_KEY + id, jsonStr, CACHE_SHOP_TTL, TimeUnit.MINUTES);</span><br><span class="line">    <span class="comment">//æœ€ç»ˆæŠŠæŸ¥è¯¢åˆ°çš„å•†æˆ·ä¿¡æ¯è¿”å›ç»™å‰ç«¯</span></span><br><span class="line">    <span class="keyword">return</span> shop;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>æ”¹ä¸ºé€šç”¨æ–¹æ³•ï¼Œé‚£ä¹ˆè¿”å›å€¼å°±éœ€è¦è¿›è¡Œä¿®æ”¹ï¼Œä¸èƒ½è¿”å›Shopäº†ï¼Œé‚£æˆ‘ä»¬ç›´æ¥è®¾ç½®ä¸€ä¸ªæ³›å‹ï¼ŒåŒæ—¶IDçš„ç±»å‹ï¼Œä¹Ÿä¸ä¸€å®šéƒ½æ˜¯Longç±»å‹ï¼Œæ‰€ä»¥æˆ‘ä»¬ä¹Ÿé‡‡ç”¨æ³›å‹ã€‚</li>
<li>Keyçš„å‰ç¼€ä¹Ÿä¼šéšç€ä¸šåŠ¡éœ€æ±‚çš„ä¸åŒè€Œä¿®æ”¹ï¼Œæ‰€ä»¥å‚æ•°åˆ—è¡¨é‡Œè¿˜éœ€è¦åŠ å…¥Keyçš„å‰ç¼€</li>
<li>é€šè¿‡idå»æ•°æ®åº“æŸ¥è¯¢çš„å…·ä½“ä¸šåŠ¡éœ€æ±‚æˆ‘ä»¬ä¹Ÿä¸æ¸…æ¥šï¼Œæ‰€ä»¥æˆ‘ä»¬ä¹Ÿè¦åœ¨å‚æ•°åˆ—è¡¨ä¸­åŠ å…¥ä¸€ä¸ªæŸ¥è¯¢æ•°æ®åº“é€»è¾‘çš„å‡½æ•°</li>
<li>æœ€åå†åŠ ä¸Šè®¾ç½®TTLéœ€è¦çš„ä¸¤ä¸ªå‚æ•°</li>
<li>é‚£ä¹ˆç»¼ä¸Šæ‰€è¿°ï¼Œæˆ‘ä»¬çš„å‚æ•°åˆ—è¡¨éœ€è¦ <ol>
<li>keyå‰ç¼€</li>
<li>idï¼ˆç±»å‹æ³›å‹ï¼‰</li>
<li>è¿”å›å€¼ç±»å‹ï¼ˆæ³›å‹ï¼‰</li>
<li>æŸ¥è¯¢çš„å‡½æ•°</li>
<li>TTLéœ€è¦çš„ä¸¤ä¸ªå‚æ•°</li>
</ol>
</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> &lt;R, ID&gt; R <span class="title function_">queryWithPassThrough</span><span class="params">(String keyPrefix, ID id, Class&lt;R&gt; type, Function&lt;ID, R&gt; dbFallback, Long time, TimeUnit timeUnit)</span> &#123;</span><br><span class="line">    <span class="comment">//å…ˆä»Redisä¸­æŸ¥ï¼Œè¿™é‡Œçš„å¸¸é‡å€¼æ˜¯å›ºå®šçš„å‰ç¼€ + åº—é“ºid</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> keyPrefix + id;</span><br><span class="line">    <span class="type">String</span> <span class="variable">json</span> <span class="operator">=</span> stringRedisTemplate.opsForValue().get(key);</span><br><span class="line">    <span class="comment">//å¦‚æœä¸ä¸ºç©ºï¼ˆæŸ¥è¯¢åˆ°äº†ï¼‰ï¼Œåˆ™è½¬ä¸ºRç±»å‹ç›´æ¥è¿”å›</span></span><br><span class="line">    <span class="keyword">if</span> (StrUtil.isNotBlank(json)) &#123;</span><br><span class="line">        <span class="keyword">return</span> JSONUtil.toBean(json, type);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (json != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//å¦åˆ™å»æ•°æ®åº“ä¸­æŸ¥ï¼ŒæŸ¥è¯¢é€»è¾‘ç”¨æˆ‘ä»¬å‚æ•°ä¸­æ³¨å…¥çš„å‡½æ•°</span></span><br><span class="line">    <span class="type">R</span> <span class="variable">r</span> <span class="operator">=</span> dbFallback.apply(id);</span><br><span class="line">    <span class="comment">//æŸ¥ä¸åˆ°ï¼Œåˆ™å°†ç©ºå€¼å†™å…¥Redis</span></span><br><span class="line">    <span class="keyword">if</span> (r == <span class="literal">null</span>) &#123;</span><br><span class="line">        stringRedisTemplate.opsForValue().set(key, <span class="string">&quot;&quot;</span>, CACHE_NULL_TTL, TimeUnit.MINUTES);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//æŸ¥åˆ°äº†åˆ™è½¬ä¸ºjsonå­—ç¬¦ä¸²</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">jsonStr</span> <span class="operator">=</span> JSONUtil.toJsonStr(r);</span><br><span class="line">    <span class="comment">//å¹¶å­˜å…¥redisï¼Œè®¾ç½®TTL</span></span><br><span class="line">    <span class="built_in">this</span>.set(key, jsonStr, time, timeUnit);</span><br><span class="line">    <span class="comment">//æœ€ç»ˆæŠŠæŸ¥è¯¢åˆ°çš„å•†æˆ·ä¿¡æ¯è¿”å›ç»™å‰ç«¯</span></span><br><span class="line">    <span class="keyword">return</span> r;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> Result <span class="title function_">queryById</span><span class="params">(Long id)</span> &#123;</span><br><span class="line">    <span class="type">Shop</span> <span class="variable">shop</span> <span class="operator">=</span> cacheClient.</span><br><span class="line">            queryWithPassThrough(CACHE_SHOP_KEY, id, Shop.class, <span class="built_in">this</span>::getById, CACHE_SHOP_TTL, TimeUnit.MINUTES);</span><br><span class="line">    <span class="keyword">if</span> (shop == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> Result.fail(<span class="string">&quot;åº—é“ºä¸å­˜åœ¨ï¼ï¼&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> Result.ok(shop);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æ–¹æ³•4ï¼šæ ¹æ®æŒ‡å®šçš„KeyæŸ¥è¯¢ç¼“å­˜ï¼Œå¹¶ååºåˆ—åŒ–ä¸ºæŒ‡å®šç±»å‹ï¼Œéœ€è¦åˆ©ç”¨é€»è¾‘è¿‡æœŸè§£å†³ç¼“å­˜å‡»ç©¿é—®é¢˜</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> &lt;R, ID&gt; R <span class="title function_">queryWithLogicalExpire</span><span class="params">(String keyPrefix, ID id, Class&lt;R&gt; type, Function&lt;ID, R&gt; dbFallback, Long time, TimeUnit timeUnit)</span> &#123;</span><br><span class="line">    <span class="comment">//1. ä»redisä¸­æŸ¥è¯¢å•†é“ºç¼“å­˜</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> keyPrefix + id;</span><br><span class="line">    <span class="type">String</span> <span class="variable">json</span> <span class="operator">=</span> stringRedisTemplate.opsForValue().get(key);</span><br><span class="line">    <span class="comment">//2. å¦‚æœæœªå‘½ä¸­ï¼Œåˆ™è¿”å›ç©º</span></span><br><span class="line">    <span class="keyword">if</span> (StrUtil.isBlank(json)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//3. å‘½ä¸­ï¼Œå°†jsonååºåˆ—åŒ–ä¸ºå¯¹è±¡</span></span><br><span class="line">    <span class="type">RedisData</span> <span class="variable">redisData</span> <span class="operator">=</span> JSONUtil.toBean(json, RedisData.class);</span><br><span class="line">    <span class="type">R</span> <span class="variable">r</span> <span class="operator">=</span> JSONUtil.toBean((JSONObject) redisData.getData(), type);</span><br><span class="line">    <span class="type">LocalDateTime</span> <span class="variable">expireTime</span> <span class="operator">=</span> redisData.getExpireTime();</span><br><span class="line">    <span class="comment">//4. åˆ¤æ–­æ˜¯å¦è¿‡æœŸ</span></span><br><span class="line">    <span class="keyword">if</span> (expireTime.isAfter(LocalDateTime.now())) &#123;</span><br><span class="line">        <span class="comment">//5. æœªè¿‡æœŸï¼Œç›´æ¥è¿”å›å•†é“ºä¿¡æ¯</span></span><br><span class="line">        <span class="keyword">return</span> r;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//6. è¿‡æœŸï¼Œå°è¯•è·å–äº’æ–¥é”</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">lockKey</span> <span class="operator">=</span> LOCK_SHOP_KEY + id;</span><br><span class="line">    <span class="type">boolean</span> <span class="variable">flag</span> <span class="operator">=</span> tryLock(lockKey);</span><br><span class="line">    <span class="comment">//7. è·å–åˆ°äº†é”</span></span><br><span class="line">    <span class="keyword">if</span> (flag) &#123;</span><br><span class="line">        <span class="comment">//8. å¼€å¯ç‹¬ç«‹çº¿ç¨‹</span></span><br><span class="line">        CACHE_REBUILD_EXECUTOR.submit(() -&gt; &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="type">R</span> <span class="variable">tmp</span> <span class="operator">=</span> dbFallback.apply(id);</span><br><span class="line">                <span class="built_in">this</span>.setWithLogicExpire(key, tmp, time, timeUnit);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">            &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                unlock(lockKey);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="comment">//9. ç›´æ¥è¿”å›å•†é“ºä¿¡æ¯</span></span><br><span class="line">        <span class="keyword">return</span> r;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//10. æœªè·å–åˆ°é”ï¼Œç›´æ¥è¿”å›å•†é“ºä¿¡æ¯</span></span><br><span class="line">    <span class="keyword">return</span> r;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æ–¹æ³•5ï¼šæ ¹æ®æŒ‡å®šçš„KeyæŸ¥è¯¢ç¼“å­˜ï¼Œå¹¶ååºåˆ—åŒ–ä¸ºæŒ‡å®šç±»å‹ï¼Œéœ€è¦åˆ©ç”¨äº’æ–¥é”è§£å†³ç¼“å­˜å‡»ç©¿é—®é¢˜</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> &lt;R, ID&gt; R <span class="title function_">queryWithMutex</span><span class="params">(String keyPrefix, ID id, Class&lt;R&gt; type, Function&lt;ID, R&gt; dbFallback, Long time, TimeUnit timeUnit)</span> &#123;</span><br><span class="line">    <span class="comment">//å…ˆä»Redisä¸­æŸ¥ï¼Œè¿™é‡Œçš„å¸¸é‡å€¼æ˜¯å›ºå®šçš„å‰ç¼€ + åº—é“ºid</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> keyPrefix + id;</span><br><span class="line">    <span class="type">String</span> <span class="variable">json</span> <span class="operator">=</span> stringRedisTemplate.opsForValue().get(key);</span><br><span class="line">    <span class="comment">//å¦‚æœä¸ä¸ºç©ºï¼ˆæŸ¥è¯¢åˆ°äº†ï¼‰ï¼Œåˆ™è½¬ä¸ºShopç±»å‹ç›´æ¥è¿”å›</span></span><br><span class="line">    <span class="keyword">if</span> (StrUtil.isNotBlank(json)) &#123;</span><br><span class="line">        <span class="keyword">return</span> JSONUtil.toBean(json, type);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (json != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">R</span> <span class="variable">r</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">    <span class="type">String</span> <span class="variable">lockKey</span> <span class="operator">=</span> LOCK_SHOP_KEY + id;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">//å¦åˆ™å»æ•°æ®åº“ä¸­æŸ¥</span></span><br><span class="line">        <span class="type">boolean</span> <span class="variable">flag</span> <span class="operator">=</span> tryLock(lockKey);</span><br><span class="line">        <span class="keyword">if</span> (!flag) &#123;</span><br><span class="line">            Thread.sleep(<span class="number">50</span>);</span><br><span class="line">            <span class="keyword">return</span> queryWithMutex(keyPrefix, id, type, dbFallback, time, timeUnit);</span><br><span class="line">        &#125;</span><br><span class="line">        r = dbFallback.apply(id);</span><br><span class="line">        <span class="comment">//æŸ¥ä¸åˆ°ï¼Œåˆ™å°†ç©ºå€¼å†™å…¥Redis</span></span><br><span class="line">        <span class="keyword">if</span> (r == <span class="literal">null</span>) &#123;</span><br><span class="line">            stringRedisTemplate.opsForValue().set(key, <span class="string">&quot;&quot;</span>, CACHE_NULL_TTL, TimeUnit.MINUTES);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//å¹¶å­˜å…¥redisï¼Œè®¾ç½®TTL</span></span><br><span class="line">        <span class="built_in">this</span>.set(key, r, time, timeUnit);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        unlock(lockKey);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> r;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="å®Œæ•´ä»£ç "><a href="#å®Œæ•´ä»£ç " class="headerlink" title="å®Œæ•´ä»£ç "></a>å®Œæ•´ä»£ç </h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> cn.hutool.core.util.BooleanUtil;</span><br><span class="line"><span class="keyword">import</span> cn.hutool.core.util.StrUtil;</span><br><span class="line"><span class="keyword">import</span> cn.hutool.json.JSONObject;</span><br><span class="line"><span class="keyword">import</span> cn.hutool.json.JSONUtil;</span><br><span class="line"><span class="keyword">import</span> com.hmdp.entity.RedisData;</span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.core.StringRedisTemplate;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.time.LocalDateTime;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.ExecutorService;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.Executors;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.TimeUnit;</span><br><span class="line"><span class="keyword">import</span> java.util.function.Function;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="keyword">static</span> com.hmdp.utils.RedisConstants.*;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CacheClient</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> StringRedisTemplate stringRedisTemplate;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">ExecutorService</span> <span class="variable">CACHE_REBUILD_EXECUTOR</span> <span class="operator">=</span> Executors.newFixedThreadPool(<span class="number">10</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">CacheClient</span><span class="params">(StringRedisTemplate stringRedisTemplate)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.stringRedisTemplate = stringRedisTemplate;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">set</span><span class="params">(String key, Object value, Long time, TimeUnit timeUnit)</span> &#123;</span><br><span class="line">        stringRedisTemplate.opsForValue().set(key, JSONUtil.toJsonStr(value), time, timeUnit);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setWithLogicExpire</span><span class="params">(String key, Object value, Long time, TimeUnit timeUnit)</span> &#123;</span><br><span class="line">        RedisData&lt;Object&gt; redisData = <span class="keyword">new</span> <span class="title class_">RedisData</span>&lt;&gt;();</span><br><span class="line">        redisData.setData(value);</span><br><span class="line">        redisData.setExpireTime(LocalDateTime.now().plusSeconds(timeUnit.toSeconds(time)));</span><br><span class="line">        stringRedisTemplate.opsForValue().set(key, JSONUtil.toJsonStr(redisData));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> &lt;R, ID&gt; R <span class="title function_">queryWithPassThrough</span><span class="params">(String keyPrefix, ID id, Class&lt;R&gt; type, Function&lt;ID, R&gt; dbFallback, Long time, TimeUnit timeUnit)</span> &#123;</span><br><span class="line">        <span class="comment">//å…ˆä»Redisä¸­æŸ¥ï¼Œè¿™é‡Œçš„å¸¸é‡å€¼æ˜¯å›ºå®šçš„å‰ç¼€ + åº—é“ºid</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> keyPrefix + id;</span><br><span class="line">        <span class="type">String</span> <span class="variable">json</span> <span class="operator">=</span> stringRedisTemplate.opsForValue().get(key);</span><br><span class="line">        <span class="comment">//å¦‚æœä¸ä¸ºç©ºï¼ˆæŸ¥è¯¢åˆ°äº†ï¼‰ï¼Œåˆ™è½¬ä¸ºRç±»å‹ç›´æ¥è¿”å›</span></span><br><span class="line">        <span class="keyword">if</span> (StrUtil.isNotBlank(json)) &#123;</span><br><span class="line">            <span class="keyword">return</span> JSONUtil.toBean(json, type);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (json != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//å¦åˆ™å»æ•°æ®åº“ä¸­æŸ¥ï¼ŒæŸ¥è¯¢é€»è¾‘ç”¨æˆ‘ä»¬å‚æ•°ä¸­æ³¨å…¥çš„å‡½æ•°</span></span><br><span class="line">        <span class="type">R</span> <span class="variable">r</span> <span class="operator">=</span> dbFallback.apply(id);</span><br><span class="line">        <span class="comment">//æŸ¥ä¸åˆ°ï¼Œåˆ™å°†ç©ºå€¼å†™å…¥Redis</span></span><br><span class="line">        <span class="keyword">if</span> (r == <span class="literal">null</span>) &#123;</span><br><span class="line">            stringRedisTemplate.opsForValue().set(key, <span class="string">&quot;&quot;</span>, CACHE_NULL_TTL, TimeUnit.MINUTES);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//æŸ¥åˆ°äº†åˆ™è½¬ä¸ºjsonå­—ç¬¦ä¸²</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">jsonStr</span> <span class="operator">=</span> JSONUtil.toJsonStr(r);</span><br><span class="line">        <span class="comment">//å¹¶å­˜å…¥redisï¼Œè®¾ç½®TTL</span></span><br><span class="line">        <span class="built_in">this</span>.set(key, jsonStr, time, timeUnit);</span><br><span class="line">        <span class="comment">//æœ€ç»ˆæŠŠæŸ¥è¯¢åˆ°çš„å•†æˆ·ä¿¡æ¯è¿”å›ç»™å‰ç«¯</span></span><br><span class="line">        <span class="keyword">return</span> r;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> &lt;R, ID&gt; R <span class="title function_">queryWithLogicalExpire</span><span class="params">(String keyPrefix, ID id, Class&lt;R&gt; type, Function&lt;ID, R&gt; dbFallback, Long time, TimeUnit timeUnit)</span> &#123;</span><br><span class="line">        <span class="comment">//1. ä»redisä¸­æŸ¥è¯¢å•†é“ºç¼“å­˜</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> keyPrefix + id;</span><br><span class="line">        <span class="type">String</span> <span class="variable">json</span> <span class="operator">=</span> stringRedisTemplate.opsForValue().get(key);</span><br><span class="line">        <span class="comment">//2. å¦‚æœæœªå‘½ä¸­ï¼Œåˆ™è¿”å›ç©º</span></span><br><span class="line">        <span class="keyword">if</span> (StrUtil.isBlank(json)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//3. å‘½ä¸­ï¼Œå°†jsonååºåˆ—åŒ–ä¸ºå¯¹è±¡</span></span><br><span class="line">        <span class="type">RedisData</span> <span class="variable">redisData</span> <span class="operator">=</span> JSONUtil.toBean(json, RedisData.class);</span><br><span class="line">        <span class="type">R</span> <span class="variable">r</span> <span class="operator">=</span> JSONUtil.toBean((JSONObject) redisData.getData(), type);</span><br><span class="line">        <span class="type">LocalDateTime</span> <span class="variable">expireTime</span> <span class="operator">=</span> redisData.getExpireTime();</span><br><span class="line">        <span class="comment">//4. åˆ¤æ–­æ˜¯å¦è¿‡æœŸ</span></span><br><span class="line">        <span class="keyword">if</span> (expireTime.isAfter(LocalDateTime.now())) &#123;</span><br><span class="line">            <span class="comment">//5. æœªè¿‡æœŸï¼Œç›´æ¥è¿”å›å•†é“ºä¿¡æ¯</span></span><br><span class="line">            <span class="keyword">return</span> r;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//6. è¿‡æœŸï¼Œå°è¯•è·å–äº’æ–¥é”</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">lockKey</span> <span class="operator">=</span> LOCK_SHOP_KEY + id;</span><br><span class="line">        <span class="type">boolean</span> <span class="variable">flag</span> <span class="operator">=</span> tryLock(lockKey);</span><br><span class="line">        <span class="comment">//7. è·å–åˆ°äº†é”</span></span><br><span class="line">        <span class="keyword">if</span> (flag) &#123;</span><br><span class="line">            <span class="comment">//8. å¼€å¯ç‹¬ç«‹çº¿ç¨‹</span></span><br><span class="line">            CACHE_REBUILD_EXECUTOR.submit(() -&gt; &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="type">R</span> <span class="variable">tmp</span> <span class="operator">=</span> dbFallback.apply(id);</span><br><span class="line">                    <span class="built_in">this</span>.setWithLogicExpire(key, tmp, time, timeUnit);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">                &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                    unlock(lockKey);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">            <span class="comment">//9. ç›´æ¥è¿”å›å•†é“ºä¿¡æ¯</span></span><br><span class="line">            <span class="keyword">return</span> r;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//10. æœªè·å–åˆ°é”ï¼Œç›´æ¥è¿”å›å•†é“ºä¿¡æ¯</span></span><br><span class="line">        <span class="keyword">return</span> r;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> &lt;R, ID&gt; R <span class="title function_">queryWithMutex</span><span class="params">(String keyPrefix, ID id, Class&lt;R&gt; type, Function&lt;ID, R&gt; dbFallback, Long time, TimeUnit timeUnit)</span> &#123;</span><br><span class="line">        <span class="comment">//å…ˆä»Redisä¸­æŸ¥ï¼Œè¿™é‡Œçš„å¸¸é‡å€¼æ˜¯å›ºå®šçš„å‰ç¼€ + åº—é“ºid</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> keyPrefix + id;</span><br><span class="line">        <span class="type">String</span> <span class="variable">json</span> <span class="operator">=</span> stringRedisTemplate.opsForValue().get(key);</span><br><span class="line">        <span class="comment">//å¦‚æœä¸ä¸ºç©ºï¼ˆæŸ¥è¯¢åˆ°äº†ï¼‰ï¼Œåˆ™è½¬ä¸ºShopç±»å‹ç›´æ¥è¿”å›</span></span><br><span class="line">        <span class="keyword">if</span> (StrUtil.isNotBlank(json)) &#123;</span><br><span class="line">            <span class="keyword">return</span> JSONUtil.toBean(json, type);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (json != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">R</span> <span class="variable">r</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="type">String</span> <span class="variable">lockKey</span> <span class="operator">=</span> LOCK_SHOP_KEY + id;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">//å¦åˆ™å»æ•°æ®åº“ä¸­æŸ¥</span></span><br><span class="line">            <span class="type">boolean</span> <span class="variable">flag</span> <span class="operator">=</span> tryLock(lockKey);</span><br><span class="line">            <span class="keyword">if</span> (!flag) &#123;</span><br><span class="line">                Thread.sleep(<span class="number">50</span>);</span><br><span class="line">                <span class="keyword">return</span> queryWithMutex(keyPrefix, id, type, dbFallback, time, timeUnit);</span><br><span class="line">            &#125;</span><br><span class="line">            r = dbFallback.apply(id);</span><br><span class="line">            <span class="comment">//æŸ¥ä¸åˆ°ï¼Œåˆ™å°†ç©ºå€¼å†™å…¥Redis</span></span><br><span class="line">            <span class="keyword">if</span> (r == <span class="literal">null</span>) &#123;</span><br><span class="line">                stringRedisTemplate.opsForValue().set(key, <span class="string">&quot;&quot;</span>, CACHE_NULL_TTL, TimeUnit.MINUTES);</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//å¹¶å­˜å…¥redisï¼Œè®¾ç½®TTL</span></span><br><span class="line">            <span class="built_in">this</span>.set(key, r, time, timeUnit);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            unlock(lockKey);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> r;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="type">boolean</span> <span class="title function_">tryLock</span><span class="params">(String key)</span> &#123;</span><br><span class="line">        <span class="type">Boolean</span> <span class="variable">flag</span> <span class="operator">=</span> stringRedisTemplate.opsForValue().setIfAbsent(key, <span class="string">&quot;1&quot;</span>, <span class="number">10</span>, TimeUnit.SECONDS);</span><br><span class="line">        <span class="keyword">return</span> BooleanUtil.isTrue(flag);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">unlock</span><span class="params">(String key)</span> &#123;</span><br><span class="line">        stringRedisTemplate.delete(key);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="åˆ†å¸ƒå¼å…¨å±€idç”Ÿæˆ"><a href="#åˆ†å¸ƒå¼å…¨å±€idç”Ÿæˆ" class="headerlink" title="åˆ†å¸ƒå¼å…¨å±€idç”Ÿæˆ"></a>åˆ†å¸ƒå¼å…¨å±€idç”Ÿæˆ</h1><ul>
<li>å¦‚æœä½¿ç”¨æ•°æ®åº“è‡ªå¢IDå°±ä¼šå­˜åœ¨ä¸€äº›é—®é¢˜ <ol>
<li>idè§„å¾‹æ€§å¤ªæ˜æ˜¾</li>
<li>å—å•è¡¨æ•°æ®é‡çš„é™åˆ¶</li>
</ol>
</li>
<li>å…¨å±€IDç”Ÿæˆå™¨æ˜¯ä¸€ç§åœ¨åˆ†å¸ƒå¼ç³»ç»Ÿä¸‹ç”¨æ¥ç”Ÿæˆå…¨å±€å”¯ä¸€IDçš„å·¥å…·ï¼Œä¸€èˆ¬è¦æ»¡è¶³ä¸€ä¸‹ç‰¹æ€§ <ul>
<li>å”¯ä¸€æ€§</li>
<li>é«˜å¯ç”¨</li>
<li>é«˜æ€§èƒ½</li>
<li>é€’å¢æ€§</li>
<li>å®‰å…¨æ€§</li>
</ul>
</li>
</ul>
<h2 id="è®¾è®¡å®ç°"><a href="#è®¾è®¡å®ç°" class="headerlink" title="è®¾è®¡å®ç°"></a>è®¾è®¡å®ç°</h2><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.nlark.com/yuque/0/2023/png/32620241/1681645376670-917c4244-2986-4587-8bb8-8b3b8ce9f1ad.png#averageHue=%23f7f6f6&clientId=u58a9a4fb-4925-4&from=paste&height=300&id=ue088a6be&originHeight=450&originWidth=970&originalType=binary&ratio=1.5&rotation=0&showTitle=false&size=142203&status=done&style=none&taskId=u93e5b036-dfe7-4b8a-ae16-0521deae911&title=&width=646.6666666666666" alt="image.png"></p>
<ul>
<li>ä¸ºäº†å¢åŠ IDçš„å®‰å…¨æ€§ï¼Œæˆ‘ä»¬å¯ä»¥ä¸ç›´æ¥ä½¿ç”¨Redisè‡ªå¢çš„æ•°å€¼ï¼Œè€Œæ˜¯æ‹¼æ¥ä¸€äº›å…¶ä»–ä¿¡æ¯</li>
<li>IDç»„æˆéƒ¨åˆ† <ul>
<li>ç¬¦å·ä½ï¼š1bitï¼Œæ°¸è¿œä¸º0</li>
<li>æ—¶é—´æˆ³ï¼š31bitï¼Œä»¥ç§’ä¸ºå•ä½ï¼Œå¯ä»¥ä½¿ç”¨69å¹´ï¼ˆ2^31ç§’çº¦ç­‰äº69å¹´ï¼‰</li>
<li>åºåˆ—å·ï¼š32bitï¼Œç§’å†…çš„è®¡æ•°å™¨ï¼Œæ”¯æŒæ¯ç§’ä¼ è¾“2^32ä¸ªä¸åŒID<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RedisIdWorker</span> &#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> StringRedisTemplate stringRedisTemplate;</span><br><span class="line">    <span class="comment">//è®¾ç½®èµ·å§‹æ—¶é—´ï¼Œæˆ‘è¿™é‡Œè®¾å®šçš„æ˜¯2022.01.01 00:00:00</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Long</span> <span class="variable">BEGIN_TIMESTAMP</span> <span class="operator">=</span> <span class="number">1640995200L</span>;</span><br><span class="line">    <span class="comment">//åºåˆ—å·é•¿åº¦</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Long</span> <span class="variable">COUNT_BIT</span> <span class="operator">=</span> <span class="number">32L</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">long</span> <span class="title function_">nextId</span><span class="params">(String keyPrefix)</span>&#123;</span><br><span class="line">        <span class="comment">//1. ç”Ÿæˆæ—¶é—´æˆ³</span></span><br><span class="line">        <span class="type">LocalDateTime</span> <span class="variable">now</span> <span class="operator">=</span> LocalDateTime.now();</span><br><span class="line">        <span class="type">long</span> <span class="variable">currentSecond</span> <span class="operator">=</span> now.toEpochSecond(ZoneOffset.UTC);</span><br><span class="line">        <span class="type">long</span> <span class="variable">timeStamp</span> <span class="operator">=</span> currentSecond - BEGIN_TIMESTAMP;</span><br><span class="line">        <span class="comment">//2. ç”Ÿæˆåºåˆ—å·</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">date</span> <span class="operator">=</span> now.format(DateTimeFormatter.ofPattern(<span class="string">&quot;yyyy:MM:dd&quot;</span>));</span><br><span class="line">        <span class="type">long</span> <span class="variable">count</span> <span class="operator">=</span> stringRedisTemplate.opsForValue().increment(<span class="string">&quot;inc:&quot;</span>+keyPrefix+<span class="string">&quot;:&quot;</span>+date);</span><br><span class="line">        <span class="comment">//3. æ‹¼æ¥å¹¶è¿”å›ï¼Œç®€å•ä½è¿ç®—</span></span><br><span class="line">        <span class="keyword">return</span> timeStamp &lt;&lt; COUNT_BIT | count;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>stringRedisTemplate.opsForValue().increment(â€œinc:â€+keyPrefix+â€:â€+date)æ˜¯Redisä¸­çš„ä¸€ä¸ªåŸå­æ“ä½œï¼Œç”¨äºè·å–æŒ‡å®škeyçš„å€¼å¹¶å°†å…¶è‡ªå¢1ã€‚å…·ä½“è§£é‡Šå¦‚ä¸‹ï¼š</p>
<ul>
<li>stringRedisTemplateæ˜¯ä¸€ä¸ªStringRedisTemplateç±»å‹çš„å¯¹è±¡ï¼Œç”¨äºæ“ä½œRedisä¸­çš„å­—ç¬¦ä¸²ç±»å‹æ•°æ®ã€‚</li>
<li>opsForValue()æ–¹æ³•è¿”å›ä¸€ä¸ªValueOperationsç±»å‹çš„å¯¹è±¡ï¼Œç”¨äºæ“ä½œRedisä¸­çš„å­—ç¬¦ä¸²ç±»å‹æ•°æ®ã€‚</li>
<li>increment(key)æ–¹æ³•ç”¨äºè·å–æŒ‡å®škeyçš„å€¼å¹¶å°†å…¶è‡ªå¢1ã€‚å¦‚æœkeyä¸å­˜åœ¨ï¼Œåˆ™ä¼šå…ˆå°†å…¶åˆå§‹åŒ–ä¸º0ï¼Œç„¶åå†æ‰§è¡Œè‡ªå¢æ“ä½œã€‚</li>
</ul>
</blockquote>
åœ¨è¿™æ®µä»£ç ä¸­ï¼Œâ€inc:â€+keyPrefix+â€:â€+dateæ˜¯ä¸€ä¸ªRedisçš„keyï¼Œç”¨äºå­˜å‚¨æ¯å¤©çš„åºåˆ—å·ã€‚å…¶ä¸­ï¼ŒkeyPrefixæ˜¯ä¸€ä¸ªå‰ç¼€ï¼Œç”¨äºåŒºåˆ†ä¸åŒç§ç±»çš„IDï¼Œdateæ˜¯å½“å‰æ—¥æœŸï¼ˆæ ¼å¼ä¸ºâ€yyyy:MM:ddâ€ï¼‰ï¼Œç”¨äºæŒ‰å¤©å­˜å‚¨åºåˆ—å·ã€‚æ¯æ¬¡è°ƒç”¨increment()æ–¹æ³•æ—¶ï¼Œä¼šè‡ªåŠ¨è·å–å½“å¤©çš„åºåˆ—å·å¹¶å°†å…¶åŠ 1ï¼Œç„¶åè¿”å›åŠ 1åçš„å€¼ã€‚è¿™æ ·å¯ä»¥ä¿è¯æ¯å¤©çš„åºåˆ—å·æ˜¯å”¯ä¸€çš„ï¼Œä¸”æ˜¯è¿ç»­çš„ã€‚</li>
</ul>
</li>
</ul>
<h1 id="ç§’æ€"><a href="#ç§’æ€" class="headerlink" title="ç§’æ€"></a>ç§’æ€</h1><p>æ ¸å¿ƒæµç¨‹ï¼šåˆ¤æ–­æ—¥æœŸï¼ˆæ˜¯å¦å¼€å¯ç»“æŸæ´»åŠ¨ï¼‰å’Œåº“å­˜ã€æ‰£å‡åº“å­˜ã€åˆ›å»ºè®¢å•<br><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.nlark.com/yuque/0/2023/png/32620241/1679646991653-5c59b606-c702-4ca0-a977-996eca0aa82f.png#averageHue=%23faf8f8&clientId=u93ccb212-de26-4&from=paste&height=499&id=u37552472&name=image.png&originHeight=749&originWidth=1410&originalType=binary&ratio=1.5&rotation=0&showTitle=false&size=189490&status=done&style=none&taskId=ubbe33f63-c3d6-431d-afc6-2cc1eee5cba&title=&width=940#averageHue=%23faf8f8&id=OoSSt&originHeight=749&originWidth=1410&originalType=binary&ratio=1&rotation=0&showTitle=false&status=done&style=none&title=" alt="image.png"></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> Result <span class="title function_">seckillVoucher</span><span class="params">(Long voucherId)</span> &#123;</span><br><span class="line">    <span class="comment">// 1.æŸ¥è¯¢ä¼˜æƒ åˆ¸</span></span><br><span class="line">    <span class="type">SeckillVoucher</span> <span class="variable">voucher</span> <span class="operator">=</span> seckillVoucherService.getById(voucherId);</span><br><span class="line">    <span class="comment">// 2.åˆ¤æ–­ç§’æ€æ˜¯å¦å¼€å§‹</span></span><br><span class="line">    <span class="keyword">if</span> (voucher.getBeginTime().isAfter(LocalDateTime.now())) &#123;</span><br><span class="line">        <span class="comment">// å°šæœªå¼€å§‹</span></span><br><span class="line">        <span class="keyword">return</span> Result.fail(<span class="string">&quot;ç§’æ€å°šæœªå¼€å§‹ï¼&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 3.åˆ¤æ–­ç§’æ€æ˜¯å¦å·²ç»ç»“æŸ</span></span><br><span class="line">    <span class="keyword">if</span> (voucher.getEndTime().isBefore(LocalDateTime.now())) &#123;</span><br><span class="line">        <span class="comment">// å°šæœªå¼€å§‹</span></span><br><span class="line">        <span class="keyword">return</span> Result.fail(<span class="string">&quot;ç§’æ€å·²ç»ç»“æŸï¼&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 4.åˆ¤æ–­åº“å­˜æ˜¯å¦å……è¶³</span></span><br><span class="line">    <span class="keyword">if</span> (voucher.getStock() &lt; <span class="number">1</span>) &#123;</span><br><span class="line">        <span class="comment">// åº“å­˜ä¸è¶³</span></span><br><span class="line">        <span class="keyword">return</span> Result.fail(<span class="string">&quot;åº“å­˜ä¸è¶³ï¼&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//5ï¼Œæ‰£å‡åº“å­˜</span></span><br><span class="line">    <span class="type">boolean</span> <span class="variable">success</span> <span class="operator">=</span> seckillVoucherService.update()</span><br><span class="line">            .setSql(<span class="string">&quot;stock= stock -1&quot;</span>)</span><br><span class="line">            .eq(<span class="string">&quot;voucher_id&quot;</span>, voucherId).update();</span><br><span class="line">    <span class="keyword">if</span> (!success) &#123;</span><br><span class="line">        <span class="comment">//æ‰£å‡åº“å­˜</span></span><br><span class="line">        <span class="keyword">return</span> Result.fail(<span class="string">&quot;åº“å­˜ä¸è¶³ï¼&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//6.åˆ›å»ºè®¢å•</span></span><br><span class="line">    <span class="type">VoucherOrder</span> <span class="variable">voucherOrder</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">VoucherOrder</span>();</span><br><span class="line">    <span class="comment">// 6.1.è®¢å•id</span></span><br><span class="line">    <span class="type">long</span> <span class="variable">orderId</span> <span class="operator">=</span> redisIdWorker.nextId(<span class="string">&quot;order&quot;</span>);</span><br><span class="line">    voucherOrder.setId(orderId);</span><br><span class="line">    <span class="comment">// 6.2.ç”¨æˆ·id</span></span><br><span class="line">    <span class="type">Long</span> <span class="variable">userId</span> <span class="operator">=</span> UserHolder.getUser().getId();</span><br><span class="line">    voucherOrder.setUserId(userId);</span><br><span class="line">    <span class="comment">// 6.3.ä»£é‡‘åˆ¸id</span></span><br><span class="line">    voucherOrder.setVoucherId(voucherId);</span><br><span class="line">    save(voucherOrder);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> Result.ok(orderId);</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="è¶…å–é—®é¢˜"><a href="#è¶…å–é—®é¢˜" class="headerlink" title="è¶…å–é—®é¢˜"></a>è¶…å–é—®é¢˜</h2><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.nlark.com/yuque/0/2023/png/32620241/1679647202344-e58f37f3-5d6f-42fb-9087-162a7f3599a3.png#averageHue=%23fcfcfb&clientId=u93ccb212-de26-4&from=paste&height=260&id=fPoGf&name=image.png&originHeight=390&originWidth=676&originalType=binary&ratio=1.5&rotation=0&showTitle=false&size=56981&status=done&style=none&taskId=ud9fea0a2-6b19-428e-a9e6-26e3dc7f29d&title=&width=450.6666666666667#averageHue=%23fcfcfb&id=JWaHy&originHeight=390&originWidth=676&originalType=binary&ratio=1&rotation=0&showTitle=false&status=done&style=none&title=" alt="image.png"><br><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.nlark.com/yuque/0/2023/png/32620241/1679647229131-0b8f954f-cd8b-4132-8ec9-13514f6591fe.png#averageHue=%23f2f2f1&clientId=u93ccb212-de26-4&from=paste&height=559&id=ub3f80388&name=image.png&originHeight=839&originWidth=1667&originalType=binary&ratio=1.5&rotation=0&showTitle=false&size=169407&status=done&style=none&taskId=u8c78f38d-5980-4261-bf58-ea319ddc187&title=&width=1111.3333333333333#averageHue=%23f2f2f1&id=LRYY6&originHeight=839&originWidth=1667&originalType=binary&ratio=1&rotation=0&showTitle=false&status=done&style=none&title=" alt="image.png"></p>
<h3 id="è§£å†³æ–¹æ³•"><a href="#è§£å†³æ–¹æ³•" class="headerlink" title="è§£å†³æ–¹æ³•"></a>è§£å†³æ–¹æ³•</h3><p>è¶…å–é—®é¢˜æ˜¯å…¸å‹çš„å¤šçº¿ç¨‹å®‰å…¨é—®é¢˜ï¼Œé’ˆå¯¹è¿™ä¸€é—®é¢˜çš„å¸¸è§è§£å†³æ–¹æ¡ˆå°±æ˜¯åŠ é”ï¼šè€Œå¯¹äºåŠ é”ï¼Œæˆ‘ä»¬é€šå¸¸æœ‰ä¸¤ç§è§£å†³æ–¹æ¡ˆï¼šè§ä¸‹å›¾ï¼š<br><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.nlark.com/yuque/0/2023/png/32620241/1679647250229-4ea29080-91de-4ed1-abbf-38a7a2883996.png#averageHue=%23f5f0ef&clientId=u93ccb212-de26-4&from=paste&height=394&id=ua7a74957&name=image.png&originHeight=591&originWidth=1423&originalType=binary&ratio=1.5&rotation=0&showTitle=false&size=289141&status=done&style=none&taskId=u5dc24863-8d82-4511-8895-e2f085ac62f&title=&width=948.6666666666666#averageHue=%23f5f0ef&id=vsB9v&originHeight=591&originWidth=1423&originalType=binary&ratio=1&rotation=0&showTitle=false&status=done&style=none&title=" alt="image.png"><br><strong>æ‚²è§‚é”ï¼š</strong><br>æ‚²è§‚é”å¯ä»¥å®ç°å¯¹äºæ•°æ®çš„ä¸²è¡ŒåŒ–æ‰§è¡Œï¼Œæ¯”å¦‚synï¼Œå’Œlockéƒ½æ˜¯æ‚²è§‚é”çš„ä»£è¡¨ï¼ŒåŒæ—¶ï¼Œæ‚²è§‚é”ä¸­åˆå¯ä»¥å†ç»†åˆ†ä¸ºå…¬å¹³é”ï¼Œéå…¬å¹³é”ï¼Œå¯é‡å…¥é”ï¼Œç­‰ç­‰<br><strong>ä¹è§‚é”ï¼š</strong>å‡å®šå¹¶å‘ä¸ä¸€å®šä¼šå†²çªï¼Œæ‰€ä»¥ä¸åŠ é”ï¼Œè€Œæ˜¯é€šè¿‡åˆ¤æ–­æ•°æ®æ˜¯å¦åœ¨æŸ¥å‡ºæ¥ä¹‹åè¢«å…¶å®ƒçº¿ç¨‹ä¿®æ”¹è¿‡ï¼Œæ¥å†³å®šæ˜¯å¦è¿è¡Œæ“ä½œ</p>
<p>ä¹è§‚é”ä¸»è¦æœ‰ç‰ˆæœ¬å·æ³•å’ŒCASä¸¤ç§å®ç°æ–¹å¼</p>
<ul>
<li>ç‰ˆæœ¬å·æ³•ï¼šç»™æ•°æ®å¢åŠ ä¸€ä¸ªç‰ˆæœ¬å·å­—æ®µï¼Œæ¯æ¬¡ä¿®æ”¹æ“ä½œç‰ˆæœ¬å·+1ï¼Œå°±å¯ä»¥é€šè¿‡ç‰ˆæœ¬å·æ¥ç‰‡æ®µæ˜¯å¦æœ‰è¢«ä¿®æ”¹</li>
</ul>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.nlark.com/yuque/0/2023/png/32620241/1681728499601-3cd30a77-3d47-4dbc-9655-6bb84cab5cad.png#averageHue=%23f9f8f8&clientId=uc6d03285-7526-4&from=paste&height=296&id=uda9d781a&originHeight=444&originWidth=988&originalType=binary&ratio=1.5&rotation=0&showTitle=false&size=142224&status=done&style=none&taskId=u082a9274-8b55-401b-a477-ceaa86a7715&title=&width=658.6666666666666" alt="image.png"></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="type">boolean</span> <span class="variable">success</span> <span class="operator">=</span> seckillVoucherService.update()</span><br><span class="line">            .setSql(<span class="string">&quot;stock= stock -1&quot;</span>) <span class="comment">//set stock = stock -1</span></span><br><span class="line">            .eq(<span class="string">&quot;voucher_id&quot;</span>, voucherId)</span><br><span class="line">    .eq(<span class="string">&quot;stock&quot;</span>,voucher.getStock()).update(); <span class="comment">//where id = ï¼Ÿ and stock = ?</span></span><br></pre></td></tr></table></figure>

<ul>
<li>CASæ˜¯å¯¹ä¹è§‚é”çš„ç®€åŒ–ï¼Œå³ç›´æ¥ç”¨ä¸€ä¸ªæ¯æ¬¡éƒ½ä¼šæŸ¥è¯¢å’Œæ›´æ–°çš„å­—æ®µæ¥ä»£æ›¿ç‰ˆæœ¬å·ï¼Œæ¯”å¦‚åº“å­˜stockå­—æ®µ</li>
</ul>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.nlark.com/yuque/0/2023/png/32620241/1681728571837-846cf1f8-e33f-4d01-b9ee-d80fda839660.png#averageHue=%23fafafa&clientId=uc6d03285-7526-4&from=paste&height=291&id=ud413dcfe&originHeight=436&originWidth=980&originalType=binary&ratio=1.5&rotation=0&showTitle=false&size=118694&status=done&style=none&taskId=u3651f5f1-84c5-4127-9cac-89e7b7db72b&title=&width=653.3333333333334" alt="image.png"></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="type">boolean</span> <span class="variable">success</span> <span class="operator">=</span> seckillVoucherService.update()</span><br><span class="line">                .setSql(<span class="string">&quot;stock = stock - 1&quot;</span>)</span><br><span class="line">                .eq(<span class="string">&quot;voucher_id&quot;</span>, voucherId).gt(<span class="string">&quot;stock&quot;</span>, <span class="number">0</span>).update(); <span class="comment">//where id = ? and stock &gt; 0</span></span><br></pre></td></tr></table></figure>
<blockquote>
<ul>
<li>ä¼˜ç‚¹ï¼šæ€§èƒ½å¥½</li>
<li>ç¼ºç‚¹ï¼šå­˜åœ¨æˆåŠŸç‡ä½çš„é—®é¢˜ï¼ˆå¾ˆå¤šäººæŸ¥åˆ°çš„ç‰ˆæœ¬å·æ˜¯ä¸€æ ·çš„ï¼Œç»“æœåªèƒ½æœ‰ä¸€ä¸ªäººæ“ä½œæˆåŠŸï¼‰ï¼Œä½¿ç”¨åˆ†æ®µé”æ¥æ”¹è¿›ã€‚æ¯”å¦‚å°†100ä¸ªåº“å­˜åˆ†ä¸º10åˆ†ï¼Œå¤§å®¶åˆ†åˆ«æŠ¢è¿™10åˆ†</li>
</ul>
</blockquote>
<p>å¯¹äºä»¥ä¸Šåœºæ™¯ï¼Œå…¶å®ä¸ç”¨åˆ¤æ–­stockæ˜¯å¦å˜åŒ–ï¼Œç›´æ¥åˆ¤æ–­stock&gt;0.ä»è€Œä¿è¯æˆåŠŸç‡</p>
<h1 id="ä¸€äººä¸€å•"><a href="#ä¸€äººä¸€å•" class="headerlink" title="ä¸€äººä¸€å•"></a>ä¸€äººä¸€å•</h1><p>éœ€æ±‚ï¼šä¿®æ”¹ç§’æ€ä¸šåŠ¡ï¼Œè¦æ±‚åŒä¸€ä¸ªä¼˜æƒ åˆ¸ï¼Œä¸€ä¸ªç”¨æˆ·åªèƒ½ä¸‹ä¸€å•<br><strong>ç°åœ¨çš„é—®é¢˜åœ¨äºï¼š</strong><br>ä¼˜æƒ å·æ˜¯ä¸ºäº†å¼•æµï¼Œä½†æ˜¯ç›®å‰çš„æƒ…å†µæ˜¯ï¼Œä¸€ä¸ªäººå¯ä»¥æ— é™åˆ¶çš„æŠ¢è¿™ä¸ªä¼˜æƒ å·ï¼Œæ‰€ä»¥æˆ‘ä»¬åº”å½“å¢åŠ ä¸€å±‚é€»è¾‘ï¼Œè®©ä¸€ä¸ªç”¨æˆ·åªèƒ½ä¸‹ä¸€ä¸ªå•ï¼Œè€Œä¸æ˜¯è®©ä¸€ä¸ªç”¨æˆ·ä¸‹å¤šä¸ªå•<br><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.nlark.com/yuque/0/2023/png/32620241/1679647698772-0be59b9c-7fa9-4124-a3bc-30114e7bde16.png#averageHue=%23faf8f8&clientId=u93ccb212-de26-4&from=paste&height=322&id=u87a39ba7&name=image.png&originHeight=483&originWidth=1012&originalType=binary&ratio=1.5&rotation=0&showTitle=false&size=113348&status=done&style=none&taskId=ub57286b9-90f2-4545-bdc8-06f0316af7d&title=&width=674.6666666666666#averageHue=%23faf8f8&id=gQYKJ&originHeight=483&originWidth=1012&originalType=binary&ratio=1&rotation=0&showTitle=false&status=done&style=none&title=" alt="image.png"><br>å› ä¸ºè®¢å•æ˜¯åˆ›å»ºæ•°æ®ï¼Œæ— æ³•ä½¿ç”¨ä¹è§‚é”ï¼Œä½¿ç”¨æ‚²è§‚é”å®ç°</p>
<h2 id="å•æœºå®ç°"><a href="#å•æœºå®ç°" class="headerlink" title="å•æœºå®ç°"></a>å•æœºå®ç°</h2><p>å•æœºéƒ¨ç½²åç«¯æœåŠ¡å™¨æ—¶ï¼Œå¯ä»¥ä½¿ç”¨javaè‡ªå¸¦çš„<code>Synchronized</code>å…³é”®å­—ä½œä¸ºæ‚²è§‚é”<br>æ³¨æ„äº‹é¡¹ï¼š</p>
<ol>
<li><p>Synchronizedé”çš„èŒƒå›´ä¸èƒ½å¤ªå¤§ï¼Œä¸èƒ½é”ä½æ•´ä¸ªå¯¹è±¡ï¼Œä¼šä¸¥é‡å½±å“æ€§èƒ½ã€‚å› ä¸ºæ˜¯ä¸€äººä¸€å•ï¼Œæ‰€ä»¥å¯ä»¥æ¯ä¸ªç”¨æˆ·ä¸€æŠŠç‹¬ç«‹çš„é”</p>
</li>
<li><p>æ³¨æ„ï¼Œé”ä½å¯¹è±¡æ—¶è¦ç”¨<code>toString.intern</code>ï¼Œä¿è¯åŒidçš„ç”¨æˆ·å§‹ç»ˆæ˜¯åŒä¸€ä¸ªå¯¹è±¡ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Transactional</span></span><br><span class="line"><span class="keyword">public</span> Result <span class="title function_">createVoucherOrder</span><span class="params">(Long voucherId)</span> &#123;</span><br><span class="line">    <span class="comment">// ä¸€äººä¸€å•é€»è¾‘</span></span><br><span class="line">    <span class="type">Long</span> <span class="variable">userId</span> <span class="operator">=</span> UserHolder.getUser().getId();</span><br><span class="line">    <span class="keyword">synchronized</span> (userId.toString().intern()) &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">count</span> <span class="operator">=</span> query().eq(<span class="string">&quot;voucherId&quot;</span>, voucherId).eq(<span class="string">&quot;userId&quot;</span>, userId).count();</span><br><span class="line">        <span class="keyword">if</span> (count &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> Result.fail(<span class="string">&quot;ä½ å·²ç»æŠ¢è¿‡ä¼˜æƒ åˆ¸äº†å“¦&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//5. æ‰£å‡åº“å­˜</span></span><br><span class="line">        <span class="type">boolean</span> <span class="variable">success</span> <span class="operator">=</span> seckillVoucherService.update()</span><br><span class="line">                .setSql(<span class="string">&quot;stock = stock - 1&quot;</span>)</span><br><span class="line">                .eq(<span class="string">&quot;voucher_id&quot;</span>, voucherId)</span><br><span class="line">                .gt(<span class="string">&quot;stock&quot;</span>, <span class="number">0</span>)</span><br><span class="line">                .update();</span><br><span class="line">        <span class="keyword">if</span> (!success) &#123;</span><br><span class="line">            <span class="keyword">return</span> Result.fail(<span class="string">&quot;åº“å­˜ä¸è¶³&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//6. åˆ›å»ºè®¢å•</span></span><br><span class="line">        <span class="type">VoucherOrder</span> <span class="variable">voucherOrder</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">VoucherOrder</span>();</span><br><span class="line">        <span class="comment">//6.1 è®¾ç½®è®¢å•id</span></span><br><span class="line">        <span class="type">long</span> <span class="variable">orderId</span> <span class="operator">=</span> redisIdWorker.nextId(<span class="string">&quot;order&quot;</span>);</span><br><span class="line">        <span class="comment">//6.2 è®¾ç½®ç”¨æˆ·id</span></span><br><span class="line">        <span class="type">Long</span> <span class="variable">id</span> <span class="operator">=</span> UserHolder.getUser().getId();</span><br><span class="line">        <span class="comment">//6.3 è®¾ç½®ä»£é‡‘åˆ¸id</span></span><br><span class="line">        voucherOrder.setVoucherId(voucherId);</span><br><span class="line">        voucherOrder.setId(orderId);</span><br><span class="line">        voucherOrder.setUserId(id);</span><br><span class="line">        <span class="comment">//7. å°†è®¢å•æ•°æ®ä¿å­˜åˆ°è¡¨ä¸­</span></span><br><span class="line">        save(voucherOrder);</span><br><span class="line">        <span class="comment">//8. è¿”å›è®¢å•id</span></span><br><span class="line">        <span class="keyword">return</span> Result.ok(orderId);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//æ‰§è¡Œåˆ°è¿™é‡Œï¼Œé”å·²ç»è¢«é‡Šæ”¾äº†ï¼Œä½†æ˜¯å¯èƒ½å½“å‰äº‹åŠ¡è¿˜æœªæäº¤ï¼Œå¦‚æœæ­¤æ—¶æœ‰çº¿ç¨‹è¿›æ¥ï¼Œä¸èƒ½ç¡®ä¿äº‹åŠ¡ä¸å‡ºé—®é¢˜</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>userId.toString().intern()æ˜¯Javaä¸­çš„å­—ç¬¦ä¸²å¸¸é‡æ± ï¼ˆString Poolï¼‰æœºåˆ¶ï¼Œç”¨äºå°†å­—ç¬¦ä¸²å¯¹è±¡æ”¾å…¥å¸¸é‡æ± ä¸­ï¼Œå¹¶è¿”å›å¸¸é‡æ± ä¸­çš„å¼•ç”¨ã€‚å…·ä½“è§£é‡Šå¦‚ä¸‹ï¼š</p>
<ul>
<li>userIdæ˜¯ä¸€ä¸ªLongç±»å‹çš„å¯¹è±¡ï¼Œè°ƒç”¨toString()æ–¹æ³•å¯ä»¥å°†å…¶è½¬æ¢ä¸ºå­—ç¬¦ä¸²ç±»å‹ã€‚</li>
<li>intern()æ–¹æ³•æ˜¯Stringç±»ä¸­çš„ä¸€ä¸ªæ–¹æ³•ï¼Œç”¨äºå°†å­—ç¬¦ä¸²å¯¹è±¡æ”¾å…¥å¸¸é‡æ± ä¸­ï¼Œå¹¶è¿”å›å¸¸é‡æ± ä¸­çš„å¼•ç”¨ã€‚</li>
<li>å½“è°ƒç”¨intern()æ–¹æ³•æ—¶ï¼ŒJVMé¦–å…ˆæ£€æŸ¥å¸¸é‡æ± ä¸­æ˜¯å¦å·²ç»å­˜åœ¨ç›¸åŒå€¼çš„å­—ç¬¦ä¸²å¯¹è±¡ï¼Œå¦‚æœå­˜åœ¨ï¼Œåˆ™è¿”å›å¸¸é‡æ± ä¸­çš„å¼•ç”¨ï¼›å¦‚æœä¸å­˜åœ¨ï¼Œåˆ™å°†è¯¥å­—ç¬¦ä¸²å¯¹è±¡æ”¾å…¥å¸¸é‡æ± ä¸­ï¼Œç„¶åè¿”å›å¸¸é‡æ± ä¸­çš„å¼•ç”¨ã€‚</li>
<li>è¦æ³¨æ„å³ä½¿æ˜¯toStringï¼ˆï¼‰æ¯æ¬¡åˆ›å»ºéƒ½éƒ½æ˜¯ä¸€ä¸ªæ–°å¯¹è±¡ï¼Œå¦‚æœæˆ‘ä»¬ç›´æ¥ä½¿ç”¨userId.toString() ä»–æ‹¿åˆ°çš„å¯¹è±¡å®é™…ä¸Šæ˜¯ä¸åŒçš„å¯¹è±¡ï¼Œnewå‡ºæ¥çš„å¯¹è±¡ï¼Œæˆ‘ä»¬ä½¿ç”¨é”å¿…é¡»ä¿è¯é”å¿…é¡»æ˜¯åŒä¸€æŠŠï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦ä½¿ç”¨intern()æ–¹æ³•</li>
</ul>
</blockquote>
</li>
<li><p>Synchronizedå¿…é¡»åœ¨ä½¿ç”¨<code>@Transactional</code>æ³¨è§£çš„æ–¹æ³•å¤–å±‚ä½¿ç”¨ï¼Œå› ä¸º<code>@Transactional</code>æ˜¯ä½¿ç”¨åŠ¨æ€ä»£ç†ï¼Œåœ¨æ–¹æ³•æ‰§è¡Œç»“æŸåæ‰æäº¤äº‹åŠ¡ã€‚å¦‚æœæŠŠSynchronizedå†™åœ¨äº‹åŠ¡æ–¹æ³•å†…ï¼Œæäº¤äº‹åŠ¡å‰é”å·²ç»é‡Šæ”¾ï¼Œä½†æ­¤æ—¶æ•°æ®è¿˜æœªæ›´æ–°ï¼Œå…¶å®ƒçº¿ç¨‹ä¾ç„¶èƒ½è·å–é”å¹¶é¡ºåˆ©æ‰§è¡Œ</p>
</li>
<li><p>è°ƒç”¨äº‹åŠ¡æ–¹æ³•æ—¶ä¸èƒ½ç”¨thiså¯¹è±¡ï¼Œå› ä¸º@Transactionalæ³¨è§£å®é™…ä¸Šæ˜¯è°ƒç”¨Springç”Ÿæˆçš„ä»£ç†å¯¹è±¡çš„æ–¹æ³•ï¼Œå¦‚æœè°ƒç”¨thiså¯¹è±¡çš„æ–¹æ³•ä¼šæ— æ³•ä½¿ç”¨äº‹åŠ¡åŠŸèƒ½ï¼Œæ‰€ä»¥è¦è·å–ä»£ç†å¯¹è±¡å¹¶è°ƒç”¨</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="type">Long</span> <span class="variable">userId</span> <span class="operator">=</span> UserHolder.getUser().getId();</span><br><span class="line"><span class="keyword">synchronized</span> (userId.toString().intern()) &#123;</span><br><span class="line">    <span class="keyword">return</span> createVoucherOrder(voucherId);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Transactional</span></span><br><span class="line"><span class="keyword">public</span> Result <span class="title function_">createVoucherOrder</span><span class="params">(Long voucherId)</span> &#123;</span><br><span class="line">    <span class="comment">// ä¸€äººä¸€å•é€»è¾‘</span></span><br><span class="line">    <span class="type">Long</span> <span class="variable">userId</span> <span class="operator">=</span> UserHolder.getUser().getId();</span><br><span class="line">    <span class="type">int</span> <span class="variable">count</span> <span class="operator">=</span> query().eq(<span class="string">&quot;voucherId&quot;</span>, voucherId).eq(<span class="string">&quot;userId&quot;</span>, userId).count();</span><br><span class="line">    <span class="keyword">if</span> (count &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> Result.fail(<span class="string">&quot;ä½ å·²ç»æŠ¢è¿‡ä¼˜æƒ åˆ¸äº†å“¦&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//5. æ‰£å‡åº“å­˜</span></span><br><span class="line">    <span class="type">boolean</span> <span class="variable">success</span> <span class="operator">=</span> seckillVoucherService.update()</span><br><span class="line">            .setSql(<span class="string">&quot;stock = stock - 1&quot;</span>)</span><br><span class="line">            .eq(<span class="string">&quot;voucher_id&quot;</span>, voucherId)</span><br><span class="line">            .gt(<span class="string">&quot;stock&quot;</span>, <span class="number">0</span>)</span><br><span class="line">            .update();</span><br><span class="line">    <span class="keyword">if</span> (!success) &#123;</span><br><span class="line">        <span class="keyword">return</span> Result.fail(<span class="string">&quot;åº“å­˜ä¸è¶³&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//6. åˆ›å»ºè®¢å•</span></span><br><span class="line">    <span class="type">VoucherOrder</span> <span class="variable">voucherOrder</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">VoucherOrder</span>();</span><br><span class="line">    <span class="comment">//6.1 è®¾ç½®è®¢å•id</span></span><br><span class="line">    <span class="type">long</span> <span class="variable">orderId</span> <span class="operator">=</span> redisIdWorker.nextId(<span class="string">&quot;order&quot;</span>);</span><br><span class="line">    <span class="comment">//6.2 è®¾ç½®ç”¨æˆ·id</span></span><br><span class="line">    <span class="type">Long</span> <span class="variable">id</span> <span class="operator">=</span> UserHolder.getUser().getId();</span><br><span class="line">    <span class="comment">//6.3 è®¾ç½®ä»£é‡‘åˆ¸id</span></span><br><span class="line">    voucherOrder.setVoucherId(voucherId);</span><br><span class="line">    voucherOrder.setId(orderId);</span><br><span class="line">    voucherOrder.setUserId(id);</span><br><span class="line">    <span class="comment">//7. å°†è®¢å•æ•°æ®ä¿å­˜åˆ°è¡¨ä¸­</span></span><br><span class="line">    save(voucherOrder);</span><br><span class="line">    <span class="comment">//8. è¿”å›è®¢å•id</span></span><br><span class="line">    <span class="keyword">return</span> Result.ok(orderId);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ol>
<h2 id="åˆ†å¸ƒå¼å®ç°"><a href="#åˆ†å¸ƒå¼å®ç°" class="headerlink" title="åˆ†å¸ƒå¼å®ç°"></a>åˆ†å¸ƒå¼å®ç°</h2><p>Synchronizedå…³é”®å­—åªå¯¹å•ä¸ªJVMæœ‰æ•ˆï¼Œå¤šæœºéƒ¨ç½²æ—¶è¿˜æ˜¯å¯èƒ½ä¼šåŒæ—¶æœ‰å¤šä¸ªä¸åŒJVMçš„çº¿ç¨‹è®¿é—®å·²åŠ é”çš„æ–¹æ³•<br><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.nlark.com/yuque/0/2023/png/32620241/1679654809416-a086161e-8482-4942-97ce-e6fb2f4ea697.png#averageHue=%23eeebea&clientId=u93ccb212-de26-4&from=paste&height=502&id=u64fa1957&name=image.png&originHeight=753&originWidth=1708&originalType=binary&ratio=1.5&rotation=0&showTitle=false&size=355271&status=done&style=none&taskId=u79aa1e21-6d1a-4647-a2dd-1057e9a8aeb&title=&width=1138.6666666666667#averageHue=%23eeebea&id=gymaM&originHeight=753&originWidth=1708&originalType=binary&ratio=1&rotation=0&showTitle=false&status=done&style=none&title=" alt="image.png"><br>å› æ­¤ï¼Œæˆ‘ä»¬ä¸èƒ½æŠŠé”å­˜å‚¨åˆ°å•ä¸ªæœåŠ¡å™¨ä¸Šï¼Œè€Œæ˜¯åº”è¯¥ä½¿ç”¨ä¸€ä¸ªé›†ä¸­çš„å­˜å‚¨æ¥ç®¡ç†é”ï¼Œæ‰€æœ‰çš„è¿›ç¨‹éƒ½èƒ½è¯»åˆ°ä»–ï¼Œè¿™å°±éœ€è¦åˆ†å¸ƒå¼é”</p>
<h2 id="åˆ†å¸ƒå¼é”"><a href="#åˆ†å¸ƒå¼é”" class="headerlink" title="åˆ†å¸ƒå¼é”"></a>åˆ†å¸ƒå¼é”</h2><ul>
<li>åˆ†å¸ƒå¼é”ï¼šæ»¡è¶³åˆ†å¸ƒå¼ç³»ç»Ÿæˆ–é›†ç¾¤æ¨¡å¼ä¸‹å¤šè¿›ç¨‹å¯è§å¹¶ä¸”äº’æ–¥çš„é”ã€‚</li>
<li>åˆ†å¸ƒå¼é”çš„ä¸¤ä¸ªåŸºæœ¬ç‰¹å¾ï¼š<ul>
<li>å¤šè¿›ç¨‹ï¼ˆçº¿ç¨‹ï¼‰å¯è§ï¼ˆè¯»å†™ï¼‰</li>
<li>äº’æ–¥</li>
</ul>
</li>
<li>è¿˜åº”å…·å¤‡çš„ç‰¹å¾<ul>
<li>é«˜å¯ç”¨ï¼šä¸èƒ½æŒ‚æœº</li>
<li>é«˜æ€§èƒ½ï¼šè¯»å†™è¦å¿«</li>
<li>å®‰å…¨æ€§ï¼šä¸èƒ½å‡ºç°æ­»é”</li>
</ul>
</li>
</ul>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.nlark.com/yuque/0/2023/png/32620241/1679654873984-7edb8dfc-bd42-4e89-bade-1b22d4111a25.png#averageHue=%23f2f1f1&clientId=u93ccb212-de26-4&from=paste&height=541&id=ude651043&name=image.png&originHeight=812&originWidth=1591&originalType=binary&ratio=1.5&rotation=0&showTitle=false&size=358347&status=done&style=none&taskId=u2ee91661-0d92-4c29-8dc0-56ef3d5b2af&title=&width=1060.6666666666667#averageHue=%23f2f1f1&id=WAxUQ&originHeight=812&originWidth=1591&originalType=binary&ratio=1&rotation=0&showTitle=false&status=done&style=none&title=" alt="image.png"></p>
<h3 id="å®ç°æ–¹å¼"><a href="#å®ç°æ–¹å¼" class="headerlink" title="å®ç°æ–¹å¼"></a>å®ç°æ–¹å¼</h3><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.nlark.com/yuque/0/2023/png/32620241/1679654888124-ca0a7120-a8fe-41f4-8ccb-6efc145a2134.png#averageHue=%23d6c0bf&clientId=u93ccb212-de26-4&from=paste&height=403&id=u652eccc7&name=image.png&originHeight=604&originWidth=1685&originalType=binary&ratio=1.5&rotation=0&showTitle=false&size=203873&status=done&style=none&taskId=ue89bcda7-7fda-4cfc-ac1b-b4f3201ddd9&title=&width=1123.3333333333333#averageHue=%23d6c0bf&id=FhCMD&originHeight=604&originWidth=1685&originalType=binary&ratio=1&rotation=0&showTitle=false&status=done&style=none&title=" alt="image.png"></p>
<h3 id="Redisåˆ†å¸ƒå¼é”å®ç°"><a href="#Redisåˆ†å¸ƒå¼é”å®ç°" class="headerlink" title="Redisåˆ†å¸ƒå¼é”å®ç°"></a>Redisåˆ†å¸ƒå¼é”å®ç°</h3><p>å®ç°åˆ†å¸ƒå¼é”æ—¶éœ€è¦å®ç°çš„ä¸¤ä¸ªåŸºæœ¬æ–¹æ³•ï¼š</p>
<ul>
<li>è·å–é”ï¼ˆsetnxï¼‰ï¼š <ul>
<li>äº’æ–¥ï¼šç¡®ä¿åªèƒ½æœ‰ä¸€ä¸ªçº¿ç¨‹è·å–é”</li>
<li>éé˜»å¡ï¼šå°è¯•ä¸€æ¬¡ï¼ŒæˆåŠŸè¿”å›trueï¼Œå¤±è´¥è¿”å›false</li>
</ul>
</li>
</ul>
<p>æ³¨æ„äº‹é¡¹ï¼š</p>
<ol>
<li>ä¸ºäº†é˜²æ­¢setnxåå°±å®•æœºäº†å¯¼è‡´lockæ°¸ä¹…å­˜åœ¨ï¼Œå¿…é¡»ç§ç”¨set [key] ex nxçš„åŸå­å‘½ä»¤ï¼Œä¿è¯æ¯ä¸ªlockéƒ½æœ‰è¿‡æœŸæ—¶é—´</li>
</ol>
<ul>
<li>é‡Šæ”¾é”ï¼š <ul>
<li>ä¸»åŠ¨é‡Šæ”¾ï¼šä¸šåŠ¡æ‰§è¡Œå®Œååˆ é™¤keyï¼Œæ³¨æ„éœ€è¦æŠŠé”é‡Šæ”¾çš„é€»è¾‘æ”¾åˆ°finallyé‡Œä¿è¯ä¸€å®šæ‰§è¡Œ</li>
<li>è¶…æ—¶é‡Šæ”¾ï¼šè·å–é”æ—¶æ·»åŠ ä¸€ä¸ªè¶…æ—¶æ—¶é—´<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SimpleRedisLock</span> <span class="keyword">implements</span> <span class="title class_">ILock</span> &#123;</span><br><span class="line">    <span class="comment">//é”çš„å‰ç¼€</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">KEY_PREFIX</span> <span class="operator">=</span> <span class="string">&quot;lock:&quot;</span>;</span><br><span class="line">    <span class="comment">//å…·ä½“ä¸šåŠ¡åç§°ï¼Œå°†å‰ç¼€å’Œä¸šåŠ¡åæ‹¼æ¥ä¹‹åå½“åšKey</span></span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="comment">//è¿™é‡Œä¸éœ€è¦@Autowiredï¼Œå› ä¸ºè¯¥å¯¹è±¡æ˜¯æˆ‘ä»¬ä½¿ç”¨æ„é€ å‡½æ•°æ‰‹åŠ¨newå‡ºæ¥çš„</span></span><br><span class="line">    <span class="keyword">private</span> StringRedisTemplate stringRedisTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">SimpleRedisLock</span><span class="params">(String name, StringRedisTemplate stringRedisTemplate)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.name = name;</span><br><span class="line">        <span class="built_in">this</span>.stringRedisTemplate = stringRedisTemplate;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">tryLock</span><span class="params">(<span class="type">long</span> timeoutSec)</span> &#123;</span><br><span class="line">        <span class="comment">//è·å–çº¿ç¨‹æ ‡è¯†</span></span><br><span class="line">        <span class="type">long</span> <span class="variable">threadId</span> <span class="operator">=</span> Thread.currentThread().getId();</span><br><span class="line">        <span class="comment">//è·å–é”ï¼Œä½¿ç”¨SETNXæ–¹æ³•è¿›è¡ŒåŠ é”ï¼ŒåŒæ—¶è®¾ç½®è¿‡æœŸæ—¶é—´ï¼Œé˜²æ­¢æ­»é”</span></span><br><span class="line">        <span class="type">Boolean</span> <span class="variable">success</span> <span class="operator">=</span> stringRedisTemplate.opsForValue().setIfAbsent(KEY_PREFIX + name, threadId + <span class="string">&quot;&quot;</span>, timeoutSec, TimeUnit.SECONDS);</span><br><span class="line">        <span class="comment">//è‡ªåŠ¨æ‹†ç®±å¯èƒ½ä¼šå‡ºç°nullï¼Œè¿™æ ·å†™æ›´ç¨³å¦¥</span></span><br><span class="line">        <span class="keyword">return</span> Boolean.TRUE.equals(success);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">unlock</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">//é€šè¿‡DELæ¥åˆ é™¤é”</span></span><br><span class="line">        stringRedisTemplate.delete(KEY_PREFIX + name);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="type">Long</span> <span class="variable">userId</span> <span class="operator">=</span> UserHolder.getUser().getId();</span><br><span class="line"><span class="comment">// åˆ›å»ºé”å¯¹è±¡</span></span><br><span class="line"><span class="type">SimpleRedisLock</span> <span class="variable">redisLock</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SimpleRedisLock</span>(<span class="string">&quot;order:&quot;</span> + userId, stringRedisTemplate);</span><br><span class="line"><span class="comment">// è·å–é”å¯¹è±¡</span></span><br><span class="line"><span class="type">boolean</span> <span class="variable">isLock</span> <span class="operator">=</span> redisLock.tryLock(<span class="number">120</span>);</span><br><span class="line"><span class="comment">// åŠ é”å¤±è´¥ï¼Œè¯´æ˜å½“å‰ç”¨æˆ·å¼€äº†å¤šä¸ªçº¿ç¨‹æŠ¢ä¼˜æƒ åˆ¸ï¼Œä½†æ˜¯ç”±äºkeyæ˜¯SETNXçš„ï¼Œæ‰€ä»¥ä¸èƒ½åˆ›å»ºkeyï¼Œå¾—ç­‰keyçš„TTLåˆ°æœŸæˆ–é‡Šæ”¾é”ï¼ˆåˆ é™¤keyï¼‰</span></span><br><span class="line"><span class="keyword">if</span> (!isLock) &#123;</span><br><span class="line">    <span class="keyword">return</span> Result.fail(<span class="string">&quot;ä¸å…è®¸æŠ¢å¤šå¼ ä¼˜æƒ åˆ¸&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="comment">// è·å–ä»£ç†å¯¹è±¡</span></span><br><span class="line">    <span class="type">IVoucherOrderService</span> <span class="variable">proxy</span> <span class="operator">=</span> (IVoucherOrderService) AopContext.currentProxy();</span><br><span class="line">    <span class="keyword">return</span> proxy.createVoucherOrder(voucherId);</span><br><span class="line">&#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">    <span class="comment">// é‡Šæ”¾é”</span></span><br><span class="line">    redisLock.unlock();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
</ul>
<ol>
<li><p>æ³¨æ„è¿™è¾¹ä½¿ç”¨ä»£ç†è¦æ·»åŠ ä¾èµ–</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.aspectj<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>aspectjweaver<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>å¯åŠ¨ç±»ä¸ŠåŠ æ³¨è§£ @EnableAspectJAutoProxy(exposeProxy &#x3D; true)</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@EnableAspectJAutoProxy(exposeProxy = true)</span></span><br></pre></td></tr></table></figure></li>
</ol>
<h3 id="åˆ†å¸ƒå¼é”è¯¯åˆ æƒ…å†µ"><a href="#åˆ†å¸ƒå¼é”è¯¯åˆ æƒ…å†µ" class="headerlink" title="åˆ†å¸ƒå¼é”è¯¯åˆ æƒ…å†µ"></a>åˆ†å¸ƒå¼é”è¯¯åˆ æƒ…å†µ</h3><h4 id="æƒ…å†µ1"><a href="#æƒ…å†µ1" class="headerlink" title="æƒ…å†µ1"></a>æƒ…å†µ1</h4><p>é€»è¾‘è¯´æ˜</p>
<ul>
<li>æŒæœ‰é”çš„çº¿ç¨‹1åœ¨é”çš„å†…éƒ¨å‡ºç°äº†é˜»å¡ï¼Œå¯¼è‡´ä»–çš„é”TTLåˆ°æœŸï¼Œè‡ªåŠ¨é‡Šæ”¾</li>
<li>æ­¤æ—¶çº¿ç¨‹2ä¹Ÿæ¥å°è¯•è·å–é”ï¼Œç”±äºçº¿ç¨‹1å·²ç»é‡Šæ”¾äº†é”ï¼Œæ‰€ä»¥çº¿ç¨‹2å¯ä»¥æ‹¿åˆ°</li>
<li>ä½†æ˜¯ç°åœ¨çº¿ç¨‹1é˜»å¡å®Œäº†ï¼Œç»§ç»­å¾€ä¸‹æ‰§è¡Œï¼Œè¦å¼€å§‹é‡Šæ”¾é”äº†</li>
<li>é‚£ä¹ˆæ­¤æ—¶å°±ä¼šå°†å±äºçº¿ç¨‹2çš„é”é‡Šæ”¾ï¼Œè¿™å°±æ˜¯è¯¯åˆ åˆ«äººé”çš„æƒ…å†µ</li>
</ul>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.nlark.com/yuque/0/2023/png/32620241/1681730800881-831ff771-8996-4614-a0a4-94bb2061c416.png#averageHue=%23f9f9f8&clientId=uc6d03285-7526-4&from=paste&height=279&id=u4a0557b9&originHeight=418&originWidth=985&originalType=binary&ratio=1.5&rotation=0&showTitle=false&size=120152&status=done&style=none&taskId=u0451b92c-d775-40c2-8334-950811ed9db&title=&width=656.6666666666666" alt="image.png"><br>è§£å†³æ–¹æ¡ˆ</p>
<ul>
<li>è§£å†³æ–¹æ¡ˆå°±æ˜¯åœ¨æ¯ä¸ªçº¿ç¨‹é‡Šæ”¾é”çš„æ—¶å€™ï¼Œéƒ½åˆ¤æ–­ä¸€ä¸‹è¿™ä¸ªé”æ˜¯ä¸æ˜¯è‡ªå·±çš„ï¼ˆè·å–é”çš„æ—¶å€™åœ¨valueä¸­å­˜å…¥[æœ¬æœºæ ‡è¯†+çº¿ç¨‹id]ï¼‰ï¼Œå¦‚æœä¸å±äºè‡ªå·±ï¼Œåˆ™ä¸è¿›è¡Œåˆ é™¤æ“ä½œã€‚</li>
<li>å‡è®¾è¿˜æ˜¯ä¸Šé¢çš„æƒ…å†µï¼Œçº¿ç¨‹1é˜»å¡ï¼Œé”è‡ªåŠ¨é‡Šæ”¾ï¼Œçº¿ç¨‹2è¿›å…¥åˆ°é”çš„å†…éƒ¨æ‰§è¡Œé€»è¾‘ï¼Œæ­¤æ—¶çº¿ç¨‹1é˜»å¡å®Œäº†ï¼Œç»§ç»­å¾€ä¸‹æ‰§è¡Œï¼Œå¼€å§‹åˆ é™¤é”ï¼Œä½†æ˜¯çº¿ç¨‹1å‘ç°è¿™æŠŠé”ä¸æ˜¯è‡ªå·±çš„ï¼Œæ‰€ä»¥ä¸è¿›è¡Œåˆ é™¤é”çš„é€»è¾‘ï¼Œå½“çº¿ç¨‹2æ‰§è¡Œåˆ°åˆ é™¤é”çš„é€»è¾‘æ—¶ï¼Œå¦‚æœTTLè¿˜æœªåˆ°æœŸï¼Œåˆ™åˆ¤æ–­å½“å‰è¿™æŠŠé”æ˜¯è‡ªå·±çš„ï¼Œäºæ˜¯åˆ é™¤è¿™æŠŠé”</li>
</ul>
<p>æ³¨æ„ï¼šä¸èƒ½åªåœ¨valueä¸­å­˜å…¥çº¿ç¨‹idï¼Œå› ä¸ºå¤šä¸ªæœºå™¨çš„çº¿ç¨‹idå¯èƒ½æ˜¯ä¸€æ ·çš„ï¼Œä»»ç„¶è‚¯ä¼šå‡ºç°è¯¯åˆ </p>
<h4 id="æƒ…å†µ2-åŸå­æ€§é—®é¢˜"><a href="#æƒ…å†µ2-åŸå­æ€§é—®é¢˜" class="headerlink" title="æƒ…å†µ2-åŸå­æ€§é—®é¢˜"></a>æƒ…å†µ2-åŸå­æ€§é—®é¢˜</h4><p>å‡è®¾çº¿ç¨‹Aé‡Šæ”¾é”æ—¶å·²ç»åˆ¤æ–­äº†æ˜¯è‡ªå·±çš„é”ï¼Œä½†åœ¨è¿™æ—¶å€™ï¼Œçº¿ç¨‹Aå¡ä½äº†ï¼Œé”è¶…æ—¶é‡Šæ”¾äº†ï¼Œçº¿ç¨‹Bæ‹¿åˆ°äº†é”å¹¶æ‰§è¡Œä¸šåŠ¡ï¼Œè¿™æ—¶ï¼Œçº¿ç¨‹Aé†’äº†ï¼Œé‡Šæ”¾äº†Bçš„é”<br><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.nlark.com/yuque/0/2023/png/32620241/1679656285059-d901e586-9c7c-4a4e-88d9-56c886288015.png#averageHue=%23fbfafa&clientId=u93ccb212-de26-4&from=paste&height=547&id=ubb79267f&name=image.png&originHeight=820&originWidth=1723&originalType=binary&ratio=1.5&rotation=0&showTitle=false&size=215685&status=done&style=none&taskId=u14d6f930-1bf0-4266-8f07-1a28a995c70&title=&width=1148.6666666666667#averageHue=%23fbfafa&id=CwWHM&originHeight=820&originWidth=1723&originalType=binary&ratio=1&rotation=0&showTitle=false&status=done&style=none&title=" alt="image.png"></p>
<p>è§£å†³æ–¹æ¡ˆ<br>é—®é¢˜çš„æœ¬è´¨æ˜¯åˆ¤æ–­é”å’Œåˆ é™¤é”æ˜¯ä¸¤ä¸ªåŠ¨ä½œï¼Œä¸å…·å¤‡åŸå­æ€§ï¼Œå¯ä»¥ä½¿ç”¨Redis Luaè„šæœ¬ï¼Œå°†å¤šä¸ªRediså‘½ä»¤æ”¾åˆ°ä¸€ä¸ªè„šæœ¬ä¸­ï¼Œæ•´ä¸ªè„šæœ¬<br><a target="_blank" rel="noopener" href="https://www.runoob.com/lua/lua-tutorial.html">https://www.runoob.com/lua/lua-tutorial.html</a><br><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.nlark.com/yuque/0/2023/png/32620241/1679656633823-cb5ca03d-176f-4621-9c1a-d330f01cef0c.png#averageHue=%23c2c7b9&clientId=u93ccb212-de26-4&from=paste&height=536&id=ue7fef514&name=image.png&originHeight=804&originWidth=1753&originalType=binary&ratio=1.5&rotation=0&showTitle=false&size=561968&status=done&style=none&taskId=ue4d1ca6c-7844-4512-a9cd-eea1205383c&title=&width=1168.6666666666667#averageHue=%23c2c7b9&id=dJopT&originHeight=804&originWidth=1753&originalType=binary&ratio=1&rotation=0&showTitle=false&status=done&style=none&title=" alt="image.png"><br>æ”¾åœ¨Resourcesç›®å½•ä¸‹</p>
<figure class="highlight lua"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- è¿™é‡Œçš„KEYS[1]å°±æ˜¯ä¼ å…¥é”çš„key</span></span><br><span class="line"><span class="comment">-- è¿™é‡Œçš„ARGV[1]å°±æ˜¯çº¿ç¨‹æ ‡è¯†</span></span><br><span class="line"><span class="comment">-- æ¯”è¾ƒé”ä¸­ çš„çº¿ç¨‹æ ‡è¯†ä¸çº¿ç¨‹æ ‡è¯†æ˜¯å¦ä¸€è‡´</span></span><br><span class="line"><span class="keyword">if</span> (redis.call(<span class="string">&#x27;get&#x27;</span>, KEYS[<span class="number">1</span>]) == ARGV[<span class="number">1</span>]) <span class="keyword">then</span></span><br><span class="line">  <span class="comment">-- ä¸€è‡´åˆ™é‡Šæ”¾é”</span></span><br><span class="line">  <span class="keyword">return</span> redis.call(<span class="string">&#x27;del&#x27;</span>, KEYS[<span class="number">1</span>])</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span></span><br></pre></td></tr></table></figure>

<p>åœ¨RedisTemplateä¸­ï¼Œå¯ä»¥åˆ©ç”¨executeæ–¹æ³•å»æ‰§è¡Œluaè„šæœ¬</p>
<figure class="highlight lua"><table><tr><td class="code"><pre><span class="line">public &lt;T&gt; T <span class="built_in">execute</span>(RedisScript&lt;T&gt; script, List&lt;K&gt; keys, Object... args) &#123;</span><br><span class="line">    <span class="keyword">return</span> this.scriptExecutor.<span class="built_in">execute</span>(script, keys, args);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> DefaultRedisScript&lt;Long&gt; UNLOCK_SCRIPT;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> &#123;</span><br><span class="line">    UNLOCK_SCRIPT = <span class="keyword">new</span> <span class="title class_">DefaultRedisScript</span>();</span><br><span class="line">    UNLOCK_SCRIPT.setLocation(<span class="keyword">new</span> <span class="title class_">ClassPathResource</span>(<span class="string">&quot;unlock.lua&quot;</span>));</span><br><span class="line">    UNLOCK_SCRIPT.setResultType(Long.class);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">unlock</span><span class="params">()</span> &#123;</span><br><span class="line">    stringRedisTemplate.execute(UNLOCK_SCRIPT,</span><br><span class="line">                                Collections.singletonList(KEY_PREFIX + name),</span><br><span class="line">                                ID_PREFIX + Thread.currentThread().getId());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<ul>
<li>åˆ©ç”¨SET NX EXè·å–é”ï¼Œå¹¶è®¾ç½®è¿‡æœŸæ—¶é—´ï¼Œä¿å­˜çº¿ç¨‹æ ‡è¯†</li>
<li>é‡Šæ”¾é”æ—¶å…ˆåˆ¤æ–­çº¿ç¨‹æ ‡è¯†æ˜¯å¦ä¸è‡ªå·±ä¸€è‡´ï¼Œä¸€è‡´åˆ™åˆ é™¤æ‰€ <ul>
<li>ç‰¹æ€§ <ul>
<li>åˆ©ç”¨SET NXæ»¡è¶³äº’æ–¥æ€§</li>
<li>åˆ©ç”¨SET EXä¿è¯æ•…éšœæ—¶ä¾ç„¶èƒ½é‡Šæ”¾é”ï¼Œé¿å…æ­»é”ï¼Œæé«˜å®‰å…¨æ€§</li>
<li>åˆ©ç”¨Redisé›†ç¾¤ä¿è¯é«˜å¯ç”¨å’Œé«˜å¹¶å‘ç‰¹æ€§</li>
</ul>
</li>
</ul>
</li>
</ul>
</blockquote>
<h1 id="åˆ†å¸ƒå¼é”-Redisson"><a href="#åˆ†å¸ƒå¼é”-Redisson" class="headerlink" title="åˆ†å¸ƒå¼é”-Redisson"></a>åˆ†å¸ƒå¼é”-Redisson</h1><h2 id="åˆ†å¸ƒå¼é”-redissionåŠŸèƒ½ä»‹ç»"><a href="#åˆ†å¸ƒå¼é”-redissionåŠŸèƒ½ä»‹ç»" class="headerlink" title="åˆ†å¸ƒå¼é”-redissionåŠŸèƒ½ä»‹ç»"></a>åˆ†å¸ƒå¼é”-redissionåŠŸèƒ½ä»‹ç»</h2><p>åŸºäºsetnxå®ç°çš„åˆ†å¸ƒå¼é”å­˜åœ¨ä¸‹é¢çš„é—®é¢˜ï¼š</p>
<ul>
<li><strong>é‡å…¥é—®é¢˜</strong>ï¼šé‡å…¥é—®é¢˜æ˜¯æŒ‡ è·å¾—é”çš„çº¿ç¨‹å¯ä»¥å†æ¬¡è¿›å…¥åˆ°ç›¸åŒçš„é”çš„ä»£ç å—ä¸­ï¼Œå¯é‡å…¥é”çš„æ„ä¹‰åœ¨äºé˜²æ­¢æ­»é”ã€‚</li>
<li><strong>ä¸å¯é‡è¯•</strong>ï¼šæ˜¯æŒ‡ç›®å‰çš„åˆ†å¸ƒå¼åªèƒ½å°è¯•ä¸€æ¬¡ï¼Œåˆç†çš„æƒ…å†µæ˜¯ï¼šå½“çº¿ç¨‹åœ¨è·å¾—é”å¤±è´¥åï¼Œä»–åº”è¯¥èƒ½å†æ¬¡å°è¯•è·å¾—é”ã€‚</li>
<li><strong>è¶…æ—¶é‡Šæ”¾ï¼š</strong>æˆ‘ä»¬åœ¨åŠ é”æ—¶å¢åŠ äº†è¿‡æœŸæ—¶é—´ï¼Œè¿™æ ·çš„æˆ‘ä»¬å¯ä»¥é˜²æ­¢æ­»é”ï¼Œä½†æ˜¯å¦‚æœå¡é¡¿çš„æ—¶é—´è¶…é•¿ï¼Œè™½ç„¶æˆ‘ä»¬é‡‡ç”¨äº†luaè¡¨è¾¾å¼é˜²æ­¢åˆ é”çš„æ—¶å€™ï¼Œè¯¯åˆ åˆ«äººçš„é”ï¼Œä½†æ˜¯æ¯•ç«Ÿæ²¡æœ‰é”ä½ï¼Œæœ‰å®‰å…¨éšæ‚£</li>
<li><strong>ä¸»ä»ä¸€è‡´æ€§ï¼š</strong> å¦‚æœRedisæä¾›äº†ä¸»ä»é›†ç¾¤ï¼Œå½“æˆ‘ä»¬å‘é›†ç¾¤å†™æ•°æ®æ—¶ï¼Œä¸»æœºéœ€è¦å¼‚æ­¥çš„å°†æ•°æ®åŒæ­¥ç»™ä»æœºï¼Œè€Œä¸‡ä¸€åœ¨åŒæ­¥è¿‡å»ä¹‹å‰ï¼Œä¸»æœºå®•äº†ï¼Œå°±ä¼šå‡ºç°æ­»é”é—®é¢˜ã€‚</li>
</ul>
<p>é‚£ä¹ˆä»€ä¹ˆæ˜¯Redissionå‘¢<br>Redissonæ˜¯ä¸€ä¸ªåœ¨Redisçš„åŸºç¡€ä¸Šå®ç°çš„Javaé©»å†…å­˜æ•°æ®ç½‘æ ¼ï¼ˆIn-Memory Data Gridï¼‰ã€‚å®ƒä¸ä»…æä¾›äº†ä¸€ç³»åˆ—çš„åˆ†å¸ƒå¼çš„Javaå¸¸ç”¨å¯¹è±¡ï¼Œè¿˜æä¾›äº†è®¸å¤šåˆ†å¸ƒå¼æœåŠ¡ï¼Œå…¶ä¸­å°±åŒ…å«äº†å„ç§åˆ†å¸ƒå¼é”çš„å®ç°ã€‚<br>å®˜ç½‘ï¼š<a target="_blank" rel="noopener" href="https://github.com/redisson/redisson">https://github.com/redisson/redisson</a><br>ä¸­æ–‡æ–‡æ¡£ï¼š<a target="_blank" rel="noopener" href="https://github.com/redisson/redisson/wiki/%E7%9B%AE%E5%BD%95">https://github.com/redisson/redisson/wiki/%E7%9B%AE%E5%BD%95</a></p>
<ul>
<li>Redisæä¾›äº†åˆ†å¸ƒå¼é”çš„å¤šç§å¤šæ ·åŠŸèƒ½ <ol>
<li>å¯é‡å…¥é”(Reentrant Lock)</li>
<li>å…¬å¹³é”(Fair Lock)</li>
<li>è”é”(MultiLock)</li>
<li>çº¢é”(RedLock)</li>
<li>è¯»å†™é”(ReadWriteLock)</li>
<li>ä¿¡å·é‡(Semaphore)</li>
<li>å¯è¿‡æœŸæ€§ä¿¡å·é‡(PermitExpirableSemaphore)</li>
<li>é—­é”(CountDownLatch)</li>
</ol>
</li>
</ul>
<h3 id="å…¥é—¨"><a href="#å…¥é—¨" class="headerlink" title="å…¥é—¨"></a>å…¥é—¨</h3><ol>
<li><p>å¯¼å…¥ä¾èµ–</p>
</li>
<li><p>é…ç½®Redissonå®¢æˆ·ç«¯ï¼Œåœ¨configåŒ…ä¸‹æ–°å»º<code>RedissonConfig</code></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> org.redisson.Redisson;</span><br><span class="line"><span class="keyword">import</span> org.redisson.api.RedissonClient;</span><br><span class="line"><span class="keyword">import</span> org.redisson.config.Config;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RedissonConfig</span> &#123;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> RedissonClient <span class="title function_">redissonClient</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">Config</span> <span class="variable">config</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Config</span>();</span><br><span class="line">        config.useSingleServer()</span><br><span class="line">            .setAddress(<span class="string">&quot;redis://127.0.0.1:6379&quot;</span>)</span><br><span class="line">            .setPassword(<span class="string">&quot;123456&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> Redisson.create(config);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>ä¿®æ”¹ä¹‹å‰çš„ä»£ç </p>
</li>
</ol>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Resource</span></span><br><span class="line"><span class="keyword">private</span> RedissonClient redissonClient;</span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> Result <span class="title function_">seckillVoucher</span><span class="params">(Long voucherId)</span> &#123;</span><br><span class="line">    LambdaQueryWrapper&lt;SeckillVoucher&gt; queryWrapper = <span class="keyword">new</span> <span class="title class_">LambdaQueryWrapper</span>&lt;&gt;();</span><br><span class="line">    <span class="comment">//1. æŸ¥è¯¢ä¼˜æƒ åˆ¸</span></span><br><span class="line">    queryWrapper.eq(SeckillVoucher::getVoucherId, voucherId);</span><br><span class="line">    <span class="type">SeckillVoucher</span> <span class="variable">seckillVoucher</span> <span class="operator">=</span> seckillVoucherService.getOne(queryWrapper);</span><br><span class="line">    <span class="comment">//2. åˆ¤æ–­ç§’æ€æ—¶é—´æ˜¯å¦å¼€å§‹</span></span><br><span class="line">    <span class="keyword">if</span> (LocalDateTime.now().isBefore(seckillVoucher.getBeginTime())) &#123;</span><br><span class="line">        <span class="keyword">return</span> Result.fail(<span class="string">&quot;ç§’æ€è¿˜æœªå¼€å§‹ï¼Œè¯·è€å¿ƒç­‰å¾…&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//3. åˆ¤æ–­ç§’æ€æ—¶é—´æ˜¯å¦ç»“æŸ</span></span><br><span class="line">    <span class="keyword">if</span> (LocalDateTime.now().isAfter(seckillVoucher.getEndTime())) &#123;</span><br><span class="line">        <span class="keyword">return</span> Result.fail(<span class="string">&quot;ç§’æ€å·²ç»ç»“æŸï¼&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//4. åˆ¤æ–­åº“å­˜æ˜¯å¦å……è¶³</span></span><br><span class="line">    <span class="keyword">if</span> (seckillVoucher.getStock() &lt; <span class="number">1</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> Result.fail(<span class="string">&quot;ä¼˜æƒ åˆ¸å·²è¢«æŠ¢å…‰äº†å“¦ï¼Œä¸‹æ¬¡è®°å¾—æ‰‹é€Ÿå¿«ç‚¹&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">Long</span> <span class="variable">userId</span> <span class="operator">=</span> UserHolder.getUser().getId();</span><br><span class="line">    <span class="type">RLock</span> <span class="variable">redisLock</span> <span class="operator">=</span> redissonClient.getLock(<span class="string">&quot;order:&quot;</span> + userId);</span><br><span class="line">    <span class="type">boolean</span> <span class="variable">isLock</span> <span class="operator">=</span> redisLock.tryLock();</span><br><span class="line">    <span class="keyword">if</span> (!isLock) &#123;</span><br><span class="line">        <span class="keyword">return</span> Result.fail(<span class="string">&quot;ä¸å…è®¸æŠ¢å¤šå¼ ä¼˜æƒ åˆ¸&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="type">IVoucherOrderService</span> <span class="variable">proxy</span> <span class="operator">=</span> (IVoucherOrderService) AopContext.currentProxy();</span><br><span class="line">        <span class="keyword">return</span> proxy.createVoucherOrder(voucherId);</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        redisLock.unlock();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="å¯é‡å…¥åŸç†"><a href="#å¯é‡å…¥åŸç†" class="headerlink" title="å¯é‡å…¥åŸç†"></a>å¯é‡å…¥åŸç†</h3><blockquote>
<p>å¯é‡å…¥é”æŒ‡çš„æ˜¯å¯é‡å¤å¯é€’å½’è°ƒç”¨çš„é”ï¼Œåœ¨å¤–å±‚ä½¿ç”¨é”ä¹‹åï¼Œåœ¨å†…å±‚ä»ç„¶å¯ä»¥ä½¿ç”¨ï¼Œå¹¶ä¸”ä¸å‘ç”Ÿæ­»é”ï¼Œè¿™æ ·çš„é”å°±å«åšå¯é‡å…¥é”ã€‚<br>ä¸å¯é‡å…¥é”ç›¸åï¼Œä¸å¯é‡å…¥é”ä¸å¯é€’å½’è°ƒç”¨ï¼Œé€’å½’è°ƒç”¨å°±å‘ç”Ÿæ­»é”ã€‚å¯é‡å…¥é”çš„å·¥ä½œåŸç†å¾ˆç®€å•ï¼Œå°±æ˜¯ç”¨ä¸€ä¸ªè®¡æ•°å™¨æ¥è®°å½•é”è¢«è·å–çš„æ¬¡æ•°ï¼Œè·å–é”ä¸€æ¬¡è®¡æ•°å™¨+1ï¼Œé‡Šæ”¾é”ä¸€æ¬¡è®¡æ•°å™¨-1ï¼Œå½“è®¡æ•°å™¨ä¸º0æ—¶ï¼Œè¡¨ç¤ºé”å¯ç”¨ã€‚<br>ä¸å¯é‡å…¥é”ä¹Ÿå«è‡ªæ—‹é”ã€‚</p>
</blockquote>
<p>å¯é‡å…¥é”çš„å®ç°åŸç†æ˜¯åŸºäºè®¡æ•°å™¨çš„ï¼Œæ¯æ¬¡è·å–é”æ—¶ï¼Œè®¡æ•°å™¨è‡ªå¢ï¼Œæ¯æ¬¡é‡Šæ”¾é”æ—¶ï¼Œè®¡æ•°å™¨è‡ªå‡ï¼Œä»è€Œå®ç°äº†çº¿ç¨‹é—´çš„åŒæ­¥å’Œäº’æ–¥ã€‚å…·ä½“åœ°ï¼Œå½“çº¿ç¨‹æŒæœ‰é”æ—¶ï¼Œè®¡æ•°å™¨åŠ 1ï¼›å½“çº¿ç¨‹é‡Šæ”¾é”æ—¶ï¼Œè®¡æ•°å™¨å‡1ã€‚å½“è®¡æ•°å™¨å‡è‡³0æ—¶ï¼Œé”è¢«é‡Šæ”¾ï¼Œæ­¤æ—¶çº¿ç¨‹å¯ä»¥ç»§ç»­æ‰§è¡Œã€‚è¿™ç§åŒæ­¥æœºåˆ¶å¯ä»¥æœ‰æ•ˆåœ°é¿å…æ­»é”ç­‰é—®é¢˜ï¼Œæé«˜ç¨‹åºçš„å¹¶å‘æ€§å’Œå¯é æ€§ã€‚</p>
<ul>
<li>åœ¨Locké”ä¸­ï¼Œä»–æ˜¯å€ŸåŠ©äºç­‰æ›¾çš„ä¸€ä¸ªvoaltileçš„ä¸€ä¸ªstateå˜é‡æ¥è®°å½•é‡å…¥çš„çŠ¶æ€çš„ <ul>
<li>å¦‚æœå½“å‰æ²¡æœ‰äººæŒæœ‰è¿™æŠŠé”ï¼Œé‚£ä¹ˆstate &#x3D; 0</li>
<li>å¦‚æœæœ‰äººæŒæœ‰è¿™æŠŠé”ï¼Œé‚£ä¹ˆstate &#x3D; 1 <ul>
<li>å¦‚æœæŒæœ‰è€…æŠŠé”çš„äººå†æ¬¡æŒæœ‰è¿™æŠŠé”ï¼Œé‚£ä¹ˆstateä¼š+1</li>
</ul>
</li>
<li>å¦‚æœå¯¹äºsynchronizeè€Œè¨€ï¼Œä»–åœ¨cè¯­è¨€ä»£ç ä¸­ä¼šæœ‰ä¸€ä¸ªcount</li>
<li>åŸç†ä¸stateç±»ä¼¼ï¼Œä¹Ÿæ˜¯é‡å…¥ä¸€æ¬¡å°±+1ï¼Œé‡Šæ”¾ä¸€æ¬¡å°±-1ï¼Œç›´è‡³å‡åˆ°0ï¼Œè¡¨ç¤ºè¿™æŠŠé”æ²¡æœ‰è¢«äººæŒæœ‰</li>
</ul>
</li>
<li>åœ¨redissonä¸­ï¼Œæˆ‘ä»¬ä¹Ÿæ”¯æŒå¯é‡å…¥é” <ul>
<li>åœ¨åˆ†å¸ƒå¼é”ä¸­ï¼Œå®ƒé‡‡ç”¨hashç»“æ„æ¥å­˜å‚¨é”ï¼Œå…¶ä¸­å¤–å±‚keyè¡¨ç¤ºè¿™æŠŠé”æ˜¯å¦å­˜åœ¨ï¼Œå†…å±‚keyåˆ™è®°å½•å½“å‰è¿™æŠŠé”è¢«å“ªä¸ªçº¿ç¨‹æŒæœ‰</li>
</ul>
</li>
<li>ç”±äºæˆ‘ä»¬éœ€è¦é¢å¤–å­˜å‚¨ä¸€ä¸ªstateï¼Œæ‰€ä»¥ç”¨å­—ç¬¦ä¸²å‹SET NX EXæ˜¯ä¸è¡Œçš„ï¼Œéœ€è¦ç”¨åˆ°Hashç»“æ„ï¼Œä½†æ˜¯Hashç»“æ„åˆæ²¡æœ‰NXè¿™ç§æ–¹æ³•ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦å°†åŸæœ‰çš„é€»è¾‘æ‹†å¼€ï¼Œè¿›è¡Œæ‰‹åŠ¨åˆ¤æ–­</li>
</ul>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.nlark.com/yuque/0/2023/png/32620241/1679738915658-07739206-a06d-43bb-9af9-ea871a4de358.png#averageHue=%23e8dfde&clientId=u51856e4d-12b3-4&from=paste&id=u337f15c8&name=image.png&originHeight=688&originWidth=636&originalType=url&ratio=1.5&rotation=0&showTitle=false&size=238378&status=done&style=none&taskId=u2d7678f9-73ff-49ce-a12b-f1e89277a20&title=#averageHue=%23e8dfde&id=E1zcv&originHeight=688&originWidth=636&originalType=binary&ratio=1&rotation=0&showTitle=false&status=done&style=none&title=" alt="image.png"><br>ä¸ºäº†ä¿è¯åŸå­æ€§ï¼Œæ‰€ä»¥æµç¨‹å›¾ä¸­çš„ä¸šåŠ¡é€»è¾‘ä¹Ÿæ˜¯éœ€è¦ç”¨Luaæ¥å®ç°</p>
<ul>
<li><p>è·å–é”çš„é€»è¾‘</p>
<figure class="highlight lua"><table><tr><td class="code"><pre><span class="line"><span class="keyword">local</span> key = KEYS[<span class="number">1</span>]; <span class="comment">-- é”çš„key</span></span><br><span class="line"><span class="keyword">local</span> threadId = ARGV[<span class="number">1</span>]; <span class="comment">-- çº¿ç¨‹å”¯ä¸€æ ‡è¯†</span></span><br><span class="line"><span class="keyword">local</span> releaseTime = ARGV[<span class="number">2</span>]; <span class="comment">-- é”çš„è‡ªåŠ¨é‡Šæ”¾æ—¶é—´</span></span><br><span class="line"><span class="comment">-- é”ä¸å­˜åœ¨</span></span><br><span class="line"><span class="keyword">if</span> (redis.call(<span class="string">&#x27;exists&#x27;</span>, key) == <span class="number">0</span>) <span class="keyword">then</span></span><br><span class="line">    <span class="comment">-- è·å–é”å¹¶æ·»åŠ çº¿ç¨‹æ ‡è¯†ï¼Œstateè®¾ä¸º1</span></span><br><span class="line">    redis.call(<span class="string">&#x27;hset&#x27;</span>, key, threadId, <span class="string">&#x27;1&#x27;</span>);</span><br><span class="line">    <span class="comment">-- è®¾ç½®é”æœ‰æ•ˆæœŸ</span></span><br><span class="line">    redis.call(<span class="string">&#x27;expire&#x27;</span>, key, releaseTime);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>; <span class="comment">-- è¿”å›ç»“æœ</span></span><br><span class="line"><span class="keyword">end</span>;</span><br><span class="line"><span class="comment">-- é”å­˜åœ¨ï¼Œåˆ¤æ–­threadIdæ˜¯å¦ä¸ºè‡ªå·±</span></span><br><span class="line"><span class="keyword">if</span> (redis.call(<span class="string">&#x27;hexists&#x27;</span>, key, threadId) == <span class="number">1</span>) <span class="keyword">then</span></span><br><span class="line">    <span class="comment">-- é”å­˜åœ¨ï¼Œé‡å…¥æ¬¡æ•° +1ï¼Œè¿™é‡Œç”¨çš„æ˜¯hashç»“æ„çš„incrbyå¢é•¿</span></span><br><span class="line">    redis.call(<span class="string">&#x27;hincrby&#x27;</span>, key, thread, <span class="number">1</span>);</span><br><span class="line">    <span class="comment">-- è®¾ç½®é”çš„æœ‰æ•ˆæœŸ</span></span><br><span class="line">    redis.call(<span class="string">&#x27;expire&#x27;</span>, key, releaseTime);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>; <span class="comment">-- è¿”å›ç»“æœ</span></span><br><span class="line"><span class="keyword">end</span>;</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>; <span class="comment">-- ä»£ç èµ°åˆ°è¿™é‡Œï¼Œè¯´æ˜è·å–é”çš„ä¸æ˜¯è‡ªå·±ï¼Œè·å–é”å¤±è´¥</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>é‡Šæ”¾é”çš„é€»è¾‘</p>
<figure class="highlight lua"><table><tr><td class="code"><pre><span class="line"><span class="keyword">local</span> key = KEYS[<span class="number">1</span>];</span><br><span class="line"><span class="keyword">local</span> threadId = ARGV[<span class="number">1</span>];</span><br><span class="line"><span class="keyword">local</span> releaseTime = ARGV[<span class="number">2</span>];</span><br><span class="line"><span class="comment">-- å¦‚æœé”ä¸æ˜¯è‡ªå·±çš„</span></span><br><span class="line"><span class="keyword">if</span> (redis.call(<span class="string">&#x27;HEXISTS&#x27;</span>, key, threadId) == <span class="number">0</span>) <span class="keyword">then</span></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nil</span>; <span class="comment">-- ç›´æ¥è¿”å›</span></span><br><span class="line"><span class="keyword">end</span>;</span><br><span class="line"><span class="comment">-- é”æ˜¯è‡ªå·±çš„ï¼Œé”è®¡æ•°-1ï¼Œè¿˜æ˜¯ç”¨hincrbyï¼Œä¸è¿‡è‡ªå¢é•¿çš„å€¼ä¸º-1</span></span><br><span class="line"><span class="keyword">local</span> count = redis.call(<span class="string">&#x27;hincrby&#x27;</span>, key, threadId, <span class="number">-1</span>);</span><br><span class="line"><span class="comment">-- åˆ¤æ–­é‡å…¥æ¬¡æ•°ä¸ºå¤šå°‘</span></span><br><span class="line"><span class="keyword">if</span> (count &gt; <span class="number">0</span>) <span class="keyword">then</span></span><br><span class="line">    <span class="comment">-- å¤§äº0ï¼Œé‡ç½®æœ‰æ•ˆæœŸ</span></span><br><span class="line">    redis.call(<span class="string">&#x27;expire&#x27;</span>, key, releaseTime);</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">    <span class="comment">-- å¦åˆ™ç›´æ¥é‡Šæ”¾é”</span></span><br><span class="line">    redis.call(<span class="string">&#x27;del&#x27;</span>, key);</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line"><span class="keyword">end</span>;</span><br></pre></td></tr></table></figure></li>
</ul>
<h3 id="å¦‚ä½•é‡è¯•è·å–é”"><a href="#å¦‚ä½•é‡è¯•è·å–é”" class="headerlink" title="å¦‚ä½•é‡è¯•è·å–é”"></a>å¦‚ä½•é‡è¯•è·å–é”</h3><p>åŸºäºRedis Pub&#x2F;Subå‘å¸ƒè®¢é˜…æœºåˆ¶ã€‚å¦‚æœè·å–é”å¤±è´¥ï¼Œåˆ™é˜»å¡è®¢é˜…é‡Šæ”¾é”çš„æ¶ˆæ¯ï¼›å½“é”è¢«é‡Šæ”¾æ—¶ï¼Œä¼šè§¦å‘æ¨é€ï¼ˆå‘Šè¯‰å…¶å®ƒçº¿ç¨‹æˆ‘è¢«é‡Šæ”¾äº†ï¼‰ï¼Œç„¶åå…¶å®ƒçº¿ç¨‹å†é‡è¯•è·å–ï¼›å¦‚æ­¤å¾€å¤çŸ¥é“è¶…æ—¶</p>
<h3 id="å¦‚ä½•é˜²æ­¢é”æå‰è¶…æ—¶é‡Šæ”¾"><a href="#å¦‚ä½•é˜²æ­¢é”æå‰è¶…æ—¶é‡Šæ”¾" class="headerlink" title="å¦‚ä½•é˜²æ­¢é”æå‰è¶…æ—¶é‡Šæ”¾"></a>å¦‚ä½•é˜²æ­¢é”æå‰è¶…æ—¶é‡Šæ”¾</h3><p>åŸºäº<strong>çœ‹é—¨ç‹—æœºåˆ¶</strong>ã€‚å¦‚æœä¸æ‰‹åŠ¨è®¾ç½®é”é‡Šæ”¾æ—¶é—´ (leaseTime) ï¼Œé»˜è®¤è®¾ç½® 30 ç§’è¿‡æœŸï¼Œå¹¶ç›®ç»™å½“å‰é”æ³¨å†Œä¸€ä¸ªå®šæ—¶ä»»åŠ¡ï¼Œè¯¥å®šæ—¶ä»»åŠ¡æ¯éš” 1&#x2F;3 çš„é”é‡Šæ”¾æ—¶é—´ (ä¸€èˆ¬æ˜¯ 10 ç§’)ä¼šé‡ç½®é”çš„è¿‡æœŸæ—¶é—´(é€’å½’è°ƒç”¨ï¼Œä¸€æ¬¡ç»­æœŸå®Œäº†å†)<br>éœ€è¦æ€è€ƒä¸¤ä¸ªé—®é¢˜:</p>
<ol>
<li>å¦‚ä½•ä¿è¯åŒä¸€ä¸ªé”åªæ³¨å†Œä¸€ä¸ªå®šæ—¶ä»»åŠ¡?</li>
<li>å¦‚ä½•é˜²æ­¢æ— é™ç»­æœŸ?</li>
</ol>
<p>è¦è§£å†³è¿™äº›é—®é¢˜ï¼Œä½¿ç”¨å…¨å±€ ConcurrentHashMap æ¥ç®¡ç†é” &#x3D;&gt; ä»»åŠ¡ä¿¡æ¯ï¼Œkey ä¸ºé”çš„idï¼Œä»è€Œä¿è¯å”¯ä¸€ã€‚å½“æŸä¸ªé”é‡Šæ”¾æ—¶ï¼Œä»å…¨å±€ ConcurrentHashMap ä¸­å–å‡ºå®šæ—¶ä»»åŠ¡å¹¶å–æ¶ˆæ‰ï¼Œç„¶åæŠŠé”çš„ä¿¡æ¯ä» Map ä¸­åˆ æ‰å³å¯ã€‚<br>æœ€ç»ˆï¼Œå®Œæ•´çš„åˆ†å¸ƒå¼é”æµç¨‹å¦‚ä¸‹<br><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.nlark.com/yuque/0/2023/png/32620241/1679714572280-1fbba4ec-3b96-45ce-bc60-a8ee46289386.png#averageHue=%23faf6f6&clientId=u909f52ab-0fa4-4&from=paste&height=528&id=u13ed5ec8&name=image.png&originHeight=792&originWidth=1740&originalType=binary&ratio=1.5&rotation=0&showTitle=false&size=334255&status=done&style=none&taskId=u3219ee15-2a06-42f7-87c7-76a9162405c&title=&width=1160#averageHue=%23faf6f6&id=yu9hV&originHeight=792&originWidth=1740&originalType=binary&ratio=1&rotation=0&showTitle=false&status=done&style=none&title=" alt="image.png"></p>
<h2 id="å¦‚ä½•è§£å†³ä¸»ä»ä¸€è‡´æ€§é—®é¢˜"><a href="#å¦‚ä½•è§£å†³ä¸»ä»ä¸€è‡´æ€§é—®é¢˜" class="headerlink" title="å¦‚ä½•è§£å†³ä¸»ä»ä¸€è‡´æ€§é—®é¢˜"></a>å¦‚ä½•è§£å†³ä¸»ä»ä¸€è‡´æ€§é—®é¢˜</h2><p>å¦‚æœä½¿ç”¨ä¸»ä»å¤åˆ¶çš„ Redis é›†ç¾¤ï¼Œå¯èƒ½å‡ºç°ä¸»ä»èŠ‚ç‚¹è®¾ç½®çš„é”çŠ¶æ€ä¸ä¸€è‡´çš„é—®é¢˜å¯ä»¥ä½¿ç”¨ Redisson çš„ MultiLock (è”é”) æ¥è§£å†³ï¼Œæ ¸å¿ƒæ€æƒ³æ˜¯å¼€å¯å¤šä¸ªç‹¬ç«‹çš„ Redis ä¸»èŠ‚ç‚¹ï¼Œè®¾ç½®é”æ—¶å¿…é¡»åœ¨æ‰€æœ‰ä¸»èŠ‚ç‚¹éƒ½å†™å…¥æˆåŠŸï¼Œæ‰ç®—è®¾ç½®æˆåŠŸã€‚è¿™æ ·åšä¹‹åï¼Œå“ªæ€•æœ‰éƒ¨åˆ†èŠ‚ç‚¹æŒ‚æ‰ï¼Œå…¶ä»–çº¿ç¨‹ä¹Ÿæ— æ³• setnx å…¨éƒ¨æˆåŠŸï¼Œå°±ä¸ä¼šå‡ºç°é‡å¤æ‰§è¡Œä¸šåŠ¡çš„æƒ…å†µã€‚<br>å¦‚ä¸‹å›¾:<br><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.nlark.com/yuque/0/2023/png/32620241/1681732694779-5bf00dd9-c14e-41c8-8d37-47ff81e797bf.png#averageHue=%23f5f4f0&clientId=uc6d03285-7526-4&from=paste&height=249&id=ua490693f&originHeight=373&originWidth=990&originalType=binary&ratio=1.5&rotation=0&showTitle=false&size=171249&status=done&style=none&taskId=ub7813047-c49d-49f1-a65b-f9551efe0ca&title=&width=660" alt="image.png"><br>å®ç° MultiLock çš„å‡ ä¸ªå…³é”®:</p>
<ol>
<li>éå†æ‰€æœ‰èŠ‚ç‚¹ï¼Œä¾æ¬¡è®¾ç½®é”ï¼Œå¹¶ä½¿ç”¨åˆ—è¡¨æ¥è®°å½•æ‰€æœ‰ä¸»èŠ‚ç‚¹çš„é”æ˜¯å¦è®¾ç½®æˆåŠŸã€‚</li>
<li>åªè¦æœ‰ä¸€ä¸ªèŠ‚ç‚¹è®¾ç½®ä¸æˆåŠŸï¼Œå°±è¦é‡Šæ”¾æ‰€æœ‰çš„é”ï¼Œä»å¤´æ¥è¿‡ã€‚</li>
<li>å› ä¸ºä¸åŒèŠ‚ç‚¹è®¾ç½®é”æˆåŠŸçš„æ—¶é—´ä¸åŒï¼Œæ‰€ä»¥åœ¨æ‰€æœ‰é”è®¾ç½®æˆåŠŸåï¼Œè¦ç»Ÿä¸€è®¾ç½®è¿‡æœŸæ—¶é—´(ä½†å¦‚æœ leaseTime &#x3D; -1 å°±ä¸ç”¨äº†ï¼Œå› ä¸ºå¼€å¯äº†çœ‹é—¨ç‹—æœºåˆ¶ä¼šè‡ªåŠ¨ç»­æœŸ)</li>
<li>é”é‡Šæ”¾æ—¶é—´ (leaseTime) å¿…é¡»è¦å¤§äºæŠ¢é”æœ€å¤§ç­‰å¾…æ—¶é—´ (waitTime) ï¼Œå¦åˆ™å¯èƒ½å‡ºç°ç¬¬ä¸€ä¸ªèŠ‚ç‚¹æŠ¢åˆ°é”ï¼Œæœ€åä¸€ä¸ªèŠ‚ç‚¹è¿˜æ²¡æŠ¢åˆ°é”ï¼Œä¹‹å‰çš„é”å°±å·²ç»è¶…æ—¶é‡Šæ”¾äº†ã€‚æ‰€ä»¥å¦‚æœæŒ‡å®šäº† waitTime å’Œ leaseTimeï¼Œé»˜è®¤ leaseTime &#x3D; waitTime * 2</li>
</ol>
<p>MultiLock æœ€å®‰å…¨ï¼Œä½†åŒæ ·ä¼šå¸¦æ¥å¾ˆå¤§çš„è¿ç»´æˆæœ¬</p>
<h2 id="ç§’æ€ä¸šåŠ¡ä¼˜åŒ–"><a href="#ç§’æ€ä¸šåŠ¡ä¼˜åŒ–" class="headerlink" title="ç§’æ€ä¸šåŠ¡ä¼˜åŒ–"></a>ç§’æ€ä¸šåŠ¡ä¼˜åŒ–</h2><p>æˆ‘ä»¬å…ˆæ¥å›é¡¾ä¸€ä¸‹ä¸‹å•æµç¨‹<br>å½“ç”¨æˆ·å‘èµ·è¯·æ±‚ï¼Œæ­¤æ—¶ä¼šå…ˆè¯·æ±‚Nginxï¼ŒNginxåå‘ä»£ç†åˆ°Tomcatï¼Œè€ŒTomcatä¸­çš„ç¨‹åºï¼Œä¼šè¿›è¡Œä¸²è¡Œæ“ä½œï¼Œåˆ†ä¸ºå¦‚ä¸‹å‡ ä¸ªæ­¥éª¤</p>
<ol>
<li>æŸ¥è¯¢ä¼˜æƒ åˆ¸</li>
<li>åˆ¤æ–­ç§’æ€åº“å­˜æ˜¯å¦è¶³å¤Ÿ</li>
<li>æŸ¥è¯¢è®¢å•</li>
<li>æ ¡éªŒæ˜¯å¦ä¸€äººä¸€å•</li>
<li>æ‰£å‡åº“å­˜</li>
<li>åˆ›å»ºè®¢å•</li>
</ol>
<ul>
<li>åœ¨è¿™å…­ä¸ªæ­¥éª¤ä¸­ï¼Œæœ‰å¾ˆå¤šæ“ä½œéƒ½æ˜¯è¦å»æ“ä½œæ•°æ®åº“çš„ï¼Œè€Œä¸”è¿˜æ˜¯ä¸€ä¸ªçº¿ç¨‹ä¸²è¡Œæ‰§è¡Œï¼Œè¿™æ ·å°±ä¼šå¯¼è‡´æˆ‘ä»¬çš„ç¨‹åºæ‰§è¡Œå¾ˆæ…¢ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦å¼‚æ­¥ç¨‹åºæ‰§è¡Œï¼Œé‚£ä¹ˆå¦‚ä½•åŠ é€Ÿå‘¢ï¼Ÿ</li>
<li>ä¼˜åŒ–æ–¹æ¡ˆï¼šæˆ‘ä»¬å°†è€—æ—¶è¾ƒçŸ­çš„é€»è¾‘åˆ¤æ–­æ”¾åˆ°Redisä¸­ï¼Œä¾‹å¦‚ï¼šåº“å­˜æ˜¯å¦å……è¶³ï¼Œæ˜¯å¦ä¸€äººä¸€å•è¿™æ ·çš„æ“ä½œï¼Œåªè¦æ»¡è¶³è¿™ä¸¤æ¡æ“ä½œï¼Œé‚£æˆ‘ä»¬æ˜¯ä¸€å®šå¯ä»¥ä¸‹å•æˆåŠŸçš„ï¼Œä¸ç”¨ç­‰æ•°æ®çœŸçš„å†™è¿›æ•°æ®åº“ï¼Œæˆ‘ä»¬ç›´æ¥å‘Šè¯‰ç”¨æˆ·ä¸‹å•æˆåŠŸå°±å¥½äº†ã€‚ç„¶ååå°å†å¼€ä¸€ä¸ªçº¿ç¨‹ï¼Œåå°çº¿ç¨‹å†å»æ…¢æ…¢æ‰§è¡Œé˜Ÿåˆ—é‡Œçš„æ¶ˆæ¯ï¼Œè¿™æ ·æˆ‘ä»¬å°±èƒ½å¾ˆå¿«çš„å®Œæˆä¸‹å•ä¸šåŠ¡ã€‚</li>
</ul>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.nlark.com/yuque/0/2023/png/32620241/1679795940035-050f0b62-6ac6-4f8d-9d35-e02215f0004f.png#averageHue=%23faf6f6&clientId=uaf30bc39-5a32-4&from=paste&id=u29e65c67&name=image.png&originHeight=732&originWidth=1540&originalType=url&ratio=1.5&rotation=0&showTitle=false&size=423648&status=done&style=none&taskId=u070515ef-409f-4cba-ab7c-d58280195f5&title=#averageHue=%23faf6f6&id=Pdrmz&originHeight=732&originWidth=1540&originalType=binary&ratio=1&rotation=0&showTitle=false&status=done&style=none&title=" alt="image.png"></p>
<ul>
<li>ä½†æ˜¯è¿™é‡Œè¿˜å­˜åœ¨ä¸¤ä¸ªéš¾ç‚¹ <ol>
<li>æˆ‘ä»¬æ€ä¹ˆåœ¨Redisä¸­å¿«é€Ÿæ ¡éªŒæ˜¯å¦ä¸€äººä¸€å•ï¼Œè¿˜æœ‰åº“å­˜åˆ¤æ–­</li>
<li>æˆ‘ä»¬æ ¡éªŒä¸€äººä¸€å•å’Œå°†ä¸‹å•æ•°æ®å†™å…¥æ•°æ®åº“ï¼Œè¿™æ˜¯ä¸¤ä¸ªçº¿ç¨‹ï¼Œæˆ‘ä»¬æ€ä¹ˆçŸ¥é“ä¸‹å•æ˜¯å¦å®Œæˆã€‚ <ul>
<li>æˆ‘ä»¬éœ€è¦å°†ä¸€äº›ä¿¡æ¯è¿”å›ç»™å‰ç«¯ï¼ŒåŒæ—¶ä¹Ÿå°†è¿™äº›ä¿¡æ¯ä¸¢åˆ°å¼‚æ­¥queueä¸­å»ï¼Œåç»­æ“ä½œä¸­ï¼Œå¯ä»¥é€šè¿‡è¿™ä¸ªidæ¥æŸ¥è¯¢ä¸‹å•é€»è¾‘æ˜¯å¦å®Œæˆ</li>
</ul>
</li>
</ol>
</li>
<li>æˆ‘ä»¬ç°åœ¨æ¥çœ‹æ•´ä½“æ€è·¯ï¼šå½“ç”¨æˆ·ä¸‹å•ä¹‹åï¼Œåˆ¤æ–­åº“å­˜æ˜¯å¦å……è¶³ï¼Œåªéœ€è¦å–Redisä¸­æ ¹æ®keyæ‰¾å¯¹åº”çš„valueæ˜¯å¦å¤§äº0å³å¯ï¼Œå¦‚æœä¸å……è¶³ï¼Œåˆ™ç›´æ¥ç»“æŸã€‚å¦‚æœå……è¶³ï¼Œåˆ™åœ¨Redisä¸­åˆ¤æ–­ç”¨æˆ·æ˜¯å¦å¯ä»¥ä¸‹å•ï¼Œå¦‚æœseté›†åˆä¸­æ²¡æœ‰è¯¥ç”¨æˆ·çš„ä¸‹å•æ•°æ®ï¼Œåˆ™å¯ä»¥ä¸‹å•ï¼Œå¹¶å°†userIdå’Œä¼˜æƒ åˆ¸å­˜å…¥åˆ°Redisä¸­ï¼Œå¹¶ä¸”è¿”å›0ï¼Œæ•´ä¸ªè¿‡ç¨‹éœ€è¦ä¿è¯æ˜¯åŸå­æ€§çš„ï¼Œæ‰€ä»¥æˆ‘ä»¬è¦ç”¨Luaæ¥æ“ä½œï¼ŒåŒæ—¶ç”±äºæˆ‘ä»¬éœ€è¦åœ¨Redisä¸­æŸ¥è¯¢ä¼˜æƒ åˆ¸ä¿¡æ¯ï¼Œæ‰€ä»¥åœ¨æˆ‘ä»¬æ–°å¢ç§’æ€ä¼˜æƒ åˆ¸çš„åŒæ—¶ï¼Œéœ€è¦å°†ä¼˜æƒ åˆ¸ä¿¡æ¯ä¿å­˜åˆ°Redisä¸­</li>
<li>å®Œæˆä»¥ä¸Šé€»è¾‘åˆ¤æ–­æ—¶ï¼Œæˆ‘ä»¬åªéœ€è¦åˆ¤æ–­å½“å‰Redisä¸­çš„è¿”å›å€¼æ˜¯å¦ä¸º0ï¼Œå¦‚æœæ˜¯0ï¼Œåˆ™è¡¨ç¤ºå¯ä»¥ä¸‹å•ï¼Œå°†ä¿¡æ¯ä¿å­˜åˆ°queueä¸­å»ï¼Œç„¶åè¿”å›ï¼Œå¼€ä¸€ä¸ªçº¿ç¨‹æ¥å¼‚æ­¥ä¸‹å•ï¼Œå…¶é˜¿å¥´å•å¯ä»¥é€šè¿‡è¿”å›è®¢å•çš„idæ¥åˆ¤æ–­æ˜¯å¦ä¸‹å•æˆåŠŸ</li>
</ul>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.nlark.com/yuque/0/2023/png/32620241/1679795974724-d93dabe5-c9ad-40eb-a1d4-d978736cd505.png#averageHue=%23f2eded&clientId=uaf30bc39-5a32-4&from=paste&id=u4e25731c&name=image.png&originHeight=760&originWidth=1606&originalType=url&ratio=1.5&rotation=0&showTitle=false&size=413127&status=done&style=none&taskId=ua7f3dfb8-229d-40a6-a4f4-d68e5ed3118&title=#averageHue=%23f2eded&id=v0nPj&originHeight=760&originWidth=1606&originalType=binary&ratio=1&rotation=0&showTitle=false&status=done&style=none&title=" alt="image.png"></p>
<h3 id="å®ç°-2"><a href="#å®ç°-2" class="headerlink" title="å®ç°"></a>å®ç°</h3><p>æ–°å¢ç§’æ€ä¼˜æƒ åˆ¸çš„åŒæ—¶ï¼Œå°†ä¼˜æƒ åˆ¸ä¿¡æ¯ä¿å­˜åˆ°Redisä¸­(ä¿®æ”¹ä¹‹å‰æ·»åŠ çš„é€»è¾‘ï¼‰</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="meta">@Transactional</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">addSeckillVoucher</span><span class="params">(Voucher voucher)</span> &#123;</span><br><span class="line">    <span class="comment">// ä¿å­˜ä¼˜æƒ åˆ¸</span></span><br><span class="line">    save(voucher);</span><br><span class="line">    <span class="comment">// ä¿å­˜ç§’æ€ä¿¡æ¯</span></span><br><span class="line">    <span class="type">SeckillVoucher</span> <span class="variable">seckillVoucher</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SeckillVoucher</span>();</span><br><span class="line">    seckillVoucher.setVoucherId(voucher.getId());</span><br><span class="line">    seckillVoucher.setStock(voucher.getStock());</span><br><span class="line">    seckillVoucher.setBeginTime(voucher.getBeginTime());</span><br><span class="line">    seckillVoucher.setEndTime(voucher.getEndTime());</span><br><span class="line">    seckillVoucherService.save(seckillVoucher);</span><br><span class="line">    <span class="comment">// ä¿å­˜ç§’æ€ä¼˜æƒ åˆ¸ä¿¡æ¯åˆ°Reidsï¼Œè¿™é‡Œå¹¶ä¸éœ€è¦è®¾ç½®æœ‰æ•ˆæœŸï¼Œç­‰ç§’æ€æ´»åŠ¨è¿‡äº†ï¼Œæˆ‘ä»¬å†æ‰‹åŠ¨å°†å…¶åˆ é™¤</span></span><br><span class="line">    stringRedisTemplate.opsForValue().set(SECKILL_STOCK_KEY + voucher.getId(), voucher.getStock().toString()); </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ç¼–å†™Luaè„šæœ¬ï¼šluaçš„å­—ç¬¦ä¸²æ‹¼æ¥ä½¿ç”¨..ï¼Œå­—ç¬¦ä¸²è½¬æ•°å­—æ˜¯tonumber()</p>
<figure class="highlight lua"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- è®¢å•id</span></span><br><span class="line"><span class="keyword">local</span> voucherId = ARGV[<span class="number">1</span>]</span><br><span class="line"><span class="comment">-- ç”¨æˆ·id</span></span><br><span class="line"><span class="keyword">local</span> userId = ARGV[<span class="number">2</span>]</span><br><span class="line"><span class="comment">-- ä¼˜æƒ åˆ¸key</span></span><br><span class="line"><span class="keyword">local</span> stockKey = <span class="string">&#x27;seckill:stock:&#x27;</span> .. voucherId</span><br><span class="line"><span class="comment">-- è®¢å•key</span></span><br><span class="line"><span class="keyword">local</span> orderKey = <span class="string">&#x27;seckill:order:&#x27;</span> .. voucherId</span><br><span class="line"><span class="comment">-- åˆ¤æ–­åº“å­˜æ˜¯å¦å……è¶³</span></span><br><span class="line"><span class="keyword">if</span> (<span class="built_in">tonumber</span>(redis.call(<span class="string">&#x27;get&#x27;</span>, stockKey)) &lt;= <span class="number">0</span>) <span class="keyword">then</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"><span class="comment">-- åˆ¤æ–­ç”¨æˆ·æ˜¯å¦ä¸‹å•</span></span><br><span class="line"><span class="keyword">if</span> (redis.call(<span class="string">&#x27;sismember&#x27;</span>, orderKey, userId) == <span class="number">1</span>) <span class="keyword">then</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">2</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"><span class="comment">-- æ‰£å‡åº“å­˜</span></span><br><span class="line">redis.call(<span class="string">&#x27;incrby&#x27;</span>, stockKey, <span class="number">-1</span>)</span><br><span class="line"><span class="comment">-- å°†userIdå­˜å…¥å½“å‰ä¼˜æƒ åˆ¸çš„seté›†åˆ</span></span><br><span class="line">redis.call(<span class="string">&#x27;sadd&#x27;</span>, orderKey, userId)</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span></span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> DefaultRedisScript&lt;Long&gt; SECKILL_SCRIPT;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> &#123;</span><br><span class="line">	SECKILL_SCRIPT = <span class="keyword">new</span> <span class="title class_">DefaultRedisScript</span>();</span><br><span class="line">	SECKILL_SCRIPT.setLocation(<span class="keyword">new</span> <span class="title class_">ClassPathResource</span>(<span class="string">&quot;seckill.lua&quot;</span>));</span><br><span class="line">	SECKILL_SCRIPT.setResultType(Long.class);</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line">	<span class="keyword">public</span> Result <span class="title function_">seckillVoucher</span><span class="params">(Long voucherId)</span> &#123;</span><br><span class="line">	<span class="comment">//1. æ‰§è¡Œluaè„šæœ¬</span></span><br><span class="line">	<span class="type">Long</span> <span class="variable">result</span> <span class="operator">=</span> stringRedisTemplate.execute(SECKILL_SCRIPT,</span><br><span class="line">											  Collections.emptyList(), voucherId.toString(),</span><br><span class="line">											  UserHolder.getUser().getId().toString());</span><br><span class="line"><span class="comment">//2. åˆ¤æ–­è¿”å›å€¼ï¼Œå¹¶è¿”å›é”™è¯¯ä¿¡æ¯</span></span><br><span class="line"><span class="keyword">if</span> (result.intValue() != <span class="number">0</span>) &#123;</span><br><span class="line">	<span class="keyword">return</span> Result.fail(result.intValue() == <span class="number">1</span> ? <span class="string">&quot;åº“å­˜ä¸è¶³&quot;</span> : <span class="string">&quot;ä¸èƒ½é‡å¤ä¸‹å•&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">long</span> <span class="variable">orderId</span> <span class="operator">=</span> redisIdWorker.nextId(<span class="string">&quot;order&quot;</span>);</span><br><span class="line"><span class="comment">//TODO ä¿å­˜é˜»å¡é˜Ÿåˆ—</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//3. è¿”å›è®¢å•id</span></span><br><span class="line"><span class="keyword">return</span> Result.ok(orderId);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>æ³¨æ„è¿™è¾¹ç”±äºæ²¡æœ‰keyï¼Œæ‰€ä»¥ä½¿ç”¨Collections.emptyList()</p>
</blockquote>
<h3 id="åŸºäºé˜»å¡é˜Ÿåˆ—å®ç°ç§’æ€ä¼˜åŒ–"><a href="#åŸºäºé˜»å¡é˜Ÿåˆ—å®ç°ç§’æ€ä¼˜åŒ–" class="headerlink" title="åŸºäºé˜»å¡é˜Ÿåˆ—å®ç°ç§’æ€ä¼˜åŒ–"></a>åŸºäºé˜»å¡é˜Ÿåˆ—å®ç°ç§’æ€ä¼˜åŒ–</h3><ul>
<li>ä¿®æ”¹ä¸‹å•çš„æ“ä½œï¼Œæˆ‘ä»¬åœ¨ä¸‹å•æ—¶ï¼Œæ˜¯é€šè¿‡Luaè¡¨è¾¾å¼å»åŸå­æ‰§è¡Œåˆ¤æ–­é€»è¾‘ï¼Œå¦‚æœåˆ¤æ–­ç»“æœä¸ä¸º0ï¼Œè¿”å›é”™è¯¯ä¿¡æ¯ï¼Œå¦‚æœåˆ¤æ–­ç»“æœä¸º0ï¼Œåˆ™å°†ä¸‹å•çš„é€»è¾‘ä¿å­˜åˆ°é˜Ÿåˆ—ä¸­å»ï¼Œç„¶åå¼‚æ­¥æ‰§è¡Œ</li>
<li>éœ€æ±‚ <ol>
<li>å¦‚æœç§’æ€æˆåŠŸï¼Œåˆ™å°†ä¼˜æƒ åˆ¸idå’Œç”¨æˆ·idå°è£…åå­˜å…¥é˜»å¡é˜Ÿåˆ—</li>
<li>å¼€å¯çº¿ç¨‹ä»»åŠ¡ï¼Œä¸æ–­ä»é˜»å¡é˜Ÿåˆ—ä¸­è·å–ä¿¡æ¯ï¼Œå®ç°å¼‚æ­¥ä¸‹å•åŠŸèƒ½</li>
</ol>
</li>
<li>æ­¥éª¤ä¸€ï¼šåˆ›å»ºé˜»å¡é˜Ÿåˆ—<br>é˜»å¡é˜Ÿåˆ—æœ‰ä¸€ä¸ªç‰¹ç‚¹ï¼šå½“ä¸€ä¸ªçº¿ç¨‹å°è¯•ä»é˜»å¡é˜Ÿåˆ—é‡Œè·å–å…ƒç´ çš„æ—¶å€™ï¼Œå¦‚æœæ²¡æœ‰å…ƒç´ ï¼Œé‚£ä¹ˆè¯¥çº¿ç¨‹å°±ä¼šè¢«é˜»å¡ï¼Œç›´åˆ°é˜Ÿåˆ—ä¸­æœ‰å…ƒç´ ï¼Œæ‰ä¼šè¢«å”¤é†’ï¼Œå¹¶å»è·å–å…ƒç´ <br>é˜»å¡é˜Ÿåˆ—çš„åˆ›å»ºéœ€è¦æŒ‡å®šä¸€ä¸ªå¤§å°<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> BlockingQueue&lt;VoucherOrder&gt; orderTasks = <span class="keyword">new</span> <span class="title class_">ArrayBlockingQueue</span>&lt;&gt;(<span class="number">1024</span> * <span class="number">1024</span>);</span><br></pre></td></tr></table></figure>
é‚£ä¹ˆæŠŠä¼˜æƒ åˆ¸idå’Œç”¨æˆ·idå°è£…åå­˜å…¥é˜»å¡é˜Ÿåˆ—<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> Result <span class="title function_">seckillVoucher</span><span class="params">(Long voucherId)</span> &#123;</span><br><span class="line">    <span class="type">Long</span> <span class="variable">result</span> <span class="operator">=</span> stringRedisTemplate.execute(SECKILL_SCRIPT,</span><br><span class="line">            Collections.emptyList(), voucherId.toString(),</span><br><span class="line">            UserHolder.getUser().getId().toString());</span><br><span class="line">    <span class="keyword">if</span> (result.intValue() != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> Result.fail(result.intValue() == <span class="number">1</span> ? <span class="string">&quot;åº“å­˜ä¸è¶³&quot;</span> : <span class="string">&quot;ä¸èƒ½é‡å¤ä¸‹å•&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">long</span> <span class="variable">orderId</span> <span class="operator">=</span> redisIdWorker.nextId(<span class="string">&quot;order&quot;</span>);</span><br><span class="line">    <span class="comment">//å°è£…åˆ°voucherOrderä¸­</span></span><br><span class="line">    <span class="type">VoucherOrder</span> <span class="variable">voucherOrder</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">VoucherOrder</span>();</span><br><span class="line">    voucherOrder.setVoucherId(voucherId);</span><br><span class="line">    voucherOrder.setUserId(UserHolder.getUser().getId());</span><br><span class="line">    voucherOrder.setId(orderId);</span><br><span class="line">    <span class="comment">//åŠ å…¥åˆ°é˜»å¡é˜Ÿåˆ—</span></span><br><span class="line">    orderTasks.add(voucherOrder);</span><br><span class="line">    <span class="keyword">return</span> Result.ok(orderId);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
å®ç°å¼‚æ­¥ä¸‹å•åŠŸèƒ½</li>
</ul>
<ol>
<li><p>åˆ›å»ºä¸€ä¸ªçº¿ç¨‹æ± </p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">ExecutorService</span> <span class="variable">SECKILL_ORDER_EXECUTOR</span> <span class="operator">=</span> Executors.newSingleThreadExecutor();</span><br></pre></td></tr></table></figure>
</li>
<li><p>åˆ›å»ºçº¿ç¨‹ä»»åŠ¡ï¼šç§’æ€ä¸šåŠ¡éœ€è¦åœ¨ç±»åˆå§‹åŒ–ä¹‹åï¼Œå°±ç«‹å³æ‰§è¡Œï¼Œè¿™é‡Œç”¨åˆ°@PostConstructæ³¨è§£</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@PostConstruct</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">init</span><span class="params">()</span> &#123;</span><br><span class="line">    SECKILL_ORDER_EXECUTOR.submit(<span class="keyword">new</span> <span class="title class_">VoucherOrderHandler</span>());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">class</span> <span class="title class_">VoucherOrderHandler</span> <span class="keyword">implements</span> <span class="title class_">Runnable</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">//1. è·å–é˜Ÿåˆ—ä¸­çš„è®¢å•ä¿¡æ¯</span></span><br><span class="line">                <span class="type">VoucherOrder</span> <span class="variable">voucherOrder</span> <span class="operator">=</span> orderTasks.take();</span><br><span class="line">                <span class="comment">//2. åˆ›å»ºè®¢å•</span></span><br><span class="line">                handleVoucherOrder(voucherOrder);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                log.error(<span class="string">&quot;è®¢å•å¤„ç†å¼‚å¸¸&quot;</span>, e);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>åˆ›å»ºè®¢å•é€»è¾‘</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> IVoucherOrderService proxy;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">handleVoucherOrder</span><span class="params">(VoucherOrder voucherOrder)</span> &#123;</span><br><span class="line">    <span class="comment">//1. è·å–ç”¨æˆ·</span></span><br><span class="line">    <span class="type">Long</span> <span class="variable">userId</span> <span class="operator">=</span> voucherOrder.getUserId();</span><br><span class="line">    <span class="comment">//2. åˆ›å»ºé”å¯¹è±¡ï¼Œä½œä¸ºå…œåº•æ–¹æ¡ˆ</span></span><br><span class="line">    <span class="type">RLock</span> <span class="variable">redisLock</span> <span class="operator">=</span> redissonClient.getLock(<span class="string">&quot;order:&quot;</span> + userId);</span><br><span class="line">    <span class="comment">//3. è·å–é”</span></span><br><span class="line">    <span class="type">boolean</span> <span class="variable">isLock</span> <span class="operator">=</span> redisLock.tryLock();</span><br><span class="line">    <span class="comment">//4. åˆ¤æ–­æ˜¯å¦è·å–é”æˆåŠŸ(ç†è®ºä¸Šå¿…æˆåŠŸï¼Œrediså·²ç»å¸®æˆ‘ä»¬åˆ¤æ–­äº†)</span></span><br><span class="line">    <span class="keyword">if</span> (!isLock) &#123;</span><br><span class="line">        log.error(<span class="string">&quot;ä¸å…è®¸é‡å¤ä¸‹å•!&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">//5. ä½¿ç”¨ä»£ç†å¯¹è±¡ï¼Œç”±äºè¿™é‡Œæ˜¯å¦å¤–ä¸€ä¸ªçº¿ç¨‹ï¼Œ</span></span><br><span class="line">        proxy.createVoucherOrder(voucherOrder);</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        redisLock.unlock();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æŸ¥çœ‹AopContextæºç ï¼Œå®ƒçš„è·å–ä»£ç†å¯¹è±¡ä¹Ÿæ˜¯é€šè¿‡ThreadLocalè¿›è¡Œè·å–çš„ï¼Œç”±äºæˆ‘ä»¬è¿™é‡Œæ˜¯å¼‚æ­¥ä¸‹å•ï¼Œå’Œä¸»çº¿ç¨‹ä¸æ˜¯ä¸€ä¸ªçº¿ç¨‹ï¼Œæ‰€ä»¥ä¸èƒ½è·å–æˆåŠŸ</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> ThreadLocal&lt;Object&gt; currentProxy = <span class="keyword">new</span> <span class="title class_">NamedThreadLocal</span>(<span class="string">&quot;Current AOP proxy&quot;</span>);</span><br></pre></td></tr></table></figure>
<p>ä½†æ˜¯æˆ‘ä»¬å¯ä»¥å°†proxyæ”¾åœ¨æˆå‘˜å˜é‡çš„ä½ç½®ï¼Œç„¶ååœ¨ä¸»çº¿ç¨‹ä¸­è·å–ä»£ç†å¯¹è±¡</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> Result <span class="title function_">seckillVoucher</span><span class="params">(Long voucherId)</span> &#123;</span><br><span class="line">    <span class="type">Long</span> <span class="variable">result</span> <span class="operator">=</span> stringRedisTemplate.execute(SECKILL_SCRIPT,</span><br><span class="line">            Collections.emptyList(), voucherId.toString(),</span><br><span class="line">            UserHolder.getUser().getId().toString());</span><br><span class="line">    <span class="keyword">if</span> (result.intValue() != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> Result.fail(result.intValue() == <span class="number">1</span> ? <span class="string">&quot;åº“å­˜ä¸è¶³&quot;</span> : <span class="string">&quot;ä¸èƒ½é‡å¤ä¸‹å•&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">long</span> <span class="variable">orderId</span> <span class="operator">=</span> redisIdWorker.nextId(<span class="string">&quot;order&quot;</span>);</span><br><span class="line">    <span class="comment">//å°è£…åˆ°voucherOrderä¸­</span></span><br><span class="line">    <span class="type">VoucherOrder</span> <span class="variable">voucherOrder</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">VoucherOrder</span>();</span><br><span class="line">    voucherOrder.setVoucherId(voucherId);</span><br><span class="line">    voucherOrder.setUserId(UserHolder.getUser().getId());</span><br><span class="line">    voucherOrder.setId(orderId);</span><br><span class="line">    <span class="comment">//åŠ å…¥åˆ°é˜»å¡é˜Ÿåˆ—</span></span><br><span class="line">    orderTasks.add(voucherOrder);</span><br><span class="line">    <span class="comment">//ä¸»çº¿ç¨‹è·å–ä»£ç†å¯¹è±¡</span></span><br><span class="line">    proxy = (IVoucherOrderService) AopContext.currentProxy();</span><br><span class="line">    <span class="keyword">return</span> Result.ok(orderId);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å®Œæ•´ä»£ç å¦‚ä¸‹</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.hmdp.service.impl;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.hmdp.dto.Result;</span><br><span class="line"><span class="keyword">import</span> com.hmdp.entity.VoucherOrder;</span><br><span class="line"><span class="keyword">import</span> com.hmdp.mapper.VoucherOrderMapper;</span><br><span class="line"><span class="keyword">import</span> com.hmdp.service.ISeckillVoucherService;</span><br><span class="line"><span class="keyword">import</span> com.hmdp.service.IVoucherOrderService;</span><br><span class="line"><span class="keyword">import</span> com.baomidou.mybatisplus.extension.service.impl.ServiceImpl;</span><br><span class="line"><span class="keyword">import</span> com.hmdp.utils.RedisIdWorker;</span><br><span class="line"><span class="keyword">import</span> com.hmdp.utils.UserHolder;</span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.redisson.api.RLock;</span><br><span class="line"><span class="keyword">import</span> org.redisson.api.RedissonClient;</span><br><span class="line"><span class="keyword">import</span> org.springframework.aop.framework.AopContext;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.core.io.ClassPathResource;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.core.StringRedisTemplate;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.core.script.DefaultRedisScript;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Service;</span><br><span class="line"><span class="keyword">import</span> org.springframework.transaction.annotation.Transactional;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.annotation.PostConstruct;</span><br><span class="line"><span class="keyword">import</span> javax.annotation.Resource;</span><br><span class="line"><span class="keyword">import</span> java.util.Collections;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.ArrayBlockingQueue;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.BlockingQueue;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.ExecutorService;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.Executors;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">VoucherOrderServiceImpl</span> <span class="keyword">extends</span> <span class="title class_">ServiceImpl</span>&lt;VoucherOrderMapper, VoucherOrder&gt; <span class="keyword">implements</span> <span class="title class_">IVoucherOrderService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> ISeckillVoucherService seckillVoucherService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RedisIdWorker redisIdWorker;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> StringRedisTemplate stringRedisTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> RedissonClient redissonClient;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> IVoucherOrderService proxy;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> DefaultRedisScript&lt;Long&gt; SECKILL_SCRIPT;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        SECKILL_SCRIPT = <span class="keyword">new</span> <span class="title class_">DefaultRedisScript</span>();</span><br><span class="line">        SECKILL_SCRIPT.setLocation(<span class="keyword">new</span> <span class="title class_">ClassPathResource</span>(<span class="string">&quot;seckill.lua&quot;</span>));</span><br><span class="line">        SECKILL_SCRIPT.setResultType(Long.class);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">ExecutorService</span> <span class="variable">SECKILL_ORDER_EXECUTOR</span> <span class="operator">=</span> Executors.newSingleThreadExecutor();</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PostConstruct</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">init</span><span class="params">()</span> &#123;</span><br><span class="line">        SECKILL_ORDER_EXECUTOR.submit(<span class="keyword">new</span> <span class="title class_">VoucherOrderHandler</span>());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> BlockingQueue&lt;VoucherOrder&gt; orderTasks = <span class="keyword">new</span> <span class="title class_">ArrayBlockingQueue</span>&lt;&gt;(<span class="number">1024</span> * <span class="number">1024</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">handleVoucherOrder</span><span class="params">(VoucherOrder voucherOrder)</span> &#123;</span><br><span class="line">        <span class="comment">//1. è·å–ç”¨æˆ·</span></span><br><span class="line">        <span class="type">Long</span> <span class="variable">userId</span> <span class="operator">=</span> voucherOrder.getUserId();</span><br><span class="line">        <span class="comment">//2. åˆ›å»ºé”å¯¹è±¡ï¼Œä½œä¸ºå…œåº•æ–¹æ¡ˆ</span></span><br><span class="line">        <span class="type">RLock</span> <span class="variable">redisLock</span> <span class="operator">=</span> redissonClient.getLock(<span class="string">&quot;order:&quot;</span> + userId);</span><br><span class="line">        <span class="comment">//3. è·å–é”</span></span><br><span class="line">        <span class="type">boolean</span> <span class="variable">isLock</span> <span class="operator">=</span> redisLock.tryLock();</span><br><span class="line">        <span class="comment">//4. åˆ¤æ–­æ˜¯å¦è·å–é”æˆåŠŸ(ç†è®ºä¸Šå¿…æˆåŠŸï¼Œrediså·²ç»å¸®æˆ‘ä»¬åˆ¤æ–­äº†)</span></span><br><span class="line">        <span class="keyword">if</span> (!isLock) &#123;</span><br><span class="line">            log.error(<span class="string">&quot;ä¸å…è®¸é‡å¤ä¸‹å•!&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">//5. ä½¿ç”¨ä»£ç†å¯¹è±¡ï¼Œç”±äºè¿™é‡Œæ˜¯å¦å¤–ä¸€ä¸ªçº¿ç¨‹ï¼Œ</span></span><br><span class="line">            proxy.createVoucherOrder(voucherOrder);</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            redisLock.unlock();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">class</span> <span class="title class_">VoucherOrderHandler</span> <span class="keyword">implements</span> <span class="title class_">Runnable</span> &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="comment">//1. è·å–é˜Ÿåˆ—ä¸­çš„è®¢å•ä¿¡æ¯</span></span><br><span class="line">                    <span class="type">VoucherOrder</span> <span class="variable">voucherOrder</span> <span class="operator">=</span> orderTasks.take();</span><br><span class="line">                    <span class="comment">//2. åˆ›å»ºè®¢å•</span></span><br><span class="line">                    handleVoucherOrder(voucherOrder);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                    log.error(<span class="string">&quot;è®¢å•å¤„ç†å¼‚å¸¸&quot;</span>, e);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Result <span class="title function_">seckillVoucher</span><span class="params">(Long voucherId)</span> &#123;</span><br><span class="line">        <span class="type">Long</span> <span class="variable">result</span> <span class="operator">=</span> stringRedisTemplate.execute(SECKILL_SCRIPT,</span><br><span class="line">                Collections.emptyList(), voucherId.toString(),</span><br><span class="line">                UserHolder.getUser().getId().toString());</span><br><span class="line">        <span class="keyword">if</span> (result.intValue() != <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> Result.fail(result.intValue() == <span class="number">1</span> ? <span class="string">&quot;åº“å­˜ä¸è¶³&quot;</span> : <span class="string">&quot;ä¸èƒ½é‡å¤ä¸‹å•&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">long</span> <span class="variable">orderId</span> <span class="operator">=</span> redisIdWorker.nextId(<span class="string">&quot;order&quot;</span>);</span><br><span class="line">        <span class="comment">//å°è£…åˆ°voucherOrderä¸­</span></span><br><span class="line">        <span class="type">VoucherOrder</span> <span class="variable">voucherOrder</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">VoucherOrder</span>();</span><br><span class="line">        voucherOrder.setVoucherId(voucherId);</span><br><span class="line">        voucherOrder.setUserId(UserHolder.getUser().getId());</span><br><span class="line">        voucherOrder.setId(orderId);</span><br><span class="line">        <span class="comment">//åŠ å…¥åˆ°é˜»å¡é˜Ÿåˆ—</span></span><br><span class="line">        orderTasks.add(voucherOrder);</span><br><span class="line">        <span class="comment">//ä¸»çº¿ç¨‹è·å–ä»£ç†å¯¹è±¡</span></span><br><span class="line">        proxy = (IVoucherOrderService) AopContext.currentProxy();</span><br><span class="line">        <span class="keyword">return</span> Result.ok(orderId);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Transactional</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">createVoucherOrder</span><span class="params">(VoucherOrder voucherOrder)</span> &#123;</span><br><span class="line">        <span class="comment">// ä¸€äººä¸€å•é€»è¾‘</span></span><br><span class="line">        <span class="type">Long</span> <span class="variable">userId</span> <span class="operator">=</span> voucherOrder.getUserId();</span><br><span class="line">        <span class="type">Long</span> <span class="variable">voucherId</span> <span class="operator">=</span> voucherOrder.getVoucherId();</span><br><span class="line">        <span class="keyword">synchronized</span> (userId.toString().intern()) &#123;</span><br><span class="line">            <span class="type">int</span> <span class="variable">count</span> <span class="operator">=</span> query().eq(<span class="string">&quot;voucher_id&quot;</span>, voucherId).eq(<span class="string">&quot;user_id&quot;</span>, userId).count();</span><br><span class="line">            <span class="keyword">if</span> (count &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                log.error(<span class="string">&quot;ä½ å·²ç»æŠ¢è¿‡ä¼˜æƒ åˆ¸äº†å“¦&quot;</span>);</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//5. æ‰£å‡åº“å­˜</span></span><br><span class="line">            <span class="type">boolean</span> <span class="variable">success</span> <span class="operator">=</span> seckillVoucherService.update()</span><br><span class="line">                    .setSql(<span class="string">&quot;stock = stock - 1&quot;</span>)</span><br><span class="line">                    .eq(<span class="string">&quot;voucher_id&quot;</span>, voucherId)</span><br><span class="line">                    .gt(<span class="string">&quot;stock&quot;</span>, <span class="number">0</span>)</span><br><span class="line">                    .update();</span><br><span class="line">            <span class="keyword">if</span> (!success) &#123;</span><br><span class="line">                log.error(<span class="string">&quot;åº“å­˜ä¸è¶³&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//7. å°†è®¢å•æ•°æ®ä¿å­˜åˆ°è¡¨ä¸­</span></span><br><span class="line">            save(voucherOrder);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ol>
<h1 id="æ¶ˆæ¯é˜Ÿåˆ—"><a href="#æ¶ˆæ¯é˜Ÿåˆ—" class="headerlink" title="æ¶ˆæ¯é˜Ÿåˆ—"></a>æ¶ˆæ¯é˜Ÿåˆ—</h1><h2 id="é—®é¢˜"><a href="#é—®é¢˜" class="headerlink" title="é—®é¢˜"></a>é—®é¢˜</h2><p>JDK ä¸­çš„é˜»å¡é˜Ÿåˆ—ï¼ˆBlockingQueueï¼‰æ˜¯ä¸€ç§çº¿ç¨‹å®‰å…¨çš„é˜Ÿåˆ—ï¼Œå®ƒå¯ä»¥åœ¨å¤šçº¿ç¨‹ç¯å¢ƒä¸‹ä½¿ç”¨ã€‚ä½†æ˜¯ï¼Œä½¿ç”¨é˜»å¡é˜Ÿåˆ—ä¹Ÿå¯èƒ½å­˜åœ¨ä¸€äº›é—®é¢˜ï¼Œä»¥ä¸‹æ˜¯å…¶ä¸­çš„ä¸€äº›ï¼š</p>
<ol>
<li>æ­»é”ï¼šå¦‚æœå¤šä¸ªçº¿ç¨‹åŒæ—¶å°è¯•è·å–é˜Ÿåˆ—çš„å…ƒç´ ï¼Œä½†é˜Ÿåˆ—å·²æ»¡æˆ–å·²ç©ºï¼Œåˆ™å¯èƒ½ä¼šå¯¼è‡´æ­»é”ã€‚è¿™æ˜¯å› ä¸ºé˜Ÿåˆ—çš„æ“ä½œæ˜¯é˜»å¡çš„ï¼Œä¸€æ—¦æœ‰çº¿ç¨‹è·å–äº†é˜Ÿåˆ—çš„å…ƒç´ ï¼Œå…¶ä»–çº¿ç¨‹å°±å¿…é¡»ç­‰å¾…ï¼Œç›´åˆ°é˜Ÿåˆ—ä¸­æœ‰ç©ºé—´å¯ç”¨ã€‚</li>
<li>ç«äº‰æ¡ä»¶ï¼šå¦‚æœå¤šä¸ªçº¿ç¨‹åŒæ—¶å°è¯•è·å–é˜Ÿåˆ—çš„å…ƒç´ ï¼Œä½†é˜Ÿåˆ—ä¸­å·²ç»æœ‰ä¸€ä¸ªçº¿ç¨‹æ­£åœ¨ç­‰å¾…ï¼Œåˆ™å…¶ä»–çº¿ç¨‹å¯èƒ½ä¼šè¢«é˜»å¡ï¼Œç›´åˆ°é˜Ÿåˆ—ä¸­æœ‰ç©ºé—´å¯ç”¨ã€‚è¿™ä¼šå¯¼è‡´ç³»ç»Ÿèµ„æºçš„æµªè´¹ã€‚</li>
<li>ä¸ç¡®å®šæ€§ï¼šç”±äºé˜»å¡é˜Ÿåˆ—æ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Œå› æ­¤åœ¨æŸäº›æƒ…å†µä¸‹ï¼Œçº¿ç¨‹å¯èƒ½ä¼šåœ¨ç­‰å¾…é˜Ÿåˆ—æ“ä½œå®Œæˆæ—¶å‘ç”Ÿé˜»å¡ï¼Œè€Œæ— æ³•ç«‹å³æ‰§è¡Œå…¶ä»–æ“ä½œã€‚è¿™ä¼šå¯¼è‡´ç¨‹åºçš„æ€§èƒ½ä¸‹é™ã€‚</li>
<li>ä¸å¯æ¢å¤æ€§ï¼šå¦‚æœé˜Ÿåˆ—è¢«æ„å¤–åœ°ç ´åï¼Œä¾‹å¦‚ç”±äºç³»ç»Ÿæ•…éšœæˆ–å¼‚å¸¸ï¼Œåˆ™å¯èƒ½ä¼šå¯¼è‡´æ•°æ®ä¸¢å¤±æˆ–ä¸ä¸€è‡´ã€‚è¿™ä½¿å¾—é˜»å¡é˜Ÿåˆ—åœ¨æŸäº›æƒ…å†µä¸‹ä¸å¯æ¢å¤ã€‚</li>
</ol>
<h2 id="ä»€ä¹ˆæ˜¯æ¶ˆæ¯é˜Ÿåˆ—"><a href="#ä»€ä¹ˆæ˜¯æ¶ˆæ¯é˜Ÿåˆ—" class="headerlink" title="ä»€ä¹ˆæ˜¯æ¶ˆæ¯é˜Ÿåˆ—"></a>ä»€ä¹ˆæ˜¯æ¶ˆæ¯é˜Ÿåˆ—</h2><p>æœ€ç®€å•çš„æ¶ˆæ¯é˜Ÿåˆ—æ¨¡å‹åŒ…æ‹¬3ä¸ªè§’è‰²</p>
<ol>
<li>æ¶ˆæ¯é˜Ÿåˆ—ï¼šå­˜å‚¨å’Œç®¡ç†æ¶ˆæ¯ï¼Œä¹Ÿè¢«ç§°ä¸ºæ¶ˆæ¯ä»£ç†ï¼ˆMessage Brokerï¼‰</li>
<li>ç”Ÿäº§è€…ï¼šå‘é€æ¶ˆæ¯åˆ°æ¶ˆæ¯é˜Ÿåˆ—</li>
<li>æ¶ˆè´¹è€…ï¼šä»æ¶ˆæ¯é˜Ÿåˆ—è·å–æ¶ˆæ¯å¹¶å¤„ç†æ¶ˆæ¯</li>
</ol>
<p>ä½¿ç”¨é˜Ÿåˆ—çš„å¥½å¤„åœ¨äºè§£è€¦ï¼šä¸¾ä¸ªä¾‹å­ï¼Œå¿«é€’å‘˜(ç”Ÿäº§è€…)å§å¿«é€’æ”¾åˆ°é©¿ç«™&#x2F;å¿«é€’æŸœé‡Œå»(Message Queue)å»ï¼Œæˆ‘ä»¬(æ¶ˆè´¹è€…)ä»å¿«é€’æŸœ&#x2F;é©¿ç«™å»æ‹¿å¿«é€’ï¼Œè¿™å°±æ˜¯ä¸€ä¸ªå¼‚æ­¥ï¼Œå¦‚æœè€¦åˆï¼Œé‚£ä¹ˆå¿«é€’å‘˜å¿…é¡»äº²è‡ªä¸Šæ¥¼æŠŠå¿«é€’é€’åˆ°ä½ æ‰‹é‡Œï¼ŒæœåŠ¡å½“ç„¶å¥½ï¼Œä½†æ˜¯ä¸‡ä¸€æˆ‘ä¸åœ¨å®¶ï¼Œå¿«é€’å‘˜å°±å¾—ä¸€ç›´ç­‰æˆ‘ï¼Œæµªè´¹äº†å¿«é€’å‘˜çš„æ—¶é—´ã€‚æ‰€ä»¥è§£è€¦è¿˜æ˜¯éå¸¸æœ‰å¿…è¦çš„<br>é‚£ä¹ˆåœ¨è¿™ç§åœºæ™¯ä¸‹æˆ‘ä»¬çš„ç§’æ€å°±å˜æˆäº†ï¼šåœ¨æˆ‘ä»¬ä¸‹å•ä¹‹åï¼Œåˆ©ç”¨Rediså»è¿›è¡Œæ ¡éªŒä¸‹å•çš„ç»“æœï¼Œç„¶ååœ¨é€šè¿‡é˜Ÿåˆ—æŠŠæ¶ˆæ¯å‘é€å‡ºå»ï¼Œç„¶ååœ¨å¯åŠ¨ä¸€ä¸ªçº¿ç¨‹å»æ‹¿åˆ°è¿™ä¸ªæ¶ˆæ¯ï¼Œå®Œæˆè§£è€¦ï¼ŒåŒæ—¶ä¹ŸåŠ å¿«æˆ‘ä»¬çš„å“åº”é€Ÿåº¦<br>è¿™é‡Œæˆ‘ä»¬å¯ä»¥ç›´æ¥ä½¿ç”¨ä¸€äº›ç°æˆçš„(MQ)æ¶ˆæ¯é˜Ÿåˆ—ï¼Œå¦‚kafkaï¼Œrabbitmqç­‰ï¼Œä½†æ˜¯å¦‚æœæ²¡æœ‰å®‰è£…MQï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥ä½¿ç”¨Redisæä¾›çš„MQæ–¹æ¡ˆ(å­¦å®ŒRedisæˆ‘å°±å»å­¦å¾®æœåŠ¡)</p>
<h2 id="å®ç°æ–¹å¼-1"><a href="#å®ç°æ–¹å¼-1" class="headerlink" title="å®ç°æ–¹å¼"></a>å®ç°æ–¹å¼</h2><h3 id="List-1"><a href="#List-1" class="headerlink" title="List"></a>List</h3><p>Redisçš„listæ•°æ®ç»“æ„æ˜¯ä¸€ä¸ª<strong>åŒå‘é“¾è¡¨</strong>ï¼Œå¾ˆå®¹æ˜“æ¨¡æ‹Ÿå‡ºé˜Ÿåˆ—çš„æ•ˆæœ<br>é˜Ÿåˆ—çš„å…¥å£å’Œå‡ºå£ä¸åœ¨åŒä¸€è¾¹ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥åˆ©ç”¨ï¼šLPUSHæ¨¡æ‹Ÿç”Ÿäº§è€…å‘é€æ¶ˆæ¯å…¥é˜Ÿï¼Œä½¿ç”¨<br>BRPOPæˆ–è€…BLPOPæ¥å®ç°é˜»å¡æ•ˆæœ<br><code>BRPOP</code> å‘½ä»¤ç”¨äºé˜»å¡åœ°ç­‰å¾…é˜Ÿåˆ—ä¸­æœ‰ç©ºé—²ç©ºé—´(é˜Ÿåˆ—é•¿åº¦&gt;0)ï¼Œå¹¶åœ¨æœ‰ç©ºé—²ç©ºé—´æ—¶ç«‹å³è¿”å›æ¶ˆæ¯ã€‚å¦‚æœé˜Ÿåˆ—ä¸ºç©ºï¼Œåˆ™ BRPOP å‘½ä»¤ä¼šé˜»å¡ç­‰å¾…ï¼Œç›´åˆ°æœ‰ç©ºé—²ç©ºé—´å¯ç”¨ã€‚<br><code>BLPOP</code> å‘½ä»¤ç”¨äºç«‹å³è·å–é˜Ÿåˆ—ä¸­çš„æ¶ˆæ¯ï¼Œå¹¶åœ¨æœ‰æ¶ˆæ¯å¯ç”¨æ—¶è¿”å›ã€‚å¦‚æœé˜Ÿåˆ—ä¸ºç©ºï¼Œåˆ™ BLPOP å‘½ä»¤ä¼šé˜»å¡ç­‰å¾…ï¼Œç›´åˆ°æœ‰æ¶ˆæ¯å¯ç”¨ã€‚<br>åŸºäºListçš„æ¶ˆæ¯é˜Ÿåˆ—æœ‰å“ªäº›ä¼˜ç¼ºç‚¹ï¼Ÿ<br>ä¼˜ç‚¹</p>
<ol>
<li>åˆ©ç”¨Rediså­˜å‚¨ï¼Œä¸å—é™äºJVMå†…å­˜ä¸Šé™</li>
<li>åŸºäºRedisçš„æŒä¹…åŒ–æœºåˆ¶ï¼Œæ•°æ®å®‰å…¨æ€§æœ‰ä¿éšœ</li>
<li>å¯ä»¥æ»¡è¶³æ¶ˆæ¯æœ‰åºæ€§</li>
</ol>
<p>ç¼ºç‚¹</p>
<ol>
<li>æ— æ³•é¿å…æ¶ˆæ¯ä¸¢å¤±(ç»å…¸æœåŠ¡å™¨å®•æœº)</li>
<li>åªæ”¯æŒå•æ¶ˆè´¹è€…(ä¸€ä¸ªæ¶ˆè´¹è€…æŠŠæ¶ˆæ¯æ‹¿èµ°äº†ï¼Œå…¶ä»–æ¶ˆè´¹è€…å°±çœ‹ä¸åˆ°è¿™æ¡æ¶ˆæ¯äº†)</li>
</ol>
<h2 id="Pub-x2F-Sub"><a href="#Pub-x2F-Sub" class="headerlink" title="Pub&#x2F;Sub"></a>Pub&#x2F;Sub</h2><p>ä½¿ç”¨ Redis çš„è®¢é˜…å‘å¸ƒæ¨¡å‹ï¼Œç”Ÿäº§è€…å¯ä»¥å°†æ¶ˆæ¯æ¨é€ç»™æŸä¸ª Channel (é¢‘é“) ï¼Œå¤šä¸ªæ¶ˆè´¹è€…å¯ä»¥è®¢é˜…è¯¥é¢‘é“ï¼Œä»è€ŒåŒæ—¶å¾—åˆ°æ¶ˆæ¯ã€‚(å¯ä»¥ç†è§£ä¸ºâ€œä½ å…³æ³¨çš„ UP ä¸»æ›´æ–°å•¦â€)<br>ç”¨åˆ°çš„å‘½ä»¤ä¸»è¦æ˜¯</p>
<ul>
<li>Publish æ¨é€</li>
<li>SubScribe è®¢é˜…</li>
<li>PSubScribe è®¢é˜…æŸä¸ªè¡¨è¾¾å¼åŒ¹é…çš„å¤šä¸ªé¢‘é“è¿™æ ·å°±å®ç°äº†å¤šç”Ÿäº§ã€å¤šæ¶ˆè´¹ç¼ºç‚¹æ¯”è¾ƒå¤š</li>
</ul>
<p>ä¼˜ç‚¹ï¼š<br>é‡‡ç”¨å‘å¸ƒè®¢é˜…æ¨¡å‹ï¼Œæ”¯æŒå¤šç”Ÿäº§ï¼Œå¤šæ¶ˆè´¹<br>ç¼ºç‚¹ï¼š</p>
<ol>
<li>ä¸æ”¯æŒæ•°æ®æŒä¹…åŒ–</li>
<li>æ— æ³•é¿å…æ¶ˆæ¯ä¸¢å¤±ï¼ˆå¦‚æœå‘é¢‘é“å‘é€äº†æ¶ˆæ¯ï¼Œå´æ²¡æœ‰äººè®¢é˜…è¯¥é¢‘é“ï¼Œé‚£å‘é€çš„è¿™æ¡æ¶ˆæ¯å°±ä¸¢å¤±äº†ï¼‰</li>
<li>æ¶ˆæ¯å †ç§¯æœ‰ä¸Šé™ï¼Œè¶…å‡ºæ—¶æ•°æ®ä¸¢å¤±ï¼ˆæ¶ˆè´¹è€…æ‹¿åˆ°æ•°æ®çš„æ—¶å€™å¤„ç†çš„å¤ªæ…¢ï¼Œè€Œå‘é€æ¶ˆæ¯å‘çš„å¤ªå¿«ï¼‰</li>
</ol>
<h1 id="Stream"><a href="#Stream" class="headerlink" title="Stream"></a>Stream</h1><ul>
<li>Streamæ˜¯Redis 5.0å¼•å…¥çš„ä¸€ç§æ–°æ•°æ®ç±»å‹ï¼Œå¯ä»¥æ—¶é—´ä¸€ä¸ªåŠŸèƒ½éå¸¸å®Œå–„çš„æ¶ˆæ¯é˜Ÿåˆ—</li>
</ul>
<h2 id="æ ¸å¿ƒå‘½ä»¤"><a href="#æ ¸å¿ƒå‘½ä»¤" class="headerlink" title="æ ¸å¿ƒå‘½ä»¤"></a>æ ¸å¿ƒå‘½ä»¤</h2><h3 id="å‘é€æ¶ˆæ¯"><a href="#å‘é€æ¶ˆæ¯" class="headerlink" title="å‘é€æ¶ˆæ¯"></a>å‘é€æ¶ˆæ¯</h3><p><code>XAdd</code>ï¼šæ·»åŠ æ¶ˆæ¯&#x2F;åˆ›å»ºé˜Ÿåˆ—ï¼Œæ¶ˆæ¯ä¼šè‡ªåŠ¨æŒä¹…åŒ–ï¼Œä¸ä¼šä¸¢å¤±ï¼Œæ¯ä¸ªæ¶ˆæ¯éƒ½æœ‰å”¯ä¸€id</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">XADD streamName ID field1 value1 field2 value2 ... fieldN valueN</span><br></pre></td></tr></table></figure>

<blockquote>
<ul>
<li>treamNameæ˜¯Streamçš„åç§°ï¼ŒIDæ˜¯æ¶ˆæ¯çš„å”¯ä¸€æ ‡è¯†ç¬¦ï¼Œfieldå’Œvalueæ˜¯æ¶ˆæ¯çš„é”®å€¼å¯¹ã€‚</li>
<li>Dæœ‰ä¸¤ç§å½¢å¼ï¼šå’Œ*ã€‚è¡¨ç¤ºä½¿ç”¨è‡ªåŠ¨ç”Ÿæˆçš„IDï¼Œè¡¨ç¤ºæ‰‹åŠ¨æŒ‡å®šIDã€‚å¦‚æœä½¿ç”¨$ï¼Œé‚£ä¹ˆIDçš„æ ¼å¼ä¸ºtimestamp-sequencenumberï¼Œå…¶ä¸­timestampæ˜¯Unixæ—¶é—´æˆ³ï¼Œsequencenumberæ˜¯ä¸€ä¸ªé€’å¢çš„åºåˆ—å·ã€‚å¦‚æœä½¿ç”¨ï¼Œé‚£ä¹ˆIDå¿…é¡»æ˜¯ä¸€ä¸ªæ•´æ•°ï¼Œå¹¶ä¸”å¿…é¡»æ¯”Streamä¸­æœ€åä¸€æ¡æ¶ˆæ¯çš„IDå¤§</li>
<li>XADDæŒ‡ä»¤ä¼šè¿”å›æ–°æ¶ˆæ¯çš„IDï¼Œå¯ä»¥ç”¨è¿™ä¸ªIDæ¥æŸ¥è¯¢æˆ–åˆ é™¤æ¶ˆæ¯ã€‚å¦‚æœStreamä¸å­˜åœ¨ï¼ŒXADDæŒ‡ä»¤ä¼šè‡ªåŠ¨åˆ›å»ºä¸€ä¸ªæ–°çš„Streamã€‚</li>
</ul>
</blockquote>
<h3 id="è¯»å–æ¶ˆæ¯"><a href="#è¯»å–æ¶ˆæ¯" class="headerlink" title="è¯»å–æ¶ˆæ¯"></a>è¯»å–æ¶ˆæ¯</h3><p><code>XRead</code>ï¼šè¯»å–æ¶ˆæ¯ï¼Œæ”¯æŒå¤šæ¶ˆè´¹è€…è¯»ï¼Œå¯ä»æŒ‡å®šidå¼€è¯»ï¼Œæ”¯æŒé˜»å¡è¯»å–æœ€æ–°æ¶ˆæ¯<br>Redis Streamæä¾›äº†å¤šç§æ–¹å¼æ¥è¯»å–æ¶ˆæ¯ï¼Œä»¥ä¸‹æ˜¯å¸¸ç”¨çš„å‡ ç§æ–¹æ³•ï¼š<br>XREADï¼šä½¿ç”¨XREADæŒ‡ä»¤å¯ä»¥è¯»å–Streamä¸­çš„æ¶ˆæ¯ã€‚XREADå¯ä»¥æŒ‡å®šå¤šä¸ªStreamå’ŒIDï¼Œè¿”å›çš„ç»“æœæ˜¯ä¸€ä¸ªæ•°ç»„ï¼ŒåŒ…å«äº†æ¯ä¸ªStreamä¸­æŒ‡å®šIDä¹‹åçš„æ‰€æœ‰æ¶ˆæ¯ã€‚</p>
<ul>
<li><p>XREAD</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">XREAD [COUNT count] [BLOCK milliseconds] STREAMS key [key ...] ID [ID ...]</span><br></pre></td></tr></table></figure>
<p>å…¶ä¸­ï¼ŒCOUNTå’ŒBLOCKæ˜¯å¯é€‰å‚æ•°ã€‚COUNTè¡¨ç¤ºæœ€å¤šè¿”å›çš„æ¶ˆæ¯æ•°é‡ï¼ŒBLOCKè¡¨ç¤ºé˜»å¡çš„è¶…æ—¶æ—¶é—´ã€‚å¦‚æœä¸æŒ‡å®šè¿™ä¸¤ä¸ªå‚æ•°ï¼ŒXREADä¼šä¸€ç›´é˜»å¡ç›´åˆ°Streamä¸­æœ‰æ–°çš„æ¶ˆæ¯å¯è¯»ã€‚<br>STREAMSåé¢è·Ÿç€çš„æ˜¯ä¸€ä¸ªæˆ–å¤šä¸ªStreamçš„åç§°ï¼ŒIDåé¢è·Ÿç€çš„æ˜¯ä¸€ä¸ªæˆ–å¤šä¸ªIDã€‚XREADä¼šè¿”å›æ¯ä¸ªStreamä¸­æŒ‡å®šIDä¹‹åçš„æ‰€æœ‰æ¶ˆæ¯ã€‚<br>XREADè¿”å›çš„ç»“æœæ˜¯ä¸€ä¸ªæ•°ç»„ï¼Œæ•°ç»„ä¸­çš„æ¯ä¸ªå…ƒç´ éƒ½æ˜¯ä¸€ä¸ªé”®å€¼å¯¹ï¼Œé”®æ˜¯Streamçš„åç§°ï¼Œå€¼æ˜¯ä¸€ä¸ªæ•°ç»„ï¼ŒåŒ…å«äº†Streamä¸­æŒ‡å®šIDä¹‹åçš„æ‰€æœ‰æ¶ˆæ¯ã€‚<br>èµ·å§‹IDï¼Œåªè¿”å›å¤§äºè¯¥IDçš„æ¶ˆæ¯<br>0ï¼šè¡¨ç¤ºä»ç¬¬ä¸€ä¸ªæ¶ˆæ¯å¼€å§‹<br>$ï¼šè¡¨ç¤ºä»æœ€æ–°çš„æ¶ˆæ¯å¼€å§‹<br>XREADæŒ‡ä»¤å¯ä»¥æ ¹æ®å®é™…éœ€æ±‚çµæ´»ä½¿ç”¨ã€‚å¦‚æœä¸éœ€è¦é˜»å¡ç­‰å¾…æ–°çš„æ¶ˆæ¯ï¼Œåˆ™å¯ä»¥ä¸æŒ‡å®šBLOCKå‚æ•°ï¼›å¦‚æœéœ€è¦ä¸€æ¬¡æ€§è¯»å–å¤šä¸ªStreamä¸­çš„æ¶ˆæ¯ï¼Œåˆ™å¯ä»¥åœ¨STREAMSå‚æ•°ä¸­æŒ‡å®šå¤šä¸ªStreamçš„åç§°ã€‚å¦‚æœéœ€è¦æ§åˆ¶è¿”å›çš„æ¶ˆæ¯æ•°é‡ï¼Œåˆ™å¯ä»¥ä½¿ç”¨COUNTå‚æ•°ã€‚</p>
</li>
<li><p>é˜»å¡è¯»å–æœ€æ–°æ¶ˆæ¯</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">XREAD COUNT 2 BLOCK 10000 STREAMS users $</span><br></pre></td></tr></table></figure>
</li>
<li><p>ä¸šåŠ¡ä¼ªä»£ç </p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">while</span> (<span class="literal">true</span>)&#123;</span><br><span class="line">    <span class="comment">//å°è¯•è¯»å–é˜Ÿåˆ—ä¸­çš„æ¶ˆæ¯ï¼Œæœ€å¤šé˜»å¡2ç§’</span></span><br><span class="line">    <span class="type">Object</span> <span class="variable">msg</span> <span class="operator">=</span> redis.execute(<span class="string">&quot;XREAD COUNT 2 BLOCK 10000 STREAMS users $&quot;</span>);</span><br><span class="line">    <span class="comment">//æ²¡è¯»å–åˆ°ï¼Œè·³è¿‡ä¸‹é¢çš„é€»è¾‘</span></span><br><span class="line">    <span class="keyword">if</span>(msg == <span class="literal">null</span>)&#123;</span><br><span class="line">        <span class="keyword">continue</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//å¤„ç†æ¶ˆæ¯</span></span><br><span class="line">    handleMessage(msg);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ul>
<blockquote>
<p>æ³¨æ„ï¼šå½“æˆ‘ä»¬æŒ‡å®šå…¶å®IDä¸º$æ—¶ï¼Œä»£è¡¨åªèƒ½è¯»å–åˆ°æœ€æ–°æ¶ˆæ¯ï¼Œå¦‚æœå½“æˆ‘ä»¬åœ¨å¤„ç†ä¸€æ¡æ¶ˆæ¯çš„è¿‡ç¨‹ä¸­ï¼Œåˆæœ‰è¶…è¿‡1æ¡ä»¥ä¸Šçš„æ¶ˆæ¯åˆ°è¾¾é˜Ÿåˆ—ï¼Œé‚£ä¹ˆä¸‹æ¬¡è·å–çš„æ—¶å€™ï¼Œä¹Ÿåªèƒ½è·å–åˆ°æœ€æ–°çš„ä¸€æ¡ï¼Œä¼šå‡ºç°æ¼è¯»æ¶ˆæ¯çš„é—®é¢˜</p>
</blockquote>
<ul>
<li>STREAMç±»å‹æ¶ˆæ¯é˜Ÿåˆ—çš„XREADå‘½ä»¤ç‰¹ç‚¹ <ol>
<li>æ¶ˆæ¯å¯å›æº¯</li>
<li>ä¸€ä¸ªæ¶ˆæ¯å¯ä»¥è¢«å¤šä¸ªæ¶ˆè´¹è€…è¯»å–</li>
<li>å¯ä»¥é˜»å¡è¯»å–</li>
<li>æœ‰æ¼è¯»æ¶ˆæ¯çš„é£é™©</li>
</ol>
</li>
</ul>
<h2 id="åŸºäºStreamçš„æ¶ˆæ¯é˜Ÿåˆ—-æ¶ˆè´¹è€…ç»„"><a href="#åŸºäºStreamçš„æ¶ˆæ¯é˜Ÿåˆ—-æ¶ˆè´¹è€…ç»„" class="headerlink" title="åŸºäºStreamçš„æ¶ˆæ¯é˜Ÿåˆ—-æ¶ˆè´¹è€…ç»„"></a>åŸºäºStreamçš„æ¶ˆæ¯é˜Ÿåˆ—-æ¶ˆè´¹è€…ç»„</h2><p>åªç”¨è¿™ä¸¤ä¸ªå‘½ä»¤è¿˜æ˜¯ä¸å¤Ÿçš„ï¼Œå› ä¸ºç›®å‰åªæ”¯æŒ<code>é˜»å¡è¯»æœ€æ–°</code>æ¶ˆæ¯ï¼Œå‡è®¾å¤„ç†æ¶ˆæ¯è¿‡ç¨‹ä¸­åˆæ¥äº†å‡ æ¡æ¶ˆæ¯ï¼Œå¯èƒ½å‡ºç°<code>æ¼è¯»æ¶ˆæ¯</code>çš„æƒ…å†µ<br>ä¸ºè§£å†³ä¸Šè¿°é—®é¢˜ï¼Œå¯ä»¥ç”¨ Stream çš„ä»¥ä¸‹ç‰¹æ€§:<br><code>æ¶ˆè´¹ç»„</code>: åŒç»„å†…çš„å¤šä¸ªæ¶ˆè´¹è€…å¯ä»¥ç«äº‰æ¶ˆè´¹(æ¯ä¸ªæ¶ˆæ¯åªæœ‰<code>ä¸€ä¸ª</code>æ¶ˆè´¹è€…èƒ½æŠ¢åˆ°) ï¼Œä»è€Œæé«˜æ¶ˆè´¹èƒ½åŠ› (å¹¶å‘åº¦) ã€‚å¯¹åº”å‘½ä»¤ä¸º<code>XGROUP</code>ã€<code>XREADGROUP</code> ç­‰<br><code>æ¶ˆæ¯æ ‡è¯†</code>: è‡ªåŠ¨è®°å½•æ¶ˆè´¹çš„è¿›åº¦ï¼Œæ”¯æŒä»ä¸Šæ¬¡æœªæ¶ˆè´¹çš„åœ°æ–¹å¼€å§‹æ¥ç€æ¶ˆè´¹ï¼Œä¿è¯æ¯æ¡æ¶ˆæ¯æŒ‰é¡ºåºæ¶ˆè´¹<br><code>æ¶ˆæ¯ç¡®è®¤æœºåˆ¶</code>: é»˜è®¤æ¶ˆè´¹çš„æ¶ˆæ¯ä¸º pending çŠ¶æ€ï¼Œä¼šæ”¾åˆ°æ¯ä¸ªæ¶ˆè´¹è€…çš„ pending list ä¸­ï¼Œåªæœ‰æ¶ˆæ¯ç”±æ¶ˆè´¹è€…ç¡®è®¤ (ACK) ï¼Œæ‰ä¼šä»pending list ç§»é™¤ã€‚è¿™æ ·å¦‚æœæ¶ˆè´¹ä¸šåŠ¡å¤„ç†å¼‚å¸¸ï¼Œå¯ä»¥ä» pending list çš„å¼€å¤´ä¾æ¬¡è¯»å–æœªç¡®è®¤æ¶ˆæ¯ï¼Œé‡è¯•å¤„ç†ã€‚(ä¹Ÿè¦é¿å…æ— é™é‡è¯•ï¼Œå®åœ¨å¤„ç†ä¸æˆåŠŸå°±å¼ºåˆ¶ ACK + ä¸šåŠ¡è®°æ—¥å¿—)æ•´ä¸ªæ¶ˆè´¹æµç¨‹ä¼ªä»£ç å¦‚ä¸‹</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.nlark.com/yuque/0/2023/png/32620241/1681813734547-cf20c3b8-8162-497e-971f-ff1653f75412.png#averageHue=%23f3f3f5&clientId=uf387f538-a383-4&from=paste&height=647&id=u0424266b&originHeight=970&originWidth=1064&originalType=binary&ratio=1.5&rotation=0&showTitle=false&size=276073&status=done&style=none&taskId=u210cccb8-a907-47ef-a20c-ed947cc9a52&title=&width=709.3333333333334" alt="image.png"></p>
<h3 id="å®ç°-3"><a href="#å®ç°-3" class="headerlink" title="å®ç°"></a>å®ç°</h3><p><code>æ¶ˆè´¹è€…ç»„</code>(Consumer Group)ï¼šå°†å¤šä¸ªæ¶ˆè´¹è€…åˆ’åˆ†åˆ°ä¸€ä¸ªç»„ä¸­ï¼Œç›‘å¬åŒä¸€ä¸ªé˜Ÿåˆ—ï¼Œå…·å¤‡ä»¥ä¸‹ç‰¹ç‚¹</p>
<ol>
<li>æ¶ˆæ¯åˆ†æµï¼šé˜Ÿåˆ—ä¸­çš„æ¶ˆæ¯ä¼šåˆ†ç•™ç»™ç»„å†…çš„ä¸åŒæ¶ˆè´¹è€…ï¼Œè€Œä¸æ˜¯é‡å¤æ¶ˆè´¹è€…ï¼Œä»è€ŒåŠ å¿«æ¶ˆæ¯å¤„ç†çš„é€Ÿåº¦</li>
<li><code>æ¶ˆæ¯æ ‡è¯†</code>ï¼šæ¶ˆè´¹è€…ä¼šç»´æŠ¤ä¸€ä¸ªæ ‡è¯†ï¼Œè®°å½•æœ€åä¸€ä¸ªè¢«å¤„ç†çš„æ¶ˆæ¯ï¼Œå“ªæ€•æ¶ˆè´¹è€…å®•æœºé‡å¯ï¼Œè¿˜ä¼šä»æ ‡è¯†ä¹‹åè¯»å–æ¶ˆæ¯ï¼Œç¡®ä¿æ¯ä¸€ä¸ªæ¶ˆæ¯éƒ½ä¼šè¢«æ¶ˆè´¹</li>
<li>æ¶ˆæ¯ç¡®è®¤ï¼šæ¶ˆè´¹è€…è·å–æ¶ˆæ¯åï¼Œæ¶ˆæ¯å¤„äºpendingçŠ¶æ€ï¼Œå¹¶å­˜å…¥ä¸€ä¸ªpending-listï¼Œå½“å¤„ç†å®Œæˆåï¼Œéœ€è¦é€šè¿‡XACKæ¥ç¡®è®¤æ¶ˆæ¯ï¼Œæ ‡è®°æ¶ˆæ¯ä¸ºå·²å¤„ç†ï¼Œæ‰ä¼šä»pending-listä¸­ç§»é™¤</li>
</ol>
<p>åœ¨Redis Streamä¸­ï¼Œæ¶ˆè´¹è€…ç»„çš„<code>åˆ›å»ºå’Œç®¡ç†</code>éƒ½ç”±<code>XGROUP</code>å‘½ä»¤å®Œæˆã€‚XGROUPå‘½ä»¤æœ‰ä¸¤ä¸ªå­å‘½ä»¤ï¼šCREATEå’Œ<code>SETID</code>ã€‚CREATEç”¨äºåˆ›å»ºä¸€ä¸ªæ–°çš„æ¶ˆè´¹è€…ç»„ï¼ŒSETIDç”¨äºè®¾ç½®æ¶ˆè´¹è€…ç»„çš„<code>æœ€åå·²è¯»æ¶ˆæ¯ID</code>ã€‚</p>
<p>åˆ›å»ºæ¶ˆè´¹è€…ç»„åï¼Œå¯ä»¥ä½¿ç”¨<code>XREADGROUP</code>å‘½ä»¤è®©å¤šä¸ªæ¶ˆè´¹è€…ä»<code>åŒä¸€ä¸ªStreamä¸­è¯»å–æ¶ˆæ¯</code>ï¼Œå¹¶ä½¿ç”¨XACKå‘½ä»¤ç¡®è®¤å·²ç»æ¶ˆè´¹çš„æ¶ˆæ¯ã€‚è¿™ç§æ–¹å¼å¯ä»¥ä¿è¯æ¶ˆæ¯ä¸ä¼šè¢«é‡å¤æ¶ˆè´¹ï¼Œä¹Ÿå¯ä»¥è®©å¤šä¸ªæ¶ˆè´¹è€…ååŒå¤„ç†æ¶ˆæ¯ï¼Œæé«˜å¤„ç†æ•ˆç‡ã€‚</p>
<p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œæ¶ˆè´¹è€…ç»„ä¸­çš„æ¯ä¸ªæ¶ˆè´¹è€…éƒ½è¦æœ‰ä¸€ä¸ªå”¯ä¸€çš„åç§°ï¼ˆå³æ¶ˆè´¹è€…IDï¼‰ï¼ŒXGROUPå’ŒXREADGROUPå‘½ä»¤éƒ½éœ€è¦æŒ‡å®šæ¶ˆè´¹è€…IDã€‚æ¶ˆè´¹è€…IDå¯ä»¥è‡ªå·±å®šä¹‰ï¼Œä¹Ÿå¯ä»¥ç”±ç¨‹åºè‡ªåŠ¨ç”Ÿæˆã€‚å¦å¤–ï¼Œæ¶ˆè´¹è€…ç»„ä¸­çš„æ¶ˆè´¹è€…æ•°é‡åº”è¯¥æ ¹æ®å®é™…éœ€æ±‚è¿›è¡Œé€‚å½“æ§åˆ¶ï¼Œé¿å…è¿‡å¤šæˆ–è¿‡å°‘å¯¼è‡´æ€§èƒ½é—®é¢˜ã€‚</p>
<p>åˆ›å»ºæ¶ˆè´¹è€…ç»„</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">XGROUP CREATE key groupName ID [MKSTREAM]</span><br></pre></td></tr></table></figure>

<blockquote>
<ul>
<li>key <ul>
<li>é˜Ÿåˆ—åç§°</li>
</ul>
</li>
<li>groupName <ul>
<li>æ¶ˆè´¹è€…ç»„åç§°</li>
</ul>
</li>
<li>ID <ul>
<li>èµ·å§‹IDæ ‡è¯†ï¼Œ$ä»£è¡¨é˜Ÿåˆ—ä¸­çš„æœ€åä¸€ä¸ªæ¶ˆæ¯ï¼Œ0ä»£è¡¨é˜Ÿåˆ—ä¸­çš„ç¬¬ä¸€ä¸ªæ¶ˆæ¯</li>
</ul>
</li>
<li>MKSTREAM <ul>
<li>é˜Ÿåˆ—ä¸å­˜åœ¨æ—¶è‡ªåŠ¨åˆ›å»ºé˜Ÿåˆ—</li>
</ul>
</li>
</ul>
</blockquote>
<ul>
<li><p>åˆ é™¤æŒ‡å®šçš„æ¶ˆè´¹è€…ç»„</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">XGROUP DESTORY key groupName</span><br></pre></td></tr></table></figure>
</li>
<li><p>ç»™æŒ‡å®šçš„æ¶ˆè´¹è€…ç»„æ·»åŠ æ¶ˆè´¹è€…</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">XGROUP CREATECONSUMER key groupName consumerName</span><br></pre></td></tr></table></figure>
</li>
<li><p>åˆ é™¤æ¶ˆè´¹è€…ä¸­æŒ‡å®šçš„æ¶ˆè´¹è€…</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">XGROUP DELCONSUMER key groupName consumerName</span><br></pre></td></tr></table></figure>
</li>
<li><p>ä»æ¶ˆè´¹è€…ä¸­è¯»å–ä¿¡æ¯</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">XREADGROUP GROUP groupName consumerName [COUNT count] [BLOCK milliseconds] STREAMS key [key ...] ID [ID ...]</span><br></pre></td></tr></table></figure></li>
</ul>
<blockquote>
<ul>
<li>group <ul>
<li>æ¶ˆè´¹è€…ç»„åç§°</li>
</ul>
</li>
<li>consumer <ul>
<li>æ¶ˆè´¹è€…åï¼Œå¦‚æœæ¶ˆè´¹è€…ä¸å­˜åœ¨ï¼Œä¼šè‡ªåŠ¨åˆ›å»ºä¸€ä¸ªæ¶ˆè´¹è€…</li>
</ul>
</li>
<li>count <ul>
<li>æœ¬æ¬¡æŸ¥è¯¢çš„æœ€å¤§æ•°é‡</li>
</ul>
</li>
<li>BLOCK milliseconds <ul>
<li>å½“å‰æ²¡æœ‰æ¶ˆæ¯æ—¶çš„æœ€å¤§ç­‰å¾…æ—¶é—´</li>
</ul>
</li>
<li>NOACK <ul>
<li>æ— éœ€æ‰‹åŠ¨ACKï¼Œè·å–åˆ°æ¶ˆæ¯åè‡ªåŠ¨ç¡®è®¤ï¼ˆä¸€èˆ¬ä¸ç”¨ï¼Œæˆ‘ä»¬éƒ½æ˜¯æ‰‹åŠ¨ç¡®è®¤ï¼‰</li>
</ul>
</li>
<li>STREAMS key <ul>
<li>æŒ‡å®šé˜Ÿåˆ—åç§°</li>
</ul>
</li>
<li><h2 id="ID-è·å–æ¶ˆæ¯çš„èµ·å§‹ID"><a href="#ID-è·å–æ¶ˆæ¯çš„èµ·å§‹ID" class="headerlink" title="ID-  è·å–æ¶ˆæ¯çš„èµ·å§‹ID "></a>ID<br>-  è·å–æ¶ˆæ¯çš„èµ·å§‹ID </h2><ul>
<li>å…¶ä»–ï¼šæ ¹æ®æŒ‡å®šidä»pending-listä¸­è·å–å·²æ¶ˆè´¹ä½†æœªç¡®è®¤çš„æ¶ˆæ¯ï¼Œä¾‹å¦‚0ï¼Œæ˜¯ä»pending-listä¸­çš„ç¬¬ä¸€ä¸ªæ¶ˆæ¯å¼€å§‹</li>
</ul>
</li>
</ul>
</blockquote>
<p>æ¶ˆè´¹è€…ç›‘å¬æ¶ˆæ¯çš„åŸºæœ¬æ€è·¯</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">while</span>(<span class="literal">true</span>)&#123;</span><br><span class="line">    <span class="comment">// å°è¯•ç›‘å¬é˜Ÿåˆ—ï¼Œä½¿ç”¨é˜»å¡æ¨¡å¼ï¼Œæœ€å¤§ç­‰å¾…æ—¶é•¿ä¸º2000ms</span></span><br><span class="line">    <span class="type">Object</span> <span class="variable">msg</span> <span class="operator">=</span> redis.call(<span class="string">&quot;XREADGROUP GROUP g1 c1 COUNT 1 BLOCK 2000 STREAMS s1 &gt;&quot;</span>)</span><br><span class="line">    <span class="keyword">if</span>(msg == <span class="literal">null</span>)&#123;</span><br><span class="line">        <span class="comment">// æ²¡ç›‘å¬åˆ°æ¶ˆæ¯ï¼Œé‡è¯•</span></span><br><span class="line">        <span class="keyword">continue</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">try</span>&#123;</span><br><span class="line">        <span class="comment">//å¤„ç†æ¶ˆæ¯ï¼Œå®Œæˆåè¦æ‰‹åŠ¨ç¡®è®¤ACKï¼ŒACKä»£ç åœ¨handleMessageä¸­ç¼–å†™</span></span><br><span class="line">        handleMessage(msg);</span><br><span class="line">    &#125; <span class="keyword">catch</span>(Exception e)&#123;</span><br><span class="line">        <span class="keyword">while</span>(<span class="literal">true</span>)&#123;</span><br><span class="line">            <span class="comment">//0è¡¨ç¤ºä»pending-listä¸­çš„ç¬¬ä¸€ä¸ªæ¶ˆæ¯å¼€å§‹ï¼Œå¦‚æœå‰é¢éƒ½ACKäº†ï¼Œé‚£ä¹ˆè¿™é‡Œå°±ä¸ä¼šç›‘å¬åˆ°æ¶ˆæ¯</span></span><br><span class="line">            <span class="type">Object</span> <span class="variable">msg</span> <span class="operator">=</span> redis.call(<span class="string">&quot;XREADGROUP GROUP g1 c1 COUNT 1 STREAMS s1 0&quot;</span>);</span><br><span class="line">            <span class="keyword">if</span>(msg == <span class="literal">null</span>)&#123;</span><br><span class="line">                <span class="comment">//nullè¡¨ç¤ºæ²¡æœ‰å¼‚å¸¸æ¶ˆæ¯ï¼Œæ‰€æœ‰æ¶ˆæ¯å‡å·²ç¡®è®¤ï¼Œç»“æŸå¾ªç¯</span></span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">try</span>&#123;</span><br><span class="line">                <span class="comment">//è¯´æ˜æœ‰å¼‚å¸¸æ¶ˆæ¯ï¼Œå†æ¬¡å¤„ç†</span></span><br><span class="line">                handleMessage(msg);</span><br><span class="line">            &#125; <span class="keyword">catch</span>(Exception e)&#123;</span><br><span class="line">                <span class="comment">//å†æ¬¡å‡ºç°å¼‚å¸¸ï¼Œè®°å½•æ—¥å¿—ï¼Œç»§ç»­å¾ªç¯</span></span><br><span class="line">                log.error(<span class="string">&quot;..&quot;</span>);</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>STREAMç±»å‹æ¶ˆæ¯é˜Ÿåˆ—çš„XREADGROUPå‘½ä»¤çš„ç‰¹ç‚¹ <ol>
<li>æ¶ˆæ¯å¯å›æº¯</li>
<li>å¯ä»¥å¤šæ¶ˆè´¹è€…äº‰æŠ¢æ¶ˆæ¯ï¼ŒåŠ å¿«æ¶ˆè´¹é€Ÿåº¦</li>
<li>å¯ä»¥é˜»å¡è¯»å–</li>
<li>æ²¡æœ‰æ¶ˆæ¯æ¼è¯»é£é™©</li>
<li>æœ‰æ¶ˆæ¯ç¡®è®¤æœºåˆ¶ï¼Œä¿è¯æ¶ˆæ¯è‡³å°‘è¢«æ¶ˆè´¹ä¸€æ¬¡</li>
</ol>
</li>
</ul>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.nlark.com/yuque/0/2023/png/32620241/1681813769915-396e4ff5-1da4-4aea-921f-f89c05eed249.png#averageHue=%23f9f7f4&clientId=uf387f538-a383-4&from=paste&height=523&id=u37f0fd91&originHeight=784&originWidth=1778&originalType=binary&ratio=1.5&rotation=0&showTitle=false&size=272522&status=done&style=none&taskId=u0a199aa2-d48b-4d81-bbe5-c06d9a36405&title=&width=1185.3333333333333" alt="image-1.png"></p>
<h3 id="å®ç°å¼‚æ­¥ä¸‹å•"><a href="#å®ç°å¼‚æ­¥ä¸‹å•" class="headerlink" title="å®ç°å¼‚æ­¥ä¸‹å•"></a>å®ç°å¼‚æ­¥ä¸‹å•</h3><p>éœ€æ±‚ï¼š</p>
<ol>
<li>åˆ›å»ºä¸€ä¸ªStreamç±»å‹çš„æ¶ˆæ¯é˜Ÿåˆ—ï¼Œåä¸ºstream.orders</li>
<li>ä¿®æ”¹ä¹‹å‰çš„ç§’æ€ä¸‹å•Luaè„šæœ¬ï¼Œåœ¨è®¤å®šæœ‰æŠ¢è´­èµ„æ ¼åï¼Œç›´æ¥å‘stream.ordersä¸­æ·»åŠ æ¶ˆæ¯ï¼Œå†…å®¹åŒ…å«voucherIdã€userIdã€orderId</li>
<li>é¡¹ç›®å¯åŠ¨æ—¶ï¼Œå¼€å¯ä¸€ä¸ªçº¿ç¨‹ä»»åŠ¡ï¼Œå°è¯•è·å–stream.ordersä¸­çš„æ¶ˆæ¯ï¼Œå®Œæˆä¸‹å•</li>
</ol>
<p>æ­¥éª¤ä¸€ï¼šåˆ›å»ºä¸€ä¸ªStreamç±»å‹çš„æ¶ˆæ¯é˜Ÿåˆ—ï¼Œåä¸ºstream.orders</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">XGROUP CREATE stream.orders g1 0 MKSTREAM</span><br></pre></td></tr></table></figure>
<p>æ­¥éª¤äºŒï¼šä¿®æ”¹Luaè„šæœ¬ï¼Œæ–°å¢orderIdå‚æ•°ï¼Œå¹¶å°†è®¢å•ä¿¡æ¯åŠ å…¥åˆ°æ¶ˆæ¯é˜Ÿåˆ—ä¸­</p>
<figure class="highlight lua"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- è®¢å•id</span></span><br><span class="line"><span class="keyword">local</span> voucherId = ARGV[<span class="number">1</span>]</span><br><span class="line"><span class="comment">-- ç”¨æˆ·id</span></span><br><span class="line"><span class="keyword">local</span> userId = ARGV[<span class="number">2</span>]</span><br><span class="line"><span class="comment">-- æ–°å¢orderIdï¼Œä½†æ˜¯å˜é‡åç”¨idå°±å¥½ï¼Œå› ä¸ºVoucherOrderå®ä½“ç±»ä¸­çš„orderIdå°±æ˜¯ç”¨idè¡¨ç¤ºçš„</span></span><br><span class="line"><span class="keyword">local</span> id = ARGV[<span class="number">3</span>]</span><br><span class="line"><span class="comment">-- ä¼˜æƒ åˆ¸key</span></span><br><span class="line"><span class="keyword">local</span> stockKey = <span class="string">&#x27;seckill:stock:&#x27;</span> .. voucherId</span><br><span class="line"><span class="comment">-- è®¢å•key</span></span><br><span class="line"><span class="keyword">local</span> orderKey = <span class="string">&#x27;seckill:order:&#x27;</span> .. voucherId</span><br><span class="line"><span class="comment">-- åˆ¤æ–­åº“å­˜æ˜¯å¦å……è¶³</span></span><br><span class="line"><span class="keyword">if</span> (<span class="built_in">tonumber</span>(redis.call(<span class="string">&#x27;get&#x27;</span>, stockKey)) &lt;= <span class="number">0</span>) <span class="keyword">then</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"><span class="comment">-- åˆ¤æ–­ç”¨æˆ·æ˜¯å¦ä¸‹å•</span></span><br><span class="line"><span class="keyword">if</span> (redis.call(<span class="string">&#x27;sismember&#x27;</span>, orderKey, userId) == <span class="number">1</span>) <span class="keyword">then</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">2</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"><span class="comment">-- æ‰£å‡åº“å­˜</span></span><br><span class="line">redis.call(<span class="string">&#x27;incrby&#x27;</span>, stockKey, <span class="number">-1</span>)</span><br><span class="line"><span class="comment">-- å°†userIdå­˜å…¥å½“å‰ä¼˜æƒ åˆ¸çš„seté›†åˆ</span></span><br><span class="line">redis.call(<span class="string">&#x27;sadd&#x27;</span>, orderKey, userId)</span><br><span class="line"><span class="comment">-- å°†ä¸‹å•æ•°æ®ä¿å­˜åˆ°æ¶ˆæ¯é˜Ÿåˆ—ä¸­</span></span><br><span class="line">redis.call(<span class="string">&quot;sadd&quot;</span>, <span class="string">&#x27;stream.orders&#x27;</span>, <span class="string">&#x27;*&#x27;</span>, <span class="string">&#x27;userId&#x27;</span>, userId, <span class="string">&#x27;voucherId&#x27;</span>, voucherId, <span class="string">&#x27;id&#x27;</span>, id)</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span></span><br></pre></td></tr></table></figure>
<p>æ­¥éª¤ä¸‰ï¼šä¿®æ”¹ç§’æ€é€»è¾‘</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> Result <span class="title function_">seckillVoucher</span><span class="params">(Long voucherId)</span> &#123;</span><br><span class="line">    <span class="type">long</span> <span class="variable">orderId</span> <span class="operator">=</span> redisIdWorker.nextId(<span class="string">&quot;order&quot;</span>);</span><br><span class="line">    <span class="type">Long</span> <span class="variable">result</span> <span class="operator">=</span> stringRedisTemplate.execute(SECKILL_SCRIPT,</span><br><span class="line">            Collections.emptyList(), voucherId.toString(),</span><br><span class="line">            UserHolder.getUser().getId().toString(), String.valueOf(orderId));</span><br><span class="line">    <span class="keyword">if</span> (result.intValue() != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> Result.fail(result.intValue() == <span class="number">1</span> ? <span class="string">&quot;åº“å­˜ä¸è¶³&quot;</span> : <span class="string">&quot;ä¸èƒ½é‡å¤ä¸‹å•&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//ä¸»çº¿ç¨‹è·å–ä»£ç†å¯¹è±¡</span></span><br><span class="line">    proxy = (IVoucherOrderService) AopContext.currentProxy();</span><br><span class="line">    <span class="keyword">return</span> Result.ok(orderId);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æ­¥éª¤å››ï¼šä¿®æ”¹æˆ‘ä»¬çš„VoucherOrderHandler</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="type">String</span> <span class="variable">queueName</span> <span class="operator">=</span> <span class="string">&quot;stream.orders&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">class</span> <span class="title class_">VoucherOrderHandler</span> <span class="keyword">implements</span> <span class="title class_">Runnable</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">//1. è·å–é˜Ÿåˆ—ä¸­çš„è®¢å•ä¿¡æ¯ XREADGROUP GROUP g1 c1 COUNT 1 BLOCK 2000 STREAMS stream.orders &gt;</span></span><br><span class="line">                List&lt;MapRecord&lt;String, Object, Object&gt;&gt; records = stringRedisTemplate.opsForStream().read(Consumer.from(<span class="string">&quot;g1&quot;</span>, <span class="string">&quot;c1&quot;</span>),</span><br><span class="line">                        StreamReadOptions.empty().count(<span class="number">1</span>).block(Duration.ofSeconds(<span class="number">2</span>)),</span><br><span class="line">                        <span class="comment">//ReadOffset.lastConsumed()åº•å±‚å°±æ˜¯ &#x27;&gt;&#x27;</span></span><br><span class="line">                        StreamOffset.create(queueName, ReadOffset.lastConsumed()));</span><br><span class="line">                <span class="comment">//2. åˆ¤æ–­æ¶ˆæ¯æ˜¯å¦è·å–æˆåŠŸ</span></span><br><span class="line">                <span class="keyword">if</span> (records == <span class="literal">null</span> || records.isEmpty()) &#123;</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">//3. æ¶ˆæ¯è·å–æˆåŠŸä¹‹åï¼Œæˆ‘ä»¬éœ€è¦å°†å…¶è½¬ä¸ºå¯¹è±¡</span></span><br><span class="line">                MapRecord&lt;String, Object, Object&gt; record = records.get(<span class="number">0</span>);</span><br><span class="line">                Map&lt;Object, Object&gt; values = record.getValue();</span><br><span class="line">                <span class="type">VoucherOrder</span> <span class="variable">voucherOrder</span> <span class="operator">=</span> BeanUtil.fillBeanWithMap(values, <span class="keyword">new</span> <span class="title class_">VoucherOrder</span>(), <span class="literal">true</span>);</span><br><span class="line">                <span class="comment">//4. è·å–æˆåŠŸï¼Œæ‰§è¡Œä¸‹å•é€»è¾‘ï¼Œå°†æ•°æ®ä¿å­˜åˆ°æ•°æ®åº“ä¸­</span></span><br><span class="line">                handleVoucherOrder(voucherOrder);</span><br><span class="line">                <span class="comment">//5. æ‰‹åŠ¨ACKï¼ŒSACK stream.orders g1 id</span></span><br><span class="line">                stringRedisTemplate.opsForStream().acknowledge(queueName, <span class="string">&quot;g1&quot;</span>, record.getId());</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                log.error(<span class="string">&quot;è®¢å•å¤„ç†å¼‚å¸¸&quot;</span>, e);</span><br><span class="line">                <span class="comment">//è®¢å•å¼‚å¸¸çš„å¤„ç†æ–¹å¼æˆ‘ä»¬å°è£…æˆä¸€ä¸ªå‡½æ•°ï¼Œé¿å…ä»£ç å¤ªè‡ƒè‚¿</span></span><br><span class="line">                handlePendingList();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">handlePendingList</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">//1. è·å–pending-listä¸­çš„è®¢å•ä¿¡æ¯ XREADGROUP GROUP g1 c1 COUNT 1 BLOCK 2000 STREAMS stream.orders 0</span></span><br><span class="line">            List&lt;MapRecord&lt;String, Object, Object&gt;&gt; records = stringRedisTemplate.opsForStream().read(</span><br><span class="line">                    Consumer.from(<span class="string">&quot;g1&quot;</span>, <span class="string">&quot;c1&quot;</span>),</span><br><span class="line">                    StreamReadOptions.empty().count(<span class="number">1</span>),</span><br><span class="line">                    StreamOffset.create(queueName, ReadOffset.from(<span class="string">&quot;0&quot;</span>)));</span><br><span class="line">            <span class="comment">//2. åˆ¤æ–­pending-listä¸­æ˜¯å¦æœ‰æœªå¤„ç†æ¶ˆæ¯</span></span><br><span class="line">            <span class="keyword">if</span> (records == <span class="literal">null</span> || records.isEmpty()) &#123;</span><br><span class="line">                <span class="comment">//å¦‚æœæ²¡æœ‰å°±è¯´æ˜æ²¡æœ‰å¼‚å¸¸æ¶ˆæ¯ï¼Œç›´æ¥ç»“æŸå¾ªç¯</span></span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//3. æ¶ˆæ¯è·å–æˆåŠŸä¹‹åï¼Œæˆ‘ä»¬éœ€è¦å°†å…¶è½¬ä¸ºå¯¹è±¡</span></span><br><span class="line">            MapRecord&lt;String, Object, Object&gt; record = records.get(<span class="number">0</span>);</span><br><span class="line">            Map&lt;Object, Object&gt; values = record.getValue();</span><br><span class="line">            <span class="type">VoucherOrder</span> <span class="variable">voucherOrder</span> <span class="operator">=</span> BeanUtil.fillBeanWithMap(values, <span class="keyword">new</span> <span class="title class_">VoucherOrder</span>(), <span class="literal">true</span>);</span><br><span class="line">            <span class="comment">//4. è·å–æˆåŠŸï¼Œæ‰§è¡Œä¸‹å•é€»è¾‘ï¼Œå°†æ•°æ®ä¿å­˜åˆ°æ•°æ®åº“ä¸­</span></span><br><span class="line">            handleVoucherOrder(voucherOrder);</span><br><span class="line">            <span class="comment">//5. æ‰‹åŠ¨ACKï¼ŒSACK stream.orders g1 id</span></span><br><span class="line">            stringRedisTemplate.opsForStream().acknowledge(queueName, <span class="string">&quot;g1&quot;</span>, record.getId());</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            log.info(<span class="string">&quot;å¤„ç†pending-listå¼‚å¸¸&quot;</span>);</span><br><span class="line">            <span class="comment">//å¦‚æœæ€•å¼‚å¸¸å¤šæ¬¡å‡ºç°ï¼Œå¯ä»¥åœ¨è¿™é‡Œä¼‘çœ ä¸€ä¼šå„¿</span></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                Thread.sleep(<span class="number">50</span>);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException ex) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(ex);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id=""><a href="#" class="headerlink" title=""></a></h1><h1 id="ç‚¹èµ"><a href="#ç‚¹èµ" class="headerlink" title="ç‚¹èµ"></a>ç‚¹èµ</h1><p>ä¿®æ”¹ç‚¹èµåŠŸèƒ½ï¼Œåˆ©ç”¨Redisä¸­çš„seté›†åˆæ¥åˆ¤æ–­æ˜¯å¦ç‚¹èµè¿‡ï¼Œæœªç‚¹èµåˆ™ç‚¹èµæ•°+1ï¼Œå·²ç‚¹èµåˆ™ç‚¹èµæ•°-1</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> Result <span class="title function_">likeBlog</span><span class="params">(Long id)</span> &#123;</span><br><span class="line">    <span class="comment">//1. è·å–å½“å‰ç”¨æˆ·ä¿¡æ¯</span></span><br><span class="line">    <span class="type">Long</span> <span class="variable">userId</span> <span class="operator">=</span> UserHolder.getUser().getId();</span><br><span class="line">    <span class="comment">//2. å¦‚æœå½“å‰ç”¨æˆ·æœªç‚¹èµï¼Œåˆ™ç‚¹èµæ•° +1ï¼ŒåŒæ—¶å°†ç”¨æˆ·åŠ å…¥seté›†åˆ</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> BLOG_LIKED_KEY + id;</span><br><span class="line">    <span class="type">Boolean</span> <span class="variable">isLiked</span> <span class="operator">=</span> stringRedisTemplate.opsForSet().isMember(key, userId.toString());</span><br><span class="line">    <span class="keyword">if</span> (BooleanUtil.isFalse(isLiked)) &#123;</span><br><span class="line">        <span class="comment">//ç‚¹èµæ•° +1</span></span><br><span class="line">        <span class="type">boolean</span> <span class="variable">success</span> <span class="operator">=</span> update().setSql(<span class="string">&quot;liked = liked + 1&quot;</span>).eq(<span class="string">&quot;id&quot;</span>, id).update();</span><br><span class="line">        <span class="comment">//å°†ç”¨æˆ·åŠ å…¥seté›†åˆ</span></span><br><span class="line">        <span class="keyword">if</span> (success) &#123;</span><br><span class="line">            stringRedisTemplate.opsForSet().add(key, userId.toString());</span><br><span class="line">        &#125;</span><br><span class="line">    <span class="comment">//3. å¦‚æœå½“å‰ç”¨æˆ·å·²ç‚¹èµï¼Œåˆ™å–æ¶ˆç‚¹èµï¼Œå°†ç”¨æˆ·ä»seté›†åˆä¸­ç§»é™¤</span></span><br><span class="line">    &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">//ç‚¹èµæ•° -1</span></span><br><span class="line">        <span class="type">boolean</span> <span class="variable">success</span> <span class="operator">=</span> update().setSql(<span class="string">&quot;liked = liked - 1&quot;</span>).eq(<span class="string">&quot;id&quot;</span>, id).update();</span><br><span class="line">        <span class="keyword">if</span> (success)&#123;</span><br><span class="line">            <span class="comment">//ä»seté›†åˆç§»é™¤</span></span><br><span class="line">            stringRedisTemplate.opsForSet().remove(key, userId.toString());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> Result.ok();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<h1 id="æ’è¡Œæ¦œ"><a href="#æ’è¡Œæ¦œ" class="headerlink" title="æ’è¡Œæ¦œ"></a>æ’è¡Œæ¦œ</h1><p>å®ç°ï¼šä½¿ç”¨Redis SortedSetï¼ˆè‡ªåŠ¨æŒ‰scoreæ’åºçš„æ•°æ®ç»“æ„ï¼‰ï¼ŒæŠŠç”¨æˆ·ç‚¹èµæ—¶é—´ä½œä¸ºscoreï¼Œä½¿ç”¨ZRangeèŒƒå›´æŸ¥è¯¢TopN<br>ä¿®æ”¹ä»£ç likeBlog,å­˜å‚¨ç‚¹èµç”¨æˆ·çš„æ—¶å€™è¿˜è¦æœ‰èƒ½åŒºåˆ†å…ˆåé¡ºåºçš„</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> Result <span class="title function_">likeBlog</span><span class="params">(Long id)</span> &#123;</span><br><span class="line">    <span class="comment">//1. è·å–å½“å‰ç”¨æˆ·ä¿¡æ¯</span></span><br><span class="line">    <span class="type">Long</span> <span class="variable">userId</span> <span class="operator">=</span> UserHolder.getUser().getId();</span><br><span class="line">    <span class="comment">//2. å¦‚æœå½“å‰ç”¨æˆ·æœªç‚¹èµï¼Œåˆ™ç‚¹èµæ•° +1ï¼ŒåŒæ—¶å°†ç”¨æˆ·åŠ å…¥seté›†åˆ</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> BLOG_LIKED_KEY + id;</span><br><span class="line">    <span class="comment">//å°è¯•è·å–score</span></span><br><span class="line">    <span class="type">Double</span> <span class="variable">score</span> <span class="operator">=</span> stringRedisTemplate.opsForZSet().score(key, userId.toString());</span><br><span class="line">    <span class="comment">//ä¸ºnullï¼Œåˆ™è¡¨ç¤ºé›†åˆä¸­æ²¡æœ‰è¯¥ç”¨æˆ·</span></span><br><span class="line">    <span class="keyword">if</span> (score == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="comment">//ç‚¹èµæ•° +1</span></span><br><span class="line">        <span class="type">boolean</span> <span class="variable">success</span> <span class="operator">=</span> update().setSql(<span class="string">&quot;liked = liked + 1&quot;</span>).eq(<span class="string">&quot;id&quot;</span>, id).update();</span><br><span class="line">        <span class="comment">//å°†ç”¨æˆ·åŠ å…¥seté›†åˆ</span></span><br><span class="line">        <span class="keyword">if</span> (success) &#123;</span><br><span class="line">            stringRedisTemplate.opsForZSet().add(key, userId.toString(), System.currentTimeMillis());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//3. å¦‚æœå½“å‰ç”¨æˆ·å·²ç‚¹èµï¼Œåˆ™å–æ¶ˆç‚¹èµï¼Œå°†ç”¨æˆ·ä»seté›†åˆä¸­ç§»é™¤</span></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">//ç‚¹èµæ•° -1</span></span><br><span class="line">        <span class="type">boolean</span> <span class="variable">success</span> <span class="operator">=</span> update().setSql(<span class="string">&quot;liked = liked - 1&quot;</span>).eq(<span class="string">&quot;id&quot;</span>, id).update();</span><br><span class="line">        <span class="keyword">if</span> (success) &#123;</span><br><span class="line">            <span class="comment">//ä»seté›†åˆç§»é™¤</span></span><br><span class="line">            stringRedisTemplate.opsForZSet().remove(key, userId.toString());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> Result.ok();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> Result <span class="title function_">queryBlogLikes</span><span class="params">(Integer id)</span> &#123;</span><br><span class="line">    <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> BLOG_LIKED_KEY + id;</span><br><span class="line">    <span class="comment">//zrange key 0 4  æŸ¥è¯¢zsetä¸­å‰5ä¸ªå…ƒç´ </span></span><br><span class="line">    Set&lt;String&gt; top5 = stringRedisTemplate.opsForZSet().range(key, <span class="number">0</span>, <span class="number">4</span>);</span><br><span class="line">    <span class="comment">//å¦‚æœæ˜¯ç©ºçš„(å¯èƒ½æ²¡äººç‚¹èµ)ï¼Œç›´æ¥è¿”å›ä¸€ä¸ªç©ºé›†åˆ</span></span><br><span class="line">    <span class="keyword">if</span> (top5 == <span class="literal">null</span> || top5.isEmpty()) &#123;</span><br><span class="line">        <span class="keyword">return</span> Result.ok(Collections.emptyList());</span><br><span class="line">    &#125;</span><br><span class="line">    List&lt;Long&gt; ids = top5.stream().map(Long::valueOf).collect(Collectors.toList());</span><br><span class="line">    <span class="comment">//å°†idsä½¿ç”¨`,`æ‹¼æ¥ï¼ŒSQLè¯­å¥æŸ¥è¯¢å‡ºæ¥çš„ç»“æœå¹¶ä¸æ˜¯æŒ‰ç…§æˆ‘ä»¬æœŸæœ›çš„æ–¹å¼è¿›è¡Œæ’</span></span><br><span class="line">    <span class="comment">//æ‰€ä»¥æˆ‘ä»¬éœ€è¦ç”¨order by fieldæ¥æŒ‡å®šæ’åºæ–¹å¼ï¼ŒæœŸæœ›çš„æ’åºæ–¹å¼å°±æ˜¯æŒ‰ç…§æŸ¥è¯¢å‡ºæ¥çš„idè¿›è¡Œæ’åº</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">idsStr</span> <span class="operator">=</span> StrUtil.join(<span class="string">&quot;,&quot;</span>, ids);</span><br><span class="line">    <span class="comment">//select * from tb_user where id in (ids[0], ids[1] ...) order by field(id, ids[0], ids[1] ...)</span></span><br><span class="line">    List&lt;UserDTO&gt; userDTOS = userService.query().in(<span class="string">&quot;id&quot;</span>, ids)</span><br><span class="line">            .last(<span class="string">&quot;order by field(id,&quot;</span> + idsStr + <span class="string">&quot;)&quot;</span>)</span><br><span class="line">            .list().stream()</span><br><span class="line">            .map(user -&gt; BeanUtil.copyProperties(user, UserDTO.class))</span><br><span class="line">            .collect(Collectors.toList());</span><br><span class="line">    <span class="keyword">return</span> Result.ok(userDTOS);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>æ³¨æ„è¿™è¾¹çš„idsæ˜¯å–å‡ºæ¥å°±æ˜¯æŒ‰ç…§ç‚¹èµæ—¶é—´æ’åºçš„ï¼Œå‡è®¾ç‚¹èµçš„æ˜¯[5,1],æ‰€ä»¥è¦æŸ¥5å’Œ1ä¸¤ä¸ªç”¨æˆ·ï¼ŒåŒæ—¶5åœ¨å‰ï¼Œä½†æ˜¯ä¸€èˆ¬çš„æŸ¥è¯¢æœ‰ä¸‹é¢çš„é—®é¢˜</p>
</blockquote>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> `tb_user` <span class="keyword">where</span> id <span class="keyword">in</span>(<span class="number">5</span>,<span class="number">1</span>)</span><br></pre></td></tr></table></figure>

<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.nlark.com/yuque/0/2023/png/32620241/1679819565995-204a993e-6d1b-4215-81e2-efa0222203bf.png#averageHue=%23f5f2f0&clientId=u7fe237e5-bb7e-4&from=paste&height=57&id=u812b333d&name=image.png&originHeight=86&originWidth=510&originalType=binary&ratio=1.5&rotation=0&showTitle=false&size=5969&status=done&style=none&taskId=u5842c336-5424-48dd-8ebf-aa6ee105bd5&title=&width=340#averageHue=%23f5f2f0&id=Wb6MF&originHeight=86&originWidth=510&originalType=binary&ratio=1&rotation=0&showTitle=false&status=done&style=none&title=" alt="image.png"><br>æŸ¥è¯¢å‡ºæ¥å˜æˆäº†1å·ç”¨æˆ·åœ¨å‰é¢</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> `tb_user` <span class="keyword">where</span> id <span class="keyword">in</span>(<span class="number">5</span>,<span class="number">1</span>)</span><br><span class="line"><span class="keyword">order</span> <span class="keyword">by</span> FIELD(id,<span class="number">5</span>,<span class="number">1</span>)</span><br></pre></td></tr></table></figure>

<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.nlark.com/yuque/0/2023/png/32620241/1679819711378-6ebee88a-ef6e-4b95-9a75-9ae92a027a5f.png#averageHue=%23f5f2f0&clientId=u7fe237e5-bb7e-4&from=paste&height=57&id=u95be7968&name=image.png&originHeight=86&originWidth=504&originalType=binary&ratio=1.5&rotation=0&showTitle=false&size=5804&status=done&style=none&taskId=u2083ad3d-1588-4431-aa7e-bf51ec7267f&title=&width=336#averageHue=%23f5f2f0&id=PRsQ5&originHeight=86&originWidth=504&originalType=binary&ratio=1&rotation=0&showTitle=false&status=done&style=none&title=" alt="image.png"><br>è¿™è¾¹ä½¿ç”¨åˆ°äº†mybatisçš„last</p>
<h1 id="å…±åŒå…³æ³¨"><a href="#å…±åŒå…³æ³¨" class="headerlink" title="å…±åŒå…³æ³¨"></a>å…±åŒå…³æ³¨</h1><p>éœ€æ±‚:è®¡ç®—ä¸¤ä¸ªäººå…±åŒå…³æ³¨çš„æ‰€æœ‰ç”¨æˆ·<br>æ€è·¯: æœ¬è´¨å°±æ˜¯æ±‚ä¸¤ä¸ªç”¨æˆ·å…³æ³¨é›†åˆçš„ <strong>äº¤é›†</strong><br>å®ç°: ä½¿ç”¨ Redis Set æ•°æ®ç»“æ„ï¼Œæ¯ä¸ª key ä¿å­˜ 1ä¸ªç”¨æˆ·çš„å…³æ³¨é›†åˆ (å–å…³æ—¶ä»é›†åˆä¸­ç§»é™¤å¯¹åº”ç”¨æˆ·)ï¼Œæœ€åå¯¹ 2 ä¸ªç”¨æˆ·å¯¹åº”çš„ set è¿›è¡Œ intersectå–äº¤é›†æ“ä½œå³å¯</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Resource</span></span><br><span class="line"><span class="keyword">private</span> StringRedisTemplate stringRedisTemplate;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> Result <span class="title function_">follow</span><span class="params">(Long followUserId, Boolean isFellow)</span> &#123;</span><br><span class="line">    <span class="comment">//è·å–å½“å‰ç”¨æˆ·id</span></span><br><span class="line">    <span class="type">Long</span> <span class="variable">userId</span> <span class="operator">=</span> UserHolder.getUser().getId();</span><br><span class="line">    <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> <span class="string">&quot;follows:&quot;</span> + userId;</span><br><span class="line">    <span class="comment">//åˆ¤æ–­æ˜¯å¦å…³æ³¨</span></span><br><span class="line">    <span class="keyword">if</span> (isFellow) &#123;</span><br><span class="line">        <span class="comment">//å…³æ³¨ï¼Œåˆ™å°†ä¿¡æ¯ä¿å­˜åˆ°æ•°æ®åº“</span></span><br><span class="line">        <span class="type">Follow</span> <span class="variable">follow</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Follow</span>();</span><br><span class="line">        follow.setUserId(userId);</span><br><span class="line">        follow.setFollowUserId(followUserId);</span><br><span class="line">        <span class="comment">//å¦‚æœä¿å­˜æˆåŠŸ</span></span><br><span class="line">        <span class="type">boolean</span> <span class="variable">success</span> <span class="operator">=</span> save(follow);</span><br><span class="line">        <span class="comment">//åˆ™å°†æ•°æ®ä¹Ÿå†™å…¥Redis</span></span><br><span class="line">        <span class="keyword">if</span> (success) &#123;</span><br><span class="line">            stringRedisTemplate.opsForSet().add(key, followUserId.toString());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">//å–å…³ï¼Œåˆ™å°†æ•°æ®ä»æ•°æ®åº“ä¸­ç§»é™¤</span></span><br><span class="line">        LambdaQueryWrapper&lt;Follow&gt; queryWrapper = <span class="keyword">new</span> <span class="title class_">LambdaQueryWrapper</span>&lt;&gt;();</span><br><span class="line">        queryWrapper.eq(Follow::getUserId, userId).eq(Follow::getFollowUserId, followUserId);</span><br><span class="line">        <span class="comment">//å¦‚æœå–å…³æˆåŠŸ</span></span><br><span class="line">        <span class="type">boolean</span> <span class="variable">success</span> <span class="operator">=</span> remove(queryWrapper);</span><br><span class="line">        <span class="comment">//åˆ™å°†æ•°æ®ä¹Ÿä»Redisä¸­ç§»é™¤</span></span><br><span class="line">        <span class="keyword">if</span> (success)&#123;</span><br><span class="line">            stringRedisTemplate.opsForSet().remove(key,followUserId.toString());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> Result.ok();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>å®ç°å…¬å…±å…³æ³¨ä»£ç <figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> Result <span class="title function_">followCommons</span><span class="params">(Long id)</span> &#123;</span><br><span class="line">    <span class="comment">//è·å–å½“å‰ç”¨æˆ·id</span></span><br><span class="line">    <span class="type">Long</span> <span class="variable">userId</span> <span class="operator">=</span> UserHolder.getUser().getId();</span><br><span class="line">    <span class="type">String</span> <span class="variable">key1</span> <span class="operator">=</span> <span class="string">&quot;follows:&quot;</span> + id;</span><br><span class="line">    <span class="type">String</span> <span class="variable">key2</span> <span class="operator">=</span> <span class="string">&quot;follows:&quot;</span> + userId;</span><br><span class="line">    <span class="comment">//å¯¹å½“å‰ç”¨æˆ·å’Œåšä¸»ç”¨æˆ·çš„å…³æ³¨åˆ—è¡¨å–äº¤é›†</span></span><br><span class="line">    Set&lt;String&gt; intersect = stringRedisTemplate.opsForSet().intersect(key1, key2);</span><br><span class="line">    <span class="keyword">if</span> (intersect == <span class="literal">null</span> || intersect.isEmpty()) &#123;</span><br><span class="line">        <span class="comment">//æ— äº¤é›†å°±è¿”å›ä¸ªç©ºé›†åˆ</span></span><br><span class="line">        <span class="keyword">return</span> Result.ok(Collections.emptyList());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//å°†ç»“æœè½¬ä¸ºlist</span></span><br><span class="line">    List&lt;Long&gt; ids = intersect.stream().map(Long::valueOf).collect(Collectors.toList());</span><br><span class="line">    <span class="comment">//ä¹‹åæ ¹æ®idså»æŸ¥è¯¢å…±åŒå…³æ³¨çš„ç”¨æˆ·ï¼Œå°è£…æˆUserDtoå†è¿”å›</span></span><br><span class="line">    List&lt;UserDTO&gt; userDTOS = userService.listByIds(ids).stream().map(user -&gt;</span><br><span class="line">            BeanUtil.copyProperties(user, UserDTO.class)).collect(Collectors.toList());</span><br><span class="line">    <span class="keyword">return</span> Result.ok(userDTOS);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ul>
<h1 id="Feedæµå…³æ³¨æ¨é€"><a href="#Feedæµå…³æ³¨æ¨é€" class="headerlink" title="Feedæµå…³æ³¨æ¨é€"></a>Feedæµå…³æ³¨æ¨é€</h1><p>åœºæ™¯ï¼šå½“æˆ‘ä»¬å…³æ³¨äº†ç”¨æˆ·ä¹‹åï¼Œè¿™ä¸ªç”¨æˆ·å‘å¸ƒäº†åŠ¨æ€ï¼Œé‚£æˆ‘ä»¬åº”è¯¥æŠŠè¿™äº›æ•°æ®æ¨é€ç»™ç”¨æˆ·ï¼Œè¿™ä¸ªéœ€æ±‚ï¼Œæˆ‘ä»¬åˆç§°å…¶ä¸ºFeedæµï¼Œå…³æ³¨æ¨é€ä¹Ÿå«ä½œFeedæµï¼Œç›´è¯‘ä¸ºæŠ•å–‚ï¼Œä¸ºç”¨æˆ·æä¾›æ²‰æµ¸å¼ä½“éªŒï¼Œé€šè¿‡æ— é™ä¸‹æ‹‰åˆ·æ–°è·å–æ–°çš„ä¿¡æ¯ï¼Œ</p>
<ul>
<li>Feedæµçš„å®ç°æœ‰ä¸¤ç§æ¨¡å¼ <ol>
<li>Timelineï¼šä¸åšå†…å®¹ç­›é€‰ï¼Œç®€å•çš„æŒ‰ç…§å†…å®¹<code>å‘å¸ƒæ—¶é—´</code>æ’åºï¼Œå¸¸ç”¨äºå¥½å‹æˆ–å…³æ³¨(Bç«™å…³æ³¨çš„upï¼Œæœ‹å‹åœˆç­‰) <ul>
<li>ä¼˜ç‚¹ï¼šä¿¡æ¯å…¨é¢ï¼Œä¸ä¼šæœ‰ç¼ºå¤±ï¼Œå¹¶ä¸”å®ç°ä¹Ÿç›¸å¯¹ç®€å•</li>
<li>ç¼ºç‚¹ï¼šä¿¡æ¯å™ªéŸ³è¾ƒå¤šï¼Œç”¨æˆ·ä¸ä¸€å®šæ„Ÿå…´è¶£ï¼Œå†…å®¹è·å–æ•ˆç‡ä½</li>
</ul>
</li>
<li>æ™ºèƒ½æ’åºï¼šåˆ©ç”¨æ™ºèƒ½ç®—æ³•å±è”½æ‰è¿è§„çš„ã€ç”¨æˆ·ä¸æ„Ÿå…´è¶£çš„å†…å®¹ï¼Œæ¨é€ç”¨æˆ·<code>æ„Ÿå…´è¶£</code>çš„ä¿¡æ¯æ¥å¸å¼•ç”¨æˆ· <ul>
<li>ä¼˜ç‚¹ï¼šæŠ•å–‚ç”¨æˆ·æ„Ÿå…´è¶£çš„ä¿¡æ¯ï¼Œç”¨æˆ·ç²˜åº¦å¾ˆé«˜ï¼Œå®¹æ˜“æ²‰è¿·</li>
<li>ç¼ºç‚¹ï¼šå¦‚æœç®—æ³•ä¸ç²¾å‡†ï¼Œå¯èƒ½ä¼šèµ·åˆ°åä½œç”¨ï¼ˆç»™ä½ æ¨çš„ä½ éƒ½ä¸çˆ±çœ‹ï¼‰</li>
</ul>
</li>
</ol>
</li>
<li>é‚£æˆ‘ä»¬è¿™é‡Œé’ˆå¯¹å¥½å‹çš„æ“ä½œï¼Œé‡‡ç”¨çš„æ˜¯Timelineæ–¹å¼ï¼Œåªéœ€è¦æ‹¿åˆ°æˆ‘ä»¬å…³æ³¨ç”¨æˆ·çš„ä¿¡æ¯ï¼Œç„¶åæŒ‰ç…§æ—¶é—´æ’åºå³å¯</li>
</ul>
<h2 id="å®ç°æ–¹æ¡ˆ"><a href="#å®ç°æ–¹æ¡ˆ" class="headerlink" title="å®ç°æ–¹æ¡ˆ"></a>å®ç°æ–¹æ¡ˆ</h2><h3 id="æ‹‰æ¨¡å¼ï¼ˆè¯»æ‰©æ•£ï¼‰"><a href="#æ‹‰æ¨¡å¼ï¼ˆè¯»æ‰©æ•£ï¼‰" class="headerlink" title="æ‹‰æ¨¡å¼ï¼ˆè¯»æ‰©æ•£ï¼‰"></a>æ‹‰æ¨¡å¼ï¼ˆè¯»æ‰©æ•£ï¼‰</h3><ul>
<li>è¯¥æ¨¡å¼çš„æ ¸å¿ƒå«ä¹‰æ˜¯ï¼šå½“å¼ ä¸‰å’Œæå››ã€ç‹äº”å‘äº†æ¶ˆæ¯ä¹‹åï¼Œéƒ½ä¼šä¿å­˜åˆ°è‡ªå·±çš„å‘ä»¶ç®±ä¸­ï¼Œå¦‚æœèµµå…­è¦è¯»å–æ¶ˆæ¯ï¼Œé‚£ä¹ˆä»–ä¼šè¯»å–ä»–è‡ªå·±çš„æ”¶ä»¶ç®±ï¼Œæ­¤æ—¶ç³»ç»Ÿä¼šä»ä»–å…³æ³¨çš„äººç¾¤ä¸­ï¼Œå°†ä»–å…³æ³¨äººçš„ä¿¡æ¯å…¨éƒ½è¿›è¡Œæ‹‰å–ï¼Œç„¶åè¿›è¡Œæ’åº</li>
<li>ä¼˜ç‚¹ï¼šæ¯”è¾ƒèŠ‚çº¦ç©ºé—´ï¼Œå› ä¸ºèµµå…­åœ¨è¯»å–ä¿¡æ¯æ—¶ï¼Œå¹¶æ²¡æœ‰é‡å¤è¯»å–ï¼Œå¹¶ä¸”è¯»å–å®Œä¹‹åï¼Œå¯ä»¥å°†ä»–çš„æ”¶ä»¶ç®±æ¸…é™¤</li>
<li>ç¼ºç‚¹ï¼šæœ‰å»¶è¿Ÿï¼Œå½“ç”¨æˆ·è¯»å–æ•°æ®æ—¶ï¼Œæ‰ä¼šå»å…³æ³¨çš„äººçš„æ—¶å‘ä»¶ç®±ä¸­æ‹‰å–ä¿¡æ¯ï¼Œå‡è®¾è¯¥ç”¨æˆ·å…³æ³¨äº†æµ·é‡ç”¨æˆ·ï¼Œé‚£ä¹ˆæ­¤æ—¶å°±ä¼šæ‹‰å–å¾ˆå¤šä¿¡æ¯ï¼Œå¯¹æœåŠ¡å™¨å‹åŠ›å·¨å¤§</li>
</ul>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.nlark.com/yuque/0/2023/png/32620241/1679831142177-eec16b9f-5547-44c4-a315-b3247d3f78ef.png#averageHue=%23fcfcfb&clientId=ucc2cc29c-dcb2-4&from=paste&id=u0b810fd4&name=image.png&originHeight=636&originWidth=1477&originalType=url&ratio=1.5&rotation=0&showTitle=false&size=299204&status=done&style=none&taskId=u1bd1e78a-ed8b-4219-94ea-0455d2e3d1a&title=#averageHue=%23fcfcfb&id=AW2pd&originHeight=636&originWidth=1477&originalType=binary&ratio=1&rotation=0&showTitle=false&status=done&style=none&title=" alt="image.png"></p>
<h3 id="æ¨æ¨¡å¼"><a href="#æ¨æ¨¡å¼" class="headerlink" title="æ¨æ¨¡å¼"></a>æ¨æ¨¡å¼</h3><ul>
<li>æ¨æ¨¡å¼æ˜¯æ²¡æœ‰å†™é‚®ç®±çš„ï¼Œå½“å¼ ä¸‰å†™äº†ä¸€ä¸ªå†…å®¹ï¼Œæ­¤æ—¶ä¼šä¸»åŠ¨æŠŠå¼ ä¸‰å†™çš„å†…å®¹å‘é€åˆ°å®ƒç²‰ä¸çš„æ”¶ä»¶ç®±ä¸­ï¼Œå‡è®¾æ­¤æ—¶æå››å†æ¥è¯»å–ï¼Œå°±ä¸ç”¨å†å»ä¸´æ—¶æ‹‰å–äº†</li>
<li>ä¼˜ç‚¹ï¼šæ—¶æ•ˆå¿«ï¼Œä¸ç”¨ä¸´æ—¶æ‹‰å–</li>
<li>ç¼ºç‚¹ï¼šå†…å­˜å‹åŠ›å¤§ï¼Œå‡è®¾ä¸€ä¸ªå¤§Vå‘äº†ä¸€ä¸ªåŠ¨æ€ï¼Œå¾ˆå¤šäººå…³æ³¨ä»–ï¼Œé‚£ä¹ˆå°±ä¼šå†™å¾ˆå¤šä»½æ•°æ®åˆ°ç²‰ä¸é‚£è¾¹å»</li>
</ul>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.nlark.com/yuque/0/2023/png/32620241/1679831159323-c8b68aac-7238-4f04-bf4e-c0799217dcb5.png#averageHue=%23fdfdfd&clientId=ucc2cc29c-dcb2-4&from=paste&id=u9807b0c6&name=image.png&originHeight=714&originWidth=1102&originalType=url&ratio=1.5&rotation=0&showTitle=false&size=246856&status=done&style=none&taskId=u41bcdc42-6f05-4639-ba22-b5bdb0701cd&title=#averageHue=%23fdfdfd&id=BjhwJ&originHeight=714&originWidth=1102&originalType=binary&ratio=1&rotation=0&showTitle=false&status=done&style=none&title=" alt="image.png"></p>
<h3 id="æ¨æ‹‰ç»“åˆ"><a href="#æ¨æ‹‰ç»“åˆ" class="headerlink" title="æ¨æ‹‰ç»“åˆ"></a>æ¨æ‹‰ç»“åˆ</h3><ul>
<li>æ¨æ‹‰æ¨¡å¼æ˜¯ä¸€ä¸ªæŠ˜ä¸­çš„æ–¹æ¡ˆï¼Œç«™åœ¨å‘ä»¶äººè¿™ä¸€è¾¹ï¼Œå¦‚æœæ˜¯æ™®é€šäººï¼Œé‚£ä¹ˆæˆ‘ä»¬é‡‡ç”¨å†™æ‰©æ•£çš„æ–¹å¼ï¼Œç›´æ¥æŠŠæ•°æ®å†™å…¥åˆ°ä»–çš„ç²‰ä¸æ”¶ä»¶ç®±ä¸­ï¼Œå› ä¸ºæ™®é€šäººçš„ç²‰ä¸æ•°é‡è¾ƒå°‘ï¼Œæ‰€ä»¥è¿™æ ·ä¸ä¼šäº§ç”Ÿå¤ªå¤§å‹åŠ›ã€‚ä½†å¦‚æœæ˜¯å¤§Vï¼Œé‚£ä¹ˆä»–æ˜¯ç›´æ¥å°†æ•°æ®å†™å…¥ä¸€ä»½åˆ°å‘ä»¶ç®±ä¸­å»ï¼Œåœ¨ç›´æ¥å†™ä¸€ä»½åˆ°æ´»è·ƒç²‰ä¸çš„æ”¶ä»¶ç®±ä¸­ï¼Œç«™åœ¨æ”¶ä»¶äººè¿™è¾¹æ¥çœ‹ï¼Œå¦‚æœæ˜¯æ´»è·ƒç²‰ä¸ï¼Œé‚£ä¹ˆå¤§Vå’Œæ™®é€šäººå‘çš„éƒ½ä¼šå†™åˆ°è‡ªå·±çš„æ”¶ä»¶ç®±é‡Œï¼Œä½†å¦‚æœæ˜¯æ™®é€šç²‰ä¸ï¼Œç”±äºä¸Šçº¿ä¸æ˜¯å¾ˆé¢‘ç¹ï¼Œæ‰€ä»¥ç­‰ä»–ä»¬ä¸Šçº¿çš„æ—¶å€™ï¼Œå†ä»å‘ä»¶ç®±ä¸­å»æ‹‰å–ä¿¡æ¯ã€‚</li>
</ul>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.nlark.com/yuque/0/2023/png/32620241/1679831189183-35e6d385-a0c9-4c18-8024-d2134f558bed.png#averageHue=%23fcfcfb&clientId=ucc2cc29c-dcb2-4&from=paste&id=u718e9b37&name=image.png&originHeight=634&originWidth=1432&originalType=url&ratio=1.5&rotation=0&showTitle=false&size=303923&status=done&style=none&taskId=uc950f982-89f8-488d-8a5f-bede7e15f14&title=#averageHue=%23fcfcfb&id=rEcsG&originHeight=634&originWidth=1432&originalType=binary&ratio=1&rotation=0&showTitle=false&status=done&style=none&title=" alt="image.png"></p>
<h3 id="å¯¹æ¯”"><a href="#å¯¹æ¯”" class="headerlink" title="å¯¹æ¯”"></a>å¯¹æ¯”</h3><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.nlark.com/yuque/0/2023/png/32620241/1681815380922-aaf78d43-aa3a-42b6-a2a3-201deff42876.png#averageHue=%23f8f5f3&clientId=uf387f538-a383-4&from=paste&height=552&id=uc3e8a299&originHeight=828&originWidth=1880&originalType=binary&ratio=1.5&rotation=0&showTitle=false&size=223851&status=done&style=none&taskId=u4c43a7eb-70a9-40db-9fa0-0782301d700&title=&width=1253.3333333333333" alt="image.png"></p>
<h2 id="æ¨æ¨¡å¼å®ç°"><a href="#æ¨æ¨¡å¼å®ç°" class="headerlink" title="æ¨æ¨¡å¼å®ç°"></a>æ¨æ¨¡å¼å®ç°</h2><p>å› ä¸ºæ¨é€æ˜¯æŒ‰æ—¶é—´æ’åºçš„ï¼Œæ‰€ä»¥å¯ä»¥ä½¿ç”¨SortedSet æ•°æ®ç»“æ„æ¥ä¿å­˜ï¼Œæ¯ä¸ª key è¡¨ç¤ºä¸€ä¸ªç”¨æˆ·çš„æ”¶ä»¶ç®±ï¼Œvalue ä¸ºæ¨é€ idã€score ä¸ºæ¨é€æ—¶é—´æˆ³ã€‚<br>æŸ¥è¯¢æ‰€æœ‰æ¨é€æ—¶ç›´æ¥éå† SortedSet å³å¯</p>
<h3 id="åˆ†é¡µé—®é¢˜"><a href="#åˆ†é¡µé—®é¢˜" class="headerlink" title="åˆ†é¡µé—®é¢˜"></a>åˆ†é¡µé—®é¢˜</h3><ul>
<li>Feedæµä¸­çš„æ•°æ®ä¼šä¸æ–­æ›´æ–°ï¼Œæ‰€ä»¥æ•°æ®çš„è§’æ ‡ä¹Ÿä¼šä¸æ–­å˜åŒ–ï¼Œæ‰€ä»¥æˆ‘ä»¬ä¸èƒ½ä½¿ç”¨ä¼ ç»Ÿçš„åˆ†é¡µæ¨¡å¼</li>
<li>å‡è®¾åœ¨t1æ—¶åˆ»ï¼Œæˆ‘ä»¬å–è¯»å–ç¬¬ä¸€é¡µï¼Œæ­¤æ—¶page &#x3D; 1ï¼Œsize &#x3D; 5ï¼Œé‚£ä¹ˆæˆ‘ä»¬æ‹¿åˆ°çš„å°±æ˜¯10<del>6è¿™å‡ æ¡è®°å½•ï¼Œå‡è®¾t2æ—¶åˆ»æœ‰å‘å¸ƒäº†ä¸€æ¡æ–°çºªå½•ï¼Œé‚£ä¹ˆåœ¨t3æ—¶åˆ»ï¼Œæˆ‘ä»¬æ¥è¯»å–ç¬¬äºŒé¡µï¼Œæ­¤æ—¶page &#x3D; 2ï¼Œsize &#x3D; 5ï¼Œé‚£ä¹ˆæ­¤æ—¶è¯»å–çš„æ•°æ®æ˜¯ä»6å¼€å§‹çš„ï¼Œè¯»åˆ°çš„æ˜¯6</del>2ï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±è¯»åˆ°äº†é‡å¤çš„æ•°æ®ï¼Œæ‰€ä»¥æˆ‘ä»¬è¦ä½¿ç”¨Feedæµçš„åˆ†é¡µï¼Œä¸èƒ½ä½¿ç”¨ä¼ ç»Ÿçš„åˆ†é¡µ</li>
</ul>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.nlark.com/yuque/0/2023/png/32620241/1679831641147-58170514-b54f-4e34-abf5-7db96a18ef6e.png#averageHue=%23faf9f8&clientId=ucc2cc29c-dcb2-4&from=paste&id=ufc97b562&name=image.png&originHeight=642&originWidth=1494&originalType=url&ratio=1.5&rotation=0&showTitle=false&size=221148&status=done&style=none&taskId=ub4b84472-7d90-451f-9db8-e0cc817c688&title=#averageHue=%23faf9f8&id=sONhM&originHeight=642&originWidth=1494&originalType=binary&ratio=1&rotation=0&showTitle=false&status=done&style=none&title=" alt="image.png"><br>å› æ­¤ï¼Œå¯ä»¥ä½¿ç”¨æ»šåŠ¨åˆ†é¡µï¼Œè®°å½•æ¯æ¬¡å½“å‰é¡µæŸ¥è¯¢åˆ°çš„æœ€åä¸€æ¡æ•°æ®çš„æ—¶é—´æˆ³(ç±»ä¼¼æ¸¸æ ‡) ã€‚æŸ¥è¯¢ä¸‹ä¸€é¡µæ—¶ï¼Œä»å½“å‰æ—¶é—´æˆ³çš„ä¸‹ä¸€æ¡å¼€å§‹æŸ¥è¯¢å³å¯<br><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.nlark.com/yuque/0/2023/png/32620241/1679831668181-4e4dd5d6-0b80-4dd0-a8e5-bb567e00e3a2.png#averageHue=%23f9f9f8&clientId=ucc2cc29c-dcb2-4&from=paste&id=ubebabba6&name=image.png&originHeight=657&originWidth=1480&originalType=url&ratio=1.5&rotation=0&showTitle=false&size=220226&status=done&style=none&taskId=uc076c65c-6ac0-4f91-8810-5e8154de3ff&title=#averageHue=%23f9f9f8&id=MOoCB&originHeight=657&originWidth=1480&originalType=binary&ratio=1&rotation=0&showTitle=false&status=done&style=none&title=" alt="image.png"></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> Result <span class="title function_">saveBlog</span><span class="params">(Blog blog)</span> &#123;</span><br><span class="line">    <span class="comment">// è·å–ç™»å½•ç”¨æˆ·</span></span><br><span class="line">    <span class="type">UserDTO</span> <span class="variable">user</span> <span class="operator">=</span> UserHolder.getUser();</span><br><span class="line">    blog.setUserId(user.getId());</span><br><span class="line">    <span class="comment">// ä¿å­˜æ¢åº—åšæ–‡</span></span><br><span class="line">    save(blog);</span><br><span class="line">    <span class="comment">// æ¡ä»¶æ„é€ å™¨</span></span><br><span class="line">    LambdaQueryWrapper&lt;Follow&gt; queryWrapper = <span class="keyword">new</span> <span class="title class_">LambdaQueryWrapper</span>&lt;&gt;();</span><br><span class="line">    <span class="comment">// ä»followè¡¨æœ€ä¸­ï¼ŒæŸ¥æ‰¾å½“å‰ç”¨æˆ·çš„ç²‰ä¸  select * from follow where follow_user_id = user_id</span></span><br><span class="line">    queryWrapper.eq(Follow::getFollowUserId, user.getId());</span><br><span class="line">    <span class="comment">//è·å–å½“å‰ç”¨æˆ·çš„ç²‰ä¸</span></span><br><span class="line">    List&lt;Follow&gt; follows = followService.list(queryWrapper);</span><br><span class="line">    <span class="keyword">for</span> (Follow follow : follows) &#123;</span><br><span class="line">        <span class="type">Long</span> <span class="variable">userId</span> <span class="operator">=</span> follow.getUserId();</span><br><span class="line">        <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> FEED_KEY + userId;</span><br><span class="line">        <span class="comment">//æ¨é€æ•°æ®</span></span><br><span class="line">        stringRedisTemplate.opsForZSet().add(key, blog.getId().toString(), System.currentTimeMillis());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// è¿”å›id</span></span><br><span class="line">    <span class="keyword">return</span> Result.ok(blog.getId());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="å®ç°åˆ†é¡µæŸ¥è¯¢æ”¶ä»¶ç®±"><a href="#å®ç°åˆ†é¡µæŸ¥è¯¢æ”¶ä»¶ç®±" class="headerlink" title="å®ç°åˆ†é¡µæŸ¥è¯¢æ”¶ä»¶ç®±"></a>å®ç°åˆ†é¡µæŸ¥è¯¢æ”¶ä»¶ç®±</h2><p>å¯ä»¥ä½¿ç”¨ <code>SortedSet</code> çš„ <code>ZRevRangeByScore</code> å‘½ä»¤å®ç°ï¼Œæ¯æ¬¡æŸ¥è¯¢æŒ‡å®šæ—¶é—´æˆ³èŒƒå›´ (0ï¼Œå½“å‰æœ€å¤§æ—¶é—´æˆ³)çš„æŒ‡å®šæ¡æ•°çš„æ•°æ®ã€‚ç¤ºä¾‹å‘½ä»¤: </p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">ZRevRangeByScore key 0 maxTimeStampoffset limit</span><br></pre></td></tr></table></figure>
<p>æ³¨æ„æœ‰ä¸ªé—®é¢˜ï¼Œå¯èƒ½å‡ºç°ç›¸åŒæ—¶é—´æˆ³æˆ³çš„æ•°æ®ï¼Œå› æ­¤ç¬¬ä¸€æ¬¡æŸ¥è¯¢æ—¶ offset ä¸º 0 (ä»ç¬¬ä¸€æ¡å¼€å§‹æŸ¥)ï¼Œä¹‹åæ¯æ¬¡æŸ¥è¯¢ï¼Œ<code>offset</code> ä¸ºä¸Šä¸€é¡µä¸­æ—¶é—´æˆ³æœ€å°å€¼çš„æ•°é‡ï¼Œä¿è¯ä¸æŸ¥å‡ºé‡å¤æ•°æ®<br>æ¯”å¦‚ score åˆ—è¡¨ä¸º: 5,4, 4,3,2,1ã€‚æ¯é¡µ 3 æ¡ç¬¬ä¸€æ¬¡æŸ¥è¯¢ ZRevRangeByScore key 0 99999990 3 æŸ¥å‡º 5ã€4ã€4ï¼Œæœ€å°å€¼ 4 é‡å¤ 2 æ¬¡ï¼Œå³ä¸‹ä¸€æ¬¡çš„æœ€å¤§å€¼ä¸º 4ã€offset ä¸º 2.æ‰€ä»¥ç¬¬äºŒæ¬¡æŸ¥è¯¢ä¸º </p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">ZRevRangeByScore key 0 4 2</span><br></pre></td></tr></table></figure>
<p> æŸ¥å‡º 3ã€2ã€1</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@GetMapping(&quot;/of/follow&quot;)</span></span><br><span class="line"><span class="keyword">public</span> Result <span class="title function_">queryBlogOfFollow</span><span class="params">(<span class="meta">@RequestParam(&quot;lastId&quot;)</span> Long max, <span class="meta">@RequestParam(value = &quot;offset&quot;,defaultValue = &quot;0&quot;)</span> Integer offset)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> blogService.queryBlogOfFollow(max,offset);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> Result <span class="title function_">queryBlogOfFollow</span><span class="params">(Long max, Integer offset)</span> &#123;</span><br><span class="line">    <span class="comment">//1. è·å–å½“å‰ç”¨æˆ·</span></span><br><span class="line">    <span class="type">Long</span> <span class="variable">userId</span> <span class="operator">=</span> UserHolder.getUser().getId();</span><br><span class="line">    <span class="comment">//2. æŸ¥è¯¢è¯¥ç”¨æˆ·æ”¶ä»¶ç®±ï¼ˆä¹‹å‰æˆ‘ä»¬å­˜çš„keyæ˜¯å›ºå®šå‰ç¼€ + ç²‰ä¸idï¼‰ï¼Œæ‰€ä»¥æ ¹æ®å½“å‰ç”¨æˆ·idå°±å¯ä»¥æŸ¥è¯¢æ˜¯å¦æœ‰å…³æ³¨çš„äººå‘äº†ç¬”è®°</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> FEED_KEY + userId;</span><br><span class="line">    <span class="comment">// 2.è¡¨ç¤ºæ¯æ¬¡æŸ¥è¯¢ä¸¤æ¡ï¼Œè¿™è¾¹å†™æ­»äº†</span></span><br><span class="line">    Set&lt;ZSetOperations.TypedTuple&lt;String&gt;&gt; typeTuples = stringRedisTemplate.opsForZSet()</span><br><span class="line">            .reverseRangeByScoreWithScores(key, <span class="number">0</span>, max, offset, <span class="number">2</span>);</span><br><span class="line">    <span class="comment">//3. éç©ºåˆ¤æ–­</span></span><br><span class="line">    <span class="keyword">if</span> (typeTuples == <span class="literal">null</span> || typeTuples.isEmpty())&#123;</span><br><span class="line">        <span class="keyword">return</span> Result.ok(Collections.emptyList());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//4. è§£ææ•°æ®ï¼ŒblogIdã€minTimeï¼ˆæ—¶é—´æˆ³ï¼‰ã€offsetï¼Œè¿™é‡ŒæŒ‡å®šåˆ›å»ºçš„listå¤§å°ï¼Œå¯ä»¥ç•¥å¾®æé«˜æ•ˆç‡ï¼Œå› ä¸ºæˆ‘ä»¬çŸ¥é“è¿™ä¸ªlistå°±å¾—æ˜¯è¿™ä¹ˆå¤§</span></span><br><span class="line">    ArrayList&lt;Long&gt; ids = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;(typeTuples.size());</span><br><span class="line">    <span class="type">long</span> <span class="variable">minTime</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">    <span class="type">int</span> <span class="variable">os</span> <span class="operator">=</span> <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">for</span> (ZSetOperations.TypedTuple&lt;String&gt; typeTuple : typeTuples) &#123;</span><br><span class="line">        <span class="comment">//4.1 è·å–id</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">id</span> <span class="operator">=</span> typeTuple.getValue();</span><br><span class="line">        ids.add(Long.valueOf(id));</span><br><span class="line">        <span class="comment">//4.2 è·å–scoreï¼ˆæ—¶é—´æˆ³ï¼‰</span></span><br><span class="line">        <span class="type">long</span> <span class="variable">time</span> <span class="operator">=</span> typeTuple.getScore().longValue();</span><br><span class="line">        <span class="keyword">if</span> (time == minTime)&#123;</span><br><span class="line">            os++;</span><br><span class="line">        &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">            minTime = time;</span><br><span class="line">            os = <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//è§£å†³SQLçš„inä¸èƒ½æ’åºé—®é¢˜ï¼Œæ‰‹åŠ¨æŒ‡å®šæ’åºä¸ºä¼ å…¥çš„ids</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">idsStr</span> <span class="operator">=</span> StrUtil.join(<span class="string">&quot;,&quot;</span>);</span><br><span class="line">    <span class="comment">//5. æ ¹æ®idæŸ¥è¯¢blog</span></span><br><span class="line">    List&lt;Blog&gt; blogs = query().in(<span class="string">&quot;id&quot;</span>, ids).last(<span class="string">&quot;ORDER BY FIELD(id,&quot;</span> + idsStr + <span class="string">&quot;)&quot;</span>).list()</span><br><span class="line">    <span class="keyword">for</span> (Blog blog : blogs) &#123;</span><br><span class="line">        <span class="comment">//5.1 æŸ¥è¯¢å‘å¸ƒè¯¥blogçš„ç”¨æˆ·ä¿¡æ¯</span></span><br><span class="line">        queryBlogUser(blog);</span><br><span class="line">        <span class="comment">//5.2 æŸ¥è¯¢å½“å‰ç”¨æˆ·æ˜¯å¦ç»™è¯¥blogç‚¹è¿‡èµ</span></span><br><span class="line">        isBlogLiked(blog);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//6. å°è£…ç»“æœå¹¶è¿”å›</span></span><br><span class="line">    <span class="type">ScrollResult</span> <span class="variable">scrollResult</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ScrollResult</span>();</span><br><span class="line">    scrollResult.setList(blogs);</span><br><span class="line">    scrollResult.setOffset(os);</span><br><span class="line">    scrollResult.setMinTime(minTime);</span><br><span class="line">    <span class="keyword">return</span> Result.ok(scrollResult);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="GEOåœ°ç†åæ ‡è®¡ç®—"><a href="#GEOåœ°ç†åæ ‡è®¡ç®—" class="headerlink" title="GEOåœ°ç†åæ ‡è®¡ç®—"></a>GEOåœ°ç†åæ ‡è®¡ç®—</h1><h2 id="GEOæ•°æ®ç±»å‹"><a href="#GEOæ•°æ®ç±»å‹" class="headerlink" title="GEOæ•°æ®ç±»å‹"></a>GEOæ•°æ®ç±»å‹</h2><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.nlark.com/yuque/0/2023/png/32620241/1681816166386-ec9bc25f-94a6-4b1e-bc82-c900b4a63ba2.png#averageHue=%23f1f1f1&clientId=uf387f538-a383-4&from=paste&height=532&id=u667e9a76&originHeight=798&originWidth=1914&originalType=binary&ratio=1.5&rotation=0&showTitle=false&size=511613&status=done&style=none&taskId=u2c83c41c-cc11-4359-a5d5-3a212a41ee0&title=&width=1276" alt="image.png"><br>GEOå°±æ˜¯Geolocationçš„ç®€å†™å½¢å¼ï¼Œä»£è¡¨åœ°ç†åæ ‡ã€‚Redisåœ¨3.2ç‰ˆæœ¬ä¸­åŠ å…¥äº†å¯¹GEOçš„æ”¯æŒï¼Œå…è®¸å­˜å‚¨åœ°ç†åæ ‡ä¿¡æ¯ï¼Œå¸®åŠ©æˆ‘ä»¬æ ¹æ®ç»çº¬åº¦æ¥æ£€ç´¢æ•°æ®ï¼Œå¸¸è§çš„å‘½ä»¤æœ‰</p>
<ul>
<li>GEOADDï¼šæ·»åŠ ä¸€ä¸ªåœ°ç†ç©ºé—´ä¿¡æ¯ï¼ŒåŒ…å«ï¼šç»åº¦ï¼ˆlongitudeï¼‰ã€çº¬åº¦ï¼ˆlatitudeï¼‰ã€å€¼ï¼ˆmemberï¼‰<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">GEOADD key longitude latitude member [longitude latitude member â€¦]</span><br></pre></td></tr></table></figure>
<blockquote>
<ul>
<li>è¿”å›å€¼ï¼šæ·»åŠ åˆ°sorted setå…ƒç´ çš„æ•°â½¬ï¼Œä½†ä¸åŒ…æ‹¬å·²æ›´æ–°scoreçš„å…ƒç´ </li>
<li>å¤æ‚åº¦ï¼šæ¯â¼€ä¸ªå…ƒç´ æ·»åŠ æ˜¯O(log(N)) ï¼ŒNæ˜¯sorted setçš„å…ƒç´ æ•°é‡</li>
</ul>
</blockquote>
</li>
</ul>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">GEOADD china 13.361389 38.115556 &quot;shanghai&quot; </span><br><span class="line">15.087269 37.502669 &quot;beijing&quot;</span><br></pre></td></tr></table></figure>

<ul>
<li>GEODISTï¼šè®¡ç®—æŒ‡å®šçš„ä¸¤ä¸ªç‚¹ä¹‹é—´çš„è·ç¦»å¹¶è¿”å›<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">GEODIST key member1 member2 [m|km|ft|mi]</span><br></pre></td></tr></table></figure>
<blockquote>
<ul>
<li>å¦‚æœä¸¤ä¸ªä½ç½®ä¹‹é—´çš„å…¶ä¸­â¼€ä¸ªä¸å­˜åœ¨ï¼Œ é‚£ä¹ˆå‘½ä»¤è¿”å›ç©ºå€¼ã€‚</li>
<li>æŒ‡å®šå•ä½çš„å‚æ•° unit å¿…é¡»æ˜¯ä»¥ä¸‹å•ä½çš„å…¶ä¸­â¼€ä¸ªï¼š <ul>
<li>m è¡¨â½°å•ä½ä¸ºâ½¶ã€‚</li>
<li>km è¡¨â½°å•ä½ä¸ºåƒâ½¶ã€‚</li>
<li>mi è¡¨â½°å•ä½ä¸ºè‹±â¾¥ã€‚</li>
<li>ft è¡¨â½°å•ä½ä¸ºè‹±å°ºã€‚</li>
</ul>
</li>
<li>å¦‚æœâ½¤æˆ·æ²¡æœ‰æ˜¾å¼åœ°æŒ‡å®šå•ä½å‚æ•°ï¼Œ é‚£ä¹ˆ GEODIST é»˜è®¤ä½¿â½¤â½¶ä½œä¸ºå•ä½ã€‚</li>
<li>GEODIST å‘½ä»¤åœ¨è®¡ç®—è·ç¦»æ—¶ä¼šå‡è®¾åœ°çƒä¸ºå®Œç¾çš„çƒå½¢ï¼Œ åœ¨æé™æƒ…å†µä¸‹ï¼Œ è¿™â¼€å‡è®¾æœ€â¼¤ä¼šé€ æˆ 0.5% çš„è¯¯å·®</li>
<li>è¿”å›å€¼ï¼šè®¡ç®—å‡ºçš„è·ç¦»ä¼šä»¥åŒç²¾åº¦æµ®ç‚¹æ•°çš„å½¢å¼è¢«è¿”å›ã€‚ å¦‚æœç»™å®šçš„ä½ç½®å…ƒç´ ä¸å­˜åœ¨ï¼Œ é‚£ä¹ˆå‘½ä»¤è¿”å›ç©ºå€¼</li>
</ul>
</blockquote>
</li>
</ul>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">GEODIST china beijing shanghai km</span><br></pre></td></tr></table></figure>

<ul>
<li><p>GEOHASHï¼šå°†æŒ‡å®šmemberçš„åæ ‡è½¬åŒ–ä¸ºhashå­—ç¬¦ä¸²å½¢å¼å¹¶è¿”å›</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">GEOHASH key member [member â€¦]</span><br></pre></td></tr></table></figure>
<blockquote>
<ul>
<li>é€šå¸¸ä½¿ç”¨è¡¨ç¤ºä½ç½®çš„å…ƒç´ ä½¿ç”¨ä¸åŒçš„æŠ€æœ¯ï¼Œä½¿ç”¨Geohashä½ç½®52ç‚¹æ•´æ•°ç¼–ç ã€‚ç”±äºç¼–ç å’Œè§£ç è¿‡ç¨‹ä¸­æ‰€ä½¿ç”¨çš„åˆå§‹æœ€å°å’Œæœ€å¤§åæ ‡ä¸åŒï¼Œç¼–ç çš„ç¼–ç ä¹Ÿä¸åŒäºæ ‡å‡†ã€‚æ­¤å‘½ä»¤è¿”å›ä¸€ä¸ªæ ‡å‡†çš„Geohashï¼Œåœ¨ç»´åŸºç™¾ç§‘å’Œgeohash.orgç½‘ç«™éƒ½æœ‰ç›¸å…³æè¿°</li>
<li>è¿”å›å€¼ï¼šä¸€ä¸ªæ•°ç»„ï¼Œ æ•°ç»„çš„æ¯ä¸ªé¡¹éƒ½æ˜¯ä¸€ä¸ª geohash ã€‚ å‘½ä»¤è¿”å›çš„ geohash çš„ä½ç½®ä¸ç”¨æˆ·ç»™å®šçš„ä½ç½®å…ƒç´ çš„ä½ç½®ä¸€ä¸€å¯¹åº”</li>
<li>å¤æ‚åº¦ï¼šO(log(N)) for each member requested, where N is the number of elements in the sorted set</li>
</ul>
</blockquote>
</li>
<li><p>GEOPOSï¼šè¿”å›æŒ‡å®šmemberçš„åæ ‡</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">GEOPOS key member [member â€¦]</span><br></pre></td></tr></table></figure>
<blockquote>
<ul>
<li>ç»™å®šä¸€ä¸ªsorted setè¡¨ç¤ºçš„ç©ºé—´ç´¢å¼•ï¼Œå¯†é›†ä½¿ç”¨ geoadd å‘½ä»¤ï¼Œå®ƒä»¥è·å¾—æŒ‡å®šæˆå‘˜çš„åæ ‡å¾€å¾€æ˜¯æœ‰ç›Šçš„ã€‚å½“ç©ºé—´ç´¢å¼•å¡«å……é€šè¿‡ geoadd çš„åæ ‡è½¬æ¢æˆä¸€ä¸ª52ä½Geohashï¼Œæ‰€ä»¥è¿”å›çš„åæ ‡å¯èƒ½ä¸å®Œå…¨ä»¥æ·»åŠ å…ƒç´ çš„ï¼Œä½†å°çš„é”™è¯¯å¯èƒ½ä¼šå‡ºå°ã€‚</li>
<li>å› ä¸º GEOPOS å‘½ä»¤æ¥å—å¯å˜æ•°é‡çš„ä½ç½®å…ƒç´ ä½œä¸ºè¾“å…¥ï¼Œ æ‰€ä»¥å³ä½¿ç”¨æˆ·åªç»™å®šäº†ä¸€ä¸ªä½ç½®å…ƒç´ ï¼Œ å‘½ä»¤ä¹Ÿä¼šè¿”å›æ•°ç»„å›å¤</li>
<li>è¿”å›å€¼ï¼šGEOPOS å‘½ä»¤è¿”å›ä¸€ä¸ªæ•°ç»„ï¼Œ æ•°ç»„ä¸­çš„æ¯ä¸ªé¡¹éƒ½ç”±ä¸¤ä¸ªå…ƒç´ ç»„æˆï¼š ç¬¬ä¸€ä¸ªå…ƒç´ ä¸ºç»™å®šä½ç½®å…ƒç´ çš„ç»åº¦ï¼Œ è€Œç¬¬äºŒä¸ªå…ƒç´ åˆ™ä¸ºç»™å®šä½ç½®å…ƒç´ çš„çº¬åº¦ã€‚å½“ç»™å®šçš„ä½ç½®å…ƒç´ ä¸å­˜åœ¨æ—¶ï¼Œ å¯¹åº”çš„æ•°ç»„é¡¹ä¸ºç©ºå€¼</li>
<li>å¤æ‚åº¦ï¼šO(log(N)) for each member requested, where N is the number of elements in the sorted set</li>
</ul>
</blockquote>
</li>
<li><p><strong>GEOGADIUS</strong>ï¼šæŒ‡å®šåœ†å¿ƒã€åŠå¾„ï¼Œæ‰¾åˆ°è¯¥å›­å†…åŒ…å«çš„æ‰€æœ‰memberï¼Œå¹¶æŒ‰ç…§ä¸åœ†å¿ƒä¹‹é—´çš„è·ç¦»æ’åºåè¿”å›ï¼Œ6.2ä¹‹åå·²åºŸå¼ƒ</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">GEORADIUS key longitude latitude radius m|km|ft|mi [WITHCOORD] [WITHDIST] [WITHHASH] </span><br><span class="line">[COUNT count [ANY]] [ASC|DESC] [STORE key] [STOREDIST key]</span><br></pre></td></tr></table></figure>
<blockquote>
<ul>
<li>èŒƒå›´å¯ä»¥ä½¿ç”¨ä»¥ä¸‹å…¶ä¸­ä¸€ä¸ªå•ä½ï¼š <ul>
<li>m è¡¨ç¤ºå•ä½ä¸ºç±³ã€‚</li>
<li>km è¡¨ç¤ºå•ä½ä¸ºåƒç±³ã€‚</li>
<li>mi è¡¨ç¤ºå•ä½ä¸ºè‹±é‡Œã€‚</li>
<li>ft è¡¨ç¤ºå•ä½ä¸ºè‹±å°ºã€‚</li>
</ul>
</li>
<li>åœ¨ç»™å®šä»¥ä¸‹å¯é€‰é¡¹æ—¶ï¼Œ å‘½ä»¤ä¼šè¿”å›é¢å¤–çš„ä¿¡æ¯ï¼š <ul>
<li>WITHDIST: åœ¨è¿”å›ä½ç½®å…ƒç´ çš„åŒæ—¶ï¼Œ å°†ä½ç½®å…ƒç´ ä¸ä¸­å¿ƒä¹‹é—´çš„è·ç¦»ä¹Ÿä¸€å¹¶è¿”å›ã€‚ è·ç¦»çš„å•ä½å’Œç”¨æˆ·ç»™å®šçš„èŒƒå›´å•ä½ä¿æŒä¸€è‡´ã€‚</li>
<li>WITHCOORD: å°†ä½ç½®å…ƒç´ çš„ç»åº¦å’Œç»´åº¦ä¹Ÿä¸€å¹¶è¿”å›ã€‚</li>
<li>WITHHASH: ä»¥ 52 ä½æœ‰ç¬¦å·æ•´æ•°çš„å½¢å¼ï¼Œ è¿”å›ä½ç½®å…ƒç´ ç»è¿‡åŸå§‹ geohash ç¼–ç çš„æœ‰åºé›†åˆåˆ†å€¼ã€‚ è¿™ä¸ªé€‰é¡¹ä¸»è¦ç”¨äºåº•å±‚åº”ç”¨æˆ–è€…è°ƒè¯•ï¼Œ å®é™…ä¸­çš„ä½œç”¨å¹¶ä¸å¤§ã€‚</li>
</ul>
</li>
<li>å‘½ä»¤é»˜è®¤è¿”å›æœªæ’åºçš„ä½ç½®å…ƒç´ ã€‚ é€šè¿‡ä»¥ä¸‹ä¸¤ä¸ªå‚æ•°ï¼Œ ç”¨æˆ·å¯ä»¥æŒ‡å®šè¢«è¿”å›ä½ç½®å…ƒç´ çš„æ’åºæ–¹å¼ï¼š <ul>
<li>ASC: æ ¹æ®ä¸­å¿ƒçš„ä½ç½®ï¼Œ æŒ‰ç…§ä»è¿‘åˆ°è¿œçš„æ–¹å¼è¿”å›ä½ç½®å…ƒç´ ã€‚</li>
<li>DESC: æ ¹æ®ä¸­å¿ƒçš„ä½ç½®ï¼Œ æŒ‰ç…§ä»è¿œåˆ°è¿‘çš„æ–¹å¼è¿”å›ä½ç½®å…ƒç´ ã€‚</li>
</ul>
</li>
<li>åœ¨é»˜è®¤æƒ…å†µä¸‹ï¼Œ GEORADIUS å‘½ä»¤ä¼šè¿”å›æ‰€æœ‰åŒ¹é…çš„ä½ç½®å…ƒç´ ã€‚ è™½ç„¶ç”¨æˆ·å¯ä»¥ä½¿ç”¨ COUNT é€‰é¡¹å»è·å–å‰ N ä¸ªåŒ¹é…å…ƒç´ ï¼Œ ä½†æ˜¯å› ä¸ºå‘½ä»¤åœ¨å†…éƒ¨å¯èƒ½ä¼šéœ€è¦å¯¹æ‰€æœ‰è¢«åŒ¹é…çš„å…ƒç´ è¿›è¡Œå¤„ç†ï¼Œ æ‰€ä»¥åœ¨å¯¹ä¸€ä¸ªéå¸¸å¤§çš„åŒºåŸŸè¿›è¡Œæœç´¢æ—¶ï¼Œ å³ä½¿åªä½¿ç”¨ COUNT é€‰é¡¹å»è·å–å°‘é‡å…ƒç´ ï¼Œ å‘½ä»¤çš„æ‰§è¡Œé€Ÿåº¦ä¹Ÿå¯èƒ½ä¼šéå¸¸æ…¢ã€‚ ä½†æ˜¯ä»å¦ä¸€æ–¹é¢æ¥è¯´ï¼Œ ä½¿ç”¨ COUNT é€‰é¡¹å»å‡å°‘éœ€è¦è¿”å›çš„å…ƒç´ æ•°é‡ï¼Œ å¯¹äºå‡å°‘å¸¦å®½æ¥è¯´ä»ç„¶æ˜¯éå¸¸æœ‰ç”¨çš„</li>
<li>è¿”å›å€¼ï¼š <ul>
<li>åœ¨æ²¡æœ‰ç»™å®šä»»ä½• WITH é€‰é¡¹çš„æƒ…å†µä¸‹ï¼Œ å‘½ä»¤åªä¼šè¿”å›ä¸€ä¸ªåƒ [â€œNew Yorkâ€,â€Milanâ€,â€Parisâ€] è¿™æ ·çš„çº¿æ€§ï¼ˆlinearï¼‰åˆ—è¡¨ã€‚</li>
<li>åœ¨æŒ‡å®šäº† WITHCOORD ã€ WITHDIST ã€ WITHHASH ç­‰é€‰é¡¹çš„æƒ…å†µä¸‹ï¼Œ å‘½ä»¤è¿”å›ä¸€ä¸ªäºŒå±‚åµŒå¥—æ•°ç»„ï¼Œ å†…å±‚çš„æ¯ä¸ªå­æ•°ç»„å°±è¡¨ç¤ºä¸€ä¸ªå…ƒç´ ã€‚</li>
<li>åœ¨è¿”å›åµŒå¥—æ•°ç»„æ—¶ï¼Œ å­æ•°ç»„çš„ç¬¬ä¸€ä¸ªå…ƒç´ æ€»æ˜¯ä½ç½®å…ƒç´ çš„åå­—ã€‚ è‡³äºé¢å¤–çš„ä¿¡æ¯ï¼Œ åˆ™ä¼šä½œä¸ºå­æ•°ç»„çš„åç»­å…ƒç´ ï¼Œ æŒ‰ç…§ä»¥ä¸‹é¡ºåºè¢«è¿”å›ï¼š <ul>
<li>ä»¥æµ®ç‚¹æ•°æ ¼å¼è¿”å›çš„ä¸­å¿ƒä¸ä½ç½®å…ƒç´ ä¹‹é—´çš„è·ç¦»ï¼Œ å•ä½ä¸ç”¨æˆ·æŒ‡å®šèŒƒå›´æ—¶çš„å•ä½ä¸€è‡´ã€‚</li>
</ul>
</li>
</ul>
</li>
</ul>
</blockquote>
</li>
</ul>
<blockquote>
<pre><code>  - geohash æ•´æ•°ã€‚
  - ç”±ä¸¤ä¸ªå…ƒç´ ç»„æˆçš„åæ ‡ï¼Œåˆ†åˆ«ä¸ºç»åº¦å’Œçº¬åº¦
</code></pre>
</blockquote>
<ul>
<li><p><strong>GEOSEARCH</strong>ï¼šåœ¨æŒ‡å®šèŒƒå›´å†…æœç´¢memberï¼Œå¹¶æŒ‰ç…§ä¸åˆ¶å®šç‚¹ä¹‹é—´çš„è·ç¦»æ’åºåè¿”å›ï¼ŒèŒƒå›´å¯ä»¥ä½¿åœ†å½¢æˆ–çŸ©å½¢ï¼Œ6.2çš„æ–°åŠŸèƒ½</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">GEOSEARCH key [FROMMEMBER member] [FROMLONLAT longitude latitude] [BYRADIUS radius m|km|ft|mi] </span><br><span class="line">[BYBOX width height m|km|ft|mi] [ASC|DESC] [COUNT count [ANY]] [WITHCOORD] [WITHDIST] [WITHHASH]</span><br></pre></td></tr></table></figure>
</li>
<li><p>GEOSEARCHSTOREï¼šä¸GEOSEARCHåŠŸèƒ½ä¸€è‡´ï¼Œä¸è¿‡å¯ä»¥æŠŠç»“æœå­˜å‚¨åˆ°ä¸€ä¸ªæŒ‡å®šçš„keyï¼Œä¹Ÿæ˜¯6.2çš„æ–°åŠŸèƒ½</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">GEOSEARCHSTORE destination source [FROMMEMBER member] [FROMLONLAT longitude latitude] </span><br><span class="line">[BYRADIUS radius m|km|ft|mi] [BYBOX width height m|km|ft|mi] </span><br><span class="line">[ASC|DESC] [COUNT count [ANY]] [STOREDIST]</span><br></pre></td></tr></table></figure>
<blockquote>
<ul>
<li>è¿™ä¸ªå‘½ä»¤å’Œ GEORADIUS å‘½ä»¤ä¸€æ ·ï¼Œ éƒ½å¯ä»¥æ‰¾å‡ºä½äºæŒ‡å®šèŒƒå›´å†…çš„å…ƒç´ ï¼Œ ä½†æ˜¯ GEORADIUSBYMEMBER çš„ä¸­å¿ƒç‚¹æ˜¯ç”±ç»™å®šçš„ä½ç½®å…ƒç´ å†³å®šçš„ï¼Œ è€Œä¸æ˜¯åƒ GEORADIUS é‚£æ ·ï¼Œ ä½¿ç”¨è¾“å…¥çš„ç»åº¦å’Œçº¬åº¦æ¥å†³å®šä¸­å¿ƒç‚¹</li>
<li>æŒ‡å®šæˆå‘˜çš„ä½ç½®è¢«ç”¨ä½œæŸ¥è¯¢çš„ä¸­å¿ƒã€‚</li>
<li>å…³äº GEORADIUSBYMEMBER å‘½ä»¤çš„æ›´å¤šä¿¡æ¯ï¼Œ è¯·å‚è€ƒ GEORADIUS å‘½ä»¤çš„æ–‡æ¡£</li>
<li>å¤æ‚åº¦ï¼šO(N+log(M)) where N is the number of elements inside the bounding box of the circular area delimited by center and radius and M is the number of items inside the index</li>
</ul>
</blockquote>
</li>
</ul>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.nlark.com/yuque/0/2023/png/32620241/1679905745055-21f78ee4-cafd-46f5-8afc-9c7a6f3faac0.png#averageHue=%23d9d9d7&clientId=u81ddba6a-6d17-4&from=paste&height=254&id=ua45eb1f1&name=image.png&originHeight=381&originWidth=702&originalType=binary&ratio=1.5&rotation=0&showTitle=false&size=125167&status=done&style=none&taskId=u40913940-bf3a-49c0-a7e1-c4324d394fa&title=&width=468#averageHue=%23d9d9d7&id=WJVFt&originHeight=381&originWidth=702&originalType=binary&ratio=1&rotation=0&showTitle=false&status=done&style=none&title=" alt="image.png"><br><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.nlark.com/yuque/0/2023/png/32620241/1679905938665-a2152d6d-335a-41b6-8605-4eb8c625f405.png#averageHue=%23e3d7d7&clientId=u81ddba6a-6d17-4&from=paste&height=463&id=ufa21e9f1&name=image.png&originHeight=695&originWidth=1405&originalType=binary&ratio=1.5&rotation=0&showTitle=false&size=290918&status=done&style=none&taskId=u6dcfa38b-fd72-4885-8a13-341daf9636a&title=&width=936.6666666666666#averageHue=%23e3d7d7&id=f1xWg&originHeight=695&originWidth=1405&originalType=binary&ratio=1&rotation=0&showTitle=false&status=done&style=none&title=" alt="image.png"></p>
<blockquote>
<ul>
<li>åå°ï¼š <ul>
<li>æŸ¥è¯¢æ‰€æœ‰çš„åº—é“ºä¿¡æ¯</li>
<li>æ ¹æ®ç±»å‹åˆ†ç±»åº—é“º</li>
<li>å°†åº—é“ºçš„éƒ¨åˆ†ä¿¡æ¯ï¼ˆidï¼Œç»çº¬åº¦ï¼‰æŒ‰ç…§åˆ†ç»„å­˜å‚¨åˆ°Redis</li>
</ul>
</li>
</ul>
</blockquote>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">loadShopData</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="comment">//1. æŸ¥è¯¢æ‰€æœ‰åº—é“ºä¿¡æ¯</span></span><br><span class="line">    List&lt;Shop&gt; shopList = shopService.list();</span><br><span class="line">    <span class="comment">//2. æŒ‰ç…§typeIdï¼Œå°†åº—é“ºè¿›è¡Œåˆ†ç»„</span></span><br><span class="line">    Map&lt;Long, List&lt;Shop&gt;&gt; map = shopList.stream().collect(Collectors.groupingBy(Shop::getTypeId));</span><br><span class="line">    <span class="comment">//3. é€ä¸ªå†™å…¥Redis</span></span><br><span class="line">    <span class="keyword">for</span> (Map.Entry&lt;Long, List&lt;Shop&gt;&gt; entry : map.entrySet()) &#123;</span><br><span class="line">        <span class="comment">//3.1 è·å–ç±»å‹id</span></span><br><span class="line">        <span class="type">Long</span> <span class="variable">typeId</span> <span class="operator">=</span> entry.getKey();</span><br><span class="line">        <span class="comment">//3.2 è·å–åŒç±»å‹åº—é“ºçš„é›†åˆ</span></span><br><span class="line">        List&lt;Shop&gt; shops = entry.getValue();</span><br><span class="line">        <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> SHOP_GEO_KEY + typeId;</span><br><span class="line">        <span class="keyword">for</span> (Shop shop : shops) &#123;</span><br><span class="line">            <span class="comment">//3.3 å†™å…¥redis GEOADD key ç»åº¦ çº¬åº¦ member</span></span><br><span class="line">            stringRedisTemplate.opsForGeo().add(key,<span class="keyword">new</span> <span class="title class_">Point</span>(shop.getX(),shop.getY()),shop.getId().toString());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">loadShopData</span><span class="params">()</span> &#123;</span><br><span class="line">    List&lt;Shop&gt; shopList = shopService.list();</span><br><span class="line">    Map&lt;Long, List&lt;Shop&gt;&gt; map = shopList.stream().collect(Collectors.groupingBy(Shop::getTypeId));</span><br><span class="line">    <span class="keyword">for</span> (Map.Entry&lt;Long, List&lt;Shop&gt;&gt; entry : map.entrySet()) &#123;</span><br><span class="line">        <span class="type">Long</span> <span class="variable">typeId</span> <span class="operator">=</span> entry.getKey();</span><br><span class="line">        List&lt;Shop&gt; shops = entry.getValue();</span><br><span class="line">        <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> SHOP_GEO_KEY + typeId;</span><br><span class="line">        <span class="comment">//GeoLocation é‡Œé¢æ˜¯nameå’Œpointä¸¤ä¸ªæ•°æ®ç»“æ„</span></span><br><span class="line">        List&lt;RedisGeoCommands.GeoLocation&lt;String&gt;&gt; locations = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;(shops.size());</span><br><span class="line">        <span class="keyword">for</span> (Shop shop : shops) &#123;</span><br><span class="line">            <span class="comment">//å°†å½“å‰typeçš„å•†é“ºéƒ½æ·»åŠ åˆ°locationsé›†åˆä¸­</span></span><br><span class="line">            locations.add(<span class="keyword">new</span> <span class="title class_">RedisGeoCommands</span>.GeoLocation&lt;&gt;(shop.getId().toString(), <span class="keyword">new</span> <span class="title class_">Point</span>(shop.getX(), shop.getY())));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//æ‰¹é‡å†™å…¥</span></span><br><span class="line">        stringRedisTemplate.opsForGeo().add(key, locations);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="é™„è¿‘åŠŸèƒ½"><a href="#é™„è¿‘åŠŸèƒ½" class="headerlink" title="é™„è¿‘åŠŸèƒ½"></a>é™„è¿‘åŠŸèƒ½</h2><p>éœ€æ±‚ï¼šæŸ¥è¯¢ä½ é™„è¿‘çš„å•†é“ºï¼Œä»¥åŠæ¯ä¸ªå•†é“ºå’Œä½ çš„è·ç¦»ï¼Œå¹¶ä¸”å®‰è£…ç”±è¿‘åŠè¿œæ’åº</p>
<ul>
<li>å¼•å…¥ä¾èµ–:SpringDataRedisçš„2.3.9ç‰ˆæœ¬å¹¶ä¸æ”¯æŒRedis 6.2æä¾›çš„GEOSEARCHå‘½ä»¤ï¼Œå› æ­¤æˆ‘ä»¬éœ€è¦æç¤ºå…¶ç‰ˆæœ¬ï¼Œä¿®æ”¹è‡ªå·±çš„pom.xmlæ–‡ä»¶<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-data-redis<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">exclusions</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">exclusion</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-data-redis<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.data<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">exclusion</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">exclusion</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lettuce-core<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.lettuce<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">exclusion</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">exclusions</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.data<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-data-redis<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.6.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.lettuce<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lettuce-core<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>6.1.6.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure></li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@GetMapping(&quot;/of/type&quot;)</span></span><br><span class="line"><span class="keyword">public</span> Result <span class="title function_">queryShopByType</span><span class="params">(</span></span><br><span class="line"><span class="params">        <span class="meta">@RequestParam(&quot;typeId&quot;)</span> Integer typeId,</span></span><br><span class="line"><span class="params">        <span class="meta">@RequestParam(value = &quot;current&quot;, defaultValue = &quot;1&quot;)</span> Integer current,</span></span><br><span class="line"><span class="params">        <span class="meta">@RequestParam(value = &quot;x&quot;, required = false)</span> Double x,</span></span><br><span class="line"><span class="params">        <span class="meta">@RequestParam(value = &quot;y&quot;, required = false)</span> Double y</span></span><br><span class="line"><span class="params">)</span> &#123;</span><br><span class="line">   <span class="keyword">return</span> shopService.queryShopByType(typeId,current,x,y);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Result <span class="title function_">queryShopByType</span><span class="params">(Integer typeId, Integer current, Double x, Double y)</span> &#123;</span><br><span class="line">        <span class="comment">//1. åˆ¤æ–­æ˜¯å¦éœ€è¦æ ¹æ®è·ç¦»æŸ¥è¯¢</span></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">        * å› ä¸ºè¿™ä¸ªæ¥å£æ˜¯å¤ç”¨çš„ï¼Œx,yå‚æ•°ä¸æ˜¯æ¥å£å¿…é¡»çš„ï¼Œå¦‚æœæ²¡æœ‰è¿™ä¸ªä¸¤ä¸ªå‚æ•°,å°±æ˜¯æŒ‰ç…§çƒ­åº¦æ’åº</span></span><br><span class="line"><span class="comment">        */</span></span><br><span class="line">        <span class="keyword">if</span> (x == <span class="literal">null</span> || y == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="comment">// æ ¹æ®ç±»å‹åˆ†é¡µæŸ¥è¯¢</span></span><br><span class="line">            Page&lt;Shop&gt; page = query()</span><br><span class="line">                .eq(<span class="string">&quot;type_id&quot;</span>, typeId)</span><br><span class="line">                .page(<span class="keyword">new</span> <span class="title class_">Page</span>&lt;&gt;(current, SystemConstants.DEFAULT_PAGE_SIZE));</span><br><span class="line">            <span class="comment">// è¿”å›æ•°æ®</span></span><br><span class="line">            <span class="keyword">return</span> Result.ok(page.getRecords());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//2. è®¡ç®—åˆ†é¡µæŸ¥è¯¢å‚æ•°</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">from</span> <span class="operator">=</span> (current - <span class="number">1</span>) * SystemConstants.MAX_PAGE_SIZE;</span><br><span class="line">        <span class="type">int</span> <span class="variable">end</span> <span class="operator">=</span> current * SystemConstants.MAX_PAGE_SIZE;</span><br><span class="line">        <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> SHOP_GEO_KEY + typeId;</span><br><span class="line">        <span class="comment">//3. æŸ¥è¯¢redisã€æŒ‰ç…§è·ç¦»æ’åºã€åˆ†é¡µ; ç»“æœï¼šshopIdã€distance</span></span><br><span class="line">        <span class="comment">//GEOSEARCH key FROMLONLAT x y BYRADIUS 5000 m WITHDIST LIMIT end</span></span><br><span class="line">        <span class="comment">// å•†å“ç±»å‹ åœ†å¿ƒ åŠå¾„ï¼ˆé»˜è®¤mï¼‰ </span></span><br><span class="line">        GeoResults&lt;RedisGeoCommands.GeoLocation&lt;String&gt;&gt; results = </span><br><span class="line">            stringRedisTemplate.opsForGeo().search(key,GeoReference.fromCoordinate(x, y),</span><br><span class="line"><span class="keyword">new</span> <span class="title class_">Distance</span>(<span class="number">5000</span>),</span><br><span class="line">    RedisGeoCommands.GeoSearchCommandArgs.newGeoSearchArgs().includeDistance().limit(end));</span><br><span class="line">        <span class="keyword">if</span> (results == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> Result.ok(Collections.emptyList());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//4. è§£æå‡ºid</span></span><br><span class="line">        List&lt;GeoResult&lt;RedisGeoCommands.GeoLocation&lt;String&gt;&gt;&gt; list = results.getContent();</span><br><span class="line">        <span class="keyword">if</span> (list.size() &lt; from) &#123;</span><br><span class="line">            <span class="comment">//èµ·å§‹æŸ¥è¯¢ä½ç½®å¤§äºæ•°æ®æ€»é‡ï¼Œåˆ™è¯´æ˜æ²¡æ•°æ®äº†ï¼Œè¿”å›ç©ºé›†åˆ</span></span><br><span class="line">            <span class="keyword">return</span> Result.ok(Collections.emptyList());</span><br><span class="line">        &#125;</span><br><span class="line">        ArrayList&lt;Long&gt; ids = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;(list.size());</span><br><span class="line">        HashMap&lt;String, Distance&gt; distanceMap = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;(list.size());</span><br><span class="line">        <span class="comment">// skipè·³è¿‡å‰from</span></span><br><span class="line">        list.stream().skip(from).forEach(result -&gt; &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">shopIdStr</span> <span class="operator">=</span> result.getContent().getName();</span><br><span class="line">            ids.add(Long.valueOf(shopIdStr));</span><br><span class="line">            <span class="type">Distance</span> <span class="variable">distance</span> <span class="operator">=</span> result.getDistance();</span><br><span class="line">            distanceMap.put(shopIdStr, distance);</span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="comment">//5. æ ¹æ®idæŸ¥è¯¢shop</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">idsStr</span> <span class="operator">=</span> StrUtil.join(<span class="string">&quot;,&quot;</span>, ids);</span><br><span class="line">        List&lt;Shop&gt; shops = query().in(<span class="string">&quot;id&quot;</span>, ids).last(<span class="string">&quot;ORDER BY FIELD( id,&quot;</span> + idsStr + <span class="string">&quot;)&quot;</span>).list();</span><br><span class="line">        <span class="keyword">for</span> (Shop shop : shops) &#123;</span><br><span class="line">            <span class="comment">//è®¾ç½®shopçš„ä¸¾ä¾‹å±æ€§ï¼Œä»distanceMapä¸­æ ¹æ®shopIdæŸ¥è¯¢</span></span><br><span class="line">            shop.setDistance(distanceMap.get(shop.getId().toString()).getValue());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//6. è¿”å›</span></span><br><span class="line">        <span class="keyword">return</span> Result.ok(shops);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<h1 id="BitMap"><a href="#BitMap" class="headerlink" title="BitMap"></a>BitMap</h1><p>å¤šä¸ªäºŒè¿›åˆ¶ä½ç»„æˆçš„æ•°æ®ç»“æ„ï¼Œæ¯ä¸ªäºŒè¿›åˆ¶ä½å¯¹åº”ä¸€ä¸ªä¸šåŠ¡çš„ä¸¤ç§äº’æ–¥çŠ¶æ€ã€‚æ¯”å¦‚: 10010011.<br>BitMap çš„ä¼˜ç‚¹æ˜¯å¯ä»¥ç”¨æœ€å°çš„ä»£ç  (1 ä¸ª bit)æ¥ä¿å­˜ä¸šåŠ¡å«ä¹‰ï¼Œä»è€Œå¤§å¹…èŠ‚çœç©ºé—´ã€å®ç°é«˜æ•ˆè¿ç®—ç­‰ã€‚æ¯”å¦‚å¯ä»¥æŠŠæŸä¸ªäºŒè¿›åˆ¶ä½ä» 0 æ”¹ä¸º 1</p>
<blockquote>
<p>åº•å±‚æ˜¯ string ç±»å‹ï¼Œä»¥å­—èŠ‚ä¸ºå•ä½å­˜å‚¨ï¼Œæ‰€ä»¥ bit çš„é•¿åº¦ä¸º 8 çš„å€æ•°</p>
</blockquote>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.nlark.com/yuque/0/2023/png/32620241/1681817342128-bf9efc40-3cf8-4647-9039-e4cbe737fcff.png#averageHue=%23f1f1f1&clientId=uf387f538-a383-4&from=paste&height=259&id=ue98311ca&originHeight=389&originWidth=888&originalType=binary&ratio=1.5&rotation=0&showTitle=false&size=192225&status=done&style=none&taskId=u7ea54330-8152-40ab-8f98-c4659b696c8&title=&width=592" alt="image.png"></p>
<h2 id="ç­¾åˆ°åŠŸèƒ½"><a href="#ç­¾åˆ°åŠŸèƒ½" class="headerlink" title="ç­¾åˆ°åŠŸèƒ½"></a>ç­¾åˆ°åŠŸèƒ½</h2><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.nlark.com/yuque/0/2023/png/32620241/1679913528034-a60a5d3c-7153-4e6f-81ba-6fa6b6587019.png#averageHue=%23f6f4f4&clientId=u81ddba6a-6d17-4&from=paste&height=197&id=u4725c995&name=image.png&originHeight=295&originWidth=1662&originalType=binary&ratio=1.5&rotation=0&showTitle=false&size=60368&status=done&style=none&taskId=u0626b572-581b-402a-9fb3-0c4ef194ef7&title=&width=1108#averageHue=%23f6f4f4&id=eRvwz&originHeight=295&originWidth=1662&originalType=binary&ratio=1&rotation=0&showTitle=false&status=done&style=none&title=" alt="image.png"></p>
<ul>
<li>BitMapçš„æ“ä½œå‘½ä»¤æœ‰ <ul>
<li>SETBITï¼šå‘æŒ‡å®šä½ç½®ï¼ˆoffsetï¼‰å­˜å…¥ä¸€ä¸ª0æˆ–1</li>
<li>GETBITï¼šè·å–æŒ‡å®šä½ç½®ï¼ˆoffsetï¼‰çš„bitå€¼</li>
<li>BITCOUNTï¼šç»Ÿè®¡BitMapä¸­å€¼ä¸º1çš„bitä½çš„æ•°é‡</li>
<li>BITFIELDï¼šæ“ä½œï¼ˆæŸ¥è¯¢ã€ä¿®æ”¹ã€è‡ªå¢ï¼‰BitMapä¸­bitæ•°ç»„ä¸­çš„æŒ‡å®šä½ç½®ï¼ˆoffsetï¼‰çš„å€¼</li>
<li>BITFIELD_ROï¼šè·å–BitMapä¸­bitæ•°ç»„ï¼Œå¹¶ä»¥åè¿›åˆ¶å½¢å¼è¿”å›</li>
<li>BITOPï¼šå°†å¤šä¸ªBitMapçš„ç»“æœåšä½è¿ç®—ï¼ˆä¸ã€æˆ–ã€å¼‚æˆ–ï¼‰</li>
<li>BITPOSï¼šæŸ¥æ‰¾bitæ•°ç»„ä¸­æŒ‡å®šèŒƒå›´å†…ç¬¬ä¸€ä¸ª0æˆ–1å‡ºç°çš„ä½ç½®</li>
</ul>
</li>
</ul>
<h3 id="åŸºæœ¬å®ç°"><a href="#åŸºæœ¬å®ç°" class="headerlink" title="åŸºæœ¬å®ç°"></a>åŸºæœ¬å®ç°</h3><p>ç”¨ <code>BITSET</code> è®¾ç½®æŸä¸€å¤©å¯¹åº”ä½ç½®çš„ bit å€¼å³å¯ï¼Œéœ€è¦æŸ¥ç­¾åˆ°çŠ¶æ€æ—¶å¯ä»¥ç”¨ <code>BITFIELD GET</code>å–å‡ºæ•´ä¸ª BitMap çš„åè¿›åˆ¶å€¼ï¼Œå†ç”¨ ä½è¿ç®— å°†åè¿›åˆ¶å€¼è½¬ä¸ºä¸šåŠ¡éœ€è¦çš„æ ¼å¼</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> Result <span class="title function_">sign</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">//1. è·å–å½“å‰ç”¨æˆ·</span></span><br><span class="line">    <span class="type">Long</span> <span class="variable">userId</span> <span class="operator">=</span> UserHolder.getUser().getId();</span><br><span class="line">    <span class="comment">//2. è·å–æ—¥æœŸ</span></span><br><span class="line">    <span class="type">LocalDateTime</span> <span class="variable">now</span> <span class="operator">=</span> LocalDateTime.now();</span><br><span class="line">    <span class="comment">//3. æ‹¼æ¥key</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">keySuffix</span> <span class="operator">=</span> now.format(DateTimeFormatter.ofPattern(<span class="string">&quot;:yyyyMM&quot;</span>));</span><br><span class="line">    <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> USER_SIGN_KEY + userId + keySuffix;</span><br><span class="line">    <span class="comment">//4. è·å–ä»Šå¤©æ˜¯å½“æœˆç¬¬å‡ å¤©(1~31)</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">dayOfMonth</span> <span class="operator">=</span> now.getDayOfMonth();</span><br><span class="line">    <span class="comment">//5. å†™å…¥Redis  BITSET key offset 1</span></span><br><span class="line">    stringRedisTemplate.opsForValue().setBit(key, dayOfMonth - <span class="number">1</span>, <span class="literal">true</span>);</span><br><span class="line">    <span class="keyword">return</span> Result.ok();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="ç»Ÿè®¡è¿ç»­ç­¾åˆ°å¤©æ•°"><a href="#ç»Ÿè®¡è¿ç»­ç­¾åˆ°å¤©æ•°" class="headerlink" title="ç»Ÿè®¡è¿ç»­ç­¾åˆ°å¤©æ•°"></a>ç»Ÿè®¡è¿ç»­ç­¾åˆ°å¤©æ•°</h2><p>å¯ä»¥å…ˆç”¨ BITFIELD GET å–å‡ºæ•´ä¸ª BitMap çš„åè¿›åˆ¶å€¼ã€‚ç„¶åå¾ªç¯å³ç§»ï¼Œä¾æ¬¡ç”¨1 å»å’ŒBitMap çš„æœ€åä¸€ä½è¿›è¡Œ<code>ä¸è¿ç®—</code>ï¼Œå³å¯å¾—çŸ¥å½“å‰ä½æ•°æ˜¯å¦ä¸º 1 (å·²ç­¾åˆ°)ï¼Œé…åˆè®¡æ•°å™¨å®Œæˆè¿ç»­ 1çš„ç»Ÿè®¡ã€‚</p>
<ul>
<li>è·å–æœ¬æœˆåˆ°ä»Šå¤©ä¸ºæ­¢çš„æ‰€æœ‰ç­¾åˆ°æ•°æ®</li>
</ul>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">BITFIELD key GET u[dayOfMonth] 0</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"> <span class="comment">//5. è·å–æˆªæ­¢è‡³ä»Šæ—¥çš„ç­¾åˆ°è®°å½•  BITFIELD key GET uDay 0</span></span><br><span class="line">List&lt;Long&gt; result = stringRedisTemplate.opsForValue()</span><br><span class="line">    .bitField(key, BitFieldSubCommands.create()</span><br><span class="line">            .get(BitFieldSubCommands.BitFieldType.unsigned(dayOfMonth))</span><br><span class="line">              .valueAt(<span class="number">0</span>));</span><br><span class="line"><span class="type">Long</span> <span class="variable">num</span> <span class="operator">=</span> result.get(<span class="number">0</span>);</span><br></pre></td></tr></table></figure>

<p>ç¤ºä¾‹ä»£ç ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="type">int</span> <span class="variable">count</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line"><span class="keyword">while</span>(<span class="literal">true</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span>((num &amp; <span class="number">1</span>) == <span class="number">0</span>)</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        count++;</span><br><span class="line">    num &gt;&gt;&gt;= <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> count;</span><br></pre></td></tr></table></figure>
<h1 id="HyperLogLog"><a href="#HyperLogLog" class="headerlink" title="HyperLogLog"></a>HyperLogLog</h1><p>HyperLogLog (HLL) æ˜¯ Redis çš„é«˜çº§æ•°æ®ç»“æ„ï¼Œä½¿ç”¨æ¦‚ç‡å­¦ç®—æ³•å®ç°ï¼Œå¯ä»¥ç”¨æä½çš„å†…å­˜å®ç°ä¸é‡å¤å…ƒç´ ä¸ªæ•°çš„ç»Ÿè®¡ã€‚<br>ç”¨æ³•å’Œé›†åˆç±»ä¼¼ï¼Œæ’å…¥å…ƒç´ ã€æ±‚ä¸é‡å¤å…ƒç´ ä¸ªæ•°ã€åˆå¹¶å¤šä¸ª HLL ç­‰<br>ä¼˜ç‚¹: å ç”¨å†…å­˜æä½ï¼Œä¸ä¼šè¶…è¿‡ 16 Kb<br>ç¼ºç‚¹: åŸºäºæ¦‚ç‡ç»Ÿè®¡ï¼Œå­˜åœ¨&lt; 0.81% çš„è¯¯å·®<br>å› æ­¤ï¼Œå®ƒå¾ˆé€‚åˆç”¨äº UVã€PV ç­‰æ•°æ®é‡å¤§ã€ç²¾åº¦è¦æ±‚ä¸é«˜çš„ç»Ÿè®¡ã€‚</p>
<ul>
<li>HyperLogLog(HLL)æ˜¯ä»Loglogç®—æ³•æ´¾ç”Ÿçš„æ¦‚ç‡ç®—æ³•ï¼Œç”¨æˆ·ç¡®å®šéå¸¸å¤§çš„é›†åˆåŸºæ•°ï¼Œè€Œä¸éœ€è¦å­˜å‚¨å…¶æ‰€æœ‰å€¼ï¼Œç®—æ³•ç›¸å…³åŸç†å¯ä»¥å‚è€ƒä¸‹é¢è¿™ç¯‡æ–‡ç« ï¼š<a target="_blank" rel="noopener" href="https://juejin.cn/post/6844903785744056333#heading-0">https://juejin.cn/post/6844903785744056333#heading-0</a></li>
</ul>
<h2 id="UVç»Ÿè®¡"><a href="#UVç»Ÿè®¡" class="headerlink" title="UVç»Ÿè®¡"></a>UVç»Ÿè®¡</h2><ul>
<li>UVï¼šå…¨ç§°Unique Visitorï¼Œä¹Ÿå«ç‹¬ç«‹è®¿å®¢é‡ï¼Œæ˜¯æŒ‡é€šè¿‡äº’è”ç½‘è®¿é—®ã€æµè§ˆè¿™ä¸ªç½‘é¡µçš„è‡ªç„¶äººã€‚1å¤©å†…åŒä¸€ä¸ªç”¨æˆ·å¤šæ¬¡è®¿é—®è¯¥ç½‘ç«™ï¼Œåªè®°å½•1æ¬¡ã€‚</li>
<li>PVï¼šå…¨ç§°Page Viewï¼Œä¹Ÿå«é¡µé¢è®¿é—®é‡æˆ–ç‚¹å‡»é‡ï¼Œç”¨æˆ·æ¯è®¿é—®ç½‘ç«™çš„ä¸€ä¸ªé¡µé¢ï¼Œè®°å½•1æ¬¡PVï¼Œç”¨æˆ·å¤šæ¬¡æ‰“å¼€é¡µé¢ï¼Œåˆ™è®°å½•å¤šæ¬¡PVã€‚å¾€å¾€ç”¨æ¥è¡¡é‡ç½‘ç«™çš„æµé‡ã€‚</li>
<li>æœ¬åšå®¢çš„é¦–é¡µä¾§è¾¹æ å°±æœ‰æœ¬ç«™è®¿å®¢é‡å’Œæœ¬ç«™æ€»è®¿é—®é‡ï¼Œå¯¹åº”çš„å°±æ˜¯UVå’ŒPV</li>
<li>é€šå¸¸æ¥è¯´PVä¼šæ¯”UVå¤§å¾ˆå¤šï¼Œæ‰€ä»¥è¡¡é‡åŒä¸€ä¸ªç½‘ç«™çš„è®¿é—®é‡ï¼Œæˆ‘ä»¬éœ€è¦ç»¼åˆè€ƒè™‘å¾ˆå¤šå› ç´ ã€‚</li>
<li>UVç»Ÿè®¡åœ¨æœåŠ¡ç«¯åšä¼šå¾ˆéº»çƒ¦ï¼Œå› ä¸ºè¦åˆ¤æ–­è¯¥ç”¨æˆ·æ˜¯å¦å·²ç»ç»Ÿè®¡è¿‡äº†ï¼Œéœ€è¦å°†ç»Ÿè®¡è¿‡çš„ä¿¡æ¯ä¿å­˜ï¼Œä½†æ˜¯å¦‚æœæ¯ä¸ªè®¿é—®çš„ç”¨æˆ·éƒ½ä¿å­˜åˆ°Redisä¸­ï¼Œé‚£ä¹ˆæ•°æ®åº“ä¼šéå¸¸ææ€–ï¼Œé‚£ä¹ˆè¯¥å¦‚ä½•å¤„ç†å‘¢ï¼Ÿ</li>
</ul>
<p>åªéœ€è¦æŠŠç”¨æˆ· id ç”¨PFADD æ·»åŠ åˆ° HLL ä¸­ï¼Œç”¨ PFCOUNT æ±‚å€¼å³å¯: è¿˜å¯ä»¥ç”¨ PFMERGEåˆå¹¶å¤šå¤©çš„ç»Ÿè®¡ï¼Œæ¥ä¼°ç®—æ•´æœˆçš„ UV</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">PFADD key element [element...]</span><br><span class="line">summary: Adds the specified elements to the specified HyperLogLog</span><br><span class="line"></span><br><span class="line">PFCOUNT key [key ...]</span><br><span class="line">Return the approximated cardinality of the set(s) observed by the HyperLogLog at key(s).</span><br><span class="line"></span><br><span class="line">PFMERGE destkey sourcekey [sourcekey ...]</span><br><span class="line">lnternal commands for debugging HyperLogLog values</span><br></pre></td></tr></table></figure>

<p>æµ‹è¯•ç™¾ä¸‡æ•°æ®çš„ç»Ÿè®¡</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testHyperLogLog</span><span class="params">()</span> &#123;</span><br><span class="line">    String[] users = <span class="keyword">new</span> <span class="title class_">String</span>[<span class="number">1000</span>];</span><br><span class="line">    <span class="type">int</span> <span class="variable">j</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">1000000</span>; i++) &#123;</span><br><span class="line">        j = i % <span class="number">1000</span>;</span><br><span class="line">        users[j] = <span class="string">&quot;user_&quot;</span> + i;</span><br><span class="line">        <span class="keyword">if</span> (j == <span class="number">999</span>) &#123;</span><br><span class="line">            stringRedisTemplate.opsForHyperLogLog().add(<span class="string">&quot;HLL&quot;</span>, users);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">Long</span> <span class="variable">count</span> <span class="operator">=</span> stringRedisTemplate.opsForHyperLogLog().size(<span class="string">&quot;HLL&quot;</span>);</span><br><span class="line">    System.out.println(<span class="string">&quot;count = &quot;</span> + count);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</article><div class="post-tools" id="post-tools"><div class="post-tools-left"><div class="rewardLeftButton"><div class="post-reward" onclick="anzhiyu.addRewardMask()"><div class="reward-button button--animated" title="èµèµä½œè€…"><i class="anzhiyufont anzhiyu-icon-hand-heart-fill"></i>æ‰“èµä½œè€…</div><div class="reward-main"><div class="reward-all"><span class="reward-title">æ„Ÿè°¢ä½ èµäºˆæˆ‘å‰è¿›çš„åŠ›é‡</span><ul class="reward-group"><li class="reward-item"><a href="https://npm.elemecdn.com/anzhiyu-blog@1.1.6/img/post/common/qrcode-weichat.png" target="_blank"><img class="post-qr-code-img" src="https://npm.elemecdn.com/anzhiyu-blog@1.1.6/img/post/common/qrcode-weichat.png" alt="wechat"/></a><div class="post-qr-code-desc">wechat</div></li><li class="reward-item"><a href="https://npm.elemecdn.com/anzhiyu-blog@1.1.6/img/post/common/qrcode-alipay.png" target="_blank"><img class="post-qr-code-img" src="https://npm.elemecdn.com/anzhiyu-blog@1.1.6/img/post/common/qrcode-alipay.png" alt="alipay"/></a><div class="post-qr-code-desc">alipay</div></li></ul><a class="reward-main-btn" href="/about/#about-reward" target="_blank"><div class="reward-text">èµèµè€…åå•</div><div class="reward-dec">å› ä¸ºä½ ä»¬çš„æ”¯æŒè®©æˆ‘æ„è¯†åˆ°å†™æ–‡ç« çš„ä»·å€¼ğŸ™</div></a></div></div></div><div id="quit-box" onclick="anzhiyu.removeRewardMask()" style="display: none"></div></div><div class="shareRight"><div class="share-link mobile"><div class="share-qrcode"><div class="share-button" title="ä½¿ç”¨æ‰‹æœºè®¿é—®è¿™ç¯‡æ–‡ç« "><i class="anzhiyufont anzhiyu-icon-qrcode"></i></div><div class="share-main"><div class="share-main-all"><div id="qrcode" title="https://y-yiqi.github.io/posts/6a89.html"></div><div class="reward-dec">ä½¿ç”¨æ‰‹æœºè®¿é—®è¿™ç¯‡æ–‡ç« </div></div></div></div></div><div class="share-link weibo"><a class="share-button" target="_blank" href="https://service.weibo.com/share/share.php?title=Redis&amp;url=https://y-yiqi.github.io/posts/6a89.html&amp;pic=/img/default_cover.jpg" rel="external nofollow noreferrer noopener"><i class="anzhiyufont anzhiyu-icon-weibo"></i></a></div><div class="share-link copyurl"><div class="share-button" id="post-share-url" title="å¤åˆ¶é“¾æ¥" onclick="rm.copyPageUrl()"><i class="anzhiyufont anzhiyu-icon-link"></i></div></div></div></div><div class="post-tools-right"><div class="tag_share"><div class="post-meta__box"><div class="post-meta__box__tag-list"><a class="post-meta__box__tags" href="/tags/Java/"><span class="tags-punctuation"> <i class="anzhiyufont anzhiyu-icon-tag"></i></span>Java<span class="tagsPageCount">4</span></a><a class="post-meta__box__tags" href="/tags/Redis/"><span class="tags-punctuation"> <i class="anzhiyufont anzhiyu-icon-tag"></i></span>Redis<span class="tagsPageCount">1</span></a></div></div></div><div class="post_share"><div class="social-share" data-image="/img/default_cover.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://npm.elemecdn.com/butterfly-extsrc@1.1.3/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"/><script src="https://npm.elemecdn.com/butterfly-extsrc@1.1.3/sharejs/dist/js/social-share.min.js" defer="defer"></script></div></div></div><div class="post-copyright"><i class="anzhiyufont anzhiyu-icon-copyright"></i><div class="post-copyright__author"><a class="post-copyright__original" title="è¯¥æ–‡ç« ä¸ºåŸåˆ›æ–‡ç« ï¼Œæ³¨æ„ç‰ˆæƒåè®®" href="https://y-yiqi.github.io/posts/6a89.html">åŸåˆ›</a><a class="post-copyright-title"><span>Redis</span></a></div><div class="post-copyright-info-box"><span class="post-copyright-meta">æ–‡ç« ä½œè€…: </span><span class="post-copyright-info"></span><a class="link" href="https://y-yiqi.github.io">å¥•ä¸ƒ</a></div><div class="post-copyright__type"><span class="post-copyright-meta">æ–‡ç« é“¾æ¥: </span><span class="post-copyright-info"><a class="link" href="https://y-yiqi.github.io/posts/6a89.html">https://y-yiqi.github.io/posts/6a89.html</a></span><span class="copy-button" onclick="rm.copyPageUrl()"><i class="anzhiyufont anzhiyu-icon-copy"></i></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">ç‰ˆæƒå£°æ˜: </span><span class="post-copyright-info">æœ¬åšå®¢æ‰€æœ‰æ–‡ç« é™¤ç‰¹åˆ«å£°æ˜å¤–ï¼Œå‡é‡‡ç”¨ <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> è®¸å¯åè®®ã€‚è½¬è½½è¯·æ³¨æ˜æ¥è‡ª <a href="https://y-yiqi.github.io" target="_blank">å¥•ä¸ƒ</a>ï¼</span></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/posts/43de.html"><img class="prev-cover" src="/img/default_cover.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">ä¸Šä¸€ç¯‡</div><div class="prev_info">JVM</div></div></a></div><div class="next-post pull-right"><a href="/posts/c44e.html"><img class="next-cover" src="/img/default_cover.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">ä¸‹ä¸€ç¯‡</div><div class="next_info">è®¾è®¡æ¨¡å¼ç®€ä»‹</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="anzhiyufont anzhiyu-icon-thumbs-up fa-fw" style="font-size: 1.5rem; margin-right: 4px"></i><span>ç›¸å…³æ¨è</span></div><div class="relatedPosts-list"><div><a href="/posts/43de.html" title="JVM"><img class="cover" src="/img/default_cover.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="anzhiyufont anzhiyu-icon-calendar-days fa-fw"></i> 2020-01-31</div><div class="title">JVM</div></div></a></div><div><a href="/posts/5ea3.html" title="å¤šçº¿ç¨‹"><img class="cover" src="/img/default_cover.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="anzhiyufont anzhiyu-icon-calendar-days fa-fw"></i> 2020-01-23</div><div class="title">å¤šçº¿ç¨‹</div></div></a></div><div><a href="/posts/c44e.html" title="è®¾è®¡æ¨¡å¼ç®€ä»‹"><img class="cover" src="/img/default_cover.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="anzhiyufont anzhiyu-icon-calendar-days fa-fw"></i> 2020-03-23</div><div class="title">è®¾è®¡æ¨¡å¼ç®€ä»‹</div></div></a></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="author-info-top"> <div class="card-info-avatar"><div class="author-status-box"><div class="author-status"><g-emoji class="g-emoji" alias="writing_hand" fallback-src="https://github.githubassets.com/images/icons/emoji/unicode/270d.png">âœï¸</g-emoji><span>on Studying</span></div></div></div></div><div class="author-info__sayhi" id="author-info__sayhi"></div><h1 class="author-info__name">å¥•ä¸ƒ</h1><div class="author-info__description"></div><div class="banner-button-group"><a class="banner-button" onclick="pjax.loadUrl(&quot;/about/&quot;)"><span class="banner-button-text">äº†è§£æ›´å¤š</span><i class="anzhiyufont anzhiyu-icon-arrow-circle-right" style="font-size: 1.5rem"></i></a></div><div class="card-info-social-icons is-center"><a class="social-icon faa-parent animated-hover" href="https://github.com/l-yiqi" target="_blank" title="Github"><i class="anzhiyufont anzhiyu-icon-github"></i></a><a class="social-icon faa-parent animated-hover" href="mailto:2392889869@qq.com" target="_blank" title="Email"><i class="anzhiyufont anzhiyu-icon-envelope"></i></a></div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-bars"></i><span>æ–‡ç« ç›®å½•</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#Redis%E5%85%A5%E9%97%A8"><span class="toc-number">1.</span> <span class="toc-text">Rediså…¥é—¨</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%AE%80%E4%BB%8B"><span class="toc-number">1.1.</span> <span class="toc-text">ç®€ä»‹</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%85%B3%E7%B3%BB%E5%9E%8BSQL%E5%92%8CNoSQL%E5%AF%B9%E6%AF%94"><span class="toc-number">1.1.1.</span> <span class="toc-text">å…³ç³»å‹SQLå’ŒNoSQLå¯¹æ¯”</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Redis%E7%89%B9%E5%BE%81"><span class="toc-number">1.1.2.</span> <span class="toc-text">Redisç‰¹å¾</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%9F%BA%E6%9C%AC%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B"><span class="toc-number">2.</span> <span class="toc-text">åŸºæœ¬æ•°æ®ç±»å‹</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%AE%80%E4%BB%8B-1"><span class="toc-number">2.1.</span> <span class="toc-text">ç®€ä»‹</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#String"><span class="toc-number">2.2.</span> <span class="toc-text">String</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Hash"><span class="toc-number">2.3.</span> <span class="toc-text">Hash</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#List"><span class="toc-number">2.4.</span> <span class="toc-text">List</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Set"><span class="toc-number">2.5.</span> <span class="toc-text">Set</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Sorted-Set"><span class="toc-number">2.6.</span> <span class="toc-text">Sorted Set</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%85%B1%E4%BA%ABSession%EF%BC%88%E5%8D%95%E7%82%B9%E7%99%BB%E5%BD%95%EF%BC%89"><span class="toc-number">3.</span> <span class="toc-text">å…±äº«Sessionï¼ˆå•ç‚¹ç™»å½•ï¼‰</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BB%8B%E7%BB%8D"><span class="toc-number">3.1.</span> <span class="toc-text">ä»‹ç»</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0"><span class="toc-number">3.2.</span> <span class="toc-text">å®ç°</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%AE%BE%E8%AE%A1key"><span class="toc-number">3.2.1.</span> <span class="toc-text">è®¾è®¡key</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%80%89%E5%8F%96%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84"><span class="toc-number">3.2.2.</span> <span class="toc-text">é€‰å–æ•°æ®ç»“æ„</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%85%B7%E4%BD%93%E6%B5%81%E7%A8%8B%EF%BC%88%E9%87%87%E7%94%A8string%EF%BC%89"><span class="toc-number">3.2.3.</span> <span class="toc-text">å…·ä½“æµç¨‹ï¼ˆé‡‡ç”¨stringï¼‰</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%A1%A5%E5%85%85"><span class="toc-number">3.2.4.</span> <span class="toc-text">è¡¥å……</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%BC%93%E5%AD%98"><span class="toc-number">4.</span> <span class="toc-text">ç¼“å­˜</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%AE%80%E4%BB%8B-2"><span class="toc-number">4.1.</span> <span class="toc-text">ç®€ä»‹</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0-1"><span class="toc-number">4.2.</span> <span class="toc-text">å®ç°</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BC%93%E5%AD%98%E6%9B%B4%E6%96%B0"><span class="toc-number">4.2.1.</span> <span class="toc-text">ç¼“å­˜æ›´æ–°</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%A0%B8%E5%BF%83%E6%A6%82%E5%BF%B5"><span class="toc-number">4.3.</span> <span class="toc-text">æ ¸å¿ƒæ¦‚å¿µ</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%BC%93%E5%AD%98%E7%A9%BF%E9%80%8F"><span class="toc-number">4.4.</span> <span class="toc-text">ç¼“å­˜ç©¿é€</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%BC%93%E5%AD%98%E9%9B%AA%E5%B4%A9"><span class="toc-number">4.5.</span> <span class="toc-text">ç¼“å­˜é›ªå´©</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%BC%93%E5%AD%98%E5%87%BB%E7%A9%BF"><span class="toc-number">4.6.</span> <span class="toc-text">ç¼“å­˜å‡»ç©¿</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BA%92%E6%96%A5%E9%94%81"><span class="toc-number">4.6.1.</span> <span class="toc-text">äº’æ–¥é”</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%80%BB%E8%BE%91%E8%BF%87%E6%9C%9F"><span class="toc-number">4.6.2.</span> <span class="toc-text">é€»è¾‘è¿‡æœŸ</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%B0%81%E8%A3%85Redis%E5%B7%A5%E5%85%B7%E7%B1%BB"><span class="toc-number">4.7.</span> <span class="toc-text">å°è£…Rediså·¥å…·ç±»</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%8C%E6%95%B4%E4%BB%A3%E7%A0%81"><span class="toc-number">4.7.1.</span> <span class="toc-text">å®Œæ•´ä»£ç </span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%88%86%E5%B8%83%E5%BC%8F%E5%85%A8%E5%B1%80id%E7%94%9F%E6%88%90"><span class="toc-number">5.</span> <span class="toc-text">åˆ†å¸ƒå¼å…¨å±€idç”Ÿæˆ</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%AE%BE%E8%AE%A1%E5%AE%9E%E7%8E%B0"><span class="toc-number">5.1.</span> <span class="toc-text">è®¾è®¡å®ç°</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%A7%92%E6%9D%80"><span class="toc-number">6.</span> <span class="toc-text">ç§’æ€</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%B6%85%E5%8D%96%E9%97%AE%E9%A2%98"><span class="toc-number">6.1.</span> <span class="toc-text">è¶…å–é—®é¢˜</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%A7%A3%E5%86%B3%E6%96%B9%E6%B3%95"><span class="toc-number">6.1.1.</span> <span class="toc-text">è§£å†³æ–¹æ³•</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%B8%80%E4%BA%BA%E4%B8%80%E5%8D%95"><span class="toc-number">7.</span> <span class="toc-text">ä¸€äººä¸€å•</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8D%95%E6%9C%BA%E5%AE%9E%E7%8E%B0"><span class="toc-number">7.1.</span> <span class="toc-text">å•æœºå®ç°</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%86%E5%B8%83%E5%BC%8F%E5%AE%9E%E7%8E%B0"><span class="toc-number">7.2.</span> <span class="toc-text">åˆ†å¸ƒå¼å®ç°</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81"><span class="toc-number">7.3.</span> <span class="toc-text">åˆ†å¸ƒå¼é”</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0%E6%96%B9%E5%BC%8F"><span class="toc-number">7.3.1.</span> <span class="toc-text">å®ç°æ–¹å¼</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Redis%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81%E5%AE%9E%E7%8E%B0"><span class="toc-number">7.3.2.</span> <span class="toc-text">Redisåˆ†å¸ƒå¼é”å®ç°</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81%E8%AF%AF%E5%88%A0%E6%83%85%E5%86%B5"><span class="toc-number">7.3.3.</span> <span class="toc-text">åˆ†å¸ƒå¼é”è¯¯åˆ æƒ…å†µ</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%83%85%E5%86%B51"><span class="toc-number">7.3.3.1.</span> <span class="toc-text">æƒ…å†µ1</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%83%85%E5%86%B52-%E5%8E%9F%E5%AD%90%E6%80%A7%E9%97%AE%E9%A2%98"><span class="toc-number">7.3.3.2.</span> <span class="toc-text">æƒ…å†µ2-åŸå­æ€§é—®é¢˜</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81-Redisson"><span class="toc-number">8.</span> <span class="toc-text">åˆ†å¸ƒå¼é”-Redisson</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81-redission%E5%8A%9F%E8%83%BD%E4%BB%8B%E7%BB%8D"><span class="toc-number">8.1.</span> <span class="toc-text">åˆ†å¸ƒå¼é”-redissionåŠŸèƒ½ä»‹ç»</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%85%A5%E9%97%A8"><span class="toc-number">8.1.1.</span> <span class="toc-text">å…¥é—¨</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8F%AF%E9%87%8D%E5%85%A5%E5%8E%9F%E7%90%86"><span class="toc-number">8.1.2.</span> <span class="toc-text">å¯é‡å…¥åŸç†</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%A6%82%E4%BD%95%E9%87%8D%E8%AF%95%E8%8E%B7%E5%8F%96%E9%94%81"><span class="toc-number">8.1.3.</span> <span class="toc-text">å¦‚ä½•é‡è¯•è·å–é”</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%A6%82%E4%BD%95%E9%98%B2%E6%AD%A2%E9%94%81%E6%8F%90%E5%89%8D%E8%B6%85%E6%97%B6%E9%87%8A%E6%94%BE"><span class="toc-number">8.1.4.</span> <span class="toc-text">å¦‚ä½•é˜²æ­¢é”æå‰è¶…æ—¶é‡Šæ”¾</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%A6%82%E4%BD%95%E8%A7%A3%E5%86%B3%E4%B8%BB%E4%BB%8E%E4%B8%80%E8%87%B4%E6%80%A7%E9%97%AE%E9%A2%98"><span class="toc-number">8.2.</span> <span class="toc-text">å¦‚ä½•è§£å†³ä¸»ä»ä¸€è‡´æ€§é—®é¢˜</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%A7%92%E6%9D%80%E4%B8%9A%E5%8A%A1%E4%BC%98%E5%8C%96"><span class="toc-number">8.3.</span> <span class="toc-text">ç§’æ€ä¸šåŠ¡ä¼˜åŒ–</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0-2"><span class="toc-number">8.3.1.</span> <span class="toc-text">å®ç°</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9F%BA%E4%BA%8E%E9%98%BB%E5%A1%9E%E9%98%9F%E5%88%97%E5%AE%9E%E7%8E%B0%E7%A7%92%E6%9D%80%E4%BC%98%E5%8C%96"><span class="toc-number">8.3.2.</span> <span class="toc-text">åŸºäºé˜»å¡é˜Ÿåˆ—å®ç°ç§’æ€ä¼˜åŒ–</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97"><span class="toc-number">9.</span> <span class="toc-text">æ¶ˆæ¯é˜Ÿåˆ—</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%97%AE%E9%A2%98"><span class="toc-number">9.1.</span> <span class="toc-text">é—®é¢˜</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BB%80%E4%B9%88%E6%98%AF%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97"><span class="toc-number">9.2.</span> <span class="toc-text">ä»€ä¹ˆæ˜¯æ¶ˆæ¯é˜Ÿåˆ—</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0%E6%96%B9%E5%BC%8F-1"><span class="toc-number">9.3.</span> <span class="toc-text">å®ç°æ–¹å¼</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#List-1"><span class="toc-number">9.3.1.</span> <span class="toc-text">List</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Pub-x2F-Sub"><span class="toc-number">9.4.</span> <span class="toc-text">Pub&#x2F;Sub</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Stream"><span class="toc-number">10.</span> <span class="toc-text">Stream</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%A0%B8%E5%BF%83%E5%91%BD%E4%BB%A4"><span class="toc-number">10.1.</span> <span class="toc-text">æ ¸å¿ƒå‘½ä»¤</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8F%91%E9%80%81%E6%B6%88%E6%81%AF"><span class="toc-number">10.1.1.</span> <span class="toc-text">å‘é€æ¶ˆæ¯</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%AF%BB%E5%8F%96%E6%B6%88%E6%81%AF"><span class="toc-number">10.1.2.</span> <span class="toc-text">è¯»å–æ¶ˆæ¯</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9F%BA%E4%BA%8EStream%E7%9A%84%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97-%E6%B6%88%E8%B4%B9%E8%80%85%E7%BB%84"><span class="toc-number">10.2.</span> <span class="toc-text">åŸºäºStreamçš„æ¶ˆæ¯é˜Ÿåˆ—-æ¶ˆè´¹è€…ç»„</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0-3"><span class="toc-number">10.2.1.</span> <span class="toc-text">å®ç°</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ID-%E8%8E%B7%E5%8F%96%E6%B6%88%E6%81%AF%E7%9A%84%E8%B5%B7%E5%A7%8BID"><span class="toc-number">10.3.</span> <span class="toc-text">ID-  è·å–æ¶ˆæ¯çš„èµ·å§‹ID </span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0%E5%BC%82%E6%AD%A5%E4%B8%8B%E5%8D%95"><span class="toc-number">10.3.1.</span> <span class="toc-text">å®ç°å¼‚æ­¥ä¸‹å•</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link"><span class="toc-number">11.</span> <span class="toc-text"></span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%82%B9%E8%B5%9E"><span class="toc-number">12.</span> <span class="toc-text">ç‚¹èµ</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%8E%92%E8%A1%8C%E6%A6%9C"><span class="toc-number">13.</span> <span class="toc-text">æ’è¡Œæ¦œ</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%85%B1%E5%90%8C%E5%85%B3%E6%B3%A8"><span class="toc-number">14.</span> <span class="toc-text">å…±åŒå…³æ³¨</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Feed%E6%B5%81%E5%85%B3%E6%B3%A8%E6%8E%A8%E9%80%81"><span class="toc-number">15.</span> <span class="toc-text">Feedæµå…³æ³¨æ¨é€</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0%E6%96%B9%E6%A1%88"><span class="toc-number">15.1.</span> <span class="toc-text">å®ç°æ–¹æ¡ˆ</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%8B%89%E6%A8%A1%E5%BC%8F%EF%BC%88%E8%AF%BB%E6%89%A9%E6%95%A3%EF%BC%89"><span class="toc-number">15.1.1.</span> <span class="toc-text">æ‹‰æ¨¡å¼ï¼ˆè¯»æ‰©æ•£ï¼‰</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%8E%A8%E6%A8%A1%E5%BC%8F"><span class="toc-number">15.1.2.</span> <span class="toc-text">æ¨æ¨¡å¼</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%8E%A8%E6%8B%89%E7%BB%93%E5%90%88"><span class="toc-number">15.1.3.</span> <span class="toc-text">æ¨æ‹‰ç»“åˆ</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AF%B9%E6%AF%94"><span class="toc-number">15.1.4.</span> <span class="toc-text">å¯¹æ¯”</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%8E%A8%E6%A8%A1%E5%BC%8F%E5%AE%9E%E7%8E%B0"><span class="toc-number">15.2.</span> <span class="toc-text">æ¨æ¨¡å¼å®ç°</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%86%E9%A1%B5%E9%97%AE%E9%A2%98"><span class="toc-number">15.2.1.</span> <span class="toc-text">åˆ†é¡µé—®é¢˜</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0%E5%88%86%E9%A1%B5%E6%9F%A5%E8%AF%A2%E6%94%B6%E4%BB%B6%E7%AE%B1"><span class="toc-number">15.3.</span> <span class="toc-text">å®ç°åˆ†é¡µæŸ¥è¯¢æ”¶ä»¶ç®±</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#GEO%E5%9C%B0%E7%90%86%E5%9D%90%E6%A0%87%E8%AE%A1%E7%AE%97"><span class="toc-number">16.</span> <span class="toc-text">GEOåœ°ç†åæ ‡è®¡ç®—</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#GEO%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B"><span class="toc-number">16.1.</span> <span class="toc-text">GEOæ•°æ®ç±»å‹</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%99%84%E8%BF%91%E5%8A%9F%E8%83%BD"><span class="toc-number">16.2.</span> <span class="toc-text">é™„è¿‘åŠŸèƒ½</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#BitMap"><span class="toc-number">17.</span> <span class="toc-text">BitMap</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%AD%BE%E5%88%B0%E5%8A%9F%E8%83%BD"><span class="toc-number">17.1.</span> <span class="toc-text">ç­¾åˆ°åŠŸèƒ½</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9F%BA%E6%9C%AC%E5%AE%9E%E7%8E%B0"><span class="toc-number">17.1.1.</span> <span class="toc-text">åŸºæœ¬å®ç°</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%BB%9F%E8%AE%A1%E8%BF%9E%E7%BB%AD%E7%AD%BE%E5%88%B0%E5%A4%A9%E6%95%B0"><span class="toc-number">17.2.</span> <span class="toc-text">ç»Ÿè®¡è¿ç»­ç­¾åˆ°å¤©æ•°</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#HyperLogLog"><span class="toc-number">18.</span> <span class="toc-text">HyperLogLog</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#UV%E7%BB%9F%E8%AE%A1"><span class="toc-number">18.1.</span> <span class="toc-text">UVç»Ÿè®¡</span></a></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-history"></i><span>æœ€æ–°æ–‡ç« </span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/posts/c44e.html" title="è®¾è®¡æ¨¡å¼ç®€ä»‹"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/img/default_cover.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="è®¾è®¡æ¨¡å¼ç®€ä»‹"/></a><div class="content"><a class="title" href="/posts/c44e.html" title="è®¾è®¡æ¨¡å¼ç®€ä»‹">è®¾è®¡æ¨¡å¼ç®€ä»‹</a><time datetime="2020-03-23T09:09:13.000Z" title="å‘è¡¨äº 2020-03-23 17:09:13">2020-03-23</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/6a89.html" title="Redis"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/img/default_cover.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Redis"/></a><div class="content"><a class="title" href="/posts/6a89.html" title="Redis">Redis</a><time datetime="2020-02-23T09:09:13.000Z" title="å‘è¡¨äº 2020-02-23 17:09:13">2020-02-23</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/43de.html" title="JVM"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/img/default_cover.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="JVM"/></a><div class="content"><a class="title" href="/posts/43de.html" title="JVM">JVM</a><time datetime="2020-01-31T09:09:13.000Z" title="å‘è¡¨äº 2020-01-31 17:09:13">2020-01-31</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/5ea3.html" title="å¤šçº¿ç¨‹"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/img/default_cover.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="å¤šçº¿ç¨‹"/></a><div class="content"><a class="title" href="/posts/5ea3.html" title="å¤šçº¿ç¨‹">å¤šçº¿ç¨‹</a><time datetime="2020-01-23T09:09:13.000Z" title="å‘è¡¨äº 2020-01-23 17:09:13">2020-01-23</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2023 By å¥•ä¸ƒ</div><p id="ghbdages"><a class="github-badge" target="_blank" href="https://hexo.io/" style="margin-inline:5px" data-title="åšå®¢æ¡†æ¶ä¸ºHexo_v5.4.0" title="åšå®¢æ¡†æ¶ä¸ºHexo_v5.4.0"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://npm.elemecdn.com/anzhiyu-blog@2.1.5/img/badge/Frame-Hexo.svg" alt="åšå®¢æ¡†æ¶ä¸ºHexo_v5.4.0"/></a><a class="github-badge" target="_blank" href="https://anzhiy.cn/" style="margin-inline:5px" data-title="æœ¬ç«™ä½¿ç”¨AnZhiYuä¸»é¢˜" title="æœ¬ç«™ä½¿ç”¨AnZhiYuä¸»é¢˜"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://npm.elemecdn.com/anzhiyu-theme-static@1.0.9/img/Theme-AnZhiYu-2E67D3.svg" alt="æœ¬ç«™ä½¿ç”¨AnZhiYuä¸»é¢˜"/></a><a class="github-badge" target="_blank" href="https://www.dogecloud.com/" style="margin-inline:5px" data-title="æœ¬ç«™ä½¿ç”¨å¤šå‰äº‘ä¸ºé™æ€èµ„æºæä¾›CDNåŠ é€Ÿ" title="æœ¬ç«™ä½¿ç”¨å¤šå‰äº‘ä¸ºé™æ€èµ„æºæä¾›CDNåŠ é€Ÿ"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://npm.elemecdn.com/anzhiyu-blog@2.2.0/img/badge/CDN-å¤šå‰äº‘-3693F3.svg" alt="æœ¬ç«™ä½¿ç”¨å¤šå‰äº‘ä¸ºé™æ€èµ„æºæä¾›CDNåŠ é€Ÿ"/></a><a class="github-badge" target="_blank" href="https://github.com/" style="margin-inline:5px" data-title="æœ¬ç«™é¡¹ç›®ç”±Githubæ‰˜ç®¡" title="æœ¬ç«™é¡¹ç›®ç”±Githubæ‰˜ç®¡"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://npm.elemecdn.com/anzhiyu-blog@2.1.5/img/badge/Source-Github.svg" alt="æœ¬ç«™é¡¹ç›®ç”±Githubæ‰˜ç®¡"/></a><a class="github-badge" target="_blank" href="http://creativecommons.org/licenses/by-nc-sa/4.0/" style="margin-inline:5px" data-title="æœ¬ç«™é‡‡ç”¨çŸ¥è¯†å…±äº«ç½²å-éå•†ä¸šæ€§ä½¿ç”¨-ç›¸åŒæ–¹å¼å…±äº«4.0å›½é™…è®¸å¯åè®®è¿›è¡Œè®¸å¯" title="æœ¬ç«™é‡‡ç”¨çŸ¥è¯†å…±äº«ç½²å-éå•†ä¸šæ€§ä½¿ç”¨-ç›¸åŒæ–¹å¼å…±äº«4.0å›½é™…è®¸å¯åè®®è¿›è¡Œè®¸å¯"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://npm.elemecdn.com/anzhiyu-blog@2.2.0/img/badge/Copyright-BY-NC-SA.svg" alt="æœ¬ç«™é‡‡ç”¨çŸ¥è¯†å…±äº«ç½²å-éå•†ä¸šæ€§ä½¿ç”¨-ç›¸åŒæ–¹å¼å…±äº«4.0å›½é™…è®¸å¯åè®®è¿›è¡Œè®¸å¯"/></a></p></div></footer></div><div id="loading-box" onclick="document.getElementById(&quot;loading-box&quot;).classList.add(&quot;loaded&quot;)"><div class="loading-bg"><img class="loading-img nolazyload" alt="åŠ è½½å¤´åƒ" src="data:image/jpeg;base64,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"/><div class="loading-image-dot"></div><div id="loading-percentage">0%</div></div></div><script>const loadingPercentage = document.getElementById("loading-percentage");
let loadingPercentageTimer = setInterval(function() {
  var progressBar = document.querySelector(".pace-progress");
  if (!progressBar) return
  var currentValue = progressBar.getAttribute("data-progress-text");
  if (currentValue !== loadingPercentage.textContent) {
    loadingPercentage.textContent = currentValue;
    if (currentValue === "100%") {
      clearInterval(loadingPercentageTimer);
    }
  }
}, 100);
const preloader = {
  endLoading: () => {
    document.body.style.overflow = 'auto';
    document.getElementById('loading-box').classList.add("loaded")
    Pace.restart()
  },
  initLoading: () => {
    document.body.style.overflow = '';
    document.getElementById('loading-box').classList.remove("loaded")
  }
}
window.addEventListener('load',()=> { preloader.endLoading() })

if (true) {
  document.addEventListener('pjax:send', () => { preloader.initLoading() })
  document.addEventListener('pjax:complete', () => { preloader.endLoading() })
}</script><link rel="stylesheet" href="https://npm.elemecdn.com/anzhiyu-theme-static@1.0.0/progress_bar/progress_bar.css"/><script async="async" src="https://npm.elemecdn.com/pace-js@1.2.4/pace.min.js" data-pace-options="{ &quot;restartOnRequestAfter&quot;:false,&quot;eventLag&quot;:false}"></script><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://bu.dusays.com/2023/04/27/64496e511b09c.jpg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/" title="archive"><div class="headline">æ–‡ç« </div><div class="length-num">4</div></a><a href="/tags/" title="tag"><div class="headline">æ ‡ç­¾</div><div class="length-num">5</div></a><a href="/categories/" title="category"><div class="headline">åˆ†ç±»</div><div class="length-num">1</div></a></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page faa-parent animated-hover" href="javascript:void(0);"><span> æ–‡ç« </span></a><ul class="menus_item_child" style="left:-79px;"><li><a class="site-page child faa-parent animated-hover" href="/archives/"><i class="anzhiyufont anzhiyu-icon-box-archive faa-tada" style="font-size: 0.9em;"></i><span> éš§é“</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/categories/"><i class="anzhiyufont anzhiyu-icon-shapes faa-tada" style="font-size: 0.9em;"></i><span> åˆ†ç±»</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/tags/"><i class="anzhiyufont anzhiyu-icon-tags faa-tada" style="font-size: 0.9em;"></i><span> æ ‡ç­¾</span></a></li></ul></div><div class="menus_item"><a class="site-page faa-parent animated-hover" href="javascript:void(0);"><span> å‹é“¾</span></a><ul class="menus_item_child" style="left:-31px;"><li><a class="site-page child faa-parent animated-hover" href="/link/"><i class="anzhiyufont anzhiyu-icon-link faa-tada" style="font-size: 0.9em;"></i><span> å‹äººå¸</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/comments/"><i class="anzhiyufont anzhiyu-icon-envelope faa-tada" style="font-size: 0.9em;"></i><span> ç•™è¨€æ¿</span></a></li></ul></div><div class="menus_item"><a class="site-page faa-parent animated-hover" href="javascript:void(0);"><span> æˆ‘çš„</span></a><ul class="menus_item_child" style="left:-79px;"><li><a class="site-page child faa-parent animated-hover" href="/music/?id=7451835303&amp;server=tencent"><i class="anzhiyufont anzhiyu-icon-music faa-tada" style="font-size: 0.9em;"></i><span> éŸ³ä¹é¦†</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/album/"><i class="anzhiyufont anzhiyu-icon-images faa-tada" style="font-size: 0.9em;"></i><span> ç›¸å†Œé›†</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/air-conditioner/"><i class="anzhiyufont anzhiyu-icon-fan faa-tada" style="font-size: 0.9em;"></i><span> å°ç©ºè°ƒ</span></a></li></ul></div><div class="menus_item"><a class="site-page faa-parent animated-hover" href="javascript:void(0);"><span> å…³äº</span></a><ul class="menus_item_child" style="left:-79px;"><li><a class="site-page child faa-parent animated-hover" href="/about/"><i class="anzhiyufont anzhiyu-icon-paper-plane faa-tada" style="font-size: 0.9em;"></i><span> å…³äºæœ¬äºº</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/essay/"><i class="anzhiyufont anzhiyu-icon-lightbulb faa-tada" style="font-size: 0.9em;"></i><span> é—²è¨€ç¢è¯­</span></a></li><li><a class="site-page child faa-parent animated-hover" href="javascript:toRandomPost()"><i class="anzhiyufont anzhiyu-icon-shoe-prints1 faa-tada" style="font-size: 0.9em;"></i><span> éšä¾¿é€›é€›</span></a></li></ul></div></div></div></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="é˜…è¯»æ¨¡å¼"><i class="anzhiyufont anzhiyu-icon-book-open"></i></button><button id="translateLink" type="button" title="ç®€ç¹è½¬æ¢">ç¹</button><button id="darkmode" type="button" title="æµ…è‰²å’Œæ·±è‰²æ¨¡å¼è½¬æ¢"><i class="anzhiyufont anzhiyu-icon-circle-half-stroke"></i></button><a class="icon-V hidden" onclick="switchNightMode()" title="æµ…è‰²å’Œæ·±è‰²æ¨¡å¼è½¬æ¢"><svg width="25" height="25" viewBox="0 0 1024 1024"><use id="modeicon" xlink:href="#icon-moon"></use></svg></a><button id="hide-aside-btn" type="button" title="å•æ å’ŒåŒæ åˆ‡æ¢"><i class="anzhiyufont anzhiyu-icon-arrows-left-right"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="è®¾ç½®"><i class="anzhiyufont anzhiyu-icon-gear"></i></button><button class="close" id="mobile-toc-button" type="button" title="ç›®å½•"><i class="anzhiyufont anzhiyu-icon-list-ul"></i></button><button id="center-console" type="button" title="ä¸­æ§å°"><i class="anzhiyufont anzhiyu-icon-fish"></i></button><button id="go-up" type="button" title="å›åˆ°é¡¶éƒ¨"><i class="anzhiyufont anzhiyu-icon-arrow-up"></i></button></div></div><div id="nav-music"><div id="nav-music-hoverTips" onclick="anzhiyu.musicToggle()">æ’­æ”¾éŸ³ä¹</div><div id="console-music-bg"></div><meting-js id="8897204599" server="tencent" type="playlist" mutex="true" preload="none" theme="var(--anzhiyu-main)" data-lrctype="0" order="random"></meting-js></div><div id="console"><div class="close-btn" onclick="anzhiyu.hideConsole()" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-circle-xmark" style="font-size: 35px;"></i></div><div class="console-card-group-reward"><ul class="reward-all console-card"><li class="reward-item"><a href="https://npm.elemecdn.com/anzhiyu-blog@1.1.6/img/post/common/qrcode-weichat.png" target="_blank"><img class="post-qr-code-img" alt="wechat" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://npm.elemecdn.com/anzhiyu-blog@1.1.6/img/post/common/qrcode-weichat.png"/></a><div class="post-qr-code-desc">wechat</div></li><li class="reward-item"><a href="https://npm.elemecdn.com/anzhiyu-blog@1.1.6/img/post/common/qrcode-alipay.png" target="_blank"><img class="post-qr-code-img" alt="alipay" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://npm.elemecdn.com/anzhiyu-blog@1.1.6/img/post/common/qrcode-alipay.png"/></a><div class="post-qr-code-desc">alipay</div></li></ul></div><div class="console-card-group"><div class="console-card-group-left"><div class="console-card" id="card-newest-comments" onclick="anzhiyu.hideConsole()"><div class="card-content"><div class="author-content-item-tips">äº’åŠ¨</div><span class="author-content-item-title"> <span>æœ€æ–°è¯„è®º</span></span></div><div class="aside-list"><span>æ­£åœ¨åŠ è½½ä¸­...</span></div></div></div><div class="console-card-group-right"><div class="console-card tags" onclick="anzhiyu.hideConsole()"><div class="card-content"><div class="author-content-item-tips">å…´è¶£ç‚¹</div><span class="author-content-item-title">å¯»æ‰¾ä½ æ„Ÿå…´è¶£çš„é¢†åŸŸ</span><div class="card-tags"><div class="item-headline"></div><div class="card-tag-cloud"><a href="/tags/JVM/" style="font-size: 1.05rem;">JVM<sup>1</sup></a><a href="/tags/Java/" style="font-size: 1.05rem;">Java<sup>4</sup></a><a href="/tags/Redis/" style="font-size: 1.05rem;">Redis<sup>1</sup></a><a href="/tags/%E5%A4%9A%E7%BA%BF%E7%A8%8B/" style="font-size: 1.05rem;">å¤šçº¿ç¨‹<sup>1</sup></a><a href="/tags/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/" style="font-size: 1.05rem;">è®¾è®¡æ¨¡å¼<sup>1</sup></a></div></div><hr/></div></div><div class="console-card history" onclick="anzhiyu.hideConsole()"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-box-archiv"></i><span>æ–‡ç« </span></div><div class="card-archives"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-archive"></i><span>å½’æ¡£</span></div><ul class="card-archive-list"><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2020/03/"><span class="card-archive-list-date">ä¸‰æœˆ 2020</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">1</span><span>ç¯‡</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2020/02/"><span class="card-archive-list-date">äºŒæœˆ 2020</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">1</span><span>ç¯‡</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2020/01/"><span class="card-archive-list-date">ä¸€æœˆ 2020</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">2</span><span>ç¯‡</span></div></a></li></ul></div><hr/></div></div></div><div class="button-group"><div class="console-btn-item"><a class="darkmode_switchbutton" onclick="rm.switchDarkMode()" title="æ˜¾ç¤ºæ¨¡å¼åˆ‡æ¢" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-moon"></i></a></div><div class="console-btn-item" id="consoleHideAside" onclick="anzhiyu.hideAsideBtn()" title="è¾¹æ æ˜¾ç¤ºæ§åˆ¶"><a class="asideSwitch"><i class="anzhiyufont anzhiyu-icon-arrows-left-right"></i></a></div><div class="console-btn-item on" id="consoleCommentBarrage" onclick="anzhiyu.switchCommentBarrage()" title="çƒ­è¯„å¼€å…³"><a class="commentBarrage"><i class="anzhiyufont anzhiyu-icon-message"></i></a></div><div class="console-btn-item" id="consoleMusic" onclick="anzhiyu.musicToggle()" title="éŸ³ä¹å¼€å…³"><a class="music-switch"><i class="anzhiyufont anzhiyu-icon-music"></i></a></div><div class="console-btn-item" id="consoleKeyboard" onclick="anzhiyu.keyboardToggle()" title="å¿«æ·é”®å¼€å…³"><a class="keyboard-switch"><i class="anzhiyufont anzhiyu-icon-keyboard"></i></a></div></div><div class="console-mask" onclick="anzhiyu.hideConsole()" href="javascript:void(0);"></div></div><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">æœç´¢</span><span id="loading-status"></span><button class="search-close-button"><i class="anzhiyufont anzhiyu-icon-xmark"></i></button></nav><div class="is-center" id="loading-database"><i class="anzhiyufont anzhiyu-icon-spinner anzhiyu-pulse-icon"></i><span>  æ•°æ®åº“åŠ è½½ä¸­</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="æœç´¢æ–‡ç« " type="text"/></div></div><hr/><div id="local-search-results"></div></div></div><div id="search-mask"></div></div><div id="rightMenu"><div class="rightMenu-group rightMenu-small"><div class="rightMenu-item" id="menu-backward"><i class="anzhiyufont anzhiyu-icon-arrow-left"></i></div><div class="rightMenu-item" id="menu-forward"><i class="anzhiyufont anzhiyu-icon-arrow-right"></i></div><div class="rightMenu-item" id="menu-refresh"><i class="anzhiyufont anzhiyu-icon-arrow-rotate-right" style="font-size: 1rem;"></i></div><div class="rightMenu-item" id="menu-top"><i class="anzhiyufont anzhiyu-icon-arrow-up"></i></div></div><div class="rightMenu-group rightMenu-line rightMenuPlugin"><div class="rightMenu-item" id="menu-copytext"><i class="anzhiyufont anzhiyu-icon-copy"></i><span>å¤åˆ¶é€‰ä¸­æ–‡æœ¬</span></div><div class="rightMenu-item" id="menu-pastetext"><i class="anzhiyufont anzhiyu-icon-paste"></i><span>ç²˜è´´æ–‡æœ¬</span></div><a class="rightMenu-item" id="menu-commenttext"><i class="anzhiyufont anzhiyu-icon-comment-medical"></i><span>å¼•ç”¨åˆ°è¯„è®º</span></a><div class="rightMenu-item" id="menu-newwindow"><i class="anzhiyufont anzhiyu-icon-window-restore"></i><span>æ–°çª—å£æ‰“å¼€</span></div><div class="rightMenu-item" id="menu-copylink"><i class="anzhiyufont anzhiyu-icon-link"></i><span>å¤åˆ¶é“¾æ¥åœ°å€</span></div><div class="rightMenu-item" id="menu-copyimg"><i class="anzhiyufont anzhiyu-icon-images"></i><span>å¤åˆ¶æ­¤å›¾ç‰‡</span></div><div class="rightMenu-item" id="menu-downloadimg"><i class="anzhiyufont anzhiyu-icon-download"></i><span>ä¸‹è½½æ­¤å›¾ç‰‡</span></div><div class="rightMenu-item" id="menu-newwindowimg"><i class="anzhiyufont anzhiyu-icon-window-restore"></i><span>æ–°çª—å£æ‰“å¼€å›¾ç‰‡</span></div><div class="rightMenu-item" id="menu-search"><i class="anzhiyufont anzhiyu-icon-magnifying-glass"></i><span>ç«™å†…æœç´¢</span></div><div class="rightMenu-item" id="menu-searchBaidu"><i class="anzhiyufont anzhiyu-icon-magnifying-glass"></i><span>ç™¾åº¦æœç´¢</span></div><div class="rightMenu-item" id="menu-music-toggle"><i class="anzhiyufont anzhiyu-icon-play"></i><span>æ’­æ”¾éŸ³ä¹</span></div><div class="rightMenu-item" id="menu-music-back"><i class="anzhiyufont anzhiyu-icon-backward"></i><span>åˆ‡æ¢åˆ°ä¸Šä¸€é¦–</span></div><div class="rightMenu-item" id="menu-music-forward"><i class="anzhiyufont anzhiyu-icon-forward"></i><span>åˆ‡æ¢åˆ°ä¸‹ä¸€é¦–</span></div><div class="rightMenu-item" id="menu-music-playlist" onclick="window.open(&quot;https://y.qq.com/n/ryqq/playlist/8897204599&quot;, &quot;_blank&quot;);" style="display: none;"><i class="anzhiyufont anzhiyu-icon-radio"></i><span>æŸ¥çœ‹æ‰€æœ‰æ­Œæ›²</span></div><div class="rightMenu-item" id="menu-music-copyMusicName"><i class="anzhiyufont anzhiyu-icon-copy"></i><span>å¤åˆ¶æ­Œå</span></div></div><div class="rightMenu-group rightMenu-line rightMenuOther"><a class="rightMenu-item menu-link" id="menu-randomPost"><i class="anzhiyufont anzhiyu-icon-shuffle"></i><span>éšä¾¿é€›é€›</span></a><a class="rightMenu-item menu-link" href="/categories/"><i class="anzhiyufont anzhiyu-icon-cube"></i><span>åšå®¢åˆ†ç±»</span></a><a class="rightMenu-item menu-link" href="/tags/"><i class="anzhiyufont anzhiyu-icon-tags"></i><span>æ–‡ç« æ ‡ç­¾</span></a></div><div class="rightMenu-group rightMenu-line rightMenuOther"><a class="rightMenu-item" id="menu-copy" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-copy"></i><span>å¤åˆ¶åœ°å€</span></a><a class="rightMenu-item" id="menu-commentBarrage" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-message"></i><span class="menu-commentBarrage-text">å…³é—­çƒ­è¯„</span></a><a class="rightMenu-item" id="menu-darkmode" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-circle-half-stroke"></i><span class="menu-darkmode-text">æ·±è‰²æ¨¡å¼</span></a><a class="rightMenu-item" id="menu-translate" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-language"></i><span>è½‰ç‚ºç¹é«”</span></a></div></div><div id="rightmenu-mask"></div><div id="he-plugin-simple"></div><script>var WIDGET = {
  "CONFIG": {
    "modules": "0124",
    "background": "2",
    "tmpColor": "FFFFFF",
    "tmpSize": "16",
    "cityColor": "FFFFFF",
    "citySize": "16",
    "aqiColor": "E8D87B",
    "aqiSize": "16",
    "weatherIconSize": "24",
    "alertIconSize": "18",
    "padding": "10px 10px 10px 10px",
    "shadow": "0",
    "language": "auto",
    "borderRadius": "20",
    "fixed": "true",
    "vertical": "top",
    "horizontal": "left",
    "left": "20",
    "top": "7.1",
    "key": "df245676fb434a0691ead1c63341cd94"
  }
}
</script><link rel="stylesheet" href="https://widget.qweather.net/simple/static/css/he-simple.css?v=1.4.0"/><script src="https://widget.qweather.net/simple/static/js/he-simple.js?v=1.4.0"></script><div><script src="https://npm.elemecdn.com/hexo-theme-anzhiyu@1.2.0/source/js/utils.js"></script><script src="https://npm.elemecdn.com/hexo-theme-anzhiyu@1.2.0/source/js/main.js"></script><script src="https://npm.elemecdn.com/hexo-theme-anzhiyu@1.2.0/source/js/tw_cn.js"></script><script src="https://npm.elemecdn.com/medium-zoom@1.0.6/dist/medium-zoom.min.js"></script><script src="https://npm.elemecdn.com/instant.page@5.1.1/instantpage.js" type="module"></script><script src="https://npm.elemecdn.com/vanilla-lazyload@17.3.1/dist/lazyload.iife.min.js"></script><script src="https://npm.elemecdn.com/node-snackbar@0.1.16/dist/snackbar.min.js"></script><canvas id="universe"></canvas><script async src="https://npm.elemecdn.com/anzhiyu-theme-static@1.0.0/dark/dark.js"></script><script>// æ¶ˆé™¤æ§åˆ¶å°æ‰“å°
var HoldLog = console.log;
console.log = function () {};
let now1 = new Date();
queueMicrotask(() => {
  const Log = function () {
    HoldLog.apply(console, arguments);
  }; //åœ¨æ¢å¤å‰è¾“å‡ºæ—¥å¿—
  const grt = new Date("06/01/2023 00:00:00"); //æ­¤å¤„ä¿®æ”¹ä½ çš„å»ºç«™æ—¶é—´æˆ–è€…ç½‘ç«™ä¸Šçº¿æ—¶é—´
  now1.setTime(now1.getTime() + 250);
  const days = (now1 - grt) / 1000 / 60 / 60 / 24;
  const dnum = Math.floor(days);
  const ascll = [
    `æ¬¢è¿ä½¿ç”¨å®‰çŸ¥é±¼!`,
    `ç”Ÿæ´»æ˜æœ—, ä¸‡ç‰©å¯çˆ±`,
    `
        
       â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ•—   â–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ•—  â–ˆâ–ˆâ•—â–ˆâ–ˆâ•—â–ˆâ–ˆâ•—   â–ˆâ–ˆâ•—â–ˆâ–ˆâ•—   â–ˆâ–ˆâ•—
      â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ•—  â–ˆâ–ˆâ•‘â•šâ•â•â–ˆâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘â•šâ–ˆâ–ˆâ•— â–ˆâ–ˆâ•”â•â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘
      â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â–ˆâ–ˆâ•— â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ–ˆâ•”â• â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘ â•šâ–ˆâ–ˆâ–ˆâ–ˆâ•”â• â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘
      â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘â•šâ–ˆâ–ˆâ•—â–ˆâ–ˆâ•‘ â–ˆâ–ˆâ–ˆâ•”â•  â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘  â•šâ–ˆâ–ˆâ•”â•  â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘
      â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘ â•šâ–ˆâ–ˆâ–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘   â•šâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•
      â•šâ•â•  â•šâ•â•â•šâ•â•  â•šâ•â•â•â•â•šâ•â•â•â•â•â•â•â•šâ•â•  â•šâ•â•â•šâ•â•   â•šâ•â•    â•šâ•â•â•â•â•â•
        
        `,
    "å·²ä¸Šçº¿",
    dnum,
    "å¤©",
    "Â©2023 By å®‰çŸ¥é±¼",
  ];
  const ascll2 = [`NCC2-036`, `è°ƒç”¨å‰ç½®æ‘„åƒå¤´æ‹ç…§æˆåŠŸï¼Œè¯†åˆ«ä¸ºã€å°ç¬¨è›‹ã€‘.`, `Photo captured: `, `ğŸ¤ª`];

  setTimeout(
    Log.bind(
      console,
      `\n%c${ascll[0]} %c ${ascll[1]} %c ${ascll[2]} %c${ascll[3]}%c ${ascll[4]}%c ${ascll[5]}\n\n%c ${ascll[6]}\n`,
      "color:#3b70fc",
      "",
      "color:#3b70fc",
      "color:#3b70fc",
      "",
      "color:#3b70fc",
      ""
    )
  );
  setTimeout(
    Log.bind(
      console,
      `%c ${ascll2[0]} %c ${ascll2[1]} %c \n${ascll2[2]} %c\n${ascll2[3]}\n`,
      "color:white; background-color:#4fd953",
      "",
      "",
      'background:url("https://npm.elemecdn.com/anzhiyu-blog@1.1.6/img/post/common/tinggge.gif") no-repeat;font-size:450%'
    )
  );

  setTimeout(Log.bind(console, "%c WELCOME %c ä½ å¥½ï¼Œå°ç¬¨è›‹.", "color:white; background-color:#4f90d9", ""));

  setTimeout(
    console.warn.bind(
      console,
      "%c âš¡ Powered by å®‰çŸ¥é±¼ %c ä½ æ­£åœ¨è®¿é—® å¥•ä¸ƒ çš„åšå®¢.",
      "color:white; background-color:#f0ad4e",
      ""
    )
  );

  setTimeout(Log.bind(console, "%c W23-12 %c ä½ å·²æ‰“å¼€æ§åˆ¶å°.", "color:white; background-color:#4f90d9", ""));

  setTimeout(
    console.warn.bind(console, "%c S013-782 %c ä½ ç°åœ¨æ­£å¤„äºç›‘æ§ä¸­.", "color:white; background-color:#d9534f", "")
  );
});</script><script async src="/anzhiyu/random.js"></script><script src="https://npm.elemecdn.com/hexo-theme-anzhiyu@1.2.0/source/js/search/local-search.js"></script><div class="js-pjax"><input type="hidden" name="page-type" id="page-type" value="post"></div><script async data-pjax src="https://npm.elemecdn.com/anzhiyu-theme-static@1.0.1/bubble/bubble.js"></script><script>var visitorMail = "visitor@anzhiy.cn";</script><script>//åŠ¨æ€æ ‡é¢˜
let leaveTitle = 'w(ï¾ŸĞ”ï¾Ÿ)w ä¸è¦èµ°ï¼å†çœ‹çœ‹å˜›ï¼';
let backTitle = 'â™ª(^âˆ‡^*)æ¬¢è¿å›æ¥ï¼';
let OriginTitile = document.title
let titleTime
document.addEventListener('visibilitychange', function () {
  if (document.hidden) {
    //ç¦»å¼€å½“å‰é¡µé¢æ—¶æ ‡ç­¾æ˜¾ç¤ºå†…å®¹
    document.title = leaveTitle
    clearTimeout(titleTime)
  } else {
    //è¿”å›å½“å‰é¡µé¢æ—¶æ ‡ç­¾æ˜¾ç¤ºå†…å®¹
    document.title = backTitle + OriginTitile
    //ä¸¤ç§’åå˜å›æ­£å¸¸æ ‡é¢˜
    titleTime = setTimeout(function () {
      document.title = OriginTitile
    }, 2000)
  }
})</script><script data-pjax src="https://npm.elemecdn.com/anzhiyu-theme-static@1.0.0/catalog-bar/catalog-bar.js"></script><script async data-pjax src="https://npm.elemecdn.com/anzhiyu-theme-static@1.0.0/categoryBar/categoryBar.js"></script><script async data-pjax src="https://npm.elemecdn.com/anzhiyu-theme-static@1.0.0/waterfall/waterfall.js"></script><script src="https://lf3-cdn-tos.bytecdntp.com/cdn/expire-1-M/qrcodejs/1.0.0/qrcode.min.js"></script><script>// åˆå§‹åŒ–å‡½æ•°
let rm = {};

//ç¦æ­¢å›¾ç‰‡ä¸è¶…é“¾æ¥æ‹–æ‹½
let aElements = document.getElementsByTagName("a");
for (let i = 0; i < aElements.length; i++) {
  aElements[i].setAttribute("draggable", "false");
  let imgElements = aElements[i].getElementsByTagName("img");
  for (let j = 0; j < imgElements.length; j++) {
    imgElements[j].setAttribute("draggable", "false");
  }
}

// æ˜¾ç¤ºèœå•
rm.showRightMenu = function (isTrue, x = 0, y = 0) {
  console.info(x, y)
  let rightMenu = document.getElementById("rightMenu");
  rightMenu.style.top = x + "px";
  rightMenu.style.left = y + "px";
  if (isTrue) {
    rightMenu.style.display = "block";
    stopMaskScroll();
  } else {
    rightMenu.style.display = "none";
  }
};

// éšè—èœå•
rm.hideRightMenu = function () {
  rm.showRightMenu(false);
  let rightMenuMask = document.querySelector("#rightmenu-mask");
  rightMenuMask.style.display = "none";
};

// å°ºå¯¸
let rmWidth = document.getElementById("rightMenu").offsetWidth;
let rmHeight = document.getElementById("rightMenu").offsetHeight;

// é‡æ–°å®šä¹‰å°ºå¯¸
rm.reloadrmSize = function () {
  rightMenu.style.visibility = "hidden";
  rightMenu.style.display = "block";
  // è·å–å®½åº¦å’Œé«˜åº¦
  rmWidth = document.getElementById("rightMenu").offsetWidth;
  rmHeight = document.getElementById("rightMenu").offsetHeight;
  rightMenu.style.visibility = "visible";
};

// è·å–ç‚¹å‡»çš„href
let domhref = "";
let domImgSrc = "";
let globalEvent = null;

var oncontextmenuFunction = function (event) {
  if (document.body.clientWidth > 768) {
    let pageX = event.clientX + 10; //åŠ 10æ˜¯ä¸ºäº†é˜²æ­¢æ˜¾ç¤ºæ—¶é¼ æ ‡é®åœ¨èœå•ä¸Š
    let pageY = event.clientY;

    //å…¶ä»–é¢å¤–èœå•
    const $rightMenuOther = document.querySelector(".rightMenuOther");
    const $rightMenuPlugin = document.querySelector(".rightMenuPlugin");
    const $rightMenuCopyText = document.querySelector("#menu-copytext");
    const $rightMenuPasteText = document.querySelector("#menu-pastetext");
    const $rightMenuCommentText = document.querySelector("#menu-commenttext");
    const $rightMenuNewWindow = document.querySelector("#menu-newwindow");
    const $rightMenuNewWindowImg = document.querySelector("#menu-newwindowimg");
    const $rightMenuCopyLink = document.querySelector("#menu-copylink");
    const $rightMenuCopyImg = document.querySelector("#menu-copyimg");
    const $rightMenuDownloadImg = document.querySelector("#menu-downloadimg");
    const $rightMenuSearch = document.querySelector("#menu-search");
    const $rightMenuSearchBaidu = document.querySelector("#menu-searchBaidu");
    const $rightMenuMusicToggle = document.querySelector("#menu-music-toggle");
    const $rightMenuMusicBack = document.querySelector("#menu-music-back");
    const $rightMenuMusicForward = document.querySelector("#menu-music-forward");
    const $rightMenuMusicPlaylist = document.querySelector("#menu-music-playlist");
    const $rightMenuMusicCopyMusicName = document.querySelector("#menu-music-copyMusicName");

    let href = event.target.href;
    let imgsrc = event.target.currentSrc;

    // åˆ¤æ–­æ¨¡å¼ æ‰©å±•æ¨¡å¼ä¸ºæœ‰äº‹ä»¶
    let pluginMode = false;
    $rightMenuOther.style.display = "block";
    globalEvent = event;

    // æ£€æŸ¥æ˜¯å¦éœ€è¦å¤åˆ¶ æ˜¯å¦æœ‰é€‰ä¸­æ–‡æœ¬
    if (selectTextNow && window.getSelection()) {
      pluginMode = true;
      $rightMenuCopyText.style.display = "block";
      $rightMenuCommentText.style.display = "block";
      $rightMenuSearch.style.display = "block";
      $rightMenuSearchBaidu.style.display = "block";
    } else {
      $rightMenuCopyText.style.display = "none";
      $rightMenuCommentText.style.display = "none";
      $rightMenuSearchBaidu.style.display = "none";
      $rightMenuSearch.style.display = "none";
    }

    //æ£€æŸ¥æ˜¯å¦å³é”®ç‚¹å‡»äº†é“¾æ¥aæ ‡ç­¾
    if (href) {
      pluginMode = true;
      $rightMenuNewWindow.style.display = "block";
      $rightMenuCopyLink.style.display = "block";
      domhref = href;
    } else {
      $rightMenuNewWindow.style.display = "none";
      $rightMenuCopyLink.style.display = "none";
    }

    //æ£€æŸ¥æ˜¯å¦éœ€è¦å¤åˆ¶å›¾ç‰‡
    if (imgsrc) {
      pluginMode = true;
      $rightMenuCopyImg.style.display = "block";
      $rightMenuDownloadImg.style.display = "block";
      $rightMenuNewWindowImg.style.display = "block";
      document.getElementById("rightMenu").style.width="12rem"
      domImgSrc = imgsrc;
    } else {
      $rightMenuCopyImg.style.display = "none";
      $rightMenuDownloadImg.style.display = "none";
      $rightMenuNewWindowImg.style.display = "none";
    }

    // åˆ¤æ–­æ˜¯å¦ä¸ºè¾“å…¥æ¡†
    if (event.target.tagName.toLowerCase() === "input" || event.target.tagName.toLowerCase() === "textarea") {
      pluginMode = true;
      $rightMenuPasteText.style.display = "block";
    } else {
      $rightMenuPasteText.style.display = "none";
    }
    const navMusicEl = document.querySelector("#nav-music");
    //åˆ¤æ–­æ˜¯å¦æ˜¯éŸ³ä¹
    if (navMusicEl && navMusicEl.contains(event.target)) {
      pluginMode = true;
      $rightMenuMusicToggle.style.display = "block";
      $rightMenuMusicBack.style.display = "block";
      $rightMenuMusicForward.style.display = "block";
      $rightMenuMusicPlaylist.style.display = "block";
      $rightMenuMusicCopyMusicName.style.display = "block";
    } else {
      $rightMenuMusicToggle.style.display = "none";
      $rightMenuMusicBack.style.display = "none";
      $rightMenuMusicForward.style.display = "none";
      $rightMenuMusicPlaylist.style.display = "none";
      $rightMenuMusicCopyMusicName.style.display = "none";
    }

    // å¦‚æœä¸æ˜¯æ‰©å±•æ¨¡å¼åˆ™éšè—æ‰©å±•æ¨¡å—
    if (pluginMode) {
      $rightMenuOther.style.display = "none";
      $rightMenuPlugin.style.display = "block";
    } else {
      $rightMenuPlugin.style.display = "none";
    }

    rm.reloadrmSize();

    // é¼ æ ‡é»˜è®¤æ˜¾ç¤ºåœ¨é¼ æ ‡å³ä¸‹æ–¹ï¼Œå½“é¼ æ ‡é å³æˆ–é ä¸‹æ—¶ï¼Œå°†èœå•æ˜¾ç¤ºåœ¨é¼ æ ‡å·¦æ–¹\ä¸Šæ–¹
    if (pageX + rmWidth > window.innerWidth) {
      pageX -= rmWidth + 10;
    }
    if (pageY + rmHeight > window.innerHeight) {
      pageY -= pageY + rmHeight - window.innerHeight;
    }

    rm.showRightMenu(true, pageY, pageX);
    document.getElementById("rightmenu-mask").style.display = "flex";
    return false;
  }
};

// ç›‘å¬å³é”®åˆå§‹åŒ–
window.oncontextmenu = oncontextmenuFunction

// ä¸‹è½½å›¾ç‰‡çŠ¶æ€
rm.downloadimging = false;

// å¤åˆ¶å›¾ç‰‡åˆ°å‰ªè´´æ¿
rm.writeClipImg = function (imgsrc) {
  console.log("æŒ‰ä¸‹å¤åˆ¶");
  rm.hideRightMenu();
  anzhiyu.snackbarShow("æ­£åœ¨ä¸‹è½½ä¸­ï¼Œè¯·ç¨å", false, 10000);
  if (rm.downloadimging == false) {
    rm.downloadimging = true;
    setTimeout(function () {
      copyImage(imgsrc);
      anzhiyu.snackbarShow("å¤åˆ¶æˆåŠŸï¼å›¾ç‰‡å·²æ·»åŠ ç›²æ°´å°ï¼Œè¯·éµå®ˆç‰ˆæƒåè®®");
      rm.downloadimging = false;
    }, "10000");
  }
};

function imageToBlob(imageURL) {
  const img = new Image();
  const c = document.createElement("canvas");
  const ctx = c.getContext("2d");
  img.crossOrigin = "";
  img.src = imageURL;
  return new Promise(resolve => {
    img.onload = function () {
      c.width = this.naturalWidth;
      c.height = this.naturalHeight;
      ctx.drawImage(this, 0, 0);
      c.toBlob(
        blob => {
          // here the image is a blob
          resolve(blob);
        },
        "image/png",
        0.75
      );
    };
  });
}

async function copyImage(imageURL) {
  const blob = await imageToBlob(imageURL);
  const item = new ClipboardItem({ "image/png": blob });
  navigator.clipboard.write([item]);
}

rm.switchDarkMode = function () {
  // Switch Between Light And Dark Mode
  const nowMode = document.documentElement.getAttribute("data-theme") === "dark" ? "dark" : "light";
  if (nowMode === "light") {
    activateDarkMode();
    saveToLocal.set("theme", "dark", 2);
    GLOBAL_CONFIG.Snackbar !== undefined && anzhiyu.snackbarShow(GLOBAL_CONFIG.Snackbar.day_to_night);
    document.querySelector(".menu-darkmode-text").textContent = "æµ…è‰²æ¨¡å¼";
  } else {
    activateLightMode();
    saveToLocal.set("theme", "light", 2);
    GLOBAL_CONFIG.Snackbar !== undefined && anzhiyu.snackbarShow(GLOBAL_CONFIG.Snackbar.night_to_day);
    document.querySelector(".menu-darkmode-text").textContent = "æ·±è‰²æ¨¡å¼";
  }
  // handle some cases
  typeof runMermaid === "function" && window.runMermaid();
  rm.hideRightMenu();
  anzhiyu.darkModeStatus();
};

rm.copyUrl = function (id) {
  const input = document.createElement("input"); // Create a new <input> element
  input.id = "copyVal"; // Set the id of the new element to "copyVal"
  document.body.appendChild(input); // Append the new element to the end of the <body> element
  
  const text = id;
  input.value = text;
  input.select();
  input.setSelectionRange(0, input.value.length);
  document.execCommand("copy");
  
  input.remove(); // Remove the <input> element from the DOM
};

function stopMaskScroll() {
  if (document.getElementById("rightmenu-mask")) {
    let xscroll = document.getElementById("rightmenu-mask");
    xscroll.addEventListener(
      "mousewheel",
      function (e) {
        //é˜»æ­¢æµè§ˆå™¨é»˜è®¤æ–¹æ³•
        rm.hideRightMenu();
        // e.preventDefault();
      },
      false
    );
  }
  if (document.getElementById("rightMenu")) {
    let xscroll = document.getElementById("rightMenu");
    xscroll.addEventListener(
      "mousewheel",
      function (e) {
        //é˜»æ­¢æµè§ˆå™¨é»˜è®¤æ–¹æ³•
        rm.hideRightMenu();
        // e.preventDefault();
      },
      false
    );
  }
}

rm.rightmenuCopyText = function (txt) {
  if (navigator.clipboard) {
    navigator.clipboard.writeText(txt);
  }
  rm.hideRightMenu();
};

rm.copyPageUrl = function () {
  var url = window.location.href;
  rm.copyUrl(url);
  anzhiyu.snackbarShow("å¤åˆ¶æœ¬é¡µé“¾æ¥åœ°å€æˆåŠŸ", false, 2000);
  rm.hideRightMenu();
};

rm.sharePage = function () {
  var content = window.location.href;
  rm.copyUrl(url);
  anzhiyu.snackbarShow("å¤åˆ¶æœ¬é¡µé“¾æ¥åœ°å€æˆåŠŸ", false, 2000);
  rm.hideRightMenu();
};

// å¤åˆ¶å½“å‰é€‰ä¸­æ–‡æœ¬
var selectTextNow = "";
document.onmouseup = document.ondblclick = selceText;

function selceText() {
  var txt;
  if (document.selection) {
    txt = document.selection.createRange().text;
  } else {
    txt = window.getSelection().toString();
  }
  selectTextNow = txt !== "" ? txt : "";
}

// è¯»å–å‰ªåˆ‡æ¿
rm.readClipboard = function () {
  if (navigator.clipboard) {
    navigator.clipboard.readText().then(clipText => rm.insertAtCaret(globalEvent.target, clipText));
  }
};

// ç²˜è´´æ–‡æœ¬åˆ°ç„¦ç‚¹
rm.insertAtCaret = function (elemt, value) {
  const startPos = elemt.selectionStart,
    endPos = elemt.selectionEnd;
  if (document.selection) {
    elemt.focus();
    var sel = document.selection.createRange();
    sel.text = value;
    elemt.focus();
  } else {
    if (startPos || startPos == "0") {
      var scrollTop = elemt.scrollTop;
      elemt.value = elemt.value.substring(0, startPos) + value + elemt.value.substring(endPos, elemt.value.length);
      elemt.focus();
      elemt.selectionStart = startPos + value.length;
      elemt.selectionEnd = startPos + value.length;
      elemt.scrollTop = scrollTop;
    } else {
      elemt.value += value;
      elemt.focus();
    }
  }
};

//ç²˜è´´æ–‡æœ¬
rm.pasteText = function () {
  const result = rm.readClipboard() || "";
  rm.hideRightMenu();
};

//å¼•ç”¨åˆ°è¯„è®º
rm.rightMenuCommentText = function (txt) {
  rm.hideRightMenu();
  const postCommentDom = document.getElementById("post-comment");
  var domTop = postCommentDom.offsetTop;
  window.scrollTo(0, domTop - 80);
  if (txt == "undefined" || txt == "null") txt = "å¥½æ£’ï¼";
  function setText() {
    setTimeout(() => {
      var input = document.getElementsByClassName("el-textarea__inner")[0];
      if (!input) setText();
      let evt = document.createEvent("HTMLEvents");
      evt.initEvent("input", true, true);
      let inputValue = replaceAll(txt, "\n", "\n> ");
      input.value = "> " + inputValue + "\n\n";
      input.dispatchEvent(evt);
      input.focus();
      input.setSelectionRange(-1, -1);
      if (document.getElementById("comment-tips")) {
        document.getElementById("comment-tips").classList.add("show");
      }
    }, 100);
  }
  setText();
};

//æ›¿æ¢æ‰€æœ‰å†…å®¹
function replaceAll(string, search, replace) {
  return string.split(search).join(replace);
}

// ç™¾åº¦æœç´¢
rm.searchBaidu = function () {
  anzhiyu.snackbarShow("å³å°†è·³è½¬åˆ°ç™¾åº¦æœç´¢", false, 2000);
  setTimeout(function () {
    window.open("https://www.baidu.com/s?wd=" + selectTextNow);
  }, "2000");
  rm.hideRightMenu();
};

//åˆ†äº«é“¾æ¥
rm.copyLink = function () {
  rm.rightmenuCopyText(domhref);
  anzhiyu.snackbarShow("å·²å¤åˆ¶é“¾æ¥åœ°å€");
};

function addRightMenuClickEvent() {
  // æ·»åŠ ç‚¹å‡»äº‹ä»¶
  document.getElementById("menu-backward").addEventListener("click", function () {
  window.history.back();
    rm.hideRightMenu();
  });

  document.getElementById("menu-forward").addEventListener("click", function () {
    window.history.forward();
    rm.hideRightMenu();
  });

  document.getElementById("menu-refresh").addEventListener("click", function () {
    window.location.reload();
  });

  document.getElementById("menu-top").addEventListener("click", function () {
    anzhiyu.scrollToDest(0, 500);
    rm.hideRightMenu();
  });

  const menuLinks = document.querySelectorAll(".menu-link");
  menuLinks.forEach(function (link) {
    link.addEventListener("click", rm.hideRightMenu);
  });

  document.getElementById("menu-darkmode").addEventListener("click", rm.switchDarkMode);

  document.getElementById("menu-home") && document.getElementById("menu-home").addEventListener("click", function () {
    window.location.href = window.location.origin;
  });

  document.getElementById("menu-randomPost").addEventListener("click", function () {
    toRandomPost();
  });

  document.getElementById("menu-commentBarrage").addEventListener("click", anzhiyu.switchCommentBarrage);

  document.getElementById("rightmenu-mask").addEventListener("click", rm.hideRightMenu);

  document.getElementById("rightmenu-mask").addEventListener("contextmenu", function (event) {
    rm.hideRightMenu();
    event.preventDefault(); // Prevent the default context menu from appearing
  });

  document.getElementById("menu-copy").addEventListener("click", rm.copyPageUrl);

  document.getElementById("menu-pastetext").addEventListener("click", rm.pasteText);

  document.getElementById("menu-copytext").addEventListener("click", function () {
    rm.rightmenuCopyText(selectTextNow);
    anzhiyu.snackbarShow("å¤åˆ¶æˆåŠŸï¼Œå¤åˆ¶å’Œè½¬è½½è¯·æ ‡æ³¨æœ¬æ–‡åœ°å€");
  });

  document.getElementById("menu-commenttext").addEventListener("click", function () {
    rm.rightMenuCommentText(selectTextNow);
  });

  document.getElementById("menu-newwindow").addEventListener("click", function () {
    window.open(domhref);
    rm.hideRightMenu();
  });

  document.getElementById("menu-copylink").addEventListener("click", rm.copyLink);

  document.getElementById("menu-downloadimg").addEventListener("click", function () {
    anzhiyu.downloadImage(domImgSrc, "anzhiyu");
  });

  document.getElementById("menu-newwindowimg").addEventListener("click", function () {
    window.open(domImgSrc);
    rm.hideRightMenu();
  });

  document.getElementById("menu-copyimg").addEventListener("click", function () {
    rm.writeClipImg(domImgSrc);
  });

  document.getElementById("menu-searchBaidu").addEventListener("click", rm.searchBaidu);

  //éŸ³ä¹
  document.getElementById("menu-music-toggle").addEventListener("click", anzhiyu.musicToggle);

  document.getElementById("menu-music-back").addEventListener("click", anzhiyu.musicSkipBack);

  document.getElementById("menu-music-forward").addEventListener("click", anzhiyu.musicSkipForward);

  document.getElementById("menu-music-copyMusicName").addEventListener("click", function () {
    rm.rightmenuCopyText(anzhiyu.musicGetName());
    anzhiyu.snackbarShow("å¤åˆ¶æ­Œæ›²åç§°æˆåŠŸ", false, 3000);
  });

}

addRightMenuClickEvent();</script><script data-pjax>var themeColorMeta = document.querySelector('meta[name="theme-color"]');
var pageHeaderEl = document.getElementById("page-header");
var navMusicEl = document.getElementById("nav-music");
var consoleEl = document.getElementById("console");
// å·²éšæœºçš„æ­Œæ›²
var selectRandomSong = [];
// éŸ³ä¹é»˜è®¤å£°éŸ³å¤§å°
var musicVolume = 0.8;
// æ˜¯å¦åˆ‡æ¢äº†å‘¨æ°ä¼¦éŸ³ä¹åˆ—è¡¨
var changeMusicListFlag = false;
// å½“å‰é»˜è®¤æ’­æ”¾åˆ—è¡¨
var defaultPlayMusicList = [];

document.getElementById("page-name").innerText = document.title.split(" | å¥•ä¸ƒ")[0];
anzhiyu.initIndexEssay();
anzhiyu.changeTimeInEssay();
anzhiyu.removeBodyPaceClass();
anzhiyu.qrcodeCreate();
anzhiyu.changeTimeInAlbumDetail();
anzhiyu.reflashEssayWaterFall();
anzhiyu.sayhi();
anzhiyu.stopImgRightDrag();
anzhiyu.addNavBackgroundInit();
anzhiyu.setValueToBodyType();

anzhiyu.getCustomPlayList();
anzhiyu.addEventListenerConsoleMusicList(false);
setTimeout(() => {
  if (typeof addFriendLinksInFooter === "function") {
    addFriendLinksInFooter();
  }
}, 200)</script><link rel="stylesheet" href="https://npm.elemecdn.com/anzhiyu-theme-static@1.1.0/icon/ali_iconfont_css.css"><script src="/js/sun_moon.js" async></script><script id="click-show-text" src="https://npm.elemecdn.com/butterfly-extsrc@1.1.3/dist/click-show-text.min.js" data-mobile="false" data-text="å¯Œå¼º,æ°‘ä¸»,æ–‡æ˜,å’Œè°,è‡ªç”±,å¹³ç­‰,å…¬æ­£,æ³•æ²»,çˆ±å›½,æ•¬ä¸š,è¯šä¿¡,å‹å–„" data-fontsize="15px" data-random="false" async="async"></script><link rel="stylesheet" href="https://npm.elemecdn.com/anzhiyu-theme-static@1.0.0/aplayer/APlayer.min.css" media="print" onload="this.media='all'"><script src="https://npm.elemecdn.com/anzhiyu-blog-static@1.0.1/js/APlayer.min.js"></script><script src="https://npm.elemecdn.com/hexo-anzhiyu-music@1.0.1/assets/js/Meting2.min.js"></script><script src="https://npm.elemecdn.com/pjax@0.2.8/pjax.min.js"></script><script>let pjaxSelectors = ["head > title","#config-diff","#body-wrap","#rightside-config-hide","#rightside-config-show",".js-pjax"]

var pjax = new Pjax({
  elements: 'a:not([target="_blank"])',
  selectors: pjaxSelectors,
  cacheBust: false,
  analytics: false,
  scrollRestoration: false
})

document.addEventListener('pjax:send', function () {
  // removeEventListener scroll 
  window.tocScrollFn && window.removeEventListener('scroll', window.tocScrollFn)
  window.scrollCollect && window.removeEventListener('scroll', scrollCollect)
  window.anzhiyuScrollFnToDo && window.removeEventListener('scroll', anzhiyuScrollFnToDo)

  document.getElementById('rightside').style.cssText = "opacity: ''; transform: ''"
  
  if (window.aplayers) {
    for (let i = 0; i < window.aplayers.length; i++) {
      if (!window.aplayers[i].options.fixed) {
        window.aplayers[i].destroy()
      }
    }
  }

  typeof typed === 'object' && typed.destroy()

  //reset readmode
  const $bodyClassList = document.body.classList
  $bodyClassList.contains('read-mode') && $bodyClassList.remove('read-mode')
})

document.addEventListener('pjax:complete', function () {
  window.refreshFn()

  document.querySelectorAll('script[data-pjax]').forEach(item => {
    const newScript = document.createElement('script')
    const content = item.text || item.textContent || item.innerHTML || ""
    Array.from(item.attributes).forEach(attr => newScript.setAttribute(attr.name, attr.value))
    newScript.appendChild(document.createTextNode(content))
    item.parentNode.replaceChild(newScript, item)
  })

  GLOBAL_CONFIG.islazyload && window.lazyLoadInstance.update()

  typeof chatBtnFn === 'function' && chatBtnFn()
  typeof panguInit === 'function' && panguInit()

  // google analytics
  typeof gtag === 'function' && gtag('config', '', {'page_path': window.location.pathname});

  // baidu analytics
  typeof _hmt === 'object' && _hmt.push(['_trackPageview',window.location.pathname]);

  typeof loadMeting === 'function' && document.getElementsByClassName('aplayer').length && loadMeting()

  // prismjs
  typeof Prism === 'object' && Prism.highlightAll()
})

document.addEventListener('pjax:error', (e) => {
  if (e.request.status === 404) {
    pjax.loadUrl('/404.html')
  }
})</script></div><!-- hexo injector body_end start --><div class="js-pjax"><script async="async">var arr = document.getElementsByClassName('recent-post-item');
for(var i = 0;i<arr.length;i++){
    arr[i].classList.add('wow');
    arr[i].classList.add('animate__zoomIn');
    arr[i].setAttribute('data-wow-duration', '1.5s');
    arr[i].setAttribute('data-wow-delay', '200ms');
    arr[i].setAttribute('data-wow-offset', '30');
    arr[i].setAttribute('data-wow-iteration', '1');
  }</script><script async="async">var arr = document.getElementsByClassName('card-widget');
for(var i = 0;i<arr.length;i++){
    arr[i].classList.add('wow');
    arr[i].classList.add('animate__zoomIn');
    arr[i].setAttribute('data-wow-duration', '');
    arr[i].setAttribute('data-wow-delay', '200ms');
    arr[i].setAttribute('data-wow-offset', '');
    arr[i].setAttribute('data-wow-iteration', '');
  }</script><script async="async">var arr = document.getElementsByClassName('flink-list-card');
for(var i = 0;i<arr.length;i++){
    arr[i].classList.add('wow');
    arr[i].classList.add('animate__flipInY');
    arr[i].setAttribute('data-wow-duration', '3s');
    arr[i].setAttribute('data-wow-delay', '');
    arr[i].setAttribute('data-wow-offset', '');
    arr[i].setAttribute('data-wow-iteration', '');
  }</script><script async="async">var arr = document.getElementsByClassName('flink-list-card');
for(var i = 0;i<arr.length;i++){
    arr[i].classList.add('wow');
    arr[i].classList.add('animate__animated');
    arr[i].setAttribute('data-wow-duration', '3s');
    arr[i].setAttribute('data-wow-delay', '');
    arr[i].setAttribute('data-wow-offset', '');
    arr[i].setAttribute('data-wow-iteration', '');
  }</script><script async="async">var arr = document.getElementsByClassName('article-sort-item');
for(var i = 0;i<arr.length;i++){
    arr[i].classList.add('wow');
    arr[i].classList.add('animate__slideInRight');
    arr[i].setAttribute('data-wow-duration', '1.5s');
    arr[i].setAttribute('data-wow-delay', '');
    arr[i].setAttribute('data-wow-offset', '');
    arr[i].setAttribute('data-wow-iteration', '');
  }</script><script async="async">var arr = document.getElementsByClassName('site-card');
for(var i = 0;i<arr.length;i++){
    arr[i].classList.add('wow');
    arr[i].classList.add('animate__flipInY');
    arr[i].setAttribute('data-wow-duration', '3s');
    arr[i].setAttribute('data-wow-delay', '');
    arr[i].setAttribute('data-wow-offset', '');
    arr[i].setAttribute('data-wow-iteration', '');
  }</script><script async="async">var arr = document.getElementsByClassName('site-card');
for(var i = 0;i<arr.length;i++){
    arr[i].classList.add('wow');
    arr[i].classList.add('animate__animated');
    arr[i].setAttribute('data-wow-duration', '3s');
    arr[i].setAttribute('data-wow-delay', '');
    arr[i].setAttribute('data-wow-offset', '');
    arr[i].setAttribute('data-wow-iteration', '');
  }</script></div><script defer src="https://cdn.cbd.int/hexo-butterfly-wowjs/lib/wow.min.js"></script><script defer src="https://cdn.cbd.int/hexo-butterfly-wowjs/lib/wow_init.js"></script><!-- hexo injector body_end end --></body></html>